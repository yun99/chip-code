var e=Object.create,t=Object.defineProperty,r=Object.defineProperties,o=Object.getOwnPropertyDescriptor,l=Object.getOwnPropertyDescriptors,u=Object.getOwnPropertyNames,s=Object.getOwnPropertySymbols,a=Object.getPrototypeOf,n=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,d=(e,r,o)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[r]=o,c=e=>t(e,"__esModule",{value:!0}),p=r=>((e,r,l)=>{if(r&&"object"==typeof r||"function"==typeof r)for(let s of u(r))n.call(e,s)||"default"===s||t(e,s,{get:()=>r[s],enumerable:!(l=o(r,s))||l.enumerable});return e})(c(t(null!=r?e(a(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);((e,r)=>{for(var o in c(e),r)t(e,o,{get:r[o],enumerable:!0})})(exports,{default:()=>D,filterData:()=>T,filterStatus:()=>E});var m=p(require("./iu.js")),g=p(require("./kc.js")),f=p(require("./uj.js")),y=p(require("./p0.js")),O=p(require("./u8.js")),v=p(require("./is.js")),R=p(require("./vz.js")),_=p(require("./u4.js")),C=p(require("./o9.js"));function E(e,t){var r,o;if(t.statusCode>=200&&t.statusCode<300)return t;const l=new f.NetworkError((null==(o=null==(r=null==t?void 0:t.data)?void 0:r.error)?void 0:o.msg)||`服务器错误 ${t.statusCode}`);throw l.res=t,l.type="http",l}function T(e,t){var o,u,a,c;const{data:p={},header:_}=t||{},C=(0,R.getHttpHeader)(_,"M-TraceId")||"",E=getApp(),T=E.getModule("cat");if(void 0===p.code)p.msg=`数据结构错误，缺少code，${p.msg}`;else{try{C&&(p.M_TraceId=C)}catch(e){}(0,O.isMMP)()&&19!==p.code&&T.reportCustomMetrics(v.YXReportTarget.FORCE_LOGIN,v.ReportValue.FAILED);const c=(null==(o=null==p?void 0:p.error)?void 0:o.msg)||(null==p?void 0:p.msg)||(null==p?void 0:p.message),f=E.getModule("login"),R=E.getModule("user").getUserInfo(),_=E.getModule("user").getLastRemoveUserInfoPath();if(0===p.code||e.isPrefetch){const e=p.data;try{(0,g.isObject)(e)&&(0,y.isNotEmptyObject)(e)&&C&&(e.M_TraceId=C)}catch(e){}return b=((e,t)=>{for(var r in t||(t={}))n.call(t,r)&&d(e,r,t[r]);if(s)for(var r of s(t))i.call(t,r)&&d(e,r,t[r]);return e})({},t),r(b,l({data:e}))}if(5==+p.code)if(T.reportError(m.CAT_SEC_CATEGORY.TOKEN_ERROR(`filterData：token失效或不存在req.url=${e.url}, token=${e.header.t}, userInfo=${JSON.stringify(R)}, lastRemoveUserInfoPath=${_}`,"invalid")),"您的登录凭证已失效，请重新登录"===c){const e=E.page();f.logout(null==e?void 0:e.__route__),f.goLoginPageSingle()}else null==(u=null==E?void 0:E.getModule("user"))||u.removeUserInfo(),p.msg=`token 失效，清除用户数据，${p.code}`;else if(19===p.code){T.reportCustomMetrics(v.YXReportTarget.FORCE_LOGIN,v.ReportValue.SUCCESS);const t=E.page(),r=decodeURIComponent(y.qs.stringify(t.options));if(~(r?`${t.__route__}?${r}`:t.__route__).indexOf("pages/login/index"))return;"您的登录凭证已失效，请重新登录"===c?(T.reportError(m.CAT_SEC_CATEGORY.TOKEN_INVALID_CODE19(`filterData：token失效或不存在req.url=${e.url}, token=${e.header.t}, userInfo=${JSON.stringify(R)}, lastRemoveUserInfoPath=${_}`,"invalid")),f.logout(null==t?void 0:t.__route__)):(null==(a=null==E?void 0:E.getModule("user"))||a.removeUserInfo(),p.msg=`token 失效，清除用户数据，${p.code}`),E.$login.login()}}var b;const D=new f.NetworkError((null==(c=null==p?void 0:p.error)?void 0:c.msg)||(null==p?void 0:p.msg)||(null==p?void 0:p.message)||"");throw D.data=p,D.type="data",D}function b(e){const{request:t,response:r,setting:o}=e,{statusFilter:l=!0,dataFilter:u=!0}=o;let s=r;return function(e,t){var r,o,l,u;if(!e.isCore)return;const s=getApp(),a=t.statusCode>=200&&t.statusCode<300?v.ReportValue.SUCCESS:v.ReportValue.FAILED,n=null==(r=null==s?void 0:s.$store)?void 0:r.getCacheValue("reqFailedRecord"),i=e.url.split("?")[0],d=s.getModule("cat");n&&n.url===i&&(null==d||d.reportCustomMetrics(v.YXReportTarget.NETWORK_FORBIDDEN,a,a?{}:n),null==s||s.$store.remove("reqFailedRecord")),a||(403===t.statusCode&&e.header["mp-mtgsig"]?(null==(o=null==s?void 0:s.$store)||o.setCache("reqFailedRecord",{url:i},{isOnlyCache:!0}),_.default.emit(_.default.CONTANTS.HTTP_CODE_ERROR,t.statusCode)):(0,R.isNetWorkReason)(null==(u=null==(l=null==t?void 0:t.data)?void 0:l.error)?void 0:u.msg)?_.default.emit(_.default.CONTANTS.HTTP_CODE_ERROR,C.default.NONETWORK):_.default.emit(_.default.CONTANTS.HTTP_CODE_ERROR,C.default.SERVERERROR))}(t,r),l&&(s=E(0,r)),u&&(s=T(t,r)),s}var D=e=>{const t=b(e);return e.setResponse(t),e};