var t=Object.create,e=Object.defineProperty,u=Object.defineProperties,a=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertyNames,n=Object.getOwnPropertySymbols,r=Object.getPrototypeOf,i=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,l=(t,u,a)=>u in t?e(t,u,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[u]=a,p=(t,e)=>{for(var u in e||(e={}))i.call(e,u)&&l(t,u,e[u]);if(n)for(var u of n(e))c.call(e,u)&&l(t,u,e[u]);return t},S=(t,e)=>u(t,s(e)),h=t=>e(t,"__esModule",{value:!0}),d=u=>((t,u,s)=>{if(u&&"object"==typeof u||"function"==typeof u)for(let n of o(u))i.call(t,n)||"default"===n||e(t,n,{get:()=>u[n],enumerable:!(s=a(u,n))||s.enumerable});return t})(h(e(null!=u?t(r(u)):{},"default",u&&u.__esModule&&"default"in u?{get:()=>u.default,enumerable:!0}:{value:u,enumerable:!0})),u),C=(t,e,u)=>new Promise(((a,s)=>{var o=t=>{try{r(u.next(t))}catch(t){s(t)}},n=t=>{try{r(u.throw(t))}catch(t){s(t)}},r=t=>t.done?a(t.value):Promise.resolve(t.value).then(o,n);r((u=u.apply(t,e)).next())}));((t,u)=>{for(var a in h(t),u)e(t,a,{get:u[a],enumerable:!0})})(exports,{default:()=>_});var m=d(require("./u5.js")),k=d(require("./ob.js")),P=d(require("./u8.js")),T=d(require("./sm.js")),O=d(require("./cz.js")),g=d(require("./32.js")),y=d(require("./33.js")),{subscribeAll:B,unsubscribeAll:R}=require("./sz.js"),b=getApp(),{isNotEmptyObject:E}=require("./p0.js"),{getSeckillActivitySubscribeRequest:A,getSkuArriveSubscribeRequest:D,getCouponExpirationSubscribeRequest:I,getTakeOnSubscribeRequest:U}=require("./cl.js"),_=class{get isPendingChangeSkuCount(){return this._isPendingChangeSkuCount}set isPendingChangeSkuCount(t){b.page().loading(t),this._isPendingChangeSkuCount=t}constructor(t,e){this.skuPurchasePanelComp=t,this.panelType=e,this.isPendingChangeSkuCount=!1}initSkuPurchasePanelData(t){return C(this,null,(function*(){try{yield this.initSkuSpecChoicesData({poiId:m.$poi.getPoiId(),poiIdStr:m.$poi.getPoiIdStr(),skuId:t.skuId,source:this.panelType===O.SkuPurchasePanelType.PURCHASE_NOW?1:2,firstEnter:!0,productPattern:t.productPattern||1,choicesScene:t.choicesScene})}catch(t){const{message:e="网络异常，请重试"}=t;throw k.log.warn(`<skuPurchasePanel purchaseNow initSkuPurchasePanelData> 初始化商品购买面板的数据错误，error为：${e}`),b.page().toast(e),t}}))}onSelectRadio(t){return C(this,arguments,(function*({selected:t=!1,attrId:e=null,value:u="",groupIndex:a=null,ratioIndex:s=null}){try{const o=this.skuPurchasePanelComp.commonData.selectedSkuId,n=(0,y.updateSelectedSkuSpecList)(this.skuPurchasePanelComp.data.selectedSkuSpecList,e,u,t);if(t){const t=`skuSpecRadioGroups[${a}].radioList[${s}].selected`;this.skuPurchasePanelComp.setData({[t]:!1,"operatorButton.enable":!1,isSpuCard:!0})}if(0===n.length)return void this.resetSpecData();b.page().loading(!0);const r={poiId:m.$poi.getPoiId(),poiIdStr:m.$poi.getPoiIdStr(),skuId:this.skuPurchasePanelComp.commonData.selectedSkuId,productPattern:2,firstEnter:!1,source:0,selectedSkuSpecList:n},i=yield(0,g.getSkuChoicesData)(r),c=E(i)?i:null;if(!c)return;yield this.renderAfterSelectRadio(c,a,s),this.isPendingChangeSkuCount=!0;const l=this.skuPurchasePanelComp.commonData.selectedSkuId;this.panelType===O.SkuPurchasePanelType.PURCHASE_NOW&&c.skuLiteVO&&l!==o&&(yield this.operateCart({cartOpType:"REPLACE",customOpTargets:{replaceTarget:{skuId:o}}}),yield this.updateCurrentSkuAddCartCount()),this.isPendingChangeSkuCount=!1,b.page().loading(!1)}catch(t){throw this.isPendingChangeSkuCount=!1,b.page().loading(!1),t}}))}onTapOperatorButton(t){return C(this,null,(function*(){var e;const{status:u}=t.currentTarget.dataset;switch(u){case O.OperatorButtonStatus.ADD_CART:yield this.onTapAddToCart(t);break;case O.OperatorButtonStatus.ORDER_NOW:case O.OperatorButtonStatus.PURCHASE_NOW:this.onTapBuyNow(t);break;case O.OperatorButtonStatus.STOCK_REMIND:null==(e=null==b?void 0:b.page())||e.toast("下载【美团优选APP】查看更多");break;case O.OperatorButtonStatus.TAKE_ON_SUBSCRIBE:case O.OperatorButtonStatus.TAKE_ON_UNSUBSCRIBE:yield this.onTapSkuTakeOn(u)}}))}onTapAddToCart(t){try{this.isPendingChangeSkuCount=!0;const{customOpCartParams:e={}}=this.skuPurchasePanelComp.commonData.originalOptions;return this.operateCart({cartOpType:"INCREASE",customOpTargets:{count:this.skuPurchasePanelComp.data.currentSkuCount},customOpCartParams:e},t).then((()=>{var e,u;this.isPendingChangeSkuCount=!1,b.$event.emit("SPU_ADD_CART_DONE",{originalSkuId:(null==(u=null==(e=this.skuPurchasePanelComp.commonData.originalOptions)?void 0:e.requestParams)?void 0:u.skuId)||0,sku:this.skuPurchasePanelComp.data.currentSku}),this.skuPurchasePanelComp.closeSpecModal(t)})).catch((e=>{throw this.isPendingChangeSkuCount=!1,this.skuPurchasePanelComp.closeSpecModal(t),e}))}catch(e){throw this.isPendingChangeSkuCount=!1,this.skuPurchasePanelComp.closeSpecModal(t),e}}onTapBuyNow(t){return C(this,null,(function*(){try{const{subChannel:e="",liveRoomNum:u=""}=this.skuPurchasePanelComp.commonData.originalOptions;this.panelType===O.SkuPurchasePanelType.ADD_TO_CART&&(yield this.operateCart({cartOpType:"INCREASE",createTempCart:!0,showSuccessToast:!1,customOpTargets:{count:this.skuPurchasePanelComp.data.currentSkuCount},customUseVirtualCart:!0},t)),b.$router.goto("igrocery://www.grocery.com/submit_order",{cartOpSource:"buyNow",tempCartId:this.skuPurchasePanelComp.commonData.tempCartId,subChannel:e,liveRoomNum:u,trafficSource:this.skuPurchasePanelComp.commonData.originalOptions.trafficSource}),this.skuPurchasePanelComp.closeSpecModal(t)}catch(e){throw this.skuPurchasePanelComp.closeSpecModal(t),e}}))}onTapStockRemind(t){return C(this,null,(function*(){const t=this.skuPurchasePanelComp.data.currentSku.subStatus,e={skuId:this.skuPurchasePanelComp.commonData.selectedSkuId||"",major:T.SUBSCRIBE_MAJOR_TYPE.MAJOR,op:t?T.SKU_ARRIVE_SUBSCRIBE_STATUS.UNSUBSCRIBE:T.SKU_ARRIVE_SUBSCRIBE_STATUS.SUBSCRIBE},u=[D(e.skuId,e.major,e.op)];let a;this.getSubSubscribeRequest(u),t?(a=yield R(u),a.success===T.SUBSCRIBE_REQUEST_STATUS.SUCCESS&&a.status===T.SUBSCRIBE_STATUS.UNSUBSCRIBED&&this.skuPurchasePanelComp.setData({"operatorButton.text":"到货提醒","currentSku.subStatus":!1})):(a=yield B(u),a.success===T.SUBSCRIBE_REQUEST_STATUS.SUCCESS&&a.status===T.SUBSCRIBE_STATUS.SUBSCRIBED&&this.skuPurchasePanelComp.setData({"operatorButton.text":"取消提醒","currentSku.subStatus":!0}))}))}onTapSkuTakeOn(t){return C(this,null,(function*(){const e={skuId:this.skuPurchasePanelComp.commonData.selectedSkuId||"",major:T.SUBSCRIBE_MAJOR_TYPE.MAJOR,op:t===O.OperatorButtonStatus.TAKE_ON_UNSUBSCRIBE?T.TAKE_ON_SUBSCRIBE_STATUS.SUBSCRIBE:T.TAKE_ON_SUBSCRIBE_STATUS.UNSUBSCRIBE},u=[U(e.skuId,e.major,e.op)];let a;switch(this.getSubSubscribeRequest(u),t){case O.OperatorButtonStatus.TAKE_ON_UNSUBSCRIBE:a=yield B(u),a.success===T.SUBSCRIBE_REQUEST_STATUS.SUCCESS&&a.status===T.SUBSCRIBE_STATUS.SUBSCRIBED&&this.skuPurchasePanelComp.setData({"operatorButton.text":"取消提醒","operatorButton.status":O.OperatorButtonStatus.TAKE_ON_SUBSCRIBE});break;case O.OperatorButtonStatus.TAKE_ON_SUBSCRIBE:a=yield R(u),a.success===T.SUBSCRIBE_REQUEST_STATUS.SUCCESS&&a.status===T.SUBSCRIBE_STATUS.UNSUBSCRIBED&&this.skuPurchasePanelComp.setData({"operatorButton.text":"上架提醒","operatorButton.status":O.OperatorButtonStatus.TAKE_ON_UNSUBSCRIBE})}}))}resetSpecData(){const t=this.skuPurchasePanelComp.data.skuSpecRadioGroups.map((t=>S(p({},t),{radioList:t.radioList.map((t=>S(p({},t),{enabled:!0})))})));this.skuPurchasePanelComp.setData({skuSpecRadioGroups:t,selectedSkuSpecList:[]})}closeSpecModal(){this.skuPurchasePanelComp.setData({showSkuPurchasePanel:!1,operatorButtonStyle:"",operatorButton:null,spuData:{},isSpuCard:!1,currentSku:{},skuSpecRadioGroups:[],currentSkuCount:null,buyStep:null,maxNum:null,minNum:null,selectedSkuSpecList:[],recommendModuleTitle:"",recommendSkuList:[]}),this.skuPurchasePanelComp.resetCommonData()}onAddToCartCompletely(){this.isPendingChangeSkuCount=!0,this.updateCurrentSkuAddCartCount().then((()=>{this.isPendingChangeSkuCount=!1})).catch((t=>{this.isPendingChangeSkuCount=!1}))}onChangeSkuCount(t){return C(this,null,(function*(){const{type:e}=t.currentTarget.dataset,{isButtonDisable:u,count:a}=this.calcCountValidity(e);if(!this.isPendingChangeSkuCount)return e===O.ChangeSkuCountType.ADD&&u?(this.skuPurchasePanelComp.setData({addCountAvailable:!1,subTractCountAvailable:!0,currentSkuCount:a}),void b.page().toast("已达到最大可购买数量")):void(e===O.ChangeSkuCountType.SUBTRACT&&u?this.skuPurchasePanelComp.setData({subTractCountAvailable:!1,addCountAvailable:!0,currentSkuCount:a}):this.panelType===O.SkuPurchasePanelType.ADD_TO_CART?this.skuPurchasePanelComp.setData({currentSkuCount:a,subTractCountAvailable:a>0,addCountAvailable:!u}):yield this.onEditCountButton(t))}))}onEditCountButton(t){return C(this,null,(function*(){try{this.isPendingChangeSkuCount=!0;const{type:e}=t.currentTarget.dataset,u=e===O.ChangeSkuCountType.ADD?{cartOpType:"INCREASE",showSuccessToast:!1}:{cartOpType:"DECREASE",customOpTargets:{productId:this.skuPurchasePanelComp.commonData.productId||""}};yield this.operateCart(u,t),yield this.updateCurrentSkuAddCartCount(),this.isPendingChangeSkuCount=!1}catch(t){throw this.isPendingChangeSkuCount=!1,t}}))}initSkuSpecChoicesData(t){return C(this,null,(function*(){try{const e=yield(0,g.getSkuChoicesData)(t),u=E(e)?e:null;if(!u)return;yield this.renderSkuSpecChoicesData(u),this.isPendingChangeSkuCount=!0,yield this.skuPurchasePanelComp.skuPurchasePanelLxReport.setSkuLxParams(e.logInfoVO,e.M_TraceId),this.skuPurchasePanelComp.skuPurchasePanelLxReport.onSkuMvReport();const a=this.calcBuyStep(u.skuLiteVO);if(this.panelType===O.SkuPurchasePanelType.PURCHASE_NOW)yield this.operateCart({cartOpType:"INCREASE",createTempCart:!0,customOpTargets:{count:a},showSuccessToast:!1}),yield this.updateCurrentSkuAddCartCount();else{const{minNum:t=1,maxNum:e=999}=this.skuPurchasePanelComp.commonData;this.skuPurchasePanelComp.setData({currentSkuCount:a,subTractCountAvailable:a>t,addCountAvailable:e>a})}this.isPendingChangeSkuCount=!1}catch(t){throw this.isPendingChangeSkuCount=!1,k.log.warn(`<skuPurchasePanel initSkuSpecChoicesData> 获取商品多规格数据出错，error：${t.message}`),t}}))}renderSkuSpecChoicesData(t){var e,u,a,s,o;const n=!!(null==(e=t.skuLiteVO)?void 0:e.soldOutUrl),r=+(null==(u=t.skuLiteVO)?void 0:u.maxNum)>0?parseFloat(parseFloat(null==(a=t.skuLiteVO)?void 0:a.maxNum).toFixed(3)):999,i=(null==(s=t.skuLiteVO)?void 0:s.minNum)?parseFloat(parseFloat(null==(o=t.skuLiteVO)?void 0:o.minNum).toFixed(3)):1;return new Promise((e=>{var u,a;this.skuPurchasePanelComp.setData({spuData:t.spuLiteVO||this.skuPurchasePanelComp.data.spuData||{},currentSku:t.skuLiteVO||{},isSpuCard:!(null==(u=t.skuLiteVO)?void 0:u.skuId),skuSpecRadioGroups:t.skuSpecRadioGroups||[],operatorButton:this.convertOperatorButton(null==(a=t.skuLiteVO)?void 0:a.buttonList[0]),selectedSkuSpecList:(0,y.getSelectedSkuSpecList)(t.skuSpecRadioGroups)},(()=>{var u,a,s,o;this.skuPurchasePanelComp.commonData=S(p({},this.skuPurchasePanelComp.commonData),{productId:null==(u=t.spuLiteVO)?void 0:u.productId,selectedSkuId:(null==(a=t.skuLiteVO)?void 0:a.skuId)||null,buyStep:parseInt(null==(s=t.skuLiteVO)?void 0:s.buyStep,10)||1,loose:(null==(o=t.skuLiteVO)?void 0:o.loose)||!1,maxNum:n?0:r,minNum:n?1:i}),e()}))}))}renderAfterSelectRadio(t,e=null,u=null){return new Promise((e=>{var u,a,s,o,n,r;if(t.skuLiteVO){const i=!!(null==(u=t.skuLiteVO)?void 0:u.soldOutUrl),c=+(null==(a=t.skuLiteVO)?void 0:a.maxNum)>0?parseFloat(parseFloat(null==(s=t.skuLiteVO)?void 0:s.maxNum).toFixed(3)):999,l=(null==(o=t.skuLiteVO)?void 0:o.minNum)?parseFloat(parseFloat(null==(n=t.skuLiteVO)?void 0:n.minNum).toFixed(3)):1;this.skuPurchasePanelComp.setData({currentSku:t.skuLiteVO,isSpuCard:!1,skuSpecRadioGroups:t.skuSpecRadioGroups||[],selectedSkuSpecList:(0,y.getSelectedSkuSpecList)(t.skuSpecRadioGroups),operatorButton:this.convertOperatorButton(null==(r=t.skuLiteVO)?void 0:r.buttonList[0]),currentSkuCount:1,subTractCountAvailable:!i&&l<1,addCountAvailable:!i&&c>1},(()=>{var u,a,s;this.skuPurchasePanelComp.commonData=S(p({},this.skuPurchasePanelComp.commonData),{selectedSkuId:(null==(u=t.skuLiteVO)?void 0:u.skuId)||null,buyStep:parseInt(null==(a=t.skuLiteVO)?void 0:a.buyStep,10)||1,loose:(null==(s=t.skuLiteVO)?void 0:s.loose)||!1,maxNum:i?0:c,minNum:i?1:l}),e()}))}else this.skuPurchasePanelComp.setData({isSpuCard:!0,skuSpecRadioGroups:t.skuSpecRadioGroups||[],selectedSkuSpecList:(0,y.getSelectedSkuSpecList)(t.skuSpecRadioGroups),currentSkuCount:1,subTractCountAvailable:!1,"operatorButton.enable":!1,"operatorButton.text":this.panelType===O.SkuPurchasePanelType.ADD_TO_CART?"加入购物车":"立即购买"},(()=>{e()}))}))}updateCurrentSkuAddCartCount(){return new Promise((t=>{const{minNum:e=1,maxNum:u=999,selectedSkuId:a}=this.skuPurchasePanelComp.commonData,s=parseInt(b.$cart.virtualSkuRealQtyList[a||""],10)||0;this.skuPurchasePanelComp.setData({currentSkuCount:s,subTractCountAvailable:s-e>0,addCountAvailable:u-s>0},(()=>{t()}))}))}operateCart({cartOpType:t,createTempCart:e=!1,showSuccessToast:u=!0,customOpTargets:a={},customOpCartParams:s={},customUseVirtualCart:o=!1},n){const r=this.panelType===O.SkuPurchasePanelType.PURCHASE_NOW||o;let i;return i=p(r?{cartOpSource:"BUYNOW",cartOpType:t,opTarget:{opTargets:[p({skuId:this.skuPurchasePanelComp.commonData.selectedSkuId},a)]},tempCartId:this.skuPurchasePanelComp.commonData.tempCartId,needAnimation:!1,createTempCart:e,showSuccessToast:u}:{cartOpSource:"ITEMLIST",cartOpType:t,needAnimation:!1,opTarget:{opTargets:[p({skuId:this.skuPurchasePanelComp.commonData.selectedSkuId},a)]},showSuccessToast:u},s),b.$cart.operateCart(i,n)}calcCountValidity(t){const{buyStep:e,maxNum:u,minNum:a}=this.skuPurchasePanelComp.commonData,s=this.skuPurchasePanelComp.data.currentSkuCount||1;if(t===O.ChangeSkuCountType.ADD){let t=s+e;return u&&t>=u&&(t=u),{count:t,isButtonDisable:u&&t>u}}if(t===O.ChangeSkuCountType.SUBTRACT){let t=s-e;return a&&t<=a&&(t=a),{count:t,isButtonDisable:a&&t<a}}}convertOperatorButton(t){if(!t)return;const e=p({},t);let u="noraml-button-style";if(t.status===O.OperatorButtonStatus.ADD_CART||t.status===O.OperatorButtonStatus.PURCHASE_NOW){const t=this.panelType===O.SkuPurchasePanelType.ADD_TO_CART;e.status=t?O.OperatorButtonStatus.ADD_CART:O.OperatorButtonStatus.PURCHASE_NOW,e.text=t?"加入购物车":"立即购买"}switch((0,P.isMT)()&&t.status===O.OperatorButtonStatus.STOCK_REMIND&&(e.enable=!1,e.text="抢光了"),!(0,P.isMTChannel)()||t.status!==O.OperatorButtonStatus.TAKE_ON_SUBSCRIBE&&t.status!==O.OperatorButtonStatus.TAKE_ON_UNSUBSCRIBE||(e.enable=!1,e.text="已下架"),e.status){case O.OperatorButtonStatus.STOCK_REMIND:case O.OperatorButtonStatus.TAKE_ON_SUBSCRIBE:case O.OperatorButtonStatus.TAKE_ON_UNSUBSCRIBE:case O.OperatorButtonStatus.ORDER_NOW:u=`${u} subscribe-button-style`;break;case O.OperatorButtonStatus.PURCHASE_NOW:u=`${u} purchase-now-style`}return e.styleId=`${u} ${e.enable?"":"unsale"}`,e}getSubSubscribeRequest(t){const e=A(T.SUBSCRIBE_MAJOR_TYPE.NOT_MAJOR);t.push(e);const u=I(this.skuPurchasePanelComp.commonData.selectedSkuId||"",T.SUBSCRIBE_MAJOR_TYPE.NOT_MAJOR);(0,P.isWX)()&&t.push(u)}calcBuyStep(t){const e=parseInt(t.buyStep,10)||1;return t.loose||!1?e:1}};