var e,t=Object.create,r=Object.defineProperty,s=Object.defineProperties,a=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertyNames,o=Object.getOwnPropertySymbols,u=Object.getPrototypeOf,c=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,l=(e,t,s)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,g=(e,t)=>{for(var r in t||(t={}))c.call(t,r)&&l(e,r,t[r]);if(o)for(var r of o(t))p.call(t,r)&&l(e,r,t[r]);return e},d=e=>{return((e,t,s)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let i of n(t))c.call(e,i)||"default"===i||r(e,i,{get:()=>t[i],enumerable:!(s=a(t,i))||s.enumerable});return e})((s=r(null!=e?t(u(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0}),r(s,"__esModule",{value:!0})),e);var s},m=(e,t,r)=>new Promise(((s,a)=>{var i=e=>{try{o(r.next(e))}catch(e){a(e)}},n=e=>{try{o(r.throw(e))}catch(e){a(e)}},o=e=>e.done?s(e.value):Promise.resolve(e.value).then(i,n);o((r=r.apply(e,t)).next())})),b=d(require("./ob.js")),y=d(require("./u3.js")),{isMMP:f,isWXMT:v,isTT:w}=require("./u8.js"),{wx2promiseify:h}=require("./gi.js"),{CAT_SEC_CATEGORY:A}=require("./iu.js"),O={skuArrive:"J2fIXvzvpWTJZcRKt-5xHUn6Ap9YxMkullKWHlUBnvA",seckill:"GZRASxJ0x9zNbORnOniOwvn1Gdm17uG5tpbeLdqU0uA",pickUp:"4pSoH2puKgBcabsWUb6XUl_zYUCbXac5H1PK0tQ4XNc",groupFail:"HQnAMTAb0DA80shf7p1sQXIK9nihIFqQHuP91XV0i5U",groupSuccess:"LjAVIsQKus4YJ0sD2RtCQ9srIVNOmEwKGrnj_pH61Gc",seckillActivity:"hGeRh0-iEcHqnienayTAGxhjYer5BPjZyRuseWQDHlA",takeOn:"b3YHqbdgdLR4yJaNT8QLTVlT-ltsknaBQoR2_62gYKE",refund:"3L4kmDTbkeKfMkQEWciP9JaGJMB52-JBYIFA6KYjH_8",inviteActivity:"joJA96tMWOZkFq1yPKBztdHo1SwpF4aDhGgvcSpBFq8",inviteGetReward:"H2H1Wj7xsL-Fk-ey9SM8cqGzOSo80UXAmli8peL9JLk",bargainSuccess:"P2qLQFlOrZPGmtWid-vSzsumh31XHRTfy_YCGFttd18",rewardWillOutdate:"cOuS9q-2QFGwImTsZADe-V5EMV1IW9sMZL3kPgSUeNo",receiveReward:"NrGIlQro2CyGXATVkMeLqI02dFUWG43KFC_6V-BJOwQ",bargainProgressOneHour:"JEu9dA9JPZ2jVqwT31RWN7zQgMU4loyps_b4o4oou9w",bargainProgressFirstFriend:"daTfvNZaP-6aUONKLQN2V2ap2nl53jp5HXw4ZgJXf7E",couponReceipted:"ViDzSx5HeYDZJr9qAG_sHXgf7oeiis1bFQK1ILwD6xo",couponExpiration:"saY6emZrcujCQ-zyJOYbqMLdg8aUjI8IZO97Aq-7Yj4",couponExpire:"saY6emZrcujCQ-zyJOYbqMLdg8aUjI8IZO97Aq-7Yj4",couponRecovery:"6a4FS9AWLgJFkOIkCWMCIGd15kWD31Tw8c85tQym0zA",freeOrder:"zUqjVTvoPoJMiw-P8tKmQmhhMOMc3X7w_a9xrpIuco4",dailyProgress:"odyzHAHg-zB1kZuZfJgq2ZRAvCP6tVn6h3y3l2DDwU0",dailyReward:"H2H1Wj7xsL-Fk-ey9SM8cqGzOSo80UXAmli8peL9JLk",redPacketProgress:"odyzHAHg-zB1kZuZfJgq2ZRAvCP6tVn6h3y3l2DDwU0",redPacketReward:"VWeZLxdlC2g1SRffQShY1ZYeK9ECVT1fJVRneLkjmR0",shake:"gRjP4ClmerR-lduiOmWOOmfPwcJ7lTDm7pziGQJTCYk",delivery:"nfEvrTWKih1ms7J2CBg5J-tJibj_WyPnPKtDsUvxlWM",arrived:"KkDYb98Z-ZP0m2SnhOOUM4wnW5njz1BRahIxWdYKrhw",earningCenterSignIn:"PGUmxBqAM8a5CwLbNfNhJV5kZW-Ury9kPRy4A16Tlm4",earningCenterActProcess:"odyzHAHg-zB1kZuZfJgq2XjxQ6FJxQrKewlwXsZWWmQ",collected:"R1FsPVsImDeAtAT1DkMA2OIxD3PumGt1mt0zKHxZSzQ",redPacketExpired:"-tfogaopbYRHgPi2EoL3bmd6fe6V3zZxTsb5gf8WIn4",chickFeed:"O2s2PR-OVDkxGvLrtJqzHfTmQqnB68KbewmeMkkm1BQ",chickOutdated:"xri-G5ogUREu-ThuC__u8ocv7rCukn8YsOBBJuWGVZM",chickReward:"zmOZj1TQp47pB2ICRTK8ElUkBnC00tE1ddvgZpvfqEg",inviteProgress:"odyzHAHg-zB1kZuZfJgq2ZRAvCP6tVn6h3y3l2DDwU0",inviteStart:"gRjP4ClmerR-lduiOmWOOmfPwcJ7lTDm7pziGQJTCYk",membershipCouponReward:"A37mz2IK6g1MFd1TlUPb_yg9OFMhIDZsvb32_NanmCg",membershipCouponReward2:"_wvgc0NFE48coGLmKyedOXgrwq_xu1CWpaoI7_vl8to",membershipCouponReward3:"mqwIqlrecM7f1OoXo_k1jOOggO9mVK0YtABeJ6-ENNw",membershipRenew:"i5JbuuUVcttYb7ESP2Wy9QotjatcTFGYhRwLQkx2GhU",membershipRenewExpire:"mqwIqlrecM7f1OoXo_k1jKgi5BX2aN7pRu8T6cOoPVw",dailyDiscount:"A37mz2IK6g1MFd1TlUPb_yg9OFMhIDZsvb32_NanmCg",dailyDiscount2:"saY6emZrcujCQ-zyJOYbqMLdg8aUjI8IZO97Aq-7Yj4",dailyDiscount3:"odyzHAHg-zB1kZuZfJgq2ZRAvCP6tVn6h3y3l2DDwU0",waitPay:"FVTpgvfaiEcDjWJ6a1WQmYCGkCBH_6W1M4bPm_2gaPM",inviteWithdrawExpired:"1YR_2Mn_mtAG3oG8CDA6WnRjSfBMivdot2QRMjuITKg",depreciate:"ahZh5EG421YmkhLVNdvI2HHvgEWMHQ6X-GMVkcKiE9g",wishProduct:"rWoV13PSnHEWTSnh8FDd25BiDSjBeHlsmUXvKbfBubc"},k={};e={skuArrive:"MSG12446826c2a62dc742375c5b9dd902e1c612fb115755",seckill:"MSG1244682f48b9b550a4f97197f7636f9628feae415749",couponExpire:"MSG12446821945750fc96dc99b67c845920a4914b815756"};var P={skuArrive:1,seckill:3,pickUp:5,seckillActivity:4,takeOn:2,refund:6,inviteActivity:7,inviteGetReward:8,bargainSuccess:9,rewardWillOutdate:10,receiveReward:11,bargainProgressOneHour:12,bargainProgressFirstFriend:13,couponReceipted:14,couponExpiration:15,couponExpire:5,couponRecovery:16,freeOrder:17,redPacketProgress:18,redPacketReward:19,shake:20,depreciate:21},T={skuArrive:"https://p0.meituan.net/mallimages/05f7c5741f2969d7fb855028e8184d33151716.png",seckill:"https://p1.meituan.net/mallimages/a099699eaad425d2a4e7201cf9708b37152266.png",seckillActivity:"https://p1.meituan.net/mallimages/dac1822cffa411559fd355ae127a7ce3153181.png",takeOn:"https://p0.meituan.net/mallimages/f2a65000a36a8fed9ae23485b3dbf5c1150659.png",refund:"https://p1.meituan.net/mallimages/b4096daf232c9cd975c009bf0e225812152846.png",dailyReward:"https://p1.meituan.net/groceryimages/1481b21940f86b1a55766bb9e5b9ea4d14444.png",dailyProgress:"https://p1.meituan.net/groceryimages/1481b21940f86b1a55766bb9e5b9ea4d14444.png"},S=()=>{const t=getApp();return g(g(g({},v()?k:O),w()?e:{}),t.$config.getByBiz("subscribeTmplIds")||{})},M=(e="")=>{if(e){return S()[e]||""}return""},C=({withSubscriptions:e=!0}={})=>h(wx.openSetting,{withSubscriptions:e}).then((e=>e)).catch((e=>{b.log.error("wx.openSetting打开授权页失败",e)})),x=({withSubscriptions:e=!0}={})=>h(wx.getSetting,{withSubscriptions:e}).then((e=>e)).catch((e=>{b.log.error("wx.getSetting获取授权设置失败",e)})),R=(e,t)=>{"function"==typeof getApp().page().popupSubscribeGuide&&getApp().page().popupSubscribeGuide({show:e,subscribeGuideGif:t})},I=(e=[],t="")=>{const r=S(),s=(()=>{const e=getApp().$systemInfo,t=e.getSystemInfo("version"),r=e.getSystemInfo("SDKVersion");return f()||!wx.requestSubscribeMessage||(0,y.default)(r,"2.10.1")<0?0:w()||!wx.requestSubscribeMessage?(0,y.default)(r,"1.73.0")>=0?3:0:(0,y.default)(t,e.isIOS()?"7.0.6":"7.0.7")>=0?3:1})();return new Promise(((a,i)=>m(void 0,null,(function*(){if(!getApp().isLogin())return i({errMsg:"请先登录",errCode:"99999",errData:{tmplTypes:e}}),void(yield getApp().$login.login());if(0===s)return void i({errMsg:`当前${f()?"App":"微信"}版本过低，不支持订阅，请升级${f()?"App":"微信"}`,errCode:"99998",errData:{tmplTypes:e}});if(!e.length||!Object.keys(r).length)return void i({errMsg:"缺少模板id",errCode:"99997",errData:{tmplTypes:e,subscribeTmplIds:r}});const n=e.map(((e,t)=>({type:e,index:t,tmplId:r[e]||"",status:"reject"}))),o=n.slice(0,s).map((e=>e.tmplId))||[];if(!o.length)return void i({errMsg:"缺少模板id",errCode:"99997",errData:{tmplTypes:e,subscribeTmplIds:r}});const u=!w()&&(yield x())||{},{subscriptionsSetting:{mainSwitch:c=!0,itemSettings:p={}}={}}=u;if(b.log.warn("订阅授权!!!",u),!c)return i({errMsg:"用户未授权订阅权限，需去授权页打开权限",errCode:"99996",errData:{tmplTypes:e,subscribeTmplIds:r}}),b.log.warn("打开授权页"),void(yield C());let l=!0;if(Object.keys(p).length){let t=0,s=0;if(o.map((e=>{if(p[e])switch(s++,p[e]){case"accept":default:break;case"reject":t++;break;case"ban":getApp().$cat.reportError(A.SUBSCRIBE_BAN(`请注意，meituanyouxuan订阅模板【${p[e]}】已被微信后台封禁`)),t++}})),s===o.length&&(l=!1),t===o.length)return b.log.warn("全部模板被禁止!!!，打开授权页",o),i({errMsg:"用户未授权订阅权限，需去授权页打开权限",errCode:"99996",errData:{tmplTypes:e,subscribeTmplIds:r}}),void(yield C())}try{l&&t&&R(!0,t);const r=yield h(wx.requestSubscribeMessage,{tmplIds:o});l&&t&&R(!1);let s=!0;o.map(((e,t)=>{r&&r[e]&&"accept"===r[e]&&(s=!1,n[t].status="resolve")})),b.log.info("订阅消息发送：",{tmplTypes:e,tmplIds:o},w()?"抖音返回值是：":"微信返回值是：",r,"结果是：",n),s?i({errMsg:"用户拒绝订阅全部消息，请确认",errCode:"99995",errData:{data2:n,data:r}}):a({data:n,isShowConfirm:l})}catch(t){R(!1);const s={1001:"订阅失败，请稍后重试",1002:"订阅失败，请稍后重试",1003:"订阅消息超过上限，不能订阅了哦~",1004:"订阅失败，请稍后重试",1005:"订阅失败，请稍后重试",2001:"订阅失败，请稍后重试",4002:"订阅失败，请稍后重试",4004:"当前抖音版本过低，不支持订阅，请升级抖音",90001:"订阅失败，请稍后重试"},a={10001:"订阅失败，请稍后重试",10002:"订阅失败，请稍后重试",10003:"订阅失败，请稍后重试",10004:"订阅失败，请稍后重试",10005:"订阅失败，请稍后重试",20001:"订阅失败，请稍后重试",20002:"订阅失败，请稍后重试",20003:"订阅消息超过上限，不能订阅了哦~",20004:"订阅失败，请稍后重试",20005:"当前微信版本过低，不支持订阅，请升级微信",90001:"订阅失败，请稍后重试"};(20005===(null==t?void 0:t.errCode)||4004===(null==t?void 0:t.errCode)&&w())&&getApp().$cat.reportError(A.SUBSCRIBE_BAN("请注意，【meituanyouxuan】小程序已被封禁"));const n=w()?s[t&&t.errCode||90001]:a[t&&t.errCode||90001];i({errMsg:n,errCode:"99994",errData:{data:t,tmplTypes:e,subscribeTmplIds:r}})}}))))};function j(e){return e.map((e=>{return t=g({},e),r={subType:P[e.subType]},s(t,i(r));var t,r}))}module.exports={subscribe:I,subscribeAll:function(e){let t;return t=function(e){return m(this,null,(function*(){var t,r,s,a,i,n;try{const r=e.map((e=>e.subType)),s=function(e){var t;return T[(null==(t=e.filter((e=>1===e.major))[0])?void 0:t.subType)||""]||""}(e),a=yield I(r,s),i=function(e,t){const r=t.data.filter((e=>"resolve"===e.status)).map((e=>e.type));return e.filter((e=>r.some((t=>t===e.subType))))}(e,a),n=yield getApp().$service.subscribeAll(j(i));return null==(t=getApp().page())||t.toast(n.message),0===n.success&&1===n.status&&getApp().$lxLog.mc("b_youxuan_ixgkinh3_mc",{}),n}catch(e){const t={success:1,status:4,message:""};switch(e.errCode){case"99994":return null==(r=getApp().page())||r.toast(e.errMsg),t.message=e.errMsg,t;case"99995":return null==(s=getApp().page())||s.toast("订阅提醒，需允许消息通知哦"),t.message="订阅提醒，需允许消息通知哦",t;case"99996":case"99999":return t;case"99997":return null==(a=getApp().page())||a.toast("订阅失败，请稍后重试"),t.message="订阅失败，请稍后重试",t;case"99998":return null==(i=getApp().page())||i.toast("当前微信版本过低，不支持订阅，请升级微信"),t.message="当前微信版本过低，不支持订阅，请升级微信",t;default:return null==(n=getApp().page())||n.toast("订阅失败，请稍后重试"),t.message="订阅失败，请稍后重试",t}}}))}(e),t},unsubscribeAll:function(e){return m(this,null,(function*(){var t,r;try{const r=yield getApp().$service.subscribeAll(j(e));return null==(t=getApp().page())||t.toast(r.message),r}catch(e){return null==(r=getApp().page())||r.toast("网络异常，请重试"),{success:1,status:2,message:"网络异常，请重试"}}}))},getTmplIdByType:M,isChooseKeep:function(e=[]){let t=!1,r=0;return x().then((s=>{const{subscriptionsSetting:a}=s||{},{itemSettings:i={}}=a||{};return e.map((e=>{i[M(e)]&&r++})),r===e.length&&(t=!0),t})).catch((t=>(b.log.warn(`检查传入的订阅模板是否都勾选了“保持以上选择” 失败，订阅模板为${e.join(", ")}`),!1)))}};