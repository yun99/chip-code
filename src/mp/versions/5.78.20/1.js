var e=Object.create,t=Object.defineProperty,s=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,a=Object.getOwnPropertySymbols,r=Object.getPrototypeOf,n=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,l=(e,s,i)=>s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i,o=(e,t)=>{for(var s in t||(t={}))n.call(t,s)&&l(e,s,t[s]);if(a)for(var s of a(t))u.call(t,s)&&l(e,s,t[s]);return e},d=a=>{return((e,a,r)=>{if(a&&"object"==typeof a||"function"==typeof a)for(let u of i(a))n.call(e,u)||"default"===u||t(e,u,{get:()=>a[u],enumerable:!(r=s(a,u))||r.enumerable});return e})((u=t(null!=a?e(r(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0}),t(u,"__esModule",{value:!0})),a);var u},p=d(require("./jc.js")),g=d(require("./ob.js")),c=d(require("./u5.js")),m=d(require("./is.js")),h=d(require("./a8.js")),y=d(require("./mz.js")),f=d(require("./lz.js")),k=d(require("./f8.js")),v=d(require("./sv.js")),S=d(require("./mm.js")),b=d(require("./m1.js")),I=d(require("./sx.js")),L=d(require("./sb.js")),x=d(require("./sc.js")),_=getApp(),{parseStyle:E}=(_.$config.get("indexGuesslikeMaxSkuIdsNum"),require("./a4.js")),{getGlobalRequestId:D}=require("./p0.js");(0,p.defineComponent)(new class{constructor(){this.created=function(){this.resetState(),this.previousExList=[]},this.ready=function(){this.globalRequestId=D(null==_?void 0:_.$poiId),h.default.registerLxOperator(h.ListTypes.ttLandingPageGuesslike,{operator:(e,t)=>(Object.assign(e,{tab_name:"热卖",module_type:L.sceneTypes.DEFAULT,requestid:this.data.requestId||"-999",list_id:"",global_request_id:this.globalRequestId||"",activity_page_id:this.data.landingPageId,tab_index_id:"-999"}),e),cid:v.bidMap.pageCid,[h.LxEventTypes.CardClick]:v.bidMap.guessLikeCardClick,[h.LxEventTypes.CardView]:v.bidMap.guessLikeCardView,[h.LxEventTypes.AddCartClick]:v.bidMap.guessLikeAddCartMc,[h.LxEventTypes.DecreaseCartClick]:v.bidMap.guessLikeDecreaseCartMc}),h.default.registerLxOperator(h.ListTypes.ttLandingPageSkuArea,{operator:(e,t)=>(Object.assign(e,{tab_name:"",module_type:L.sceneTypes.LIVE,requestid:this.data.requestId||"-999",list_id:"",global_request_id:this.globalRequestId||"",activity_page_id:this.data.landingPageId,tab_index_id:"-999"}),e),cid:v.bidMap.pageCid,[h.LxEventTypes.CardClick]:v.bidMap.liveCardClick,[h.LxEventTypes.CardView]:v.bidMap.liveCardView,[h.LxEventTypes.AddCartClick]:v.bidMap.liveAddCartMc,[h.LxEventTypes.DecreaseCartClick]:v.bidMap.guessLikeDecreaseCartMc})},this.observers={defaultValue(e){this.resetState(),this.reload(e,(()=>{}))}},this.methods={resetState(){this.isRequestEnd=!1,this.isRequestPending=!1,this.listLength=0,this.excludeIdArr=[],this.pagination={offset:0,limit:0,pageNum:1}},convertRpxToPx(e){const t=750/getApp().$systemInfo.systemInfo.windowWidth;return Math.floor(e/t)},reload(e,t){var s;let{itemList:i=[]}=e;try{const e=(null==(s=i[0])?void 0:s.requestid)||this.data.requestId;i=i.map(((t,s)=>(t.canRec=!0,(0,k.skuBoardFormat)({skuItem:t,itemKey:`${t.skuId}_${s}`,type:t.type,requestid:e}))))}catch(e){g.log.error(" <Guess Like> reload err",e,JSON.stringify(i)),i=[]}const a=_.$testStartPoint(),r={list:i||[]};_.$event.emit(_.$event.CONTANTS.INDEX_GUESS_LIKE_RENDER_CACHE,r||{}),this.setData(r,(()=>{this.listLength=i.length,this.initListState(e),a("new_guess_like_first_render"),t&&t()})),g.log.info(` <Guess Like>第一屏长度 ${i.length}`)},initListState(e){e.itemList&&e.itemList.length>0&&(this.filterGuessLikeData(e.itemList),this.pagination=function(e,t){const s=o({},e),i=t;return s.limit=20,s.offset=i,s.pageNum=e.pageNum+1,s}(this.pagination,this.listLength),g.log.info(` <Guess like> offset ${this.pagination.offset} limit ${this.pagination.limit} pageNum ${this.pagination.pageNum}`)),e&&Object.keys(e).length&&e.itemList&&0!==e.itemList.length?this.isRequestEnd=!1:(this.isRequestEnd=!0,this.triggerEvent("GuesssLikeRequestEnd")),this.data.loading&&this.setData({loading:!1})},filterGuessLikeData(e){e.forEach((e=>{1===e.type&&(null==e?void 0:e.skuId)&&this.excludeIdArr.push(e.skuId)})),this.excludeIdArr=Array.from(new Set([...this.excludeIdArr]))},getRenderData({limit:e,complete:t}){var s;if(g.log.info("<guess likeWrapper> getRenderData",this.isRequestPending,this.isRequestEnd),this.isRequestPending||this.isRequestEnd)return this.isRequestEnd&&this.triggerEvent("GuesssLikeRequestEnd"),null;const i=this.excludeIdArr.length?this.excludeIdArr:[],{pageNum:r,offset:l}=this.pagination;this.pagination.limit=e||this.pagination.limit,this.isRequestPending=!0;const{landingPageId:d}=this.data,p={offset:l,limit:this.pagination.limit,pageNum:r,excludeSkuIds:i,poiIdStr:(null==(s=null==_?void 0:_.$poi)?void 0:s.getPoiIdStr())||""};this.data.loading||this.setData({loading:!0});const c=()=>{this.isRequestPending=!1,t&&t()};(0,x.firstTagTime)(x.FirstTarget.ON_SERVICE_API_START),(0,I.getAggregationData)(_.$poiId,d,p).then((e=>{(0,x.firstTagTime)(x.FirstTarget.ON_SERVICE_API_END);const t=e,{banner:s,scenes:i,configSkus:l,feedSkus:d,M_TraceId:p}=t,m=((e,t)=>{var s={};for(var i in e)n.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&a)for(var i of a(e))t.indexOf(i)<0&&u.call(e,i)&&(s[i]=e[i]);return s})(t,["banner","scenes","configSkus","feedSkus","M_TraceId"]);let{list:h}=(0,x.formateData)(i,l,d);this.isExcludeListUnique(this.previousExList,this.excludeIdArr.length?this.excludeIdArr:[]),this.previousExList=this.excludeIdArr.length?[...this.excludeIdArr]:[];try{if(h&&h.length){const{hasDuplication:e=!1,finalList:t}=this.getDuplications(h,this.data.list);e&&(h=t)}}catch(e){g.log.info(`<猜喜监控>,${JSON.stringify(e)}`)}if(h&&h.length>0){const{skuList:e}=(0,b.skuDataFormat)({data:h,requestid:p||"-999",strategy:"",renderedListLength:this.listLength}),t=_.$testStartPoint();this.setData(o({},e),(()=>{t(`new_guess_like_render_${r}`)})),this.listLength+=h.length}this.initListState(o({itemList:h},m)),c()})).catch((e=>{(0,x.firstTagTime)(x.FirstTarget.ON_SERVICE_API_END),g.log.error(`ttLandingPage - 分页接口请求错误, message: ${null==e?void 0:e.message}, poiId: ${_.$poiId}, landPageId: ${pageId}`),this.isRequestEnd=!1,this.data.loading&&this.setData({loading:!1}),c()}))},isExcludeListUnique(e=[],t=[]){var s;const i=[...e].sort(((e,t)=>e-t)),a=[...t].sort(((e,t)=>e-t)),r=JSON.stringify(i),n=JSON.stringify(a),u=_.getModule("user");let l=(null==u?void 0:u.getUserId)&&u.getUserId();if(l=l||"",r===n){const i=JSON.stringify(e);g.log.info(`<--- guess like---\x3e, 热卖下exclude重复 prev: ${i}, current: ${JSON.stringify(t)}`),null==(s=_.$cat)||s.reportCustomMetrics(m.YXReportTarget.GUESSLIKE_DUPLICATION,m.ReportValue.FAILED,{result:`<--- guess like---\x3e, 热卖下exclude重复 prev: ${i},  current: ${JSON.stringify(t)}`,userId:l.toString()})}},getDuplications(e=[],t=[]){const s=[],i=[];let a=[];if(t.length)for(const e of t)1===e.type&&e.skuId&&s.push(e.skuId);const r=_.getModule("user");let n=(null==r?void 0:r.getUserId)&&r.getUserId();if(n=n||"",e.forEach(((e,t)=>{1===e.type&&s.includes(e.skuId)&&i.push({index:t,skuId:e.skuId})})),i.length){g.log.error("<--猜喜重复！！！--\x3e ,",i),_.$cat.reportCustomMetrics(m.YXReportTarget.GUESSSKU_DUPLICATION,m.ReportValue.FAILED,{userId:n.toString(),data:JSON.stringify(i)}),a=[...e];for(let e=i.length-1;e>=0;e--)a.splice(i[e].index,1)}return{hasDuplication:!!i.length,finalList:a}},onMvReport(e){var t;const{__mvHandler:s}=getApp().page(),{list:i=[],activeTabName:a=""}=this.data,{reportType:r="",params:n={},index_id:u=0}=null==(t=e.detail)?void 0:t.lxParams;if("function"==typeof s){if(r&&"skuBoard"===r){if(!i.length)return;const e=i[u];return void c.$lxLog.mv(n.bid,o({index_id:u,module_type:n.moduleType,tab_name:a},e.extraParams))}s(e)}},getExcludeSkuIds(e,t){const s=[];let i=t-1;for(;i>=0&&i>=t-5;){const t=e[i];i--,1===t.type&&s.push(t.skuId)}let a=t+1;for(;a<e.length&&a<=t+5;){const t=e[a];a++,1===t.type&&s.push(t.skuId)}return s.join(",")}},this.options={multipleSlots:!0},this.properties={mvHandler:{type:Function,value:()=>{}},activeSceneType:Number,skuCardProxyData:{type:Object,value:{isNeedShare:!1}},groupHeadProxyData:{type:Object,value:{isNeedShare:!0,shouldGetHighlight:!0}},needShare:{type:Boolean,value:!1},skuType:{type:String,value:h.ListTypes.ttLandingPageGuesslike,observer(e){}},requestId:{type:String,value:"-999"},currentTab:{type:String,value:""},defaultValue:{type:Object,value:{}},isNeedPreLoad:{type:Boolean,value:!1},showGroupHighlightSku:{type:Boolean,value:!0},subjectColumnStrategy:{type:String},shareSkuId:{type:String,value:""},shareProductVO:{type:Object,value:{}},showShareSkuCard:{type:Boolean,value:!1},list:{type:Array,value:[]},activeTabName:{type:String,value:""},landingPageId:{type:String,value:""},isLive:{type:Boolean,value:!1}},this.data={skuSchemaMap:f.SKU_BOARD_TYPE_MAP,guessSchema:S.guessSchema,addCartRecommendSchema:S.addCartRecommendSchema,shareSkuCardSchema:S.shareSkuCardSchema,strategyAschema:S.strategyAschema,showNegativeFeedbackGuide:y.canShowGuide(),tabItemClass:"",tabScrollLeft:0,loading:!1,list:[],activeTabName:"",hasShareSkuCardMargin:!0,hiddenSkuIdList:[]}}});