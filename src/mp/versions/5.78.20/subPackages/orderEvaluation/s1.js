var e=Object.create,t=Object.defineProperty,r=Object.defineProperties,o=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertyNames,s=Object.getOwnPropertySymbols,i=Object.getPrototypeOf,c=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,l=(e,r,o)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[r]=o,u=(e,t)=>{for(var r in t||(t={}))c.call(t,r)&&l(e,r,t[r]);if(s)for(var r of s(t))p.call(t,r)&&l(e,r,t[r]);return e},d=(e,t)=>r(e,a(t)),g=e=>t(e,"__esModule",{value:!0}),m=r=>((e,r,a)=>{if(r&&"object"==typeof r||"function"==typeof r)for(let s of n(r))c.call(e,s)||"default"===s||t(e,s,{get:()=>r[s],enumerable:!(a=o(r,s))||a.enumerable});return e})(g(t(null!=r?e(i(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r),h=(e,t,r)=>new Promise(((o,a)=>{var n=e=>{try{i(r.next(e))}catch(e){a(e)}},s=e=>{try{i(r.throw(e))}catch(e){a(e)}},i=e=>e.done?o(e.value):Promise.resolve(e.value).then(n,s);i((r=r.apply(e,t)).next())}));((e,r)=>{for(var o in g(e),r)t(e,o,{get:r[o],enumerable:!0})})(exports,{default:()=>N});var y=m(require("../../kw.js")),f=m(require("../../u9.js")),O=m(require("../../ob.js")),_=m(require("../../az.js")),P=m(require("../../a0.js")),C=m(require("../../is.js")),x=m(require("../../x0.js")),R=m(require("./ke.js")),T=m(require("./vt.js")),I=(m(require("./vy.js")),m(require("./z4.js"))),S=m(require("./p9.js")),E=m(require("../../f6.js")),D=m(require("./vu.js")),w=m(require("./vi.js")),v=m(require("./he.js")),U={7011:"截单",7012:"禁售",7013:"库存扣减异常"},N=class extends y.default{constructor(e,t){super(e,t),this.servicePhone="4006609966"}destroy(){}static register(e){const t=new N("order",e);return e.getModule("order")?O.log.info("模块$order已经挂载在app上，无需重复挂载"):(e.addModule(t),t.app.$order=t),t}askService(e){wx.makePhoneCall({phoneNumber:e&&e.trim()})}getPoiPhone(e){return this.app.$service.fetchPoiInfo({poiIds:e}).then((e=>{var t,r;return(null==(r=null==(t=null==e?void 0:e.poiInfos)?void 0:t[0])?void 0:r.servicePhone)||this.servicePhone})).catch((e=>{this.app.page().toast(e.message||"获取客服电话失败")}))}gotoEvaluation(e,t,r,o,a){"submit"===e&&this.app.$router.goto(`/subPackages/orderComment/pages/${e}/index`,{orderId:t,orderPoiId:r,poiIdStr_orderPoiId:o,submitOpenSource:a})}gotoRefund(e,t,r,o){this.app.$router.goto(`/subPackages/refund/pages/${e}/index`,{orderId:t,orderPoiId:r,poiIdStr:o})}_gotoMapPageIng(e){this.gotoMapPageFlag=e,this.app.page().loading(e)}gotoMapPage({longitude:e,latitude:t,name:r=""}={}){if(this.gotoMapPageFlag)return;const o=this.app.page();return this._gotoMapPageIng(!0),e&&t?(0,w.isValidChannel)()?(this._gotoMapPageIng(!1),void(0,D.default)({endPoint:{name:r,latitude:+t,longitude:+e}})):void f.default.getWxLocation({refresh:!0}).then((a=>(O.log.info("订单module 获取定位成功",a),(0,I.getSelfLiftBestRouteMode)({longitude:e,latitude:t}).then((o=>{this._gotoMapPageIng(!1),O.log.info("订单module 获取路线模式成功 即将跳转地图页",o),this.app.$router.goto("igrocery://www.grocery.com/road_map",{destLongitude:e,destLatitude:t,destAddress:r,defaultMode:o})})).catch((a=>{this._gotoMapPageIng(!1),o.toast("路线规划失败！"),O.log.error("路线规划失败！",{longitude:e,latitude:t,name:r},a)}))))).catch(((e={})=>{this._gotoMapPageIng(!1),O.log.warn("订单module 获取定位失败",e),o.toast(e.message||"获取定位失败，请检查授权后重试")})):(this._gotoMapPageIng(!1),void o.toast("取货信息异常！"))}cancelRefund(e,t=!0){return new Promise(((r,o)=>{const a=this.app.page();a.confirm({title:"提示",message:"确定取消退款？",ok:()=>{a.loading(!0),S.cancelRefund({orderId:e}).then((()=>{a.loading(!1),a.toast({message:"取消退款成功"}),t&&a.refreshOrder&&a.refreshOrder(e),r()})).catch(((t={})=>{a.loading(!1),a.toast({message:t.message||"取消失败，请稍后重试"}),a.refreshOrder&&a.refreshOrder(e),o()}))}})}))}finishOrder(e){const t=this.app.page();wx.showModal({title:"提示",content:"确定收到商品？",confirmColor:"#FFD100",cancelColor:"#333",success:r=>{r.confirm?(t.loading(!0),S.finishOrder({orderId:e}).then((()=>{t.loading(!1),t.toast({message:"订单完成"}),t.refreshOrder&&t.refreshOrder(e)})).catch((e=>{t.loading(!1),t.toast({message:e.message||"确认收货失败，请稍后重试"})}))):r.cancel}})}payingOrder(e,t,r,o){return h(this,arguments,(function*(e,{successUrl:t,orderPayId:r},o,a){const n=this.app.page();n.loading(!0);const{weChatFingerprint:s,fingerprint:i}=yield(0,_.getCommonFinger)();try{const c={appId:"tt48f03e4dd7c81b7d01",subChannelVersion:wx.requestOrderPayment?2:1},p={orderId:e,openId:this.app.$user.openId,weChatFingerprint:s,fingerprint:i,appId:"tt48f03e4dd7c81b7d01",orderPayId:r},l=yield S.orderPay(c,p);E.pay(l,{options:{successUrl:t||`/${n.route}?${(0,P.stringify)(n.onLoadArgs)}`},success:()=>{n.toast("支付成功"),o(),this.app.$cat.reportCustomMetrics(C.YXReportTarget.ORDER_SECOND_PAY,C.ReportValue.SUCCESS,{page:n.route,type:"success"})},fail:()=>{n.toast({message:"支付失败，请稍后重试"}),a(),this.app.$cat.reportCustomMetrics(C.YXReportTarget.ORDER_SECOND_PAY,C.ReportValue.FAILED,{page:n.route,type:"pay fail"})},cancel:()=>{a(),this.app.$cat.reportCustomMetrics(C.YXReportTarget.ORDER_SECOND_PAY,C.ReportValue.FAILED,{page:n.route,type:"pay cancel"})}}),1!==l.payTokenType&&a(),n.loading(!1)}catch(e){n.loading(!1),n.toast({message:e.message||"支付失败,请稍后重试"}),a(e.message),this.app.$cat.reportCustomMetrics(C.YXReportTarget.ORDER_SECOND_PAY,C.ReportValue.FAILED,{page:n.route,type:e.message||"pay fail"})}}))}payOrder(e,{successUrl:t,from:r,orderGroupOpFlag:o}={}){return new Promise(((a,n)=>h(this,null,(function*(){var s,i,c,p,l,d,g;const m=this.app.page();let h;if(o&&(h=yield this._payOrderGroupOrder(e),!h))return void n();m.loading(!0);const{weChatFingerprint:y,fingerprint:f}=yield(0,_.getCommonFinger)();try{const o=u({appId:"tt48f03e4dd7c81b7d01",subChannelVersion:wx.requestOrderPayment?2:1},null==(i=null==(s=this.app)?void 0:s.$systemInfo)?void 0:i.getLocation()),d={orderId:e,openId:this.app.$user.openId,weChatFingerprint:y,fingerprint:f,appId:"tt48f03e4dd7c81b7d01",orderPayId:h,sdkInfo:(null==(p=null==(c=x.mtpay)?void 0:c.requestFinancePaySDKInfo())?void 0:p.sdkInfo)||void 0},g=yield S.orderPay(o,d),O=(null==(l=((null==g?void 0:g.experiments)||[]).find((e=>"pay_success_page_optimize_group1"===e.groupKey)))?void 0:l.expKey)||"d",_="D"===(null==O?void 0:O.toLocaleUpperCase());E.pay(g,{options:{successUrl:t||`/${m.route}?${(0,P.stringify)(m.onLoadArgs)}`,callbackType:"orderDetail"===r?"navigateBack":"redirectTo"},success:()=>{m.toast("支付成功"),a(_),this.app.$cat.reportCustomMetrics(C.YXReportTarget.ORDER_SECOND_PAY,C.ReportValue.SUCCESS,{page:m.route,type:"success"})},fail:()=>{m.toast({message:"支付失败，请稍后重试"}),n(),this.app.$cat.reportCustomMetrics(C.YXReportTarget.ORDER_SECOND_PAY,C.ReportValue.FAILED,{page:m.route,type:"pay fail"})},cancel:()=>{n(),this.app.$cat.reportCustomMetrics(C.YXReportTarget.ORDER_SECOND_PAY,C.ReportValue.FAILED,{page:m.route,type:"pay cancel"})}}),m.loading(!1)}catch(e){m.loading(!1);const{data:t}=e;t&&t.code&&U[t.code]?(this.app.$lxLog.mv("b_youxuan_kr18isx1_mv",{reason_type:U[t.code]}),m.alert({message:(null==(g=null==(d=t.error)?void 0:d.reason)?void 0:g.title)||"该商品已抢光，已为您取消订单",ok:()=>{this.app.$router.goto("/pages/index/index")}})):m.toast({message:e.message||"支付失败,请稍后重试"}),n(e.message),this.app.$cat.reportCustomMetrics(C.YXReportTarget.ORDER_SECOND_PAY,C.ReportValue.FAILED,{page:m.route,type:e.message||"pay fail"})}}))))}_payOrderGroupOrder(e){return new Promise(((t,r)=>{T.default.show(d(u({},{title:"以下订单一起下单，需要一起支付",confirmText:"立即支付",cancelText:"暂不支付"}),{orderId:e,type:"pay",onConfirm:({orderPayId:e})=>{t(e)},onCancel:()=>{t()}}))}))}toCancelOrderNew(e){return h(this,arguments,(function*(e,{status:t,orderGroupOpFlag:r}={}){return O.log.warn(`<ModulesOrder toCancelOrder> 开始取消普通的订单 ${e}`),r?this._cancelOrderGroupOrderNew(e,t):this._cancelNormalOrderNew(e,t)}))}toCancelOrder(e){return h(this,arguments,(function*(e,{status:t,orderGroupOpFlag:r}={}){return O.log.warn(`<ModulesOrder toCancelOrder> 开始取消普通的订单 ${e}`),r?this._cancelOrderGroupOrder(e,t):this._cancelNormalOrder(e,t)}))}_cancelOrderGroupOrderNew(e,t){return new Promise((r=>{if([0,10].indexOf(t)>-1){const o={title:"以下订单共同提交，需要一起取消",subtitle:"精心挑选的商品就这样放弃了吗？",confirmText:"确认取消",cancelText:"暂不取消"};T.default.show(d(u({},o),{orderId:e,type:"cancel",onConfirm:()=>{if([0,10].indexOf(t)>-1){let t;this.getCancelOrderReason(e).then((o=>h(this,null,(function*(){if(t=o.hitNewLogic,t){const t={orderId:e};try{yield(0,v.closeOrder)(t)}catch(t){this.app.page().refreshOrder(e)}this.app.page().refreshOrder(e)}else this._cancelWithoutReason(e).then((()=>{r(),this.app.page().refreshOrder(e)}))}))))}},onCancel:()=>{r()}}))}}))}_cancelOrderGroupOrder(e,t){return new Promise((r=>{if([0,10].indexOf(t)>-1){const o={title:"以下订单共同提交，需要一起取消",subtitle:"精心挑选的商品就这样放弃了吗？",confirmText:"确认取消",cancelText:"暂不取消"};T.default.show(d(u({},o),{orderId:e,type:"cancel",onConfirm:()=>{[0,10].indexOf(t)>-1&&this._cancelWithoutReason(e).then((()=>{r(),this.app.page().refreshOrder(e)}))},onCancel:()=>{r()}}))}}))}getCancelOrderReason(e){return h(this,null,(function*(){return yield(0,v.getCancelReason)(e)}))}_cancelNormalOrderNew(e,t){return new Promise((r=>{if([0,10].indexOf(t)>-1){let o;O.log.warn(`<ModulesOrder _cancelNormalOrder> 准备弹出取消订单确认弹窗 ${t}`),this.getCancelOrderReason(e).then((a=>{o=a.hitNewLogic,o?(this.app.page().cancelOrderReason(e,t),r(a)):this.app.page().confirm({title:"",customContentStyle:"text-align: center; padding-left: 50rpx; padding-right: 50rpx;",message:"好不容易选好，确定取消订单吗？",textCancel:"取消",textOK:"确定",zIndex:101,cancel:()=>{O.log.warn("<ModulesOrder _cancelNormalOrder> 点击了弹窗取消按钮"),r(a)},ok:()=>{O.log.warn("<ModulesOrder _cancelNormalOrder> 点击了弹窗确认，开始取消订单"),this._cancelWithoutReason(e).then((()=>{r(a),this.app.page().refreshOrder(e)}))}})})).catch((e=>{O.log.error(`获取getCancelOrderReason接口信息失败 ${JSON.stringify(e)}`)}))}else this._cancelWithReason(e)}))}_cancelNormalOrder(e,t){return new Promise((r=>{[0,10].indexOf(t)>-1?(O.log.warn(`<ModulesOrder _cancelNormalOrder> 准备弹出取消订单确认弹窗 ${t}`),this.app.page().confirm({title:"",customContentStyle:"text-align: center; padding-left: 50rpx; padding-right: 50rpx;",message:"好不容易选好，确定取消订单吗？",textCancel:"取消",textOK:"确定",zIndex:101,cancel:()=>{O.log.warn("<ModulesOrder _cancelNormalOrder> 点击了弹窗取消按钮"),r()},ok:()=>{O.log.warn("<ModulesOrder _cancelNormalOrder> 点击了弹窗确认，开始取消订单"),this._cancelWithoutReason(e).then((()=>{r(),this.app.page().refreshOrder(e)}))}})):this._cancelWithReason(e)}))}_cancelWithoutReason(e){const t=this.app.page();return O.log.warn(`<ModulesOrder _cancelWithoutReason> 调用了取消订单接口，订单id为 ${e}`),S.cancelOrder({orderId:e}).then((()=>{t.loading(!1),t.toast("取消成功")})).catch((e=>{t.loading(!1),t.toast(e.message||"取消失败，请稍后重试")}))}_cancelWithReason(e){this.app.$router.goto(`/subPackages/refund/pages/cancel/index?orderId=${e}`)}contactService(e){this.askService(e)}intervalFetchCoupon(e,t,r,o){clearInterval(this.fetchCouponTimer);this.app.$store.getCacheValue("orderCouponShow");return this.fetchCouponTimer}getEncryptedOrderId(e,t=!0){return h(this,null,(function*(){try{const{orderIdEncrypted:r}=yield S.getEncryptedOrderId({orderId:e});return r||(t?e:"")}catch(r){return O.log.warn(`获取加密订单id(${e})接口失败 ${JSON.stringify(r)}`),t?e:""}}))}intervalFetchOrderPaySuccessCoupon(e,t){return O.log.info("开始获取到新人支付成功后比例返弹窗数据"),clearInterval(this.paySuccessCouponTimer),this.paySuccessCouponTimer=setInterval((()=>{this.getOrderPaySuccessCoupon(e,t)}),1500),setTimeout((()=>{clearInterval(this.paySuccessCouponTimer),O.log.warn("未获取到新人支付成功后比例返弹窗数据")}),12e4),this.paySuccessCouponTimer}getOrderPaySuccessCoupon(e,t){return h(this,null,(function*(){try{const r=yield S.getOrderPaySuccessCoupon(e);r&&r.popupMills&&(O.log.info(`获取到新人支付成功后比例返弹窗数据, data.popupMills为${r.popupMills}`),clearInterval(this.paySuccessCouponTimer),-1!==r.popupMills&&t(r))}catch(e){clearInterval(this.paySuccessCouponTimer),O.log.error(`获取到新人支付成功后比例返弹窗数据失败 ${JSON.stringify(e)}`)}}))}getGroupStatus(e=0,t){return d(u({},t),{isSuccess:41===e&&t&&t.groupStatus===R.GROUP_STATUS.GROUPED,isGrouping:41===e&&t&&t.groupStatus!==R.GROUP_STATUS.GROUPED&&t.closeStatus!==R.GROUP_CLOSE_STATUS.CLOSED,isFail:41===e&&t&&t.groupStatus===R.GROUP_STATUS.NOT_GROUPED&&t.closeStatus===R.GROUP_CLOSE_STATUS.CLOSED})}getShareToken(e){return h(this,null,(function*(){try{return(yield S.getShareToken({orderId:e})).token||""}catch(t){return O.log.error(`请求订单 ${e} 的订单分享token失败了！`),""}}))}completeOrder(e,t){const{orderId:r="",poiId:o=""}=e;return new Promise(((e,t)=>{this.app.page().confirm({title:"",customContentStyle:"text-align: center; padding-left: 50rpx; padding-right: 50rpx;",message:"请确认是否提货成功",textCancel:"再想想",textOK:"确定",zIndex:101,cancel:()=>{},ok:()=>{S.completeOrder(r).then((t=>{e(),t&&this.app.page().toast("提货成功")})).catch((e=>{this.app.page().toast(e.message||"确认提货失败，请稍后重试"),t()}))}})}))}refundApplyVerify(e){return h(this,arguments,(function*({reqParams:e,mvBid:t="",lxParams:r={},onTapBtn:o}){try{const a=yield S.refundApplyVerify(e);if(a){const{title:n="",contentText:s="",buttonVOS:i=[]}=a,c=i.length>1?this.app.page().confirm:this.app.page().alert,p={title:n,message:s,customContentStyle:"text-align: center",zIndex:101,textCancel:"",textOK:"",ok:()=>{},cancel:()=>{}},l={[R.REFUND_BUTTON_JUMP_TYPE.NONE]:"",[R.REFUND_BUTTON_JUMP_TYPE.ORDER_DETAIL_PAGE]:"order",[R.REFUND_BUTTON_JUMP_TYPE.ORDER_CANCEL_PAGE]:"order/applyrefund/cancel",[R.REFUND_BUTTON_JUMP_TYPE.REFUND_APPLY_PAGE]:"order/applyrefund/apply",[R.REFUND_BUTTON_JUMP_TYPE.REFUND_DETAIL_PAGE]:"order/applyrefund/detail",[R.REFUND_BUTTON_JUMP_TYPE.PRICE_MATCH_PAGE]:"insuranceDetail"},d=(t="",{buttonText:r="",jumpType:a=1,jumpUrl:i=""})=>()=>{const c=l[a]?`igrocery://www.grocery.com/${l[a]}`:"",p=o({type:t,buttonText:r,jumpType:a,title:n,contentText:s});(i||c)&&this.app.$router.goto(i||c,p||{orderId:e.orderId||""})};return i.sort(((e,t)=>t.index-e.index)).forEach(((e,t)=>{0===t?(p.textOK=e.buttonText,p.ok=d("ok",e)):1===t&&(p.textCancel=e.buttonText,p.cancel=d("cancel",e))})),t&&this.app.$lxLog.mv(t,u({toast_name:p.message,toast_type:p.title},r)),c(p),!1}return!0}catch(e){throw O.log.error("[refundApplyVerify] 退款发起校验失败",e),new Error("退款发起校验失败")}}))}addCart(e){return h(this,arguments,(function*(e,t=[],r=!0){const o=yield this.app.$cart.operateCart({cartOpSource:e,opTarget:{opTargets:t},cartOpType:"INCREASE",showSuccessToast:!1,needAnimation:!1,forceRefresh:!1});if(o){const a={200:"所选商品已加入购物车",400:"所有商品均已抢光",410:"因自提点切换、库存不足等原因，已为您调整商品数量"};[200,410].includes(o.opResult)&&r&&(O.log.info("[addCart] 准备跳转购物车",a[o.opResult],{cartOpSource:e,skus:t}),this.app.$cart.goToCartLanding(null,a[o.opResult]||""))}}))}};