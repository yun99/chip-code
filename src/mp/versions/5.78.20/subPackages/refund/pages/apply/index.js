var e,t,a=Object.create,s=Object.defineProperty,o=Object.defineProperties,n=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertyNames,d=Object.getOwnPropertySymbols,c=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,p=(e,t,a)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,h=(e,t)=>{for(var a in t||(t={}))u.call(t,a)&&p(e,a,t[a]);if(d)for(var a of d(t))l.call(t,a)&&p(e,a,t[a]);return e},f=(e,t)=>o(e,i(t)),R=e=>{return((e,t,a)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let o of r(t))u.call(e,o)||"default"===o||s(e,o,{get:()=>t[o],enumerable:!(a=n(t,o))||a.enumerable});return e})((t=s(null!=e?a(c(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0}),s(t,"__esModule",{value:!0})),e);var t},m=(e,t,a)=>new Promise(((s,o)=>{var n=e=>{try{r(a.next(e))}catch(e){o(e)}},i=e=>{try{r(a.throw(e))}catch(e){o(e)}},r=e=>e.done?s(e.value):Promise.resolve(e.value).then(n,i);r((a=a.apply(e,t)).next())})),y=R(require("../../../../er.js")),g=R(require("../../../../gb.js")),S=R(require("../../../../ob.js")),I=R(require("../../../../p0.js")),P=R(require("../../../../u8.js")),v=R(require("../../../../sz.js")),C=R(require("../../../../sy.js")),k=R(require("../../../../sn.js")),T=R(require("../../g9.js")),x=R(require("../../gn.js")),b=R(require("../../p9.js")),_=R(require("../../gx.js")),D=R(require("../../g2.js")),w=R(require("../../g1.js")),L=R(require("../../gm.js")),O=R(require("../../g4.js")),A=R(require("../../g3.js")),E=R(require("../../ah.js")),N=getApp(),F=-1;(0,y.default)({$service:N.$service,data:{zeroCompensation:"2",aftersaleType:null,compensationMsg:{amountCent:0,couponType:"",couponTypeDesc:"",couponName:""},stackId:0,orderId:0,showRefundRatioPopup:!1,retrievalTip:"",stackSkuInfo:{},totalPrice:0,maxRefundPrice:0,isIpx:null==(t=null==(e=N.getModule("systemInfo"))?void 0:e.getSystemInfo())?void 0:t.isIpx,refundTargetAccountDesc:"",orderReverseReasons:[],selectedFirstReason:{},selectedSecondReason:{},tempSelectedFirstReason:{},tempSelectedSecondReason:{},imgList:[],imgLimit:5,textareaPlaceholder:"请描述申请售后的具体原因，有助于更快的处理退款",descLimit:500,refundScaleAble:0,remark:"",lxParams:{},lxParamsV2:{},containerStyle:"padding: 0; height: auto;",placeholderStyle:"font-size:30rpx; color: #C4C7CC",textAreaStyle:"border: 2rpx solid rgba(18,25,36,0.10); border-radius: 16rpx; padding: 24rpx 20rpx; width: auto; height: 156rpx; font-size: 28rpx;",countStyle:"display: none",hasShowRefundStay:!1,showRefundStayPop:!1,refundStayInfo:{},refundStayResolve:null,ratioData:E.RATIO_DATA,showRefundEdit:!1,refundEditInputText:"",isInvalidateText:!1,selectedReceivingStatus:E.DEFAULT_RECEIVING_STATUS,showReceivingStatusOption:!1,receivingStatusOptions:[],btnStyle:"",selectedRatio:E.DEFAULT_RATIO,showInputPlaceholder:!1,inputFocus:!0,showValidateConfirm:!1,showRefundPopup:!1,refundPopupData:{title:"",content:"",tip:"",btnList:[]},isShowContactGroupHeader:!1,canInputWordsLength:500,unableScaleRefundSpecificReasonCodes:[],defaultMinQuantityReasonCodes:[],hideScaleRefundByCode:!1,pageFrom:"",refundStayOkText:"不退了",refundStayCancelText:"继续退款",allowPriceMatchSpecificReasonCodes:[],showPriceMatch:!1,isSwitchLabelShow:!1,switchLabelText:"",switchLabelChecked:!1,priceMatchInfo:{},stayPopfrom:D.FROM.REFUND_APPLY,switchLabelFrom:w.FROM.REFUND_APPLY,skuRefundPrice:null,skuRefundPriceStr:"",deliveryRefundPrice:null,deliveryRefundPriceStr:"",deliveryRefundPriceTip:"",accuratePrice:null},onLoad(e){const{orderId:t,reverseComputeItemList:a,hasShowRefundStay:s=!1,pageFrom:o=""}=e;try{const e=JSON.parse(decodeURIComponent(a));this.setData({orderId:+t,reverseComputeItemList:e,hasShowRefundStay:s,pageFrom:o}),this.imgUploading=!1,this.getNoticeInfo()}catch(e){S.log.warn("<RefundApply> onLoad JSON.parse error",JSON.stringify(e))}},onShow(){const{orderId:e,reverseComputeItemList:t}=this.data;this.getReverseCompute({orderId:e,reverseComputeItemList:t})},onHide(){this.setRefundCatchData()},getRefundCatchData(e){const t=N.$store.getCacheValue(E.REFUND_CATCH_KEY);if(N.$store.remove(E.REFUND_CATCH_KEY),t)try{return JSON.parse(t)}catch(e){S.log.error("<RefundApply> getRefundCatchData JSON.parse fail",JSON.stringify(e))}return e},setRefundCatchData(){const{selectedRatio:e,totalPrice:t,stackSkuInfo:a}=this.data,{quantity:s}=a,o={selectedRatio:e,totalPrice:t,quantity:s};N.$store.setCache(E.REFUND_CATCH_KEY,JSON.stringify(o))},getReverseCompute(){return m(this,arguments,(function*({orderId:e,reverseComputeItemList:t,userReceiptStatus:a,selectedRatio:s=this.data.selectedRatio}={}){var o,n,i,r,d,c,u,l;if(!this.requestLock){this.requestLock=!0,this.loading(!0);try{const p=this.getParamsForReverseCompute({orderId:e,reverseComputeItemList:t,userReceiptStatus:a}),R=yield b.reverseCompute(f(h({},p),{reverseComputeType:_.REVERSE_COMPUTE_TYPE.APPLY_REFUND}));S.log.info("<applyRefundPage getReverseCompute> 获取到退款商品的详情",R);const{orderReverseItemVOList:m,totalRefundPriceStr:y,refundTargetAccountDesc:I,orderReverseReasons:P,refundScaleAble:v,refundTip:C,retrievalTip:k,userReceiptStatusList:T=[],unableScaleRefundSpecificReasonCodes:D=[],allowPriceMatchSpecificReasonCodes:w=[],defaultMinQuantityReasonCodes:L=[],backToCartSwitchVO:O={},totalRefundPriceVO:E={}}=R;this.handleBackToCartSwitchVO(O);const F=m[0]||{},M={order_id:e,sku_id:F.skuId};let U=[];try{const t="0"!=`${a}`&&!a||-1==+a?{}:{receiptStatusCode:a};U=yield b.getRefundReason(h({orderId:e,skuId:F.skuId},t))}catch(e){U=P}const j={totalPrice:y,selectedRatio:s,quantity:(null==(o=this.data.stackSkuInfo)?void 0:o.quantity)||F.quantity},q=this.getRefundCatchData(j);q.quantity&&(F.quantity=q.quantity);const{skuRefundPriceCent:$,deliveryRefundPriceCent:V,deliveryRefundPriceTip:Y=""}=E;this.setData(h({aftersaleType:(null==(n=m[0])?void 0:n.aftersaleType)||null,compensationMsg:{amountCent:parseInt((0,g.fen2Yuan)(null==(i=m[0])?void 0:i.amountCent),10),couponTypeDesc:null==(r=m[0])?void 0:r.couponTypeDesc,couponType:`${parseInt((0,g.fen2Yuan)(null==(d=m[0])?void 0:d.amountCent),10)}元券`,couponName:null==(c=m[0])?void 0:c.couponName},stackSkuInfo:F,maxRefundPrice:y,refundTargetAccountDesc:I,orderReverseReasons:U,refundScaleAble:v,refundTip:C,retrievalTip:k,lxParams:M,lxParamsV2:f(h({},M),{status:(0,A.switchChecked2Status)(this.data.switchLabelChecked)}),receivingStatusOptions:T,unableScaleRefundSpecificReasonCodes:D,defaultMinQuantityReasonCodes:L,allowPriceMatchSpecificReasonCodes:w,skuRefundPrice:$,skuRefundPriceStr:(0,x.getDisplayStr)((0,g.fen2Yuan)($)),deliveryRefundPrice:V,deliveryRefundPriceStr:(0,x.getDisplayStr)((0,g.fen2Yuan)(V)),deliveryRefundPriceTip:Y},q)),N.$lxLog.pv("c_youxuan_iyxs0w3z",{poi_id:null==(u=null==N?void 0:N.$poi)?void 0:u.getPoiId(),poiIdStr:null==(l=null==N?void 0:N.$poi)?void 0:l.getPoiIdStr(),custom:{type:k?1:0}})}catch(e){this.toast(e.message||"获取订单失败"),S.log.warn(`<applyRefundPage getReverseCompute> 获取退款商品详情失败： ${e.message}`),N.$router.triggerBack("apply-getReverseCompute")}this.requestLock=!1,this.loading(!1)}}))},onRefundNumChange(e){const{stackSkuInfo:t}=this.data,{reversableQuantity:a}=t;e.detail.count<1||e.detail.count>a||e.detail.count===t.quantity?this.setData({stackSkuInfo:Object.assign(t,{quantity:e.detail.count})}):(this.setData({stackSkuInfo:Object.assign(t,{quantity:e.detail.count})}),setTimeout((()=>this.afterRefundNumChange()),0))},afterRefundNumChange(){const{orderId:e,stackSkuInfo:t,selectedReceivingStatus:a}=this.data,{skuId:s,stackId:o,quantity:n}=t,i=[{skuId:s,stackId:o,quantity:n}];this.getReverseCompute({orderId:e,reverseComputeItemList:i,userReceiptStatus:a.code})},onRefundNumBlur(e){const{stackSkuInfo:t}=this.data,a=()=>setTimeout((()=>this.afterRefundNumChange()),0);e.detail.count<1&&this.setData({stackSkuInfo:Object.assign(t,{quantity:1})},a),e.detail.count>t.reversableQuantity&&this.setData({stackSkuInfo:Object.assign(t,{quantity:t.reversableQuantity})},a)},onEditRefundPrice(){const{maxRefundPrice:e}=this.data;this.data.refundScaleAble?this.toast(this.data.refundTip):0!=+this.data.maxRefundPrice?(S.log.info("<applyRefundPage onEditRefundPrice> 开始修改退款比例和金额"),N.$lxLog.mc("b_youxuan_8f0yao7d_mc",this.data.lxParams),this.setData({showRefundEdit:!0,totalPrice:e,selectedRatio:E.NULL_RATIO,showInputPlaceholder:!0})):this.toast("最高可退0元\n无法修改退款金额")},handleRatioClick(e){const{ratioItem:t}=e.currentTarget.dataset,{totalPrice:a,maxRefundPrice:s,lxParams:o}=this.data,{ratio:n,text:i}=t,r=f(h({},o),{button_name:i});if(S.log.info("<applyRefundPage handleRatioClick> 比例按钮被点击"),N.$lxLog.mc("b_youxuan_4h4lew6k_mc",r),this.isReasonSelected()){const{orderId:e,reverseComputeItemList:a,selectedReceivingStatus:s}=this.data;this.setData({selectedRatio:t,showRefundEdit:!1,refundEditInputText:"",isInvalidateText:!1,showInputPlaceholder:!0}),this.getReverseCompute({orderId:e,reverseComputeItemList:a,userReceiptStatus:s.code,selectedRatio:t})}else{const e=(0,k.toRoundFixed)(+s*n,2);if(this.data.aftersaleType&&"2"===this.data.aftersaleType){const e=Math.ceil((0,g.fen2Yuan)(this.data.stackSkuInfo.amountCent*n));this.setData({selectedRatio:t,totalPrice:e,compensationMsg:{amountCent:e,couponType:`${e}元券`,couponTypeDesc:this.data.stackSkuInfo.couponTypeDesc,couponName:this.data.stackSkuInfo.couponName},showRefundEdit:!1,refundEditInputText:"",isInvalidateText:!1,showInputPlaceholder:!0})}else this.setData({selectedRatio:t,totalPrice:e,showRefundEdit:!1,refundEditInputText:"",isInvalidateText:!1,showInputPlaceholder:!0})}},handlePlaceholderTap(){this.setData({inputFocus:!0})},handleEditOk(){const{maxRefundPrice:e,refundEditInputText:t}=this.data;if(+t<.01)this.toast("请输入0.01元及以上的金额");else{const e=(0,k.toRoundFixed)(+t,2);if(this.isReasonSelected()){const{orderId:t,reverseComputeItemList:a,selectedReceivingStatus:s,selectedRatio:o}=this.data;this.getReverseCompute({orderId:t,reverseComputeItemList:a,userReceiptStatus:s.code,selectedRatio:o}),this.setData({showRefundEdit:!1,accuratePrice:e,isInvalidateText:!1})}else this.setData({showRefundEdit:!1,totalPrice:e,accuratePrice:e,isInvalidateText:!1})}},handleRefundEditInput(e){const{value:t}=e.detail,{maxRefundPrice:a}=this.data;return/^\d+(\.|\d+|\.\d+)?$/.test(`${t}`)?+t>+a?(this.setData({refundEditInputText:a,isInvalidateText:!0,showInputPlaceholder:!1}),`${a}`):void this.setData({refundEditInputText:t,isInvalidateText:!1,showInputPlaceholder:!1}):(this.setData({refundEditInputText:"",isInvalidateText:!1,showInputPlaceholder:!0}),"")},handleInputBlur(){this.setData({btnStyle:""})},handleKeyBoardHeightChange(e){const{height:t,duration:a}=e.detail,s=t>0?`position: fixed; left: 0; padding-bottom: 14rpx; bottom: ${t}px`:"";this.setData({btnStyle:s}),t>0?wx.pageScrollTo({scrollTop:1e3}):wx.pageScrollTo({scrollTop:0})},onRefundRatioClose(){S.log.info("<applyRefundPage onRefundRatioClose> 关闭退款比例弹窗"),this.setData({showRefundRatioPopup:!1})},onRefundRatioConfirm(e){S.log.info("<applyRefundPage onRefundRatioConfirm> 退款比例金额修改完成",e),this.setData({totalPrice:e.detail.value,showRefundRatioPopup:!1})},handleReceivingStatusClick(){this.setData({showReceivingStatusOption:!0,showRefundEdit:!1,refundEditInputText:"",isInvalidateText:!1,showInputPlaceholder:!0})},closeReceivingStatusOption(){this.setData({showReceivingStatusOption:!1})},handleSelectReceivingStatus(e){const{receivingStatusItem:t}=e.detail,{code:a=E.DEFAULT_RECEIVING_STATUS.code}=t,{code:s}=this.data.selectedReceivingStatus;+a!=+s&&(S.log.info("<applyRefundPage handleSelectReceivingStatus> 清空退款原因重新请求退款原因"),this.setData({selectedFirstReason:{},selectedSecondReason:{}}),this.handleDataAfterSelectedReceivingStatus(a)),this.setData({selectedReceivingStatus:t},(()=>{setTimeout((()=>{this.setData({showReceivingStatusOption:!1})}),100)}))},handleDataAfterSelectedReceivingStatus(e){this.setRefundCatchData();const{orderId:t,stackSkuInfo:a}=this.data,{skuId:s,stackId:o,quantity:n}=a,i=[{skuId:s,stackId:o,quantity:n}];this.getReverseCompute({orderId:t,reverseComputeItemList:i,userReceiptStatus:e})},toggleFirstReasonPop(){S.log.info("<applyRefundPage toggleFirstReasonPop> 选择退款原因弹窗"),N.$lxLog.mc("b_youxuan_5ivjrw1u_mc",this.data.lxParams),this.setData({showFirstReasonPop:!this.data.showFirstReasonPop,tempSelectedFirstReason:{},tempSelectedSecondReason:{},showRefundEdit:!1,refundEditInputText:"",isInvalidateText:!1,showInputPlaceholder:!0})},handleReasonOk(){const{tempSelectedFirstReason:e,tempSelectedSecondReason:t,unableScaleRefundSpecificReasonCodes:a=[],maxRefundPrice:s,orderId:o,reverseComputeItemList:n,selectedReceivingStatus:i,selectedRatio:r}=this.data;if(!e.code)return void this.toast("请选择退款原因");if(!t.code)return void this.toast("请选择具体问题描述");this.setData({selectedFirstReason:e,selectedSecondReason:t}),this.changeRefundNumByReasonCode(e.code,t.code);const d=-1!==a.indexOf(t.code);this.setData({hideScaleRefundByCode:d}),d&&this.setData({totalPrice:s,selectedRatio:E.DEFAULT_RATIO}),this.getReverseCompute({orderId:o,reverseComputeItemList:n,userReceiptStatus:i.code,selectedRatio:r}),this.toggleFirstReasonPop()},changeRefundNumByReasonCode(e,t){this.data.defaultMinQuantityReasonCodes.includes(e)&&this.data.defaultMinQuantityReasonCodes.includes(t)&&this.onRefundNumChange({detail:{count:1}})},onSelectFirstReason(e){S.log.info("<applyRefundPage onSelectFirstReason> 选择一级退款原因",e);const{firstReason:t}=e.currentTarget.dataset;if(this.handleSwitchLabelChecked(),this.setData({tempSelectedFirstReason:t,showPriceMatch:!1,priceMatchInfo:{}}),t.specificReverseReasonList&&t.specificReverseReasonList.length>1)this.setData({tempSelectedSecondReason:{}});else{this.setData({tempSelectedSecondReason:t.specificReverseReasonList&&t.specificReverseReasonList[0]});const{specificReverseReasonList:e=[]}=t;if(e.length){const t=e[0].code,{allowPriceMatchSpecificReasonCodes:a=[],orderId:s,stackSkuInfo:o}=this.data,{skuId:n,quantity:i,stackId:r}=o;-1!==a.indexOf(t)&&this.handlePriceMatchShow({orderId:s,skuId:n,secondCode:t,refundCount:i,stackId:r})}}},onSelectSecondReason(e){S.log.info("<applyRefundPage onSelectSecondReason> 选择二级退款原因",e);const{secondReason:t}=e.currentTarget.dataset,{tempSelectedSecondReason:a}=this.data;this.handleSwitchLabelChecked(),t.code===a.code?this.setData({tempSelectedSecondReason:{}}):this.setData({tempSelectedSecondReason:t})},onDescInput(e){clearTimeout(F);const{value:t}=e.detail,{descLimit:a}=this.data,s=a-t.length;s>=0&&this.setData({canInputWordsLength:s}),t.length>=a&&this.toast(`不得输入超过${a}字`),F=setTimeout((()=>{this.setData({remark:t.slice(0,a)})}),100)},onImgUpload(e){const{progress:t,successList:a=[]}=e.detail;"start"!==t&&"reUpload"!==t||(this.imgUploading=!0),"over"===t&&(S.log.info("<applyRefundPage onImgUpload> 退款凭证上传成功"),this.setData({imgList:a.map((e=>e.url))}),this.imgUploading=!1)},submitCheck(){const{selectedSecondReason:e,selectedFirstReason:t,remark:a,imgList:s,receivingStatusOptions:o,selectedReceivingStatus:n,selectedRatio:i}=this.data;return o.length&&+n.code==+E.DEFAULT_RECEIVING_STATUS.code?(this.toast("请选择收货状态"),!1):Object.prototype.hasOwnProperty.call(t,"code")?Object.prototype.hasOwnProperty.call(e,"code")?e.needApplyPicture&&!s.length?(this.toast("请上传图片凭证"),!1):e.needRemark&&!a?(this.toast("请填写退款说明"),!1):e.needRemark&&a.length<5?(this.toast("请至少输入5个字符"),!1):(S.log.info("<applyRefundPage submitCheck> 提交前检查通过",i),!0):(this.toast("请选择具体问题描述"),!1):(this.toast("请选择退款原因"),!1)},onSubmit(){return m(this,null,(function*(){var e,t;try{const{orderId:a,stackSkuInfo:s,selectedFirstReason:o,selectedSecondReason:n,imgList:i,remark:r,lxParams:d,maxRefundPrice:c,totalPrice:u,hasShowRefundStay:l,selectedRatio:p,receivingStatusOptions:R,selectedReceivingStatus:m,switchLabelChecked:y,accuratePrice:g=0}=this.data,{itemId:I,quantity:P,skuId:v,stackId:C}=s;let k={};k=p.ratio!==E.NULL_RATIO.ratio?{accurateRefundPrice:100*u,scale:100*p.ratio,accurateRefund:!1}:{accurateRefundPrice:+(100*g).toFixed(),accurateRefund:!0};let T={};if(R.length&&(T={userReceiptStatus:m.code}),N.$lxLog.mc("b_youxuan_o93ojjqx_mc",f(h({},d),{status:(0,A.switchChecked2Status)(y)})),this.submitLock)return void S.log.warn("<RefundApply> 触发了重复提交了申请退款，submitLock",this.submitLock);if(this.submitLock=!0,!this.submitCheck())return this.submitLock=!1,Promise.reject();if(!(yield this.validateRedemptionAssociate({orderId:a,stackId:C,quantity:P})))return void(this.submitLock=!1);if(!l){if(yield this.getRefundStayInfo(a,v,n.code,P,C)){this.submitLock=!1;const{refundStayInfo:e={}}=this.data,{stayTypeCode:t}=e;return void(t===E.STAY_INFO_TYPE_MAP.ContactGroup?this.handleContactGroupHeader(a):this.gotoOrderDetail())}}const x=h({orderId:a,orderReversableItemVOList:[h({itemId:I,quantity:P,skuId:v,stackId:C},k)],orderReverseReasonVO:{code:o.code,pictureUrls:i.join(","),reason:o.reason,reasonCodeLevel2:n.code,reasonLevel2:n.reason,remark:r},reverseComputeType:_.REVERSE_COMPUTE_TYPE.APPLY_REFUND,poi:null==(e=null==N?void 0:N.$poi)?void 0:e.getPoiId(),poiIdStr:null==(t=null==N?void 0:N.$poi)?void 0:t.getPoiIdStr()},T);try{this.loading(!0);const e=yield b.orderRefund(x),{success:t}=e;if(!t){const{popWindow:t,windowVo:s={}}=e,{title:o="",subTitle:n="",tips:i="",buttonVos:r=[]}=s;return void(t&&(this.setData({showRefundPopup:!0,refundPopupData:{title:o,content:n,tip:i,btnList:r}}),N.$lxLog.mv("b_youxuan_0e9v3099_mv",{order_id:a})))}S.log.info("<applyRefundPage onSubmit> 申请退款请求成功","requestBody",x,"res",e),yield this.subscribeMsg(),this.data.switchLabelChecked?yield this.handleBackToCart():this.gotoRefundDetail(a,s.stackId)}catch(e){const t=9008;e.data&&e.data.code&&e.data.code===t?this.gotoRefundDetail(a,s.stackId):(this.toast(e.message||"提交失败"),S.log.error(`<applyRefundPage onSubmit> 申请退款请求失败：${e.message}`))}this.submitLock=!1,this.loading(!1)}catch(e){}}))},gotoRefundDetail(e,t){const{pageFrom:a=""}=this.data;"refundDetail"!==a?N.$router.goto(`${C.PROTOCOL_PRES[0]}order/applyrefund/detail?orderId=${e}&stackId=${t}&need_type=redirectTo`):N.$router.triggerBack("apply-gotoRefundDetail")},gotoOrderDetail(){N.$router.triggerBack("apply-gotoOrderDetail")},subscribeMsg(){return m(this,null,(function*(){try{if(!(0,I.isMMP)()&&!(0,P.isWXMT)()&&!(0,P.isTT)()){const e=yield(0,v.subscribe)(["refund"]);S.log.info("提单: 优选订单提货通知订阅结果",e)}}catch(e){if(S.log.warn("提单：模板消息订阅失败",e),"99994"===e.errCode||"99998"===e.errCode)return void N.page().toast(e.errMsg);const{errData:t={}}=e,{data:a}=t;a&&Object.keys(a).every((e=>"reject"!==a[e]))?N.page().toast("订阅失败 请稍后重试"):N.page().toast("请打开订阅模板功能，重新尝试")}}))},getNoticeInfo(){return m(this,null,(function*(){}))},onTapNoticeBoard(){N.$lxLog.mc("b_youxuan_surjhz01_mc",this.data.lxParams)},getRefundStayInfo(e,t,a,s,o){return m(this,null,(function*(){var n,i,r,d,c;const u=new Promise(((e,t)=>{this.refundStayResolve=e}));try{let l={};try{const e=yield this.refundApplyVerify();l=(0,L.refundApplyVerifyRes2getRefundStayInfoV3Res)(e)}catch(n){l=yield b.getRefundStayInfoV3({orderId:e,skuId:t,type:"refund",secondCode:a,refundCount:s,stackId:o})}if(l.stay){const{stayTypeCode:a}=l;let s="",o="继续退款";l.buttonVOS&&l.buttonVOS.length>0?l.buttonVOS.forEach((e=>{switch(e.index){case 1:o=e.buttonText;break;case 2:s=e.buttonText}})):s=a===E.STAY_INFO_TYPE_MAP.ContactGroup?"联系团长":"不退了",this.setData({showRefundStayPop:!0,refundStayInfo:l,refundStayOkText:s,refundStayCancelText:o});let u=l.message;switch(a){case E.STAY_INFO_TYPE_MAP.Default:u=l.message;break;case E.STAY_INFO_TYPE_MAP.Stock:u=(null==(n=l.sellOut)?void 0:n.message)||"";break;case E.STAY_INFO_TYPE_MAP.Discount:u=(null==(i=l.discount)?void 0:i.message)||"";break;case E.STAY_INFO_TYPE_MAP.Review:u=(null==(r=l.skuReview)?void 0:r.message)||"";break;case E.STAY_INFO_TYPE_MAP.ContactGroup:u=(null==(d=l.contactGroup)?void 0:d.message)||"";break;case E.STAY_INFO_TYPE_MAP.BuyPeopleCount:u=(null==(c=l.buyPeopleCount)?void 0:c.message)||"";break;default:u=l.message}N.$lxLog.mv("b_youxuan_gwjluhga_mv",{order_id:e,sku_id:t,message:u})}else this.refundStayResolve(!1);return u}catch(e){return this.toast(e.message||"网络异常，请重试"),Promise.reject()}}))},refundApplyVerify(){return m(this,null,(function*(){try{const{orderId:e,stackSkuInfo:t,selectedFirstReason:a,selectedSecondReason:s,selectedRatio:o}=this.data,n={orderId:e,skuId:t.skuId,stackId:t.stackId,refundApplyPageSource:_.REFUND_APPLY_PAGE_SOURCE.REFUND_APPLY_PAGE,refundApplyType:_.REFUND_APPLY_TYPE.REFUND_SUBMIT,refundQuantity:t.quantity,firstReasonCode:a.code,firstReasonText:a.reason,secondReasonCode:s.code,secondReasonText:s.reason,refundScale:100*o.ratio};return b.refundApplyVerify(n)}catch(e){S.log.error("<RefundApply> refundApplyVerify",JSON.stringify(e))}}))},closeRefundStayPop(e){const{stay:t}=e.detail,{orderId:a,stackSkuInfo:s,refundStayInfo:o}=this.data;this.setData({showRefundStayPop:!1}),N.$lxLog.mc(t?"b_youxuan_3ajchxje_mc":"b_youxuan_g71ex1pn_mc",{order_id:a,sku_id:s.skuId,message:o.message||""}),this.refundStayResolve(t)},onNoticeBoardShow(){this.setData({showNoticeBoardPop:!this.data.showNoticeBoardPop})},validateRedemptionAssociate(e){return m(this,null,(function*(){try{const t=yield b.validateRedemptionAssociate(e);return!t.flag||new Promise((e=>{this.setData({showValidateConfirm:!0});const a=t=>{this.setData({showValidateConfirm:!1}),e(t)};this.confirm({message:t.tip,customContentStyle:"text-align: center",zIndex:101,textOK:"不退了",textCancel:"继续退款",ok:()=>{a(!1)},cancel:()=>{a(!0)}})}))}catch(e){return S.log.warn("<RefundApply validateRedemptionAssociate> 获取连带退0元换购品信息失败"),!0}}))},handleRefundPopupMaskClick(){const{orderId:e,stackSkuInfo:t}=this.data;this.setData({showRefundPopup:!1}),this.gotoOrderDetail()},handleRefundPopupBtnClick(e){const{orderId:t,stackSkuInfo:a}=this.data,{detail:s=""}=e;this.setData({showRefundPopup:!1}),"KNOWN"===s?(N.$lxLog.mc("b_youxuan_acv8ozp1_mc",{order_id:t}),this.gotoOrderDetail()):"CONTACT_GROUP_HEAD"===s&&this.handleContactGroupHeader(t)},handleContactGroupHeader(e){N.$lxLog.mc("b_youxuan_y4swxny4_mc",{order_id:e}),this.setData({isShowContactGroupHeader:!0});this.selectComponent("#contact-group-header").getGroupHeaderPhone({page:this,orderId:e,lxData:{privacyAlertMV:"b_youxuan_1pbexf9f_mv",privacyAlertOK:"b_youxuan_ks54c0z7_mc",privacyAlertCancel:"b_youxuan_8sfhzubs_mc",phoneCallAlertMV:"b_youxuan_4f5fgy2x_mv",phoneCallAlertOK:"b_youxuan_x7f170ms_mc",phoneCallAlertCancel:"b_youxuan_hhcul3tf_mc"},lxParams:{order_id:e}})},handleContactShowPop(e){const{detail:t}=e;t||(this.setData({isShowContactGroupHeader:!1}),this.gotoOrderDetail())},handlePriceMatchShow(e){return m(this,arguments,(function*({orderId:e,skuId:t,secondCode:a,refundCount:s,stackId:o}){try{let s={};try{const n=yield b.getPriceMatchResult({orderId:e,skuId:t,stackId:o,secondReasonCode:a});s=this.getPriceMatchResultRes2getRefundStayInfoV3Res(n)}catch(e){S.log.warn(e)}const{stayTypeCode:n,priceMatch:i={}}=s,{message:r="",buttonText:d="申请价保"}=i;n===E.STAY_INFO_TYPE_MAP.PriceMatch&&r&&this.setData({showPriceMatch:!0,priceMatchInfo:{message:r,buttonText:d}})}catch(e){S.log.warn("<RefundApply>选择原因后获取保价入口信息错误",e)}}))},gotoInsurance(){const{orderId:e,stackSkuInfo:t}=this.data,{skuId:a,stackId:s}=t;N.$lxLog.mc("b_youxuan_hcxpblux_mc",{order_id:e,sku_id:a}),N.$router.goto("igrocery://www.grocery.com/insuranceDetail",{stackId:s,orderId:e,skuId:a,need_type:"redirectTo"})},onSwitchLabelChange(e){const{switchVal:t}=e.detail;this.setData({switchLabelChecked:t}),(0,O.getSingleInstance)().set(t)},handleBackToCartSwitchVO(e={}){if(0===Object.keys(e).length)return;const{text:t,display:a}=e;this.setData({isSwitchLabelShow:a,switchLabelText:t})},handleSwitchLabelChecked(e=!0){const{isSwitchLabelShow:t}=this.data,a=(0,O.getSingleInstance)().get();t&&e!==this.data.switchLabelChecked&&a&&this.setData({switchLabelChecked:e})},getPriceMatchResultRes2getRefundStayInfoV3Res(e={}){var t;const{contentText:a,buttonVOS:s}=e||{};return{stayTypeCode:E.STAY_INFO_TYPE_MAP.PriceMatch,priceMatch:{message:a||"",buttonText:s&&s[0]&&(null==(t=s[0])?void 0:t.buttonText)||""}}},handleBackToCart(){return m(this,null,(function*(){const{orderId:e,stackSkuInfo:t}=this.data;try{const{selectedSecondReason:a}=this.data,s=-1!==[66,18].indexOf(a.code),o=yield this.operateCart(s);if(200!==o.opResult)throw new Error({message:"购物车加车失败",error:h({},o)});s?this.handleBackToCarModal():(this.toast("为了方便您再次购买，退款商品已为您放回购物车中"),setTimeout((()=>{this.gotoRefundDetail(e,t.stackId)}),1200))}catch(a){S.log.info(`<refund apply handleBackToCart>: error: ${a}`),this.gotoRefundDetail(e,t.stackId)}}))},handleBackToCarModal(){this.confirm({title:"退款申请成功",message:"退款商品已为您准备好，是否要再次下单？",customContentStyle:"text-align: center",zIndex:102,textOK:"再次下单",textCancel:"查看退款",ok:()=>{this.orderAgain()},cancel:()=>m(this,null,(function*(){yield this.viewRefund()}))})},viewRefund(){return m(this,null,(function*(){const{orderId:e,stackSkuInfo:t}=this.data;try{const a=yield this.operateCart();if(200!==a.opResult)throw new Error({message:"购物车加车失败",error:h({},a)});this.gotoRefundDetail(e,t.stackId)}catch(a){S.log.info(a),this.gotoRefundDetail(e,t.stackId)}}))},orderAgain(){N.$router.goto("/pages/submitOrder/index",{cartOpSource:"buyNow"})},operateCart(e=!1){const{skuId:t,quantity:a}=this.data.stackSkuInfo,s="REFUNDAPPLY",o=e?"BUYNOW":s;return N.$cart.operateCart({requestSource:s,cartOpType:"INCREASE",showSuccessToast:!e,cartOpSource:o,forceRefresh:!0,opTarget:{opTargets:[{skuId:t,count:a}]},createTempCart:e})},onDeliveryMoneyClick(e){const{deliveryRefundPriceTip:t}=this.data;t&&this.alert({type:"bottom",title:"配送费退款说明",message:`${t}`,zIndex:101,textOK:"我知道了",ok:()=>{}})},getParamsForReverseCompute({orderId:e,reverseComputeItemList:t,userReceiptStatus:a}={}){var s,o,n;const i=null==(s=null==N?void 0:N.$poi)?void 0:s.getPoiId(),r=null==(o=null==N?void 0:N.$poi)?void 0:o.getPoiIdStr(),{refundEditInputText:d,selectedRatio:c,stackSkuInfo:u}=this.data;let l={orderId:e,reverseComputeItemList:t};(null==t?void 0:t.length)<=0&&(l.reverseComputeItemList=[{}]);const{code:p}=this.data.selectedReceivingStatus;a&&+a!=+E.DEFAULT_RECEIVING_STATUS.code?l=f(h({},l),{userReceiptStatus:a}):p&&p!==E.DEFAULT_RECEIVING_STATUS.code&&(l=f(h({},l),{userReceiptStatus:p})),r||i?(l.currentPoiId=i,l.poiIdStr=r):S.log.warn("<refund apply> 获取app?.$poi?.getPoiIdStr()失败");let R={};if(this.isReasonSelected()){const{selectedFirstReason:e,selectedSecondReason:t}=this.data;R={reverseComputeReason:{code:e.code,reason:e.reason,secondCode:t.code,secondReason:t.reason}}}return this.isAccurateRefund()?l.reverseComputeItemList[0].accurateRefund=!0:(l.reverseComputeItemList[0].accurateRefund=!1,this.isRatioRefund()&&"-1"!=`${null==c?void 0:c.ratio}`&&(l.reverseComputeItemList[0].scale=+(100*+(null==c?void 0:c.ratio)).toFixed())),l.reverseComputeItemList[0].accurateRefundPriceCent=Number((0,T.yuan2fen)(d)),l.reverseComputeItemList[0].quantity=(null==u?void 0:u.quantity)||(null==(n=t[0])?void 0:n.quantity),h(h({},l),R)},isReasonSelected(){const{selectedFirstReason:e,selectedSecondReason:t}=this.data;return e.code&&t.code},isRatioRefund(){const{refundScaleAble:e,maxRefundPrice:t,hideScaleRefundByCode:a}=this.data;return"2"===this.data.aftersaleType?!(e||a):!(e||0===t||"0"===t||a)},isAccurateRefund(){const{selectedRatio:e}=this.data;return e.ratio===E.NULL_RATIO.ratio}});