var e=Object.create,t=Object.defineProperty,a=Object.defineProperties,s=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertyNames,o=Object.getOwnPropertySymbols,i=Object.getPrototypeOf,l=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,c=(e,a,s)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[a]=s,d=(e,t)=>{for(var a in t||(t={}))l.call(t,a)&&c(e,a,t[a]);if(o)for(var a of o(t))u.call(t,a)&&c(e,a,t[a]);return e},y=a=>{return((e,a,r)=>{if(a&&"object"==typeof a||"function"==typeof a)for(let o of n(a))l.call(e,o)||"default"===o||t(e,o,{get:()=>a[o],enumerable:!(r=s(a,o))||r.enumerable});return e})((r=t(null!=a?e(i(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0}),t(r,"__esModule",{value:!0})),a);var r},m=y(require("../../../../er.js")),p=y(require("../../../../p8.js")),g=y(require("../../p7.js")),h=y(require("../../p9.js")),f=getApp(),k={1:"gift",2:"addition"};(0,m.default)({$service:f.$service,data:{pageValid:!0,orderId:null,skuItems:[],skuQuantity:-1,skuCount:0,onlySelectAll:!1,selectedMap:{},hiddenMap:{}},onLoad(e){const{orderId:t,orderPoiId:a}=e;this.setData({orderId:t,orderPoiId:a}),wx.hideShareMenu()},onShow(){const{orderId:e,skuCount:t,pageValid:a}=this.data;a||(getCurrentPages().length>1?f.$router.triggerBack("detail-onShow"):f.$router.goto(`/pages/orderDetail/index?need_type=redirectTo&orderId=${e}`)),t||(this.loading(!0),this.init())},init(){this.getRefundItems()},getRefundItems(){h.getRefundItems({orderId:this.data.orderId}).then((e=>{this.loading(!1);const t={},a={};let s=0;const r=e.items.map((r=>{const n=d({},r),{itemKey:o,quantity:i}=n;return n.selected=e.onlySelectAll,n.count=e.onlySelectAll?i:1,n.isGift||3===n.itemTag?a[n.itemKey]={itemKey:o,quantity:i}:s+=i,n.picTag=k[n.itemTag],e.onlySelectAll&&(t[n.itemKey]={itemKey:o,quantity:i}),n}));this.setData({skuItems:r.filter((e=>!e.isGift&&3!==e.itemTag)),onlySelectAll:e.onlySelectAll,selectedMap:t,hiddenMap:a,skuQuantity:s,skuCount:e.onlySelectAll?s:0})})).catch((e=>{this.loading(!1),this.toast(e.message||"获取退款商品异常！")}))},onSkuSelect(e){const{skuItems:t,selectedMap:a,onlySelectAll:s}=this.data;if(s)return;const{index:r,selected:n,itemKey:o}=e.currentTarget.dataset,i=!n;t[r].selected=i,t[r].count=i?1:0,i?a[o]={quantity:1,itemKey:o}:delete a[o],this.setData({skuItems:t,selectedMap:a,skuCount:this.calcSkuCount()})},onSkuCountChange(e){const{count:t}=e.detail,{index:a,itemKey:s}=e.currentTarget.dataset,{skuItems:r,selectedMap:n}=this.data;r[a].count=t,n[s].quantity=t,this.setData({skuItems:r,selectedMap:n,skuCount:this.calcSkuCount()})},calcSkuCount(){return(0,g.objectValues)(this.data.selectedMap).reduce(((e,t)=>e+t.quantity),0)},onSelectAll(e){const{skuQuantity:t,onlySelectAll:s}=this.data;if(-1===t)return;if(s)return void this.toast("本订单仅支持全单退款，如需部分退款请联系客服协助处理");const{selected:n}=e.currentTarget.dataset,o=!n,i={},l=this.data.skuItems.map((e=>{return o&&(i[e.itemKey]={itemKey:e.itemKey,quantity:e.quantity}),t=d({},e),s={selected:o,count:o?e.quantity:0},a(t,r(s));var t,s}));this.setData({skuItems:l,selectedMap:i,skuCount:o?this.data.skuQuantity:0})},getSelectedSkuList(){const{skuQuantity:e,skuCount:t,onlySelectAll:a,selectedMap:s={},hiddenMap:r={}}=this.data;if(a||e!==t)return Object.keys(s).map((e=>s[e]));const n=Object.assign({},s,r);return Object.keys(n).map((e=>n[e]))},onNext(){const{orderId:e,orderPoiId:t}=this.data;f.$router.goto("/subPackages/refund/pages/apply/index",{orderId:e,orderPoiId:t})},showDescDialog(){f.$lxLog.mc("b_chaoshi_y2keapbd_mc"),(0,p.default)({title:"退款说明",message:"当您发起退款时，系统会根据下述逻辑计算应退金额\n\n            · 若所选同类型多件商品售价一致，退款时按照售价退还相应的金额\n\n            · 若所选同类型多件商品中部分享受了特价或折扣类型的优惠，退款时为了保证用户权益，优先退还原价商品，再退还享受了优惠的商品\n\n            · 若所选同类型多件商品享受了第n件n折的优惠，退款时会将优惠均摊到每个商品进行反扣，再按照反扣后的价格进行退款",selector:"#dialog-refund-desc",confirmButtonText:"知道了",confirmButtonColor:"#FFD100"})}});