var e,t,o=Object.create,a=Object.defineProperty,r=Object.defineProperties,n=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertyNames,d=Object.getOwnPropertySymbols,l=Object.getPrototypeOf,u=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,p=(e,t,o)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,f=(e,t)=>{for(var o in t||(t={}))u.call(t,o)&&p(e,o,t[o]);if(d)for(var o of d(t))c.call(t,o)&&p(e,o,t[o]);return e},m=(e,t)=>r(e,s(t)),h=e=>{return((e,t,o)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of i(t))u.call(e,r)||"default"===r||a(e,r,{get:()=>t[r],enumerable:!(o=n(t,r))||o.enumerable});return e})((t=a(null!=e?o(l(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0}),a(t,"__esModule",{value:!0})),e);var t},y=(e,t,o)=>new Promise(((a,r)=>{var n=e=>{try{i(o.next(e))}catch(e){r(e)}},s=e=>{try{i(o.throw(e))}catch(e){r(e)}},i=e=>e.done?a(e.value):Promise.resolve(e.value).then(n,s);i((o=o.apply(e,t)).next())})),g=h(require("../../../../er.js")),I=h(require("../../../../ob.js")),_=(h(require("../../../../is.js")),h(require("../../../../sy.js"))),v=h(require("../../../../a3.js")),k=h(require("../../../../gb.js")),x=h(require("../../gz.js")),S=h(require("../../p9.js")),b=h(require("../../gv.js")),P=h(require("../../gc.js")),T=h(require("../../ag.js")),R=h(require("../../gx.js")),L=(h(require("../../ah.js")),{MV:"b_youxuan_57t0urhm_mv",YELLOW_BTN_BID:"b_youxuan_f5g04kns_mc",WHITE_BTN_BID:"b_youxuan_cfr04n4d_mc"}),w={startStatus:0,activeStatus:2},{contentHeight:C,statusBarHeight:D}=(0,v.getStatusBarHeight)(),B=getApp();(0,g.default)({$service:B.$service,data:{hasCompensationCouponInfo:!1,applyRefundPriceStr:"",aftersaleType:w.startStatus,orderType:w,compensationInfo:{},detailParams:{},isIpx:null==(t=null==(e=B.getModule("systemInfo"))?void 0:e.getSystemInfo())?void 0:t.isIpx,orderId:null,poiId:null,poiIdStr:null,stackId:0,detailList:[],csServiceUrl:"",groupHeaderInfo:{},showOverTimePopUp:!1,contactMVParams:{},statusStyleMap:x.statusStyleMap,titleBackgroundModule:x.titleBackgroundModule,commonMvParams:{a:"custom"},mvProps:{type:Object,value:{}},refundId:"",scrollTo:"",bottomShowGroupHeaderButton:!1,showLookforIM:!1,buttonTipsList:[],lookforIMTitle:"",contentHeight:C,statusBarHeight:D,title:"",titleClass:"",showNewStyle:!1,noticeBoardStyle:"",noticeBoardTextStyle:"",detailContainerClass:"",isWhiteTitle:!1,showLoadingPage:!0,isRefundPopShowed:!1,stackSkuInfo:{},deliveryRefundPriceStr:""},useMvReport:!0,onLoad(e){const{orderId:t,stackId:o,refundId:a}=e;this.setData({orderId:t,stackId:o,refundId:a}),wx.hideShareMenu()},onShow(){return y(this,null,(function*(){yield this.getRefundDetailV2(),this.setData({scrollTo:this.data.refundId})}))},onReady(){setTimeout((()=>{}),1e3)},getRefundDetailV2(){return y(this,null,(function*(){var e,t,o,a,r,n,s,i,d,l,u;const{orderId:c,stackId:p}=this.data;this.loading(!0);try{const h=yield S.getRefundDetailV2({orderId:c,stackId:p}),y={order_id:null==h?void 0:h.orderId,stack_id:null==h?void 0:h.stackId,type:(null==h?void 0:h.abnormalType)||0,message:null==h?void 0:h.abnormalTip,num:null==(e=null==h?void 0:h.stackSkuInfo)?void 0:e.quantity,sku_list:[null==(t=null==h?void 0:h.stackSkuInfo)?void 0:t.skuId]},g={refundCouponPriceStr:null==(o=null==h?void 0:h.compensationCouponInfo)?void 0:o.refundCouponPriceStr,couponTypeDesc:null==(a=null==h?void 0:h.compensationCouponInfo)?void 0:a.couponTypeDesc,couponName:null==(r=null==h?void 0:h.compensationCouponInfo)?void 0:r.couponName,couponAssignResult:null==(n=null==h?void 0:h.compensationCouponInfo)?void 0:n.couponAssignResult,endTime:`有效期至${null==(s=null==h?void 0:h.compensationCouponInfo)?void 0:s.endTime}`,title:(null==(i=null==h?void 0:h.compensationCouponInfo)?void 0:i.couponAssignResult)?"本单为活动订单，已成功退还等值优惠券":"优惠券获取失败，请联系客服",couponType:`${null==(d=null==h?void 0:h.compensationCouponInfo)?void 0:d.refundCouponPriceStr}元券`},I=null==(l=null==h?void 0:h.stackReverseItemList[0])?void 0:l.applyRefundPriceStr,_=null==(u=null==h?void 0:h.stackReverseItemList[0])?void 0:u.aftersaleType;this.setData({showLoadingPage:!1}),this.loading(!1);const{hasCompensationCouponInfo:v,stackReverseItemList:b,groupHeaderInfo:P,stackSkuInfo:T,csServiceUrl:R,showCancelApplyButton:L,poiId:w,poiIdStr:C="",abnormalTip:D=""}=h,{titleBackgroundModule:B}=this.data,N=this.handleNewStyleVariable(b),O=b.map((e=>{const t=f({},e);t.style=B[e.refundStatus]||B[0],t.reverseReasonInfo.reason?(t.refundReasonStr=t.reverseReasonInfo.reason,t.reverseReasonInfo.secondReason&&(t.refundReasonStr+=`-${t.reverseReasonInfo.secondReason}`)):t.refundReasonStr="无",t.totalPrice=+this.formatPrice(t.totalPrice),t.refundScaleType===x.SCALE_TYPE.scale&&t.refundScale&&(t.scaleText=`(退${t.refundScale}%)`),t.applyRefundPrice=+this.formatPrice(t.applyRefundPrice),t.showCancelApplyBtn=1===t.status&&L,t.refundNoticeTip&&4===t.status&&-1!==t.refundNoticeTip.indexOf("<red>")&&(t.refundNoticeTip=this.formatRefundNoticeTip(t.refundNoticeTip),t.refundNoticeTip.push("red")),t.compensationTip&&-1!==t.compensationTip.indexOf("<red>")&&-1!==t.compensationTip.indexOf("</red>")?t.compensationTip=this.formatRefundNoticeTip(t.compensationTip):t.compensationTip=-1;const{detailedStackReverseProgressNodeList:o=[]}=t,{length:a}=o;if(a){const e=o.map((e=>{const{title:t="",subTitle:o=""}=e;let a=[],r=[];return-1!==t.indexOf("</red>")&&(a=this.formatRefundNoticeTip(t)),-1!==o.indexOf("</red>")&&(r=this.formatRefundNoticeTip(o)),m(f({},e),{afterTitle:a,afterSubTitle:r})}));t.detailedStackReverseProgressNodeList=e}return t.isShowButton=!!(P.callStr&&t.needShowGroupHeaderButton||t.needShowAppealButton||t.needShowAppealRollBackButton),t.deliveryRefundPriceStr=t.deliveryRefundPriceCent?(0,k.fen2Yuan)(t.deliveryRefundPriceCent):"",t})),$=!b.some((e=>!!e.needShowGroupHeaderButton));T.stackTotalPrice=+this.formatPrice(T.stackTotalPrice),T.cashPay=+this.formatPrice(T.cashPay);const{isShowNoticeBoard:A,noticeBoardInfo:M}=this.getNoticeInfoData(void 0,D);this.setData(f({aftersaleType:_,applyRefundPriceStr:I,hasCompensationCouponInfo:v,compensationInfo:g,detailParams:y,detailList:O,stackSkuInfo:T,groupHeaderInfo:P,csServiceUrl:R,bottomShowGroupHeaderButton:$,poiId:w,poiIdStr:C,noticeBoardInfo:M,isShowNoticeBoard:A},N)),this.lxMV()}catch(e){this.loading(!1),this.toast(e.message||"获取退款详情失败"),B.$router.triggerBack("detail-getRefundDetailV2")}finally{this.setData({showLoadingPage:!1})}}))},lxMV(){var e;const{orderId:t,stackSkuInfo:o,detailList:a,csServiceUrl:r,groupHeaderInfo:n,isShowNoticeBoard:s}=this.data;B.$lxLog.mv("b_youxuan_fdezl6e3_mv",{order_id:t,sku_id:o.skuId}),B.$lxLog.mv("b_youxuan_1910avtd_mv",this.data.detailParams),a.forEach((e=>{e.showCancelApplyBtn&&B.$lxLog.mv("b_youxuan_9ph8gicv_mv",{order_id:t,sku_id:o.skuId}),e.retrieveMsg&&B.$lxLog.mv("b_youxuan_43zuma25_mv",{order_id:t,sku_id:o.skuId})})),r&&B.$lxLog.mv("b_youxuan_38g7k6ly_mv",{order_id:t,sku_id:o.skuId}),n.callStr&&B.$lxLog.mv("b_youxuan_mciqf9lw_mv",{order_id:t,sku_id:o.skuId}),s&&B.$lxLog.mv("b_youxuan_81elfejc_mv",{order_id:t,sku_id:o.skuId,refund_id:null==(e=a[0])?void 0:e.refundId})},formatPrice:e=>e?(e/100).toFixed(2):0,onBtnsClick(e){return y(this,null,(function*(){var t,o;const{type:a,extractInfo:r,buttonTipsList:n=[]}=null==(o=null==(t=null==e?void 0:e.currentTarget)?void 0:t.dataset)?void 0:o.type,{orderId:s,stackSkuInfo:i}=this.data;let d={};try{try{const e=yield this.refundApplyVerify();d=this.refundApplyVerifyRes2ExtractInfo(e)}catch(e){I.log.info(e),d=JSON.parse(r)}const{title:e,status:t,subTitle:o}=d,{MV:a,YELLOW_BTN_BID:l,WHITE_BTN_BID:u}=L,c={order_id:s,sku_id:i.skuId,toast_name:e||"",toast_type:o||""};if(8===t)if(n.length)this.showLookforIM(n,e);else{this.data.isRefundPopShowed||(B.$lxLog.mv(a,f({},c)),this.setData({isRefundPopShowed:!0}));const t="联系团长",r="取消";this.confirm({title:e,message:o,customContentStyle:"text-align: center",zIndex:101,textCancel:r,textOK:t,ok:()=>{B.$lxLog.mc(l,{button_name:t,order_id:s,sku_id:i.skuId}),this.onCallGroupHeader()},cancel:()=>{B.$lxLog.mc(u,{button_name:r,order_id:s,sku_id:i.skuId})}})}else if(11===t){this.data.isRefundPopShowed||(B.$lxLog.mv(a,f({},c)),this.setData({isRefundPopShowed:!0}));const t="知道了";this.alert({title:e,message:o,zIndex:101,textOK:t,ok:()=>{B.$lxLog.mc(l,{button_name:t,order_id:s,sku_id:i.skuId})}})}else this.onClickApplyRefund(d)}catch(e){I.log.info("onBtnsClick error",e),this.onClickApplyRefund(d)}}))},btnEvent(){this.data.compensationInfo.couponAssignResult?B.$router.goto("/pages/index/index"):B.$router.goto(this.data.csServiceUrl)},showLookforIM(e,t){const o=[{pic:P.Images.order_phone_guard,btn_icon:P.Images.order_phone_gray,btn_text:"电话联系"},{pic:P.Images.order_IM_guard,btn_icon:P.Images.order_IM_gray,btn_text:"在线联系"}],a=e.map((e=>1===e.btnTipsType?f(f({},e),o[0]):f(f({},e),o[1])));this.setData({showLookforIM:!0,buttonTipsList:a,lookforIMTitle:t})},makePhoneCall(e){return y(this,null,(function*(){var t;const{btnTipsType:o}=null==(t=null==e?void 0:e.detail)?void 0:t.item,{orderId:a,poiId:r,poiIdStr:n}=this.data;if(1===o)try{const e=yield S.getGroupHeaderPhone({orderId:a}),{phoneNumber:t}=e;wx.makePhoneCall({phoneNumber:t})}catch(e){I.log.error("<getGroupHeaderPhone> 获取团长隐私号失败",e)}else if(2===o){if(!b.default.isSupprotChat)return void this.toast("当前平台不支持该功能");this.loading(!0),b.default.getGroupHeaderDxId(r,n).then((e=>{this.loading(!1),b.default.jumpToChatPage(a,e,r,n)})).catch((e=>{I.log.info("[chatbot] getGroupHeaderDxId 用户大象id获取失败",e),this.loading(!1),this.toast("获取用户身份异常")}))}}))},onClickApplyRefund(e){var t;const{orderId:o,stackSkuInfo:a,stackId:r}=this.data;if(!a.reversableQuantity)return;B.$lxLog.mc("b_youxuan_fdezl6e3_mc",{order_id:o,sku_id:a.skuId});let n={};if(Object.keys(e).length>0)n=e;else try{if(!(null==(t=null==a?void 0:a.buttons[0])?void 0:t.extractInfo))throw new Error('"stackSkuInfo.buttons[0].extractInfo" is undefined');n=JSON.parse(a.buttons[0].extractInfo)}catch(e){I.log.info("onClickApplyRefund error",e)}if(Object.keys(n).length>0){const{MV:e,YELLOW_BTN_BID:t}=L,r={order_id:o,sku_id:a.skuId,toast_name:(null==n?void 0:n.title)||"",toast_type:(null==n?void 0:n.subTitle)||""};if(this.data.isRefundPopShowed||(B.$lxLog.mv(e,f({},r)),this.setData({isRefundPopShowed:!0})),3===n.status){const e="知道了";return void this.alert({title:null==n?void 0:n.title,message:null==n?void 0:n.subTitle,zIndex:101,textOK:e,ok:()=>{B.$lxLog.mc("b_youxuan_j5ia2xei_mc",{order_id:o}),B.$lxLog.mc(t,{button_name:e,order_id:o,sku_id:a.skuId})}})}if(6===n.status){const e="知道了";return void this.alert({title:null==n?void 0:n.title,message:null==n?void 0:n.subTitle,zIndex:101,textOK:e,ok:()=>{B.$lxLog.mc(t,{button_name:e,order_id:o,sku_id:a.skuId})}})}}const s={orderId:+o,reverseComputeItemList:[{quantity:a.reversableQuantity,skuId:a.skuId,stackId:r}],pageFrom:"refundDetail"};B.$router.goto("/subPackages/refund/pages/apply/index",s)},onCancelApply(e){return y(this,null,(function*(){const{canCancelApply:t,applyId:o}=e.currentTarget.dataset.detail,{orderId:a,stackSkuInfo:r}=this.data;if(B.$lxLog.mc("b_youxuan_9ph8gicv_mc",{order_id:a,sku_id:r.skuId}),t){try{const e={applyId:o};this.loading(!0),yield S.cancelReverseApply(e),this.loading(!1)}catch(e){this.loading(!1),this.toast(e.message||"取消订单失败")}this.getRefundDetailV2()}else this.toast("团长发起退款，请联系团长取消")}))},onContact(){const{orderId:e,stackSkuInfo:t}=this.data;B.$lxLog.mc("b_youxuan_38g7k6ly_mc",{order_id:e,sku_id:t.skuId}),B.$router.goto(this.data.csServiceUrl)},onCallGroupHeader(e={}){var t,o,a;const{orderId:r,stackSkuInfo:n,detailList:s}=this.data;let i;const d=null==(o=null==(t=null==e?void 0:e.target)?void 0:t.dataset)?void 0:o.refundId;if(d||0===d)i=d;else{i=null==(a=s[0])?void 0:a.refundId}B.$lxLog.mc("b_youxuan_mciqf9lw_mc",{order_id:r,sku_id:n.skuId});this.selectComponent("#contact-group-header").getGroupHeaderPhone({page:this,orderId:r,lxData:{privacyAlertMV:"b_youxuan_6e1lti31_mv",privacyAlertOK:"b_youxuan_o8ln8yjw_mc",privacyAlertCancel:"b_youxuan_owsi4kvi_mc"},lxParams:{refund_id:i}})},getNoticeInfo(){return y(this,null,(function*(){}))},onTapNoticeBoard(){var e;const{orderId:t,stackSkuInfo:o,detailList:a}=this.data;B.$lxLog.mc("b_youxuan_81elfejc_mc",{order_id:t,sku_id:o.skuId,refund_id:null==(e=a[0])?void 0:e.refundId})},onMvReport(e){B.$lxLog.mv(e.detail.bid,e.detail.lxParams)},formatRefundNoticeTip(e){const t=/([\s\S]*)<red>/,o=/<red>([\s\S]*)<\/red>/,a=/<\/red>([\s\S]*)/;return[e.match(t)?e.match(t)[1]:"",e.match(o)?e.match(o)[1]:"",e.match(a)?e.match(a)[1]:""]},closeLookForGroupHeaderPop(){this.setData({showLookforIM:!1})},onAppeal(e){B.$lxLog.mc("b_youxuan_ssdk9rqh_mc");const{orderId:t}=this.data,{dataset:o={}}=e.target,{applyId:a=""}=o,r={orderId:t,applyId:a};B.$router.goto("/subPackages/refund/pages/appeal/index",r)},onAppealCancel(e){B.page().confirm({message:"您确认撤销申诉吗？",textCancel:"再想想",textOk:"撤销",ok:()=>{this.handleAppealCancel(e)}})},handleAppealCancel(e){return y(this,null,(function*(){const{orderId:t,stackId:o}=this.data,{dataset:a={}}=e.target,{applyId:r="",appealId:n=""}=a,s={orderId:t,applyId:r,appealId:n};try{yield(0,T.appealCancel)(s),B.$router.goto(`${_.PROTOCOL_PRES[0]}order/applyrefund/detail?orderId=${t}&stackId=${o}&need_type=redirectTo`)}catch(e){I.log.warn("<RefundDetail>取消申请失败",e)}}))},goBack(){B.$router.triggerBack("detail-getRefundDetailV2")},handleNewStyleVariable(e=[]){var t,o;let a=!1,r="退款详情",n="top-title",s="margin: 0; border-radius: 0; padding: 10rpx 22rpx 10rpx 30rpx",i="font-size: 24rpx;",d="sectionOtherV2";return e.length&&(null==(o=null==(t=e[0])?void 0:t.simpleStackReverseProgressNodeList)?void 0:o.length)&&(a=!0,r=e[0].stackReverseProgressNodeTitle,s="margin: 0 18rpx 18rpx; padding: 10rpx 10rpx 10rpx 18rpx; z-index: 10",i="font-size: 26rpx;",n="top-title top-title-new",d="sectionOtherV2 detail-container"),{showNewStyle:a,title:r,titleClass:n,noticeBoardStyle:s,noticeBoardTextStyle:i,detailContainerClass:d}},handleMoreProcess(e){const{num:t}=e.target.dataset,{detailList:o}=this.data;(0===t||t)&&(o[t].showMoreProcess=!o[t].showMoreProcess,this.setData({detailList:o}))},handleShowScrollTitle(e){const{isWhiteTitle:t,showNewStyle:o}=this.data;if(o){const o=40,{scrollTop:a}=e.detail;a>o&&!t?this.setData({isWhiteTitle:!0}):a<=o&&t&&this.setData({isWhiteTitle:!1})}},getNoticeInfoData(e={},t=""){const{orderId:o,stackId:a}=this.data,r={infoLine:3,orderId:o,stackId:a};return t?{noticeBoardInfo:m(f({},r),{msg:t}),isShowNoticeBoard:!0}:e?{noticeBoardInfo:f(f({},r),e),isShowNoticeBoard:!0}:{isShowNoticeBoard:!1,noticeBoardInfo:{}}},refundApplyVerify(){return y(this,null,(function*(){try{const{orderId:e,stackSkuInfo:t,stackId:o}=this.data,a=f({orderId:e,skuId:t.skuId,stackId:o,refundApplyPageSource:R.REFUND_APPLY_PAGE_SOURCE.REFUND_DETAIL_PAGE,refundApplyType:R.REFUND_APPLY_TYPE.REFUND_APPLY,refundQuantity:t.reversableQuantity},B.$systemInfo.getLocation());return S.refundApplyVerify(a)}catch(e){I.log.error("<RefundDetail> refundApplyVerify",JSON.stringify(e))}}))},refundApplyVerifyRes2ExtractInfo(e){try{const{title:t,oldStatus:o,contentText:a}=e;return{title:t,status:o,subTitle:a}}catch(e){return I.log.warn(e),{}}}});