function e(e){return e&&e.__esModule?e:{default:e}}var t=e(require("./d8.js")),n=e(require("./nt.js")),s=e(require("./ku.js")),a=new t.default;Component({options:{},properties:{style:{type:String}},props:{inferenceevent:function(){}},data:{isShow:"none",requestCode:"xxxx",type:"",action:"login",imgurl:"",titleUrl:"",cn:0,msgType:3,refreshIcon:"https://s3plus.meituan.net/v1/mss_f231eb419c414559a1837748d11d4312/yoda-resources/inference/refresh.png",closeIcon:"https://s3plus.meituan.net/v1/mss_f231eb419c414559a1837748d11d4312/yoda-resources/inference/close.png",wxsProp:0,sendStatus:0},externalClasses:["inference-wrapper"],methods:{init:function(){var e=this.createSelectorQuery(),t=[],s=[];e.select("#yoda-inference").boundingClientRect((function(e){t.push([e.width,e.height]),s.push([Number(e.left.toFixed(3)),Number(e.top.toFixed(3))])})),e.select("#yoda-img").boundingClientRect((function(e){t.push([e.width,e.height]),s.push([Number(e.left.toFixed(3)),Number(e.top.toFixed(3))])})),e.exec((function(){var e=wx.getSystemInfoSync(),a=e.screenWidth>e.screenHeight?"v":"h";n.default.initSDK(t,s,a)}))},showInference:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=t.requestCode,a=t.appletsfp,i=this;this.yodaUrl=getApp().globalData.yodaUrl||"https://verify.meituan.com";var o=wx.getSystemInfoSync().SDKVersion;"undefined"!=typeof mmp||i.compareVersion(o,"2.11.0")>=0?(n.default.firstInit(),i.setData({imgurl:"",msgType:3,isShow:"block"}),wx.showLoading({title:"加载中"}),wx.getStorage({key:"yoda_component_data",success:function(e){var t=e.data;i.initData({requestCode:s,appletsfp:a,data:t})},fail:function(){e.verifyFail({code:999130,message:"获取推理组件data失败"}),e.setData({isShow:"none"})}}),"undefined"!=typeof mmp&&mmp.getRiskControlFingerprint({success:function(t){var n=t.fingerprint;e.setData({fp:n})}})):wx.showModal({title:"提示",content:"当前微信版本过低，无法使用该功能，请升级到最新微信版本后重试。"})},initData:function(e){var t=e.requestCode,n=e.appletsfp,s=e.data;this.setData({category:s.category,action:s.action,type:s.type,listIndex:s.listIndex,requestCode:t,appletsfp:n}),this.info()},info:function(){var e=this,t=this,s=this.data,i=s.requestCode,o=s.type,r=s.action,c=s.fp,u={};"undefined"!=typeof mmp&&(u.fingerprint=c),a.sendInfo({request_code:i,type:o,action:r,options:u}).then((function(s){var a=s.status,o=s.error,r=s.data;if(1===a){var c=r.prompt,u=c.items[1]||"",f=c.cn,d=c.items[0],p=c.hint,l=c.message;n.default.resetPoint(0);var g=3;u&&(g=-1,t.base64ToImage(u,(function(t){e.setData({titleUrl:t})}))),e.setData({message:l,cn:f,wxsProp:f,msgType:g,rotateClass:"",sendStatus:0}),t.exectuCanvas(d,p,i),t.init()}else{var m=o.code,h=o.message,v=0;121038===m&&(v=2),t.setData({errorMsg:h,msgType:v,rotateClass:"",sendStatus:0}),setTimeout((function(){t.verifyFail(o)}),2e3)}wx.hideLoading()})).catch((function(){wx.hideLoading(),t.setData({errorMsg:"您的网络状况不好",msgType:0,rotateClass:""}),setTimeout((function(){t.verifyFail({code:"00102",message:"您的网络状况不好"})}),2e3)}))},verify:function(){var e=this;wx.showLoading({title:"加载中"});var t=e.data,n=t.requestCode,i=t.type,o=t.action,r=t.bv,c=t.fp,u=t.appletsfp,f=t.listIndex,d={bv:r};"undefined"!=typeof mmp&&(d.fingerprint=c),u&&(d.appletsfp=u),(f||0===f)&&(d.listIndex=f);var p=s.default.c(n);p&&(d.d=p),a.verify({request_code:n,type:i,action:o,options:d}).then((function(t){wx.hideLoading();var n=t.status,s=t.data,a=t.error;if(1===n)e.setData({msgType:1,wxsProp:0}),setTimeout((function(){e.verifySuccess(s)}),1e3);else{var i=a.code,o=a.message;e.setData({errorMsg:o,msgType:0,wxsProp:0,sendStatus:1}),121079===i?setTimeout((function(){e.info()}),1e3):setTimeout((function(){e.verifyFail(a)}),2e3)}})).catch((function(){wx.hideLoading(),e.setData({errorMsg:"您的网络状况不好",msgType:0}),setTimeout((function(){e.verifyFail({code:"00102",message:"您的网络状况不好"})}),2e3)}))},verifySuccess:function(e){var t=this,n=e?e.response_code:"",s=e?e.nextVerifyMethodId:"",a=e&&e.origin_request_code?e.origin_request_code:t.data.requestCode;wx.showToast({title:"验证成功",content:"验证成功",complete:function(){var e={status:1,requestCode:a,responseCode:n,nextVerifyMethodId:s};t.triggerEvent?t.triggerEvent("inferenceevent",e,{bubbles:!0,composed:!0}):t.props.inferenceevent(e),t.setData({isShow:"none"})}})},verifyFail:function(e){this.setData({isShow:"none"});var t={status:0,code:e.code,msg:e.message,requestCode:e.request_code};this.triggerEvent?this.triggerEvent("inferenceevent",t,{bubbles:!0,composed:!0}):this.props.inferenceevent(t)},onrefresh:function(){0===this.data.sendStatus&&(this.setData({sendStatus:1}),this.setData({wxsProp:0,rotateClass:"animation-rotate"}),this.info())},onclose:function(){this.setData({wxsProp:0});this.verifyFail({code:"000333",message:"主动关闭验证流程"})},oncancel:function(e){var t=e.currentTarget.dataset.id-1;n.default.resetPoint(t)},nextSubmit:function(){var e=this,t=e.data.requestCode;setTimeout((function(){var s=n.default.getbv(t);e.setData({bv:s}),e.verify()}),10)},ontouchstart:function(e){n.default.canvasTouchstart(e)},ontouchend:function(e){var t=this,s=t.data.cn;n.default.canvasTouchend(e,s,t.nextSubmit.bind(t))},onGlobaTouchstart:function(e){n.default.globaTouchstart(e)},onGlobaTouchend:function(e){n.default.globaTouchend(e)},exectuCanvas:function(e,t,s){var a=this;this.createSelectorQuery().select("#canvas").fields({node:!0,size:!0}).exec((function(i){i[0]&&a.base64ToImage(e,(function(e){n.default.draw(i[0],e,t,s,(function(t){if("undefined"!=typeof mmp)wx.canvasToTempFilePath({destWidth:536,destHeight:357,canvas:i[0].node,success:function(e){var t=e.tempFilePath;a.setData({imgurl:t})},fail:function(e){}});else{var n=t.toDataURL("image/png",1);a.setData({imgurl:n})}wx.getFileSystemManager().unlink({filePath:e,success:function(){},fail:function(e){}})}))}))}))},base64ToImage:function(e,t){var n=wx.getFileSystemManager(),s="tmpbase64src"+Math.random().toString(36).substring(2),a=wx.env.USER_DATA_PATH+"/"+s;n.writeFile({filePath:a,data:e,encoding:"base64",success:function(){t(a)},fail:function(e){}})},compareVersion:function(e,t){for(var n=e.split("."),s=t.split("."),a=Math.max(n.length,s.length);n.length<a;)n.push("0");for(;s.length<a;)s.push("0");for(var i=0;i<a;i++){var o=parseInt(n[i],10),r=parseInt(s[i],10);if(o>r)return 1;if(o<r)return-1}return 0},changeVerify:function(){a.changeVerify()}}});