var e=Object.defineProperty,t=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,o=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,r=(e,r)=>{for(var i in r||(r={}))s.call(r,i)&&o(e,i,r[i]);if(t)for(var i of t(r))a.call(r,i)&&o(e,i,r[i]);return e},i=(e,t,s)=>new Promise(((a,o)=>{var r=e=>{try{c(s.next(e))}catch(e){o(e)}},i=e=>{try{c(s.throw(e))}catch(e){o(e)}},c=e=>e.done?a(e.value):Promise.resolve(e.value).then(r,i);c((s=s.apply(e,t)).next())})),c=require("./a6.js"),l=getApp();function n(e){return new Promise((t=>{setTimeout(t,e)}))}var d=[{label:"综合排序",value:0},{label:"销量从高到低",value:5}];Component(new class{constructor(){this.isRequested=!1,this.methods={trySendInitialRequest(){!this.isRequested&&this.checkParamsReady()&&(this.isRequested=!0,this.getFilterList(),this.fetchScreenData())},checkParamsReady(){const{promotionId:e,couponCode:t,isCoupon:s}=this.data;return"addon"===this.data.source?0!==e&&!s:!(0===e||0===t||!s)},toggle(e){const{categoryStatus:t,orderStatus:s,screenStatus:a,showQuickFilter:o}=this.data;if(this.disabledToggle)return;if(o===e)return;if(t.isFold||s.isFold||a.isFold)return;const{hasPriceSelector:r}=this.data;let i;if(i=(r?88:0)+("addon"===this.data.source?100:72),e){i+=88}this.setData({showQuickFilter:e,blankHeight:`${i}rpx`},(()=>{this.disabledToggle=!0,setTimeout((()=>{this.disabledToggle=!1}),500)}))},pageScroll(e){return i(this,null,(function*(){const{windowHeight:t}=this.data,{scrollTop:s}=e,{top:a}=yield this.getRect(".blank"),{height:o}=yield this.getRect(".top"),{height:r}=yield this.getRect(".page-container",!1);let i=a>o;s<=0&&(i=!0),this.lastTop=a,t<r&&a<=t-r||this.toggle(i)}))},getRect(e,t=!0){const s=t?this.createSelectorQuery():wx.createSelectorQuery();return new Promise((t=>{s.select(e).boundingClientRect((e=>{t(e||{})})).exec()}))},emitEvent(){const{selectedIndex:e,categoryStatus:t,orderStatus:s,screenStatus:a,extensions:o,filterItems:i}=this.data,c={promotionListRequestBody:r({excludeSkuIds:[],aggregationItemList:a.aggregationItemList,filterItem:i[e],extensions:o},this.data.options),orderBy:s.selectedOrder};t.selectedLevel2Id&&(c.categoryId=t.selectedLevel2Id),this.triggerEvent("search",c)},_clearScreenData(){return i(this,null,(function*(){return new Promise((e=>{this.setData({"screenStatus.aggregationItemList":[],selectedIndex:0,priceScrollLeft:0},e)}))}))},fetchScreenData(){const e={poiId:l.$poiId,poiIdStr:l.$poiIdStr},{isCoupon:t,promotionId:s,couponCode:a}=this.data;t?(e.couponId=s,e.couponCode=a):e.promotionId=s;const{categoryStatus:o}=this.data;o.selectedLevel2Id&&(e.categoryId=o.selectedLevel2Id),c.searchResultScreen(e,this.data.options).then((e=>{const t="addon"===this.data.source?"180rpx":this.data.hasTitle?"152rpx":"52rpx";this.setData({screenData:e,filterItems:e.filterItems||[],hasPriceSelector:!1,blankHeight:t})}))},getFilterList(e){const t=getApp(),s={poiId:t.$poiId,poiIdStr:t.$poiIdStr},{isCoupon:a,promotionId:o}=this.data;a?s.couponId=o:s.promotionIds=[o],c.getFilterList(s,this.data.options).then((e=>{const{userCategoryBuckets:t=[]}=e;t.length&&(this._formatFilterData(t),this.setData({categoryList:t,subCategoryList:this.cache_data[this.data.categoryStatus.selectedLevel1Id]}))})).catch((e=>{t.page().toast(e.message||"获取分类列表失败!")}))},_categoryClickCb(){return i(this,null,(function*(){yield this._clearScreenData(),this.emitEvent(),this.fetchScreenData(),yield n(200),this.closeSelector("category")}))},onCategoryClick(e){const{id:t,name:s,level:a}=e.currentTarget.dataset;1===a&&this.setData({"categoryStatus.isInit":!1,"categoryStatus.selectedLevel1Id":t,"categoryStatus.selectedLevel1Name":s,"categoryStatus.selectedLevel2Id":0==+t?0:"","categoryStatus.selectedLevel2Name":"全部分类",subCategoryList:this.cache_data[t]||[]},(()=>i(this,null,(function*(){0===t&&(l.$lxLog.mc("b_youxuan_kgen5ito_mc"),this._categoryClickCb())})))),2===a&&this.setData({"categoryStatus.selectedLevel2Id":t,"categoryStatus.selectedLevel2Name":s},(()=>i(this,null,(function*(){this._categoryClickCb()}))))},_formatFilterData(e){e.forEach((e=>{const{subUserCategoryBuckets:t=[]}=e;this.cache_map[e.userCategoryId]={name:e.userCategoryName},t.forEach((e=>{this.cache_map[e.userCategoryId]={name:e.userCategoryName}})),t.unshift({userCategoryId:e.userCategoryId,userCategoryName:`全部${e.userCategoryName}`,count:e.count}),this.cache_data[e.userCategoryId]=t})),this.cache_data[0]=[{userCategoryId:0,userCategoryName:"",count:0}],e.unshift({userCategoryId:0,userCategoryName:"全部分类",count:0,subUserCategoryBuckets:this.cache_data[0]})},onSearchOptions(e){const{field:t,options:s}=e.detail;switch(t){case"options":{const e={index_id:s.index,feature:s.feature,feature_name:s.featureName,feature_index:s.featureIndex};s&&s.is_selected,l.$lxLog.mc("b_youxuan_p7fg6y2s_mc",e);break}case"onOk":l.$lxLog.mc("b_youxuan_9opgrvfq_mc");break;case"reset":l.$lxLog.mc("b_youxuan_ghhog9uy_mc")}},onScreenChange(e){const{aggregationItemList:t}=e.detail;t&&this.setData({"screenStatus.aggregationItemList":t,"screenStatus.isFold":!1},(()=>{this.emitEvent()}))},selectOrder(e){const{selectedOrder:t}=this.data.orderStatus,{value:s,label:a}=e.currentTarget.dataset;switch(this.setData({"orderStatus.isInit":!1,"orderStatus.selectedOrder":s,"orderStatus.selectedLabel":a},(()=>i(this,null,(function*(){t!==s&&this.emitEvent(),yield n(200),this.closeSelector("order")})))),s){case 0:case 5:default:break;case 1:l.$lxLog.mc("b_chaoshi_ho33ekfa_mc");break;case 2:l.$lxLog.mc("b_chaoshi_17y234y5_mc")}},selecteItem(e){const{selectedIndex:t,filterItems:s}=this.data,{index:a}=e.currentTarget.dataset,o=s[a];l.$lxLog.mc("b_youxuan_q1ckg5lr_mc",{title:o.text,index_id:a,type:o.type}),this.setData({selectedIndex:a},(()=>i(this,null,(function*(){t!==a&&this.emitEvent()}))))},closeLayer(){this.setData({"categoryStatus.selectedLevel1Id":0,"categoryStatus.selectedLevel1Name":"全部分类","categoryStatus.selectedLevel2Id":0,"categoryStatus.selectedLevel2Name":"全部分类",subCategoryList:this.cache_data[0]||[]}),this.data.categoryStatus.isFold,this.closeSelector("category"),this.closeSelector("order")},openSelector(e){const t={};t[`${e}Status.isFold`]=!0,this.setData(t)},closeSelector(e){return i(this,null,(function*(){if(!this.data[`${e}Status`].isFold)return;const t={};t[`${e}Status.isFold`]=!1,this.setData(t),yield n(400)}))},orderSku(e){return i(this,null,(function*(){const{type:t}=e.currentTarget.dataset;switch(t){case"category":{l.$lxLog.mc("b_youxuan_kgen5ito_mc");const{categoryStatus:e}=this.data;e.isFold?this.closeSelector("category"):(yield this.closeSelector("screen"),yield this.closeSelector("order"),this.openSelector(t));break}case"order":{l.$lxLog.mc("b_youxuan_4yec7uh8_mc");const{orderStatus:e}=this.data;e.isFold?this.closeSelector("order"):(yield this.closeSelector("screen"),yield this.closeSelector("category"),this.openSelector(t));break}case"screen":{l.$lxLog.mc("b_youxuan_jd2eptso_mc");const{screenStatus:e}=this.data;e.isFold?this.closeSelector("screen"):(yield this.closeSelector("category"),yield this.closeSelector("order"),this.openSelector(t));break}}}))},updateHasTitle(){const e="addon"===this.data.source?"180rpx":this.data.hasTitle?"152rpx":"52rpx";this.setData({blankHeight:e})}},this.properties={promotionId:{type:Number,value:0,observer(e){this.cache_data||(this.cache_data={},this.cache_map={});const{windowHeight:t}=l.getModule("systemInfo").getScreenInfo();setTimeout((()=>{this.setData({windowHeight:t})}),500),0!==e&&this.trySendInitialRequest()}},couponCode:{type:Number,value:0,observer(e){0!==e&&this.trySendInitialRequest()}},extensions:{type:String,value:""},isCoupon:{type:Boolean,value:!1,observer(e){e&&this.trySendInitialRequest()}},options:{type:Object,value:{}},source:String,hasTitle:{type:Boolean,value:!1,observer(){this.updateHasTitle()}}},this.data={orders:d,blankHeight:"152rpx",hasPriceSelector:!1,showQuickFilter:!0,screenData:null,categoryList:null,subCategoryList:null,filterItems:[],selectedIndex:0,categoryStatus:{selectedLevel1Id:0,selectedLevel1Name:"全部分类",selectedLevel2Id:0,selectedLevel2Name:"全部分类",isFold:!1,isInit:!0},orderStatus:{selectedOrder:0,selectedLabel:"综合排序",isFold:!1,isInit:!0},screenStatus:{isFold:!1,aggregationItemList:[]}}}});