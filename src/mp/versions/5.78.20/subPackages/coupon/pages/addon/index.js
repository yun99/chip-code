var t=Object.create,e=Object.defineProperty,o=Object.defineProperties,i=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertyNames,n=Object.getOwnPropertySymbols,r=Object.getPrototypeOf,l=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,c=(t,o,i)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[o]=i,p=(t,e)=>{for(var o in e||(e={}))l.call(e,o)&&c(t,o,e[o]);if(n)for(var o of n(e))u.call(e,o)&&c(t,o,e[o]);return t},m=(t,e)=>o(t,a(e)),h=o=>{return((t,o,a)=>{if(o&&"object"==typeof o||"function"==typeof o)for(let n of s(o))l.call(t,n)||"default"===n||e(t,n,{get:()=>o[n],enumerable:!(a=i(o,n))||a.enumerable});return t})((a=e(null!=o?t(r(o)):{},"default",o&&o.__esModule&&"default"in o?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0}),e(a,"__esModule",{value:!0})),o);var a},d=(t,e,o)=>new Promise(((i,a)=>{var s=t=>{try{r(o.next(t))}catch(t){a(t)}},n=t=>{try{r(o.throw(t))}catch(t){a(t)}},r=t=>t.done?i(t.value):Promise.resolve(t.value).then(s,n);r((o=o.apply(t,e)).next())})),f=h(require("../../../../er.js")),y=h(require("../../../../a4.js")),g=h(require("../../a5.js")),x=h(require("../../a7.js")),v=h(require("../../../../ob.js")),C=h(require("../../../../a8.js")),P=h(require("../../../../is.js")),D=h(require("../../a6.js")),S=getApp();(0,f.default)({data:{schema:(0,x.default)(),skuType:C.ListTypes.couponAddon,giftSkuList:[],promotion:{},skuList:[],isEnd:!1,canRefresh:!0,isShowGift:!1,exchangeItems:[],hasExchangeCount:0,totalExchangeCount:0,unValid:!1,firstTime:!0,isRedemption:!1,closeToCart:!1,detail:{},extensions:"",isCheapBuyPopupShow:!1,cheapBuyPopupData:{},isClickSearch:!1,showNoData:!1},pagination:{offset:-30,limit:30,total:0},promotionHandelList:["promotion/cheap_buy","promotion/order_buy"],onLoad(t){C.default.registerLxOperator(C.ListTypes.couponAddon,{[C.LxEventTypes.CardClick]:"b_youxuan_oow6kx08_mc",[C.LxEventTypes.CardView]:"b_youxuan_oow6kx08_mv",[C.LxEventTypes.AddCartClick]:"b_youxuan_g53moou0_mc",[C.LxEventTypes.DecreaseCartClick]:"b_youxuan_md1orotl_mc",[C.LxEventTypes.SpecPopupShowClick]:"b_youxuan_z3uwm6eb_mc",[C.LxEventTypes.SpecPopupSkuView]:"b_youxuan_cs76cc3l_mv",[C.LxEventTypes.SpecPopupAddCartClick]:"b_youxuan_p48uu3yn_mc",[C.LxEventTypes.SpecPopupEditAttrClick]:"b_youxuan_jnnorvzu_mc",[C.LxEventTypes.SpecPopupRemindClick]:"b_youxuan_e7144n6n_mc"}),"auto_popup"in t&&this.setData({isRedemption:!0}),this.title=t.promotion_title,this.promotionId=t.promotion_id,this.source=t.source,this.commonParam=t.commonParam||null,this.trafficSourceData=t.trafficSource?{trafficSource:t.trafficSource}:{},this.setData({skuProxyData:{jumpOptions:this.trafficSourceData},queryParams:this.trafficSourceData,options:{commonParam:this.commonParam}}),v.log.info("【【【【【【addon page】】】】】】")},onShow(){},onPoiInfoUpdated(){this.initData()},onUnload(){},onPullDownRefresh(){this.data.isShowGift&&this.setData({isShowGift:!1}),this.initData(!0),wx.stopPullDownRefresh()},onReachBottom(){this.data.isShowGift||this.data.isClickSearch&&this.data.isEnd||this.loadMoresku(),this.data.isClickSearch&&this.setData({isClickSearch:!1})},search(t){const{detail:e}=t;this.pagination=m(p({},this.pagination),{offset:0}),this.setData({detail:e,isClickSearch:!0,isEnd:!1},(()=>{this.fetchSkuList(!0)}))},onPageScroll(t){var e;const o=this.selectComponent("#filter");null==(e=null==o?void 0:o.pageScroll)||e.call(o,t)},initData(t){return d(this,null,(function*(){this.data.showNoData&&this.setData({showNoData:!1}),this.pagination={offset:-30,limit:30,total:0},this.setData({isEnd:!1,cartNum:0,canRefresh:!0,promotionId:this.promotionId}),yield this.loadPromotionInfo(),this.loadMoresku(!0,t),this.data.isRedemption&&this.fetchRedemptionSku()}))},onCheapBuyPopupClose(t){var e,o;if(!t)return;const i=!this.data.isCheapBuyPopupShow,a=null==(o=null==(e=this.data.promotion)?void 0:e.clickUrl)?void 0:o.url,s=m(p({},function(t){const e={},o=/([^&=]+)=([^&]*)/g;let i;for(;i=o.exec(t);)e[decodeURIComponent(i[1])]=decodeURIComponent(i[2]);return e}(null==a?void 0:a.split("?")[1])),{promotionHandel:this.getPromotionHandel(a)});this.setData(Object.assign({isCheapBuyPopupShow:i},i?{cheapBuyPopupData:s}:{}))},getPromotionHandel(t){var e;return(null==(e=this.promotionHandelList.filter((e=>new RegExp(e).test(t))))?void 0:e[0])||"promotion/cheap_buy"},onCommonOperateCart(t){return d(this,null,(function*(){yield S.$cart.operateCart(t.detail),yield this.loadPromotionInfo()}))},toggleGift(t){var e,o,i,a;const{isRedemption:s,isShowGift:n,firstTime:r,closeToCart:l,promotion:u}=this.data,c=null==(e=null==u?void 0:u.clickUrl)?void 0:e.url;this.promotionHandelList.filter((t=>new RegExp(t).test(c))).length?this.onCheapBuyPopupClose(t):c?S.$router.goto(c):(s&&!n&&!r&&this.fetchRedemptionSku(),null==(o=S.$cat)||o.reportCustomMetrics(P.YXReportTarget.ADDON,1,{type:"老换购弹窗"}),s&&l&&"cart"===this.source&&("close"===(null==(i=null==t?void 0:t.detail)?void 0:i.source)?this.setData({closeToCart:!1}):"button"===(null==(a=null==t?void 0:t.detail)?void 0:a.source)&&S.$router.triggerBack("coupon-addon-toggleGift")),("cart"===this.source||"cart"!==this.source&&!r||"cart"!==this.source&&!s)&&this.setData({isShowGift:!n}))},onAddToCartCompletely(){this.loadPromotionInfo()},loadPromotionInfo(){return d(this,null,(function*(){if(getApp().page().route===this.route)try{const t=yield D.getPromotionInfo(this.promotionId,{commonParam:this.commonParam}),e=(0,g.parse)(t.addOnDesc),o=t.giftItemsInfo||[],i=[];o.forEach((t=>{t.giftItems.forEach((e=>{i.push(m(p({},e),{promotionCurRule:t.promotionCurRule,valid:t.valid}))}))})),t.addOnTitle&&this.setCustomStyle({__navigationBarTitle__:{title:t.addOnTitle}}),this.setData(p({promotion:m(p({},t),{addOnDesc:e}),giftSkuList:i},this.data.extensions?{}:{extensions:t.extensions}))}catch(t){}}))},loadMoresku(t,e){const o=this.pagination.offset+this.pagination.limit;this.data.isEnd?this.toast({message:"没有更多商品了"}):(this.loading({show:!e}),this.pagination=m(p({},this.pagination),{offset:o}),this.fetchSkuList(t))},fetchSkuList(t=!1){const{detail:e}=this.data;D.getSkuPromotion(p({offset:this.pagination.offset,limit:this.pagination.limit,promotionId:this.promotionId,promotionListRequestBody:{excludeSkuIds:t?[]:this.data.skuList.map((t=>t.skuId)),aggregationItemList:[],priceItems:{highPrice:-1,lowPrice:-1},extensions:this.data.extensions,commonParam:this.commonParam}},e)).then((e=>{e.offset+e.limit>=e.total&&this.setData({isEnd:!0});const o=(0,y.parseStyle)(e.styleMap||{},e.itemList);let i=!1;t&&0===o.length&&(i=!0),this.setData({skuList:t?o:this.data.skuList.concat(o),showNoData:i},(()=>{t&&wx.pageScrollTo({scrollTop:0}),S.$cart.emitUpdateSkuCount()})),this.loading(!1)}))},fetchRedemptionSku(){return d(this,null,(function*(){try{const t=yield D.getRedemptionAddonInfo(this.promotionId),e=t.levels.every((t=>!t.valid));this.setData({exchangeItems:(null==t?void 0:t.levels)||[],hasExchangeCount:(null==t?void 0:t.hasExchangeCount)||0,totalExchangeCount:(null==t?void 0:t.totalExchangeCount)||0,unValid:e}),!e&&this.data.firstTime&&(this.setData({closeToCart:!0}),this.toggleGift()),this.data.firstTime&&this.setData({firstTime:!1})}catch(t){}}))}});