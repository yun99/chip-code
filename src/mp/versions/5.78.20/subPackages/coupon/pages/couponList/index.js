var t=Object.create,e=Object.defineProperty,o=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,i=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,n=n=>{return((t,i,n)=>{if(i&&"object"==typeof i||"function"==typeof i)for(let r of s(i))a.call(t,r)||"default"===r||e(t,r,{get:()=>i[r],enumerable:!(n=o(i,r))||n.enumerable});return t})((r=e(null!=n?t(i(n)):{},"default",n&&n.__esModule&&"default"in n?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0}),e(r,"__esModule",{value:!0})),n);var r},r=(t,e,o)=>new Promise(((s,i)=>{var a=t=>{try{r(o.next(t))}catch(t){i(t)}},n=t=>{try{r(o.throw(t))}catch(t){i(t)}},r=t=>t.done?s(t.value):Promise.resolve(t.value).then(a,n);r((o=o.apply(t,e)).next())})),u=n(require("../../../../er.js")),c=n(require("../../../../p0.js")),l=n(require("../../../../u8.js")),d=n(require("../../../../ob.js")),p=n(require("../../../../is.js")),h=n(require("../../sh.js")),C=n(require("../../sk.js")),L=n(require("../../sj.js")),S=n(require("../../sl.js")),{subscribe:T}=require("../../../../sz.js"),m=getApp();(0,u.default)((0,C.default)({data:{isPageLoaded:!1,validCouponList:[],usedCouponList:[],invalidCouponList:[],recmmondCouponList:[],invalidLabel:"",COPYWRITING:S.COPYWRITING,CURRENTSTATUS:S.CURRENTSTATUS,validTotal:0,usedTotal:0,invalidTotal:0,isGetRemmond:!1,tab:1,top:0,noticeBoardInfo:{},isShowMember:!1,showCityScopePop:!1,cityScope:""},isMMP:!!(0,c.isMMP)(),isCanGoBack:!0,isShowConfirm:!0,__isCouponList:!0,__firstLoad:{noUsedCouponList:!1,usedCouponList:!1,invalidCouponList:!1,availableCouponList:!1,loadEntranceInfo:!1},__report:null,onShow(){},onHide(){},onLoad(t){return r(this,null,(function*(){this._startTime=t.__RST,this._fromUserCenter=t.fromUserCenter||0,this.onLoadReport(),this.__report=new h.Report(this,m),t&&t.tab&&this.setData({tab:1*t.tab})}))},onPoiInfoUpdated(){return r(this,null,(function*(){this.firstLoad()}))},onReady(){},firstLoad(){this.loading(!0);this.getPreFetchedData().catch((t=>{d.log.info(`<couponList> 没有预拉取，${JSON.stringify(t)}`);return[L.couponListService.fetchUserCouponList(this.data.tab),L.couponListService.fetchAvailableCouponList("1"),L.couponListService.fetchLoadEntranceInfo()]})).then((t=>{this.loading(!1),t[0].then((t=>this.setUserCouponList(t,this.data.tab))),t[1].then((t=>this.setAvailableCouponList(t))),t[2].then((t=>this.setLoadEntranceInfo(t)))})).catch((t=>{d.log.warn(`<couponList> 首屏请求失败，${JSON.stringify(t)}`),this.loading(!1)}))},judgeSecondLoad(t){return r(this,null,(function*(){if(this.data.isPageLoaded)return;const{tab:e}=this.data;if(e===S.CURRENTSTATUS.NO_USE&&!this.__firstLoad.noUsedCouponList||e===S.CURRENTSTATUS.USED&&!this.__firstLoad.usedCouponList||e===S.CURRENTSTATUS.INVALID&&!this.__firstLoad.invalidCouponList||!this.__firstLoad.availableCouponList||!this.__firstLoad.loadEntranceInfo)return;this.setData({isPageLoaded:!0},(()=>{d.log.info(`【优惠券页】isPageLoaded setData，值为 ${this.data.isPageLoaded}, 当前时间：${Date.now()}`)})),d.log.info(`【优惠券页】发起非首屏请求，scene 为 ${t}，当前tab为：${e}，isPageLoaded为${this.data.isPageLoaded}，__firstLoad为：${JSON.stringify(this.__firstLoad)}, 当前时间：${Date.now()}`);const o=this.getLoadMap(e);Promise.all([L.couponListService.fetchUserCouponList(o[0]),L.couponListService.fetchUserCouponList(o[1])]).then((t=>{this.setUserCouponList(t[0],o[0]),this.setUserCouponList(t[1],o[1])}))}))},getLoadMap(t){let e=[S.CURRENTSTATUS.NO_USE,S.CURRENTSTATUS.USED,S.CURRENTSTATUS.INVALID];return e=e.filter((e=>e!==t)),e},setAvailableCouponList(t,e){const o=e?[]:this.data.recmmondCouponList;try{const{couponList:e,total:s}=t;e&&e.length?(e.forEach((t=>{o.push(t)})),this.setData({recmmondCouponList:o,isGetRemmond:10===e.length},(()=>{this.__firstLoad.availableCouponList=!0,this.judgeSecondLoad("available-setData-1")}))):this.setData({isGetRemmond:!1},(()=>{this.__firstLoad.availableCouponList=!0,this.judgeSecondLoad("available-setData-2")})),this.__report.checkReport(h.REPORT_TYPE.COUPONLIST_RECOMMEND_COUPON_COUNT,s)}catch(t){this.toast({message:t&&t.message||"获取优惠券失败，请稍后重试"}),this.__firstLoad.availableCouponList=!0,this.judgeSecondLoad("available-catch")}},setUserCouponList(t,e){return r(this,null,(function*(){try{const{validCouponList:o,usedCouponList:s,invalidCouponList:i}=this.data,{userCouponList:a,invalidLabel:n,total:r}=t;if(a&&a.length&&a.forEach((t=>{t.status===S.COUPONSTATUS.VALID_NOUSE?o.push(t):t.status===S.COUPONSTATUS.VALID_USED?s.push(t):t.status!==S.COUPONSTATUS.INVALID&&t.status!==S.COUPONSTATUS.RECOVERY||i.push(t)})),e===S.CURRENTSTATUS.NO_USE){if(this.setData({validTotal:r,validCouponList:[...o],invalidLabel:n},(()=>{this.FMPReport(),this.__firstLoad.noUsedCouponList=!0,this.judgeSecondLoad("unused-setData")})),this.selectComponent("#coupon-valid")&&this.selectComponent("#coupon-valid").data.showRec&&this.data.recmmondCouponList&&this.data.recmmondCouponList.length){const t=yield L.couponListService.fetchAvailableCouponList(this.data.recmmondCouponList[this.data.recmmondCouponList.length-1].couponConfigId);this.setAvailableCouponList(t)}this.__report.checkReport(h.REPORT_TYPE.COUPONLIST_UNUSED_COUPON_COUNT,r)}e===S.CURRENTSTATUS.USED&&(this.setData({usedTotal:r,usedCouponList:[...s]},(()=>{this.__firstLoad.usedCouponList=!0,this.judgeSecondLoad("used-setData")})),this.__report.checkReport(h.REPORT_TYPE.COUPONLIST_USED_COUPON_COUNT,r)),e===S.CURRENTSTATUS.INVALID&&(this.setData({invalidTotal:r,invalidCouponList:[...i]},(()=>{this.__firstLoad.invalidCouponList=!0,this.judgeSecondLoad("invalid-setData")})),this.__report.checkReport(h.REPORT_TYPE.COUPONLIST_INVALID_COUPON_COUNT,r))}catch(t){this.toast({message:t&&t.message||"获取优惠券失败，请稍后重试"}),this.FMPReport(),e===S.CURRENTSTATUS.NO_USE?this.__firstLoad.noUsedCouponList=!0:e===S.CURRENTSTATUS.USED?this.__firstLoad.usedCouponList=!0:e===S.CURRENTSTATUS.INVALID&&(this.__firstLoad.invalidCouponList=!0),this.judgeSecondLoad(`getUserCoupon-catch-${e}`)}}))},goBack(){return r(this,null,(function*(){this.isMMP||(0,l.isWXMT)()?this.back("coupon-newCouponList-goBack"):this.isCanGoBack&&(yield this.onSubscribe())}))},offsetNum(t){switch(t){case S.CURRENTSTATUS.NO_USE:return this.validOffset;case S.CURRENTSTATUS.USED:return this.usedOffset;case S.CURRENTSTATUS.INVALID:return this.invalidOffset;default:return 1}},onSubscribe(){return r(this,null,(function*(){if(this.isCanGoBack=!1,!m.$module.getModule("networkStatus").isConnected||"none"===m.$module.getModule("networkStatus").networkType)return void this.toast("网络异常，请重试");let t=[];if(yield T(["couponReceipted","couponExpiration"],"https://p0.meituan.net/mallimages/b6d7bbdce0b6bf1dd7de3c78facc94a7153432.png").then((e=>{t=e.data,this.isShowConfirm=e.isShowConfirm,this.isShowConfirm?(this.toast("将有大波优惠来袭哦！"),setTimeout((()=>{this.isCanGoBack=!0,this.back("coupon-newCouponList-subscribe-1")}),1e3)):(this.isCanGoBack=!0,this.back("coupon-newCouponList-subscribe-2"))})).catch((t=>{this.isShowConfirm&&this.toast("已取消通知，会错过优惠提醒哦！"),setTimeout((()=>{this.isCanGoBack=!0,this.back("coupon-newCouponList-subscribe-3")}),1e3)})),t.length){const e={userId:m.getModule("user").getUserId(),poiId:m.$poiId,poiIdStr:m.$poiIdStr},o=[];t.forEach((t=>{if("resolve"===t.status){const e={subType:"couponReceipted"===t.type?14:15,bindPushInfo:""};o.push(e)}}));try{o.length&&(yield m.$service.inviteSubscribe(e,{subscribeDetailList:o}))}catch(t){t?d.log.warn(`向后端同步订阅信息失败，信息为：${t.message}`):d.log.warn("向后端同步订阅信息失败，信息为：服务端没有返回err")}}}))},back(t){m.pages().length<=1?m.$router.goto("/pages/index/index"):m.$router.triggerBack(t)},tabClick(t){if(m.$lxLog.mc("b_youxuan_hovgl5vp_mc",{tab_name:1===t.currentTarget.dataset.current?"未使用":2===t.target.dataset.current?"已使用":"已失效"}),this.data.tab===t.currentTarget.dataset.current)return!1;this.setData({tab:t.currentTarget.dataset.current}),wx.pageScrollTo({scrollTop:0,duration:0})},setLoadEntranceInfo(t){try{const e={backgroundColor:t.backgroundColor,btnText:t.btnText,canEnjoyDiscount:t.canEnjoyDiscount,code:t.code,display:t.display,landingPage:t.landingPage,leftIcon:t.leftIcon,reduceAmount:t.reduceAmount,memberCardAmount:t.memberCardAmount,memberCardStatus:t.memberCardStatus,title:t.title};this.setData({isShowMember:t.display,noticeBoardInfo:e,top:t.display?this.data.top+70:this.data.top},(()=>{this.__firstLoad.loadEntranceInfo=!0,this.judgeSecondLoad("loadEntranceInfo-setData")})),this.__report.checkReport(h.REPORT_TYPE.COUPONLIST_MONTHCARD_SHOW_COUNT,t.display?1:0)}catch(t){this.toast({message:t&&t.message||""}),this.__firstLoad.loadEntranceInfo=!0,this.judgeSecondLoad("loadEntranceInfo-catch")}},passNavHeight(t){this.setData({top:1*t.detail+96})},newRecGoods(t){this.setData({recmmondCouponList:t.detail.data})},onPullDownRefresh(){return r(this,null,(function*(){const{tab:t}=this.data,e=[],o=[],s=[];yield L.couponListService.fetchUserCouponList(t,!0).then((i=>{const{userCouponList:a,total:n}=i;a&&a.length&&(a.forEach((i=>{t===S.CURRENTSTATUS.NO_USE&&e.push(i),t===S.CURRENTSTATUS.USED&&o.push(i),t===S.CURRENTSTATUS.INVALID&&s.push(i)})),t===S.CURRENTSTATUS.NO_USE&&(this.setData({validCouponList:[...e],validTotal:n}),L.couponListService.resetOffset(t)),t===S.CURRENTSTATUS.USED&&(this.setData({usedCouponList:[...o],usedTotal:n}),L.couponListService.resetOffset(t)),t===S.CURRENTSTATUS.INVALID&&(this.setData({invalidCouponList:[...s],invalidTotal:n}),L.couponListService.resetOffset(t)))})).catch((t=>{this.toast({message:t&&t.message||"获取优惠券失败，请稍后重试"})}));const i=yield L.couponListService.fetchAvailableCouponList("1");this.setAvailableCouponList(i,!0),wx.stopPullDownRefresh()}))},onReachBottom(){return r(this,null,(function*(){const{tab:t,validCouponList:e,usedCouponList:o,invalidCouponList:s,recmmondCouponList:i,validTotal:a,usedTotal:n,invalidTotal:r}=this.data;e.length<a&&t===S.CURRENTSTATUS.NO_USE&&this.selectComponent("#coupon-valid")&&!this.selectComponent("#coupon-valid").data.showRec&&(L.couponListService.addOffset(t),L.couponListService.fetchUserCouponList(t).then((e=>{this.setUserCouponList(e,t)}))),o.length<n&&t===S.CURRENTSTATUS.USED&&this.selectComponent("#coupon-used")&&!this.selectComponent("#coupon-used").data.showRec&&(L.couponListService.addOffset(t),L.couponListService.fetchUserCouponList(t).then((e=>{this.setUserCouponList(e,t)}))),s.length<r&&t===S.CURRENTSTATUS.INVALID&&this.selectComponent("#coupon-invalid")&&!this.selectComponent("#coupon-invalid").data.showRec&&(L.couponListService.addOffset(t),L.couponListService.fetchUserCouponList(t).then((e=>{this.setUserCouponList(e,t)}))),(t===S.CURRENTSTATUS.NO_USE&&this.selectComponent("#coupon-valid")&&this.selectComponent("#coupon-valid").data.showRec||t===S.CURRENTSTATUS.USED&&this.selectComponent("#coupon-used")&&this.selectComponent("#coupon-used").data.showRec||t===S.CURRENTSTATUS.INVALID&&this.selectComponent("#coupon-invalid")&&this.selectComponent("#coupon-invalid").data.showRec)&&this.data.isGetRemmond&&L.couponListService.fetchAvailableCouponList(i[i.length-1].couponConfigId).then((t=>{this.setAvailableCouponList(t)}))}))},toogleCityScopePop(t){var e;const{showCityScopePop:o}=this.data,s=!o;this.setData({showCityScopePop:s,cityScope:(null==(e=t.detail)?void 0:e.validScopeDetailText)||""})},onLoadReport(){var t,e,o,s,i,a,n;try{const r=Date.now()-this._startTime,u=(null==(i=null==(s=null==(o=null==(e=null==(t=null==this?void 0:this.page)?void 0:t.$rootComp)?void 0:e.$$context)?void 0:o.this)?void 0:s.value)?void 0:i.route)||this.route;null==(a=m.$cat)||a.reportCustomMetrics(p.YXReportTarget.COUPONLIST_ONLOAD_COUNT,p.ReportValue.SUCCESS,{page:u,fromUserCenter:this._fromUserCenter}),null==(n=m.$cat)||n.reportCustomMetrics(p.YXReportTarget.COUPONLIST_ONLOAD_DURATION,r,{page:u,fromUserCenter:this._fromUserCenter})}catch(t){d.log.error("<couponList onLoadReport>",`error: ${JSON.stringify(t)}`)}},FMPReport(){var t,e,o,s,i,a,n;try{if(this._hasReportFMP)return;this._hasReportFMP=!0;const r=Date.now()-this._startTime,u=(null==(i=null==(s=null==(o=null==(e=null==(t=null==this?void 0:this.page)?void 0:t.$rootComp)?void 0:e.$$context)?void 0:o.this)?void 0:s.value)?void 0:i.route)||this.route;null==(a=m.$cat)||a.reportCustomMetrics(p.YXReportTarget.COUPONLIST_FMP_COUNT,p.ReportValue.SUCCESS,{page:u,fromUserCenter:this._fromUserCenter}),null==(n=m.$cat)||n.reportCustomMetrics(p.YXReportTarget.COUPONLIST_FMP_DURATION,r,{page:u,fromUserCenter:this._fromUserCenter})}catch(t){d.log.error("<couponList FMPReport>",`error: ${JSON.stringify(t)}`)}}}));