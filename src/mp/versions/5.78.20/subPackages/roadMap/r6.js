var e=Object.create,t=Object.defineProperty,a=Object.defineProperties,o=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertyNames,i=Object.getOwnPropertySymbols,s=Object.getPrototypeOf,c=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,u=(e,a,o)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[a]=o,d=(e,t)=>{for(var a in t||(t={}))c.call(t,a)&&u(e,a,t[a]);if(i)for(var a of i(t))l.call(t,a)&&u(e,a,t[a]);return e},p=(e,t)=>a(e,n(t)),f=a=>{return((e,a,n)=>{if(a&&"object"==typeof a||"function"==typeof a)for(let i of r(a))c.call(e,i)||"default"===i||t(e,i,{get:()=>a[i],enumerable:!(n=o(a,i))||n.enumerable});return e})((n=t(null!=a?e(s(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0}),t(n,"__esModule",{value:!0})),a);var n},m=f(require("../../u9.js")),h=f(require("../../ob.js")),g=f(require("../../kc.js")),y=f(require("../../p0.js")),D=f(require("./at.js")),M=f(require("./z4.js")),b=getApp();Component({properties:{destAddress:{type:String,value:""},origin:{type:Object,value:null},dest:{type:Object,value:null},defaultMode:{type:null,value:""},modeList:{type:Array,value:["walk","car"]}},data:{scale:14,maxScale:18,minScale:5,currentMode:"",modeListForView:[],ICON_LOCATE:"https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/icon_locate@3x.40f8351.png",routeInfoMap:{},routeStyle:{},markers:[],includePoints:[],polyline:[],errMessage:"",isModeIconLoadFail:!1,isLocateIconLoadFail:!1},created(){this.commonData={routeDetailMap:{walk:{},car:{}},currentLocationMarkerData:{id:1,iconPath:"https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/current-location@3x.758d174.png",width:24,height:24},selfLiftLocationMarkerData:{id:2,width:40,height:48}}},ready(){this.init()},methods:p(d({},m.default),{init(){return e=this,t=null,a=function*(){try{this.initRouteModeIcon(),yield this.getMapMarkersIconPath()}catch(e){this.setDefaultMapMarkers()}finally{this.toFetchRoute()}},new Promise(((o,n)=>{var r=e=>{try{s(a.next(e))}catch(e){n(e)}},i=e=>{try{s(a.throw(e))}catch(e){n(e)}},s=e=>e.done?o(e.value):Promise.resolve(e.value).then(r,i);s((a=a.apply(e,t)).next())}));var e,t,a},onLocate(){h.log.info("====> onLocate"),this.toFetchRoute()},getDefaultMode(e){const{defaultMode:t}=this.data,a=e[0];if("string"==typeof t)return e.indexOf(t)>0?t:a;if((0,g.isObject)(t)){const o=[];e.forEach((e=>{const a=t[e];a&&Object.keys(a).length?o.unshift(e):o.push(e)}));let n="";return o.forEach((e=>{if(n)return;n=e;const a=this.commonData.routeDetailMap[e],o=t[e];if(!o||!Object.keys(o).length)return;Object.keys(o).some((e=>{const t=a[e],{compare:n,value:r}=o[e];return(0,D.compare)(+t,n,+r)}))||(n="")})),n||a}return a},toChangeMode(e){h.log.info("=====>toChangeMode",e.currentTarget.dataset);const{mode:t}=e.currentTarget.dataset;this.changeMode(t)},toScaleMap(e){const{type:t}=e.target.dataset;let{scale:a}=this.data;const{maxScale:o,minScale:n}=this.data;"plus"===t&&a!==o&&a++,"minus"===t&&a!==n&&a--,this.setData({scale:a})},changeMode(e){h.log.info("=====>changeMode",e),this.setData({currentMode:e}),this.renderRoute(e)},toFetchRoute(){h.log.info("====> toFetchRoute"),this.setData({errMessage:""});const e=b.page(),{currentMode:t,dest:a,origin:o,modeList:n,routeInfoMap:r}=this.data;e.loading(!0),(0,M.fetchRoute)(a,o,n).then((a=>{const o=[];n.forEach((e=>{const t=a[e];t&&(o.push(e),Object.assign(this.commonData.routeDetailMap[e],this.handleRouteData(t)),r[e].minDuration=t.minDuration)}));const i=t&&o.indexOf(t)>-1?t:this.getDefaultMode(o);return this.setData({routeInfoMap:r,modeListForView:o,currentMode:i,originPoint:a.originPoint,destPoint:a.destPoint}),e.loading(!1),r})).then((()=>{this.renderRoute()})).catch((t=>{const a=t.message||"地图路线规划异常";if(e.toast(a),this.setData({errMessage:a}),e.loading(!1),"no_location_wxapp"===t.type||"no_location_mmp"===t.type)return h.log.info("地图页 地图路线规划异常",t);h.log.error("地图页 地图路线规划异常",t)}))},handleRouteData(e){return p(d({},e),{polyline:[d({points:e.points},this.data.routeStyle)]})},renderRoute(e=this.data.currentMode){h.log.info("=====>renderRoute",e);const{originPoint:t,destPoint:a}=this.data,{[e]:o={}}=this.commonData.routeDetailMap,{points:n=[],polyline:r=[],distance:i="",kmDistance:s=""}=o,{currentLocationMarkerData:c,selfLiftLocationMarkerData:l}=this.commonData;this.setData({markers:[d(d({},t),c),d(d({},a),l)],polyline:r,includePoints:n,distance:i>1e3?`${s}km `:`${i}m `})},initRouteModeIcon(){this.setData({routeInfoMap:{walk:{type:"walk",iconPath:"https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/map_walk.834c426.png",activeIconPath:"https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/map_walk_active.1faf424.png",funcName:"getWalkingRoute"},car:{type:"car",iconPath:"https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/map_car@3x.71fa416.png",activeIconPath:"https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/map_car_active@3x.4ed3414.png",funcName:"getDrivingRoute"}},routeStyle:{color:"#12B32D",width:6}})},getMapMarkersIconPath(){const e=(0,y.getImageTempFilePathAsync)("https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/current-location@3x.758d174.png"),t=(0,y.getImageTempFilePathAsync)("https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/self-lift-location.6f29659.png");return Promise.all([e,t]).then((e=>{var t,a;this.commonData.currentLocationMarkerData.iconPath=null==(t=e[0])?void 0:t.tempFilePath,this.commonData.selfLiftLocationMarkerData.iconPath=null==(a=e[1])?void 0:a.tempFilePath}))},setDefaultMapMarkers(){this.commonData.currentLocationMarkerData={id:1,width:(0,y.convertRpxToPx)(56),height:(0,y.convertRpxToPx)(56),iconPath:"/images/t-yx/map-default-green-dot.png"},this.commonData.selfLiftLocationMarkerData={id:2,width:(0,y.convertRpxToPx)(56),height:(0,y.convertRpxToPx)(56),iconPath:"/images/t-yx/map-default-red-dot.png",callout:{content:"自提门店",color:"#585D66",fontSize:(0,y.convertRpxToPx)(26),borderRadius:(0,y.convertRpxToPx)(20),borderColor:"#ffffff",bgColor:"#ffffff",padding:(0,y.convertRpxToPx)(24),textAlign:"center",display:"ALWAYS",anchorY:(0,y.convertRpxToPx)(20)}}},onModeIconLoadFail(){this.setData({isModeIconLoadFail:!0})},onLocateIconLoadFail(){this.setData({isLocateIconLoadFail:!0})}})});