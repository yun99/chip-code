var e=Object.create,t=Object.defineProperty,o=Object.defineProperties,i=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertyNames,r=Object.getOwnPropertySymbols,s=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,d=Object.prototype.propertyIsEnumerable,u=(e,o,i)=>o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[o]=i,c=(e,t)=>{for(var o in t||(t={}))a.call(t,o)&&u(e,o,t[o]);if(r)for(var o of r(t))d.call(t,o)&&u(e,o,t[o]);return e},g=e=>t(e,"__esModule",{value:!0}),p=o=>((e,o,n)=>{if(o&&"object"==typeof o||"function"==typeof o)for(let r of l(o))a.call(e,r)||"default"===r||t(e,r,{get:()=>o[r],enumerable:!(n=i(o,r))||n.enumerable});return e})(g(t(null!=o?e(s(o)):{},"default",o&&o.__esModule&&"default"in o?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0})),o),y=(e,t,o)=>new Promise(((i,n)=>{var l=e=>{try{s(o.next(e))}catch(e){n(e)}},r=e=>{try{s(o.throw(e))}catch(e){n(e)}},s=e=>e.done?i(e.value):Promise.resolve(e.value).then(l,r);s((o=o.apply(e,t)).next())}));((e,o)=>{for(var i in g(e),o)t(e,i,{get:o[i],enumerable:!0})})(exports,{default:()=>U});var P,m,T,M,E=p(require("../../aw.js")),A=p(require("../../gk.js")),h=p(require("../../ao.js")),O=p(require("../../ob.js")),f=p(require("../../u8.js")),_=p(require("../../u9.js")),R=p(require("./cx.js")),I=p(require("./ls.js")),N=p(require("./sg.js")),L=p(require("./sp.js")),C="selfLiftPoint_datacenter";(m=P||(P={}))[m.UsePoi=1]="UsePoi",m[m.UsePosition=2]="UsePosition",(M=T||(T={}))[M.Normal=0]="Normal",M[M.DeliveryFirst=2]="DeliveryFirst";var S=getApp(),U=class{constructor(e){const{latitude:t,longitude:o,address:i,cityId:n,cityName:l,districtId:r,districtName:s,districtType:a,from:d,realFrom:u}=e||{},c={};c.fromTo=i?decodeURIComponent(i):"",c.latitude=t||"",c.longitude=o||"",c.cityAddress={cityId:n,cityName:l?decodeURIComponent(l):"",districtId:r?decodeURIComponent(`${r}`):"",districtName:s?decodeURIComponent(`${s}`):"",districtType:a?decodeURIComponent(`${a}`):""},this.dataModel=new R.default(c),this.from=d,this.realFrom=u}genInitModel(){return y(this,null,(function*(){return this.dataModel.getInitData()}))}fetchRecommendPoiList(e,t){return y(this,null,(function*(){const o={latitude:null,longitude:null};o.latitude=t,o.longitude=e,S.$sceneCode===E.SCENE_CODE.LIVE&&((0,f.isMMP)()?o.subChannel=A.SUB_CHANNEL.MEITUAN_LIVE:o.subChannel=A.SUB_CHANNEL.WX_LIVE);let i=null,n="";Object.assign(o,this.getSortType());try{const e=yield(0,I.getRecommendPoiList)(o);i=null==e?void 0:e.recommendPoiList}catch(e){const{code:t}=(null==e?void 0:e.data)||{},{statusCode:o}=(null==e?void 0:e.res)||{};n=h.PoiLocationErrorType.HTTP_ERROR,420===t?n=h.PoiLocationErrorType.ANTI_ERROR_420:403===o&&(n=h.PoiLocationErrorType.ANTI_ERROR),S.page().toast(e.message||"服务繁忙！"),O.log.info(C,"fetchRecommendPoiList error",n,e)}return{list:i,errorType:n}}))}genInitMapResultModel(e){return y(this,null,(function*(){let t=this.genInitModel(),o=L.MAP_TYPE.NODEFINE;S.page().loading(!0);let i,n=(null==t?void 0:t.longitude)||0,l=(null==t?void 0:t.latitude)||null;if(!n&&!l)try{const e=yield _.default.getWxLocation({refresh:!0});if(e&&e.latitude&&e.longitude){const{latitude:i,longitude:r}=e;l=i,n=r;let s=null;try{s=yield S.$service.getPosition(e)}catch(e){o=L.MAP_TYPE.NONETWORK,O.log.info(C,"genUpdateMapResultModel 11  error ",e)}t=this.genRGEOInfo(e,s)}else o=L.MAP_TYPE.NODATA}catch(e){O.log.info(C,"genUpdateMapResultModel 22 error",e);const t=e.type;o="no_location_wx"===t||"no_location_wxapp"===t?L.MAP_TYPE.NOLOCATION_WX:"no_location_mmp"===t?L.MAP_TYPE.NOLOCATION_MMP:L.MAP_TYPE.NODATA}if(l||n)try{const{from:t="",longitude:r=null,latitude:s=null,grayType:a}=e;let d,u;this.needUsePosition({from:t,latitude:s,longitude:r,grayType:a})?(d=s,u=r):(d=l,u=n);const c=yield this.genRecommendList(u,d),{totalPage:g,list:p,currentPage:y,showList:P,errorType:m}=c;o=Array.isArray(p)?p.length?L.MAP_TYPE.LIST:L.MAP_TYPE.NODATA:m===h.PoiLocationErrorType.ANTI_ERROR||m===h.PoiLocationErrorType.ANTI_ERROR_420?L.MAP_TYPE.NODATA:L.MAP_TYPE.NONETWORK,i={totalPage:g||0,currentPage:y||0,type:o,showList:P,errorType:m},this.dataModel.updateList(p)}catch(e){O.log.info(C,"genUpdateMapResultModel 33 error",e),o=L.MAP_TYPE.NONETWORK,i={type:o,showList:[]}}else i={type:o},i.rgeoInfo=t;return S.page().loading(!1),i.rgeoInfo=t,i&&(i.title="当前定位",i.subTitle="定位附近自提点",i.locationText="重新定位"),this.dataModel.updateShowModel(i),i}))}genRGEOInfo(e,t){if(!t)return{fromTo:"定位失败",latitude:null==e?void 0:e.latitude,longitude:null==e?void 0:e.longitude};const o=(null==t?void 0:t.address)?decodeURIComponent(t.address):"",i=t.cityName?decodeURIComponent(t.cityName):"",n=t.districtName?decodeURIComponent(`${t.districtName}`):"",l=i+n+o;return{fromTo:o||"定位失败",latitude:e.latitude,longitude:e.longitude,cityAddress:{cityId:t.cityId,cityName:i,districtId:t.districtId?decodeURIComponent(`${t.districtId}`):"",districtName:n,districtType:t.districtType?decodeURIComponent(`${t.districtType}`):""},addressLoc:l}}isListType(){return this.dataModel.getShowModel().type===L.MAP_TYPE.LIST}isLocationAuth(){const e=this.dataModel.getShowModel();return e.type===L.MAP_TYPE.NOLOCATION_WX||e.type===L.MAP_TYPE.NOLOCATION_MMP}genUpdateMapResultModel(e,t=null,o=null){return y(this,null,(function*(){var i;let n={};switch(e){case L.UPDATE_SOURCE.SELECT_CARD:case L.UPDATE_SOURCE.SELECT_MAP:n=this.dataModel.getShowModel(),n.selectPoi=c({},t),O.log.info("SELECT_MAP/SELECT_CARD--\x3e showModel",n);break;case L.UPDATE_SOURCE.GPSCLICK:{const{latitude:e,longitude:l}=t;if(e&&l){const e=yield this.genShowModel(t,o);n=c(c({},n),e)}else{const e=null==(i=t.error)?void 0:i.type;e===h.PoiLocationErrorType.LOCATION_ACCESS_INVALID_WX_MP||e===h.PoiLocationErrorType.LOCATION_AUTH_INVALID_WX?n.type=L.MAP_TYPE.NOLOCATION_WX:e===h.PoiLocationErrorType.LOCATION_ACCESS_INVALID_MT?n.type=L.MAP_TYPE.NOLOCATION_MMP:n.type=L.MAP_TYPE.NODATA}break}case L.UPDATE_SOURCE.MOVEN_END:{const{latitude:e,longitude:i}=t;if(e&&i){const e=yield this.genShowModel(t,o);n=c({},e)}else n.type=L.MAP_TYPE.NODATA;break}case L.UPDATE_SOURCE.SEARCH:{const{latitude:e,longitude:i}=t;if(e&&i){const e=yield this.genShowModel(t,o);O.log.info("chdtzhy ---\x3e UPDATE_SOURCE.SEARCH 0000",e),n=c({},e),O.log.info("chdtzhy ---\x3e UPDATE_SOURCE.SEARCH 11111",n)}else n.type=L.MAP_TYPE.NONETWORK;n.title="已选地址",n.subTitle="已选地址附近自提点",n.locationText="切换到当前定位";break}case L.UPDATE_SOURCE.REFRESH:{const{longitude:e,latitude:t}=this.dataModel.getShowModel().rgeoInfo,o={longitude:e,latitude:t},i=yield this.genShowModel(o,null);n=c(c({},n),i);break}}return n.title=n.title?n.title:"当前定位",n.subTitle=n.subTitle?n.subTitle:"定位附近自提点",n.locationText=n.locationText?n.locationText:"重新定位",this.dataModel.updateShowModel(n),n}))}genShowModel(e,t){return y(this,null,(function*(){const{latitude:o,longitude:i}=e;let n=L.MAP_TYPE.NODEFINE,l=null;S.page().loading(!0);let r=null;try{l=yield S.$service.getPosition(e)}catch(e){O.log.info(C,"genShowModel error",e)}if(r=this.genRGEOInfo(e,l),O.log.info(C,"genShowModel rgeoInfo",r),t){const o={fromTo:t.address?decodeURIComponent(t.address):"",addressLoc:t.addressLoc?decodeURIComponent(t.addressLoc):"",latitude:e.latitude,longitude:e.longitude};r&&(r.fromTo=o.fromTo,r.addressLoc=o.addressLoc,r.latitude=o.latitude,r.longitude=o.longitude)}const s=yield this.genRecommendList(i,o),{totalPage:a,list:d,currentPage:u,showList:c,errorType:g}=s;S.page().loading(!1),n=Array.isArray(d)?d.length?L.MAP_TYPE.LIST:L.MAP_TYPE.NODATA:g===h.PoiLocationErrorType.ANTI_ERROR||g===h.PoiLocationErrorType.ANTI_ERROR_420?L.MAP_TYPE.NODATA:L.MAP_TYPE.NONETWORK;const p={totalPage:a||0,currentPage:u||0,type:n,showList:c,rgeoInfo:r,errorType:g};return this.dataModel.updateShowModel(p),this.dataModel.updateList(d),p}))}getCenterLocationInfo(){const e={};let t={};const o=this.dataModel.getShowModel();return O.log.info("getCenterLocationInfo showModel",o),t=(null==o?void 0:o.rgeoInfo)||null,e.latitude=o.latitude,e.longitude=o.longitude,t&&t.cityAddress&&t.latitude&&t.longitude?c({},t):c({},e)}genRecommendList(e,t){return y(this,null,(function*(){let o=null,i="",n=0,l=0,r=null;try{const n=yield this.fetchRecommendPoiList(e,t);O.log.info(C,"genRecommendList error",n),o=n.list,i=n.errorType}catch(e){O.log.info(C,"genRecommendList error",e)}const{loadCount:s}=this.dataModel;if(Array.isArray(o)&&o.length){const e=o.length%s,t=o.length/s;n=e>0?parseInt(t.toString(),10)+1:t,O.log.info(C,"genRecommendList list",o.length,n,l),l=1;const i=Number(l)*Number(s);r=o.slice(0,i)}return{list:o,totalPage:n,currentPage:l,showList:r,errorType:i}}))}updateCurrentPage(e){const t=Number(e)+1,i=this.dataModel.getShowModel();if(t>i.totalPage)return O.log.info(C,"genRecommendList nextPage",t,"totalPage",i.totalPage),null;const{loadCount:l,list:r=[]}=this.dataModel,s=Number(t)*Number(l);if(Array.isArray(r)){const e=r.slice(0,s);i.showList=e}const a=(d=c({},i),o(d,n({currentPage:t})));var d;return this.dataModel.updateShowModel(a),a}getCurrentLocation(){var e,t;const o=this.dataModel.getShowModel();return{latitude:(null==(e=null==o?void 0:o.rgeoInfo)?void 0:e.latitude)||0,longitude:(null==(t=null==o?void 0:o.rgeoInfo)?void 0:t.longitude)||0}}getSelectPoi(){const e=this.dataModel.getShowModel().selectPoi;return Object.assign({},e)}clear(){this.dataModel.clear()}needUsePosition(e){var t,o;const{from:i="",latitude:n,longitude:l,grayType:r}=e;null==(t=O.log)||t.info(`${C} 判断是否需要用经纬度的参数: ${JSON.stringify(e)}`);let s=!1;return n&&l&&(s=i===N.FROM_MAP.SUBMIT_ORDER||i===N.FROM_MAP.SUBMIT_CART||(i===N.FROM_MAP.CATEGORY_SKU_LIST||i===N.FROM_MAP.SEARCH)&&2!=+r),null==(o=O.log)||o.info(`${C} 判断是否需要用经纬度的结果: ${s}`),s}getSortType(){return this.from!==N.FROM_MAP.SUBMIT_ORDER||this.realFrom?{}:{sortType:2}}};