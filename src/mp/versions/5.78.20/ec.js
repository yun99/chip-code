var e=Object.create,t=Object.defineProperty,a=Object.defineProperties,o=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertyNames,s=Object.getOwnPropertySymbols,n=Object.getPrototypeOf,l=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,u=(e,a,o)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[a]=o,p=(e,t)=>{for(var a in t||(t={}))l.call(t,a)&&u(e,a,t[a]);if(s)for(var a of s(t))c.call(t,a)&&u(e,a,t[a]);return e},d=(e,t)=>a(e,r(t)),m=a=>{return((e,a,r)=>{if(a&&"object"==typeof a||"function"==typeof a)for(let s of i(a))l.call(e,s)||"default"===s||t(e,s,{get:()=>a[s],enumerable:!(r=o(a,s))||r.enumerable});return e})((r=t(null!=a?e(n(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0}),t(r,"__esModule",{value:!0})),a);var r},h=m(require("./ob.js")),f=m(require("./u8.js")),g=m(require("./zj.js")),y=m(require("./la.js")),{CAT_SEC_CATEGORY:S}=require("./iu.js"),b=getApp(),T=[],O={};Component(new class{constructor(){this.pageLifetimes={show(){this.isHaveFirstRequest?b.$event.on(b.$event.CONTANTS.ITEMS_REQUEST,this.refreshSubmitDataBindThis):this.isHaveFirstRequest=!0},hide(){b.$event.off(b.$event.CONTANTS.ITEMS_REQUEST,this.refreshSubmitDataBindThis)}},this.attached=function(){let e=0;const{isIpx:t}=b.getModule("systemInfo").getSystemInfo(),a="pages/cart/index"===b.page().route;e=(0,f.isWXMT)()?t?a?150:68:a?68:0:t&&!a?68:0,this.setData({bottom:e}),this.refreshSubmitDataBindThis=this.refreshSubmitData.bind(this),b.$event.on(b.$event.CONTANTS.ITEMS_REQUEST,this.refreshSubmitDataBindThis),this.cart=b.page().selectComponent("#cart")},this.detached=function(){b.$event.off(b.$event.CONTANTS.ITEMS_REQUEST,this.refreshSubmitDataBindThis)},this.methods={createOrder(){try{const{totalItemCounts:e}=this.data;if(!b.$poiId&&!b.$poiIdStr)return;if(e||b.page().toast("你还没有选择商品哦~"),this.isSubmitFinish)return void h.log.info(`用户重复点击去支付，isSubmitFinish：${this.isSubmitFinish}`);this.isSubmitFinish=!0;const{trafficSource:t}=b.page().options,a="/pages/submitOrder/index?fromPage=cart"+(t?`&trafficSource=${t}`:"");if(b.isLogin()){const e=b.getModule("user").getToken(),t=b.getModule("user").getUserInfo(),o=b.getModule("user").getLastRemoveUserInfoPath();try{b.$service.checkUserLogin(e).then((e=>{e?b.$router.goto(a):(b.getModule("cat").reportError(S.TOKEN_INVALID_ERROR(`token status: token失效, userInfo=${JSON.stringify(t)}, lastRemoveUserInfoPath=${o}`)),this.unLoginCreateOrder(a))}))}catch(e){b.getModule("cat").reportError(S.MTUSER_ERROR(`获取用户头像、名称失败, userInfo=${JSON.stringify(t)}, lastRemoveUserInfoPath=${o}`)),b.$router.goto(a)}}else this.unLoginCreateOrder(a)}catch(e){h.log.error("去提单失败error：",JSON.stringify(e))}this.isSubmitFinish=!1},unLoginCreateOrder(e){b.$login.login().then((t=>{t&&setTimeout((()=>{b.$router.goto(e)}),1e3)}))},toggleDetailPopup(){this.setData({detailPopupVisible:!this.data.detailPopupVisible})},onAllSelect(){if(this.cart||(this.cart=b.page().selectComponent("#cart")),!this.cart.canOperateCart())return;y.default.onSelectAll(this.data.allSelected?0:1);const e=b.$abTest.getGrayStrategyVal("grocery_c_front_cart_loading");this.cart.operatePopupCart({cartOpType:this.data.allSelected?"INVERT":"SELECT",opTargets:T,needLoading:~e.indexOf("a"),showSuccessToast:!1})},deleteSkus(){y.default.onDelete(),y.default.deletePopupShow();const e=T.filter((e=>e.selected));b.page().confirm({message:`确认要删除这${e.length}种商品吗？`,textOK:"确认删除",textCancel:"我再想想",ok:()=>{y.default.deleteConfirm(),this.data.operatePopupCart({cartOpType:"DELETE",opTargets:e}).then((()=>{this.data.setEditing(!1)}))},cancel:()=>{y.default.deleteCancel()}})},onButtClick(){if(this.cart||(this.cart=b.page().selectComponent("#cart")),this.cart.canOperateCart())if(this.data.totalItemCounts)if(this.data.isEditing)this.deleteSkus();else{const e=[];T.forEach((t=>{(t.selected||O[t.skuId])&&e.push(t.skuId)})),y.default.createOrder(e),this.createOrder()}else b.page().toast("您还没选择任何商品哦")},refreshSubmitData(e){const t={};let a=0;e.cartItems.forEach((e=>{var o;null==(o=null==e?void 0:e.giftItems)||o.forEach((e=>{e.selected&&(O[e.skuId]=!0)})),e.baseItems.forEach((e=>{t[e.skuId]=e.selected,e.selected&&a++}))})),T=e.skuQtyList.map((e=>d(p({},e),{selected:t[e.skuId]})));const o=this.mapSubmitData(this.data,!0),r=this.mapSubmitData(d(p({},e),{skuKinds:a})),i=(0,g.popupCartDataDiff)(r,o);"{}"!==JSON.stringify(i)&&this.setData(i)},mapSubmitData(e,t=!1){const{allSelected:a,totalItemCounts:o,totalPrice:r,reducedAmount:i,cartDetailInfo:s,detailPopupData:n,couponNotice:l,couponNoticeIconUrl:c,realTotalAmount:u,reducedAmountV2:p,realTotalAmountV2:d,reducedAmountV3:m,skuKinds:h,enterLabelText:f,deliveryTip:y}=e;return t?{allSelected:a,totalItemCounts:o,totalPrice:r,reducedAmount:i,cartDetailInfo:s,detailPopupData:n,couponNotice:l,couponNoticeIconUrl:c,skuKinds:h,enterLabelText:f,deliveryTip:y}:{allSelected:a,totalItemCounts:o,totalPrice:d||u,reducedAmount:m||p,cartDetailInfo:s,detailPopupData:s&&(0,g.formatCartDetailToPopupData)(s),couponNotice:l,couponNoticeIconUrl:c,skuKinds:h,enterLabelText:f,deliveryTip:y}},onMvReport(e){b.$lxLog.mv(e.detail.bid,e.detail.lxParams)}},this.properties={isEditing:{type:Boolean},card:{type:Array,value:[]},couponInfo:{type:Object,value:{}},isLogin:{type:Boolean},customSubmit:{type:Boolean,default:!1},orderPreview:{type:Object,default:{}}},this.data={couponNotice:"",couponNoticeIconUrl:"",allSelected:!1,totalItemCounts:b.$cart.cartNum,skuKinds:b.$cart._skuQtyList.length,totalPrice:0,reducedAmount:b.$cart.reducedMoney,cartDetailInfo:{},detailPopupVisible:!1,detailPopupData:{},fontRate:b.$cart.getCartFontRate()||1,deliveryTip:"",enterLabelText:"",bottom:0}}});