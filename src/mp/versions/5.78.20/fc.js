var e=Object.create,t=Object.defineProperty,r=Object.defineProperties,o=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertyNames,u=Object.getOwnPropertySymbols,a=Object.getPrototypeOf,l=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,c=(e,r,o)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[r]=o,p=(e,t)=>{for(var r in t||(t={}))l.call(t,r)&&c(e,r,t[r]);if(u)for(var r of u(t))i.call(t,r)&&c(e,r,t[r]);return e},d=(e,t)=>r(e,s(t)),m=e=>t(e,"__esModule",{value:!0}),y=r=>((e,r,s)=>{if(r&&"object"==typeof r||"function"==typeof r)for(let u of n(r))l.call(e,u)||"default"===u||t(e,u,{get:()=>r[u],enumerable:!(s=o(r,u))||s.enumerable});return e})(m(t(null!=r?e(a(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r),g=(e,t,r)=>new Promise(((o,s)=>{var n=e=>{try{a(r.next(e))}catch(e){s(e)}},u=e=>{try{a(r.throw(e))}catch(e){s(e)}},a=e=>e.done?o(e.value):Promise.resolve(e.value).then(n,u);a((r=r.apply(e,t)).next())}));((e,r)=>{for(var o in m(e),r)t(e,o,{get:r[o],enumerable:!0})})(exports,{default:()=>A});var f=y(require("./vs.js")),w=y(require("./kw.js")),h=y(require("./gi.js")),C=y(require("./vo.js")),E=y(require("./va.js")),R=y(require("./vp.js")),q=y(require("./io.js")),$=y(require("./vj.js")),x=y(require("./vd.js")),O=y(require("./vk.js")),k=y(require("./vf.js")),U=(y(require("./vg.js")),y(require("./vh.js"))),b=y(require("./vl.js")),D=y(require("./iu.js")),T=y(require("./ob.js")),j=y(require("./uj.js")),_=y(require("./vx.js")),v=y(require("./vz.js")),I=y(require("./vc.js")),P=y(require("./is.js")),S=new f.default({concurrency:9}),A=class extends w.default{constructor(e,t){super(e,t),this.env=t.getModule("env"),this.interceptor={request:new C.default,response:new C.default}}static register(e){const t=new A("http",e);return t.interceptor.request.use(R.default),t.interceptor.request.use(E.default),t.interceptor.request.use(q.default),t.interceptor.request.use($.default),t.interceptor.response.use(U.default),t.interceptor.response.use(k.default),t.interceptor.response.use(O.default),t.interceptor.response.use(x.default),e.addModule(t),t}send(e){var t;const r=getApp();this.requestPath=(null==e?void 0:e.url)||"",S.pending>9&&(T.log.error("队列里面超过10个请求"),null==(t=null==r?void 0:r.$cat)||t.reportError(D.CAT_SEC_CATEGORY.NETWORK_QUEUE_EXCEED(`积压请求数：${S.size},当前请求数：${S.pending} queue： ${S}`)));if(e.isCore){const{_pageCount:t,route:o}=r&&r.page()||{},s={pageId:t,route:o};T.log.info("核心接口添加超时兜底",e,s)}return S.add((()=>g(this,null,(function*(){const t=new b.default(e);yield this.interceptor.request.forEach(t,this);const r=`${(0,v.convertToCurlStr)(t.getRequest())}`,o=this.boot.getModule("networkStatus");if(o.isConnected&&"none"!==o.networkType||o.getNetworkType(),!o.isConnected||"none"===o.networkType){const e=new j.NetworkError("网络异常~");return T.log.warn(`请求失败：${r}`,"error为：",e),Promise.reject(e)}try{const o=getApp(),s=t.getRequest();let n,u=!0;if(o.$sharkService&&"shark"===e.connectType)try{n=yield(0,h.catReq2promiseify)(d(p({},s),{connectType:"websocket"}),e.reportUrl||e.url,o.$sharkService.sharkSend),u=!1}catch(e){u=!0}else o.$cloud&&e.connectType&&"shark"!==e.connectType&&(I.failover||(e.cloudContainerPre?e.cloudContainerPreRate?Math.random()<e.cloudContainerPreRate&&this.cloudContainerSend(s,e):this.cloudContainerSend(s,e):(u=!1,n=yield this.cloudContainerSend(s,e))));if(u){let t;(e._recordProfile||e.cloudContainerPre)&&(t=new _.ProfileRecorder),n=yield(0,h.catReq2promiseify)(d(p({},s),{connectType:"https"}),e.reportUrl||e.url);const{profile:r}=n;if(r)try{T.logger.info({type:"network",tag:"check_network",scene:"wx",msg:`网络测速: wx rtt ${r.rtt} ${r.httpRttEstimate} ${r.transportRttEstimate} 状态:${r.estimate_nettype} 网速:${r.downstreamThroughputKbpsEstimate} ${r.throughputKbps}`}),t&&t.report(e.reportUrl||e.url,r)}catch(e){}}t.setResponse(n),yield this.interceptor.response.forEach(t,this);const{setting:a}=t;if(T.log.trace(`请求成功：${r}`,`TraceId是：${(0,v.getHttpHeader)(n.header,"M-TraceId")}`,`StatusCode是：${n.statusCode}`),!1===a.dataFilter)return t.getResponse();const{data:l}=t.getResponse();return l}catch(e){return T.log.warn(`请求失败：${r}`,"error为：",e),Promise.reject(e instanceof j.NetworkError?e:new j.NetworkError(e))}}))))}cloudContainerSend(e,t){return g(this,null,(function*(){let r,o=!1;const s=getApp(),n=[d(p({},e),{header:d(p({},e.header),{"X-WX-REGION":"ap-beijing","X-WX-EXCLUDE-CREDENTIALS":"unionid, cloudbase-access-token, openid","x-wx-service":"enovytest",HOST:"bi-mall.meituan.com","X-WX-GATEWAY-ID":"yx-wxapp-prod-8gwij1e807aefb86"}),connectType:"cloudContainer"}),t.reportUrl||t.url,s.$cloud.callContainer];try{const e=new _.ProfileRecorder("cloud_container_response_profile"),u=Date.now();if(r=yield(0,h.catReq2promiseify)(...n),r.stats&&r.stats.profile){const{profile:o}=r.stats;try{T.logger.info({type:"network",tag:"云网关请求",scene:"wx",msg:`callId: ${r.stats.callid} 包大小 ${o.receivedByteDCount} responseEnd ${o.responseEnd-u} endTime ${Date.now()-u} rtt ${o.rtt} ${o.httpRttEstimate} ${o.transportRttEstimate} 状态:${o.estimate_nettype} 网速:${o.downstreamThroughputKbpsEstimate} ${o.throughputKbps}`}),o&&e&&e.report(t.reportUrl||t.url,o)}catch(e){}}(!r.data||r.data&&0!==r.data.code)&&s.$cat&&s.$cat.reportError(D.CAT_SEC_CATEGORY.CLOUD_CONTAINER_BIZ_ERROR(r)),o=(0,I.shouldFailOver)(r)}catch(e){o=!0,(0,I.setFailOver)(!0),T.log.trace(`云托管请求返回值：url：${n[0].url}`,`返回的错误码：${e.errCode}`,`返回的错误内容：${e.errMsg}`)}if(o)try{r=yield(0,h.catReq2promiseify)(d(p({},e),{connectType:"https"}),t.reportUrl||t.url),(!r.data||r.data&&0!==r.data.code)&&s.$cat&&s.$cat.reportError(D.CAT_SEC_CATEGORY.HTTPS_BIZ_ERROR(r)),s.$cat&&s.$cat.reportCustomMetrics(P.CloudContainerMetrics.CLOUD_CONTAINER_RECOVER_SUCCESS)}catch(e){throw s.$cat&&s.$cat.reportCustomMetrics(P.CloudContainerMetrics.CLOUD_CONTAINER_RECOVER_FAIL),e}return r}))}get(e){return this.send(p({method:"GET"},e))}post(e){return this.send(p({method:"POST"},e))}};