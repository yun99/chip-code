var t=Object.create,e=Object.defineProperty,a=Object.defineProperties,o=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertyNames,s=Object.getOwnPropertySymbols,i=Object.getPrototypeOf,c=Object.prototype.hasOwnProperty,h=Object.prototype.propertyIsEnumerable,p=(t,a,o)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[a]=o,u=(t,e)=>{for(var a in e||(e={}))c.call(e,a)&&p(t,a,e[a]);if(s)for(var a of s(e))h.call(e,a)&&p(t,a,e[a]);return t},l=a=>{return((t,a,r)=>{if(a&&"object"==typeof a||"function"==typeof a)for(let s of n(a))c.call(t,s)||"default"===s||e(t,s,{get:()=>a[s],enumerable:!(r=o(a,s))||r.enumerable});return t})((r=e(null!=a?t(i(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0}),e(r,"__esModule",{value:!0})),a);var r},d=l(require("./is.js")),g=l(require("./u8.js")),f=l(require("./ob.js")),m=l(require("./la.js")),C=l(require("./zj.js")),T=l(require("./kh.js")),y=l(require("./xg.js")),S=getApp();Component(new class{constructor(){this.created=function(){},this.attached=function(){f.log.info("购物车attach开始"),this.eventBindHandel(),this.currentPage=S.page().route||"",f.log.info("购物车attach结束"),this.onShow(),this.showPage()},this.detached=function(){this.handleOffEvent()},this.methods={onShow(){if(S&&S.page){const t=S.page(),e=t.onShow;t.onShow=(...a)=>{e.apply(t,a),this.showPage()}}},showPage(){var t;try{this.onCartShowBindThis&&this.loginRefreshCartBindThis&&this.refreshDataBindThis&&this.refreshCouponBindThis||(f.log.error("购物车attach事件挂载失败"),this.eventBindHandel()),this.currentPage=(null==(t=null==S?void 0:S.page())?void 0:t.route)||"",T.useWhitelist[this.currentPage]&&(S.$event.on(S.$event.CONTANTS.CART_SHOW,this.onCartShowBindThis),S.$event.on(S.$event.CONTANTS.LOGIN_REFRESH_CART_SUCCESS,this.loginRefreshCartBindThis),S.$event.on(S.$event.CONTANTS.ITEMS_REQUEST,this.refreshDataBindThis)),this.onCartShow()}catch(t){f.log.error(`购物车事件挂载失败，e：${JSON.stringify(t)}`)}},onCartShow(t){t&&(S.page().options.trafficSource=t.trafficSource),S.page().route||f.log.warn("[modules/cart/index] 路由信息获取失败",JSON.stringify({page:S.page(),route:S.page().route||"无"})),!S.$cart.isCartLandingPrefetcher&&S.page().route&&"pages/cart/index"!==S.page().route||this.operatePopupCart();const e=(0,g.isWXMT)()&&"pages/cart/index"===S.page().route,a=S.getModule("systemInfo").getSystemInfo().isIpx&&("pages/cart/index"!==S.page().route||(0,g.isWXMT)()),o={showCart:!0,isLogin:S.isLogin(),needBottom:e,isIpx:a};this.data.loadCart||(o.loadCart=!0),this.setData(o)},operatePopupCart(){return t=this,e=arguments,a=function*({cartOpType:t="REFRESH",opTarget:e=null,opTargets:a=[],lxData:o={},showSuccessToast:r=!1,needLoading:n=!1}={}){const s=Date.now();n&&S.page().loading(!0);const i=yield S.$cart.operateCart({opTarget:e||{opTargets:a},cartOpType:t,lxData:o,showSuccessToast:r,needAnimation:!1,forceRefresh:!0});i&&Object.keys(i).length&&(n&&S.page().loading(!1),"REFRESH"!==t&&S.$cat.reportCustomMetrics(d.YXReportTarget.CART_ITEMS_TIME,Date.now()-s,{type:t}))},new Promise(((o,r)=>{var n=t=>{try{i(a.next(t))}catch(t){r(t)}},s=t=>{try{i(a.throw(t))}catch(t){r(t)}},i=t=>t.done?o(t.value):Promise.resolve(t.value).then(n,s);i((a=a.apply(t,e)).next())}));var t,e,a},refreshData(t){const e=Date.now();if(!t)return;const{cartData:o}=(0,C.mapPopupCartReqsData)(t);if(!o)return;const n=(s=u({},o),i={card:[].concat(o.card,this.data.card.filter((t=>t.type===y.CardType.RECOMMEND)))},a(s,r(i)));var s,i;const c={card:this.data.card};this.totalItemCounts=t.totalItemCounts||0,this.cacheId=t.cacheId||0;const h=(0,C.popupCartDataDiff)(n,c);this.setData(u({},h),(()=>{var t,a;try{null==(t=S.page())||t.loading(!1)}catch(t){f.log.warn("refreshData setData finish error",t)}if(Object.keys(h).length&&S.$cat.reportCustomMetrics(d.YXReportTarget.CART_OPERATE_TIME,Date.now()-e),S._cartRenderStartTime){const t=Date.now()-S._cartRenderStartTime;f.log.info("<cart metricsSetData> 购物车首屏渲染时间为",t),m.default.onCartFinish(t),delete S._cartRenderStartTime}null==(a=S.page().cartMetricsReport)||a.reportCartFMPCount(d.YXReportTarget,d.ReportValue,S.$cat,S.$version,S.$systemInfo,"FMPCart")})),this.refreshCoupon(t)},onCouponPopupHandle(){this.setData({isShowCouponDetail:!this.data.isShowCouponDetail})},refreshCoupon(t){if(!(null==t?void 0:t.cacheId))return;const e=t.cacheId||"";let a;S.$service.queryCouponInCart(e).then((({availableCouponList:t,total:e,couponTips:o,enterLabelText:r,enterLink:n,enterLinkText:s})=>{a={VIPCouponNum:(null==t?void 0:t.total)||0,total:e||0,couponTips:o||[],enterLabelText:r||"",enterLink:n||"",enterLinkText:s||""},this.setData({totalItemCounts:this.totalItemCounts,couponInfo:a})})).catch((t=>{a={},f.log.warn("[modules/cart/index] queryCouponInCart获取券信息失败",JSON.stringify(t)),this.setData({totalItemCounts:this.totalItemCounts,couponInfo:a})}))},handleOffEvent(){S.$event.off(S.$event.CONTANTS.CART_SHOW,this.onCartShowBindThis),S.$event.off(S.$event.CONTANTS.LOGIN_REFRESH_CART_SUCCESS,this.loginRefreshCartBindThis),S.$event.off(S.$event.CONTANTS.ITEMS_REQUEST,this.refreshDataBindThis)},loginRefreshCart(){clearTimeout(this.timeoutId),this.timeoutId=setTimeout(this.onCartShowBindThis,500)},canOperateCart(){const t=S.$poi.isExperiencePoi();return t&&S.page().showNoLocationModal(),!t},eventBindHandel(){this.onCartShowBindThis=this.onCartShow.bind(this),this.loginRefreshCartBindThis=this.loginRefreshCart.bind(this),this.refreshDataBindThis=this.refreshData.bind(this),this.refreshCouponBindThis=this.refreshCoupon.bind(this)}},this.properties={cartRecDataRenderingCache:{type:Object}},this.data={isEditing:!1,noticeBoardInfo:{},isLogin:!0,card:[],totalItemCounts:0,couponInfo:{},isShowCouponDetail:!1,needBottom:!1,isTabPage:!1,isWXMT:(0,g.isWXMT)(),isIpx:!1},this.cacheId=0,this.totalItemCounts=0}});