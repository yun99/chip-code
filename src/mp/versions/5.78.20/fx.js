var e=Object.create,t=Object.defineProperty,n=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,o=Object.getPrototypeOf,s=Object.prototype.hasOwnProperty,r=e=>t(e,"__esModule",{value:!0}),l=l=>((e,o,r)=>{if(o&&"object"==typeof o||"function"==typeof o)for(let l of i(o))s.call(e,l)||"default"===l||t(e,l,{get:()=>o[l],enumerable:!(r=n(o,l))||r.enumerable});return e})(r(t(null!=l?e(o(l)):{},"default",l&&l.__esModule&&"default"in l?{get:()=>l.default,enumerable:!0}:{value:l,enumerable:!0})),l),u=(e,n,i)=>(((e,n,i)=>{n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[n]=i})(e,"symbol"!=typeof n?n+"":n,i),i),a=(e,t,n)=>new Promise(((i,o)=>{var s=e=>{try{l(n.next(e))}catch(e){o(e)}},r=e=>{try{l(n.throw(e))}catch(e){o(e)}},l=e=>e.done?i(e.value):Promise.resolve(e.value).then(s,r);l((n=n.apply(e,t)).next())}));((e,n)=>{for(var i in r(e),n)t(e,i,{get:n[i],enumerable:!0})})(exports,{default:()=>v});var p=l(require("./kw.js")),g=l(require("./u2.js")),c=l(require("./iu.js")),h=l(require("./sq.js")),d=l(require("./ob.js")),I=l(require("./p0.js")),L=l(require("./u8.js")),m=l(require("./gi.js")),N=l(require("./vr.js")),S=l(require("./kc.js")),O=l(require("./is.js")),_=l(require("./u0.js")),y=l(require("./it.js")),f=l(require("./ui.js")),E=l(require("./uv.js")),T=l(require("./ug.js"));getApp();"wx"!==f.type&&"tt"!==f.type||(d.log.warn("初始化登录SDK"),(0,N.initLoginConfig)());var C={CHECK_TOKEN:0,SLIENT_LOGIN:1,LOGIN:2},U={"pages/login/index":"1","pages/loginNew/index":"1","login/authrize/page/index":"1","login/subpages/entry/index":"1","login/subpages/bind/index":"1","login/subpages/yoda-verify/index":"1","login/subpages/change-bind-phone/index":"1","login/subpages/webview/index":"1","login/subpages/yoda/modules/index/index":"1","login/subpages/wait-yoda/index":"1","login/subpages/confirm-phone/index":"1"},v=class extends p.default{constructor(e,t){super(e,t),u(this,"wxTuanLogout",(()=>{this.logout()})),u(this,"appLogout",(()=>new Promise(((e,t)=>{wx.mtLogout({success:e,fail:t})})))),u(this,"appLogin",(()=>new Promise(((e,t)=>{wx.mtLogin({success:n=>{d.log.info("APP登录成功，结果为",n),setTimeout((()=>a(this,null,(function*(){try{const t=yield(0,f.wxLogin)({bind:!1,waitBack:!0});e(t)}catch(e){t(e)}}))),500)},fail:t=>{e(null)}})})))),u(this,"goLoginPageSingle",(()=>{let e=!1;let t=0;return()=>a(this,null,(function*(){if(e||this.checkInLoginPages())return!1;e=!0;try{const n=setInterval((()=>{++t,(this.checkInLoginPages()||t>100)&&(t>100&&d.log.warn("[loginModule] 已经到最大轮询次数了，还没有跳转到登录页"),e=!1,t=0,clearInterval(n))}),100),i=yield this.login();e=!1,t=0,i||d.log.info("[loginModule] [goLoginPageSignle] 用户取消登录")}catch(n){e=!1,t=0,d.log.info("[loginModule] [goLoginPageSignle] 用户取消登录",n)}}))})()),this.userModule=t.getModule("user"),this.loginDone=!1,this.event.on(this.event.CONTANTS.LOGIN_FINISH,(e=>{this.loginDone=!0;const{userId:t=null,openId:n=null}=e||{};(0,E.setLoggerEnv)(t,null,n)})),this.timer=null,this.code=null,this.LOGIN_HOOK=C}static register(e){const t=new v("login",e);return e.addModule(t),t}destroy(){this.event.off(this.event.CONTANTS.LOGIN_FINISH),this.event.off(this.event.CONTANTS.LOGIN_SUCCESS),this.event.off(this.event.CONTANTS.LOGIN_OUT)}setConfig({uuid:e,isProd:t,finger:n}){let i={uuid:e};n&&Object.assign(i,{finger:n}),(0,f.setAppConfig)(i),(0,f.setEnv)(t?"":"test")}isLogin(){return!!this.userModule.getUserInfo()}getLoginCode(){return a(this,null,(function*(){this.code=yield f.utils.getLoginCode()}))}getWxUserInfo(){return(0,f.getWxUserInfo)({})}setUserInfo(e){return this.app.$lxLog.setLxEnv({userId:e.userId,openId:e.openId,unionId:e.unionId}),Promise.all([this.setWxUserInfo(e),this.setMtUserInfo(e)])}setWxUserInfo(e){return a(this,null,(function*(){this.userModule.setUserInfo(e)}))}setMtUserInfo(e){return a(this,null,(function*(){try{const{data:t}=yield this.app.$service.getUserByTokenWithMsg(e);if(t.error)throw t.error;this.app.$mtuser=t.user,this.app.$store.setCache("mtuser",t.user)}catch(e){}}))}wxMobileLoginDirect(e,t){return a(this,null,(function*(){let n=null;const{passThroughData:i}=t;this.setPassThroughData(i);try{if(n=yield(0,f.wxMobileLogin)(e,this.code),!n)throw new Error("登录失败请重试");if(n.error)throw new Error(n.error);yield this.setUserInfo(n),this.event.emit(this.event.CONTANTS.LOGIN_SUCCESS,n,C.LOGIN,t),this.event.emit(this.event.CONTANTS.LOGIN_MANUALLY)}catch(e){n=null,this.app.$cat.reportError(c.CAT_SEC_CATEGORY.LOGIN_FAIL_ERROR(g.ERROR.SELF_LOGIN_FAIL))}try{setTimeout((()=>{(0,h.default)((()=>!this.checkInLoginPages())).then((()=>{this.event.emit(this.event.CONTANTS.LOGIN_FINISH,n,C.LOGIN,t)}))}),100)}catch(e){}return this.cleanPassThroughData(),n}))}beforeLocationLogin(){return a(this,null,(function*(){var e;try{const t=(0,T.buildStartPoint)(),n=getApp(),i=(null==n?void 0:n.page)&&(null==(e=null==n?void 0:n.page())?void 0:e.route);if(d.log.info("[login]","beforeLocationLogin",i),(0,L.isWX)()&&U[i])return;(0,L.isMMP)()&&n.$updateAuthPromise&&(yield n.$updateAuthPromise),t("poiLogin")}catch(e){d.log.error("[login]","beforeLocationLogin报错",e)}}))}tryLogin(){return a(this,null,(function*(){const e=(0,T.buildStartPoint)();try{d.log.info("[login]","尝试token是否有效");let t=yield(0,f.getAuthInfo)();if(t=yield this.setOpenidAndUnionid(t),d.log.info("[login]","尝试token是否有效，前往登陆",t),t&&(t.openIdCipher||(0,L.isMMP)()))return(0,L.isMMP)()||(0,_.default)(this.app,{token:(t||{}).token||""}),yield this.setUserInfo(t),e("tryLogin"),this.event.emit(this.event.CONTANTS.LOGIN_SUCCESS,t,C.CHECK_TOKEN,{}),this.event.emit(this.event.CONTANTS.LOGIN_FINISH,t,C.CHECK_TOKEN,{}),t.unionId&&this.app.$cat.reportCustomMetrics(O.YXReportTarget.SILENT_LOGIN_UNIONID,O.ReportValue.SUCCESS,{result:O.SilentLoginUnionidResults.SUCCESS_UNIONID_GETAUTHINFO}),t.userId&&this.app.$cat.reportCustomMetrics(O.YXReportTarget.SILENT_LOGIN_USERID,O.ReportValue.SUCCESS,{result:O.SilentLoginUseridResults.SUCCESS_USERID_GETAUTHINFO}),t.openId&&this.app.$cat.reportCustomMetrics(O.YXReportTarget.SILENT_LOGIN_OPENID,O.ReportValue.SUCCESS,{result:O.SilentLoginOpenidResults.SUCCESS_OPENID_GETAUTHINIFO}),t;throw d.log.info("[login]","token无效"),new Error("未登录")}catch(t){d.log.warn("[login]","tryLogin delete user info"),this.userModule.removeUserInfo("login module: tryLogin"),d.log.warn("[login]","开始尝试静默登陆");const n=null;return e("tryLogin"),(0,_.default)(this.app,{token:(n||{}).token||""}),d.log.info("[login]","静默登陆结果",n),this.event.emit(this.event.CONTANTS.LOGIN_FINISH,n,C.SLIENT_LOGIN,{}),n}}))}handleWxLoginFailed(){this.userModule.removeUserInfo("login module: wxDefaultLogin")}wxDefaultLogin(){return a(this,null,(function*(){var e;const t=(0,T.buildStartPoint)();try{let n=yield(0,f.wxLogin)({slient:!0,bind:!1});return n=yield this.setOpenidAndUnionid(n),d.log.info("[login]","静默登陆SDK结果",n),n?(this.app.$cat.reportCustomMetrics(O.YXReportTarget.SILENT_LOGIN_UNIONID,n.unionId?O.ReportValue.SUCCESS:O.ReportValue.FAILED,{result:n.unionId?O.SilentLoginUnionidResults.SUCCESS_UNIONID_WXLOGIN:O.SilentLoginUnionidResults.FAIL_UNIONID_WXLOGIN}),this.app.$cat.reportCustomMetrics(O.YXReportTarget.SILENT_LOGIN_OPENID,n.openId?O.ReportValue.SUCCESS:O.ReportValue.FAILED,{result:n.openId?O.SilentLoginOpenidResults.SUCCESS_OPENID_WXLOGIN:O.SilentLoginOpenidResults.FAIL_OPENID_WXLOGIN}),this.app.$lxLog.setLxEnv({userId:n.userId,openId:n.openId,unionId:n.unionId}),n.error?(yield this.handleWxLoginFailed(),this.app.$cat.reportCustomMetrics(O.YXReportTarget.SILENT_LOGIN_USERID,O.ReportValue.FAILED,{result:O.SilentLoginUseridResults.FAIL_USERID_WXLOGIN}),n.openId&&n.openIdCipher&&(null==(e=this.userModule)||e.setMallLoginData(n),(0,y.setJsGuardConfig)({openid:n.openid})),null):(this.app.$cat.reportCustomMetrics(O.YXReportTarget.SILENT_LOGIN_USERID,O.ReportValue.SUCCESS,{result:O.SilentLoginUseridResults.SUCCESS_USERID_WXLOGIN}),yield this.setUserInfo(n),t("wxDefaultLogin"),this.event.emit(this.event.CONTANTS.LOGIN_SUCCESS,n,C.SLIENT_LOGIN,{}),n)):(yield this.handleWxLoginFailed(),this.app.$cat.reportCustomMetrics(O.YXReportTarget.SILENT_LOGIN_UNIONID,O.ReportValue.FAILED,{result:O.SilentLoginUnionidResults.FAIL_UNIONID_WXLOGIN}),this.app.$cat.reportCustomMetrics(O.YXReportTarget.SILENT_LOGIN_USERID,O.ReportValue.FAILED,{result:O.SilentLoginUseridResults.FAIL_USERID_WXLOGIN}),this.app.$cat.reportCustomMetrics(O.YXReportTarget.SILENT_LOGIN_OPENID,O.ReportValue.FAILED,{result:O.SilentLoginOpenidResults.FAIL_OPENID_WXLOGIN}),null)}catch(e){return yield this.handleWxLoginFailed(),t("wxDefaultLogin"),this.app.$cat.reportError(c.CAT_SEC_CATEGORY.LOGIN_FAIL_ERROR(e)),null}}))}updateAuthInfo(){return a(this,null,(function*(){const e=(0,T.buildStartPoint)();try{const t=(new Date).getTime();d.log.info("[login]","更新用户信息开始");const n=yield(0,f.getAuthInfo)();if(d.log.info("[login]","更新用户信息成功",n),this.app.$cat.reportCustomMetrics(O.YXReportTarget.UPDATE_USERINFO_COMSUME,(new Date).getTime()-t),n)return this.userModule.setUserInfo(n),e("updateAuthInfo"),n;throw new Error("未登录")}catch(t){return e("updateAuthInfo"),d.log.error("[login]","更新用户信息无效",t),null}}))}setPassThroughData(e){(0,S.isObject)(e)&&(0,f.setAppConfig)({passThroughData:e})}cleanPassThroughData(){(0,f.setAppConfig)({passThroughData:null})}login(){return a(this,arguments,(function*(e={}){let t=null,n=!1;const{passThroughData:i,skipLoginMiddlePage:o}=e;o&&(n=Array.isArray(o)?o[0]:o),this.setPassThroughData(i);try{const n=null;if(n&&!n.error&&n.openId)d.log.info("手动登录时静默登录成功"),t=n,yield this.setUserInfo(t),this.event.emit(this.event.CONTANTS.LOGIN_SUCCESS,t,C.LOGIN,e);else{d.log.info("手动登录时\bwxLogin失败",t);const n=this.createSession(),i={session:n,bind:!0};if(d.log.info("打开登录页面"),(0,L.isApp)())t=yield this.appLogin();else try{t=yield(0,f.cleanLogin)(i)}catch(e){d.log.error("手动登录时异常, 尝试非绑定登录",e),t=yield(0,f.cleanLogin)({bind:!1,session:n})}if(d.log.info("手动登录,用户信息为：",t),t){if(t.error)throw new Error(t.error);yield this.setUserInfo(t),this.event.emit(this.event.CONTANTS.LOGIN_SUCCESS,t,C.LOGIN,e),this.event.emit(this.event.CONTANTS.LOGIN_MANUALLY)}}}catch(e){d.log.error("手动登录时异常",e),t=null,this.app.$cat.reportError(c.CAT_SEC_CATEGORY.LOGIN_FAIL_ERROR(g.ERROR.SELF_LOGIN_FAIL)),wx.showToast({title:e&&e.message||"登录异常，请重试",icon:"none"})}try{setTimeout((()=>{(0,h.default)((()=>!this.checkInLoginPages())).then((()=>{d.log.info("手动登录时触发LOGIN_FINISH",t),this.event.emit(this.event.CONTANTS.LOGIN_FINISH,t,C.LOGIN,e)}))}),100)}catch(e){}return t&&this.app.$lxLog.setLxEnv({userId:t.userId,openId:t.openId,unionId:t.unionId}),d.log.info("登陆Promise.resolve",t,e),this.cleanPassThroughData(),t}))}checkInLoginPages(){const e=this.app.page(-1);return e&&U[e.__route__]}doAfterTryLogin(){return new Promise((e=>{let t=null;const n=n=>{t&&clearTimeout(t),e(n)};this.loginDone?e(this.userModule.getUserInfo()):(t=setTimeout((()=>{this.event.off(this.event.CONTANTS.LOGIN_FINISH,n),e()}),5e3),this.event.once(this.event.CONTANTS.LOGIN_FINISH,n))}))}logout(e){return a(this,null,(function*(){d.log.info("主动退出登录",e),this.loginDone=!1;const t=this.userModule.getToken();if(t)try{const n=yield(0,f.sdkLogout)(t);(0,L.isMMP)()&&(yield this.appLogout()),d.log.info("退出登录成功",n),setTimeout((()=>{this.app.$cart.refreshCart(),this.app.$activity.loginFinish()}),1e3),this.userModule.removeUserInfo(e),this.app.$cart.resetSkuQtyList(),this.app.$cart.resetRedPacketBarData(),this.event.emit(this.event.CONTANTS.LOGIN_OUT,e)}catch(e){this.app.$cat.reportError(c.CAT_SEC_CATEGORY.LOGIN_FAIL_ERROR(e))}}))}mtCheckSession(){return new Promise(((e,t)=>{wx.mtCheckSession({success:e,fail:t})}))}createSession(){const e=f.authState.session||f.sdkLogin.createSession();return e.on(f.SessionEvent.NAVIBACK,(()=>{d.log.info("NAVIBACK"),this.app.$cat.reportCustomMetrics(O.YXReportTarget.BACK_FROM_LOGIN),this.app.$event.emit(this.app.$event.CONTANTS.RETURN_FROM_LOGIN)})),e.on(f.SessionEvent.CLICK,(e=>{switch(e){case f.API_TYPE.WX_MOBILE:this.app.$lxLog.mc("b_youxuan_51cwm2jg_mc"),this.app.$lxLog.mv("b_youxuan_o5f0cguz_mv");break;case f.API_TYPE.WXV2:this.app.$lxLog.mc("b_youxuan_o2txsseb_mc")}})),e.on(f.SessionEvent.ENTRYPAGEONSHOW,(()=>{this.app.$lxLog.pv("c_youxuan_fgi85b6o")})),e.on(f.SessionEvent.AUTHPAGEONSHOW,(()=>{this.app.$lxLog.pv("c_youxuan_b0wl7yz2")})),e.on(f.SessionEvent.ALLOWPHONE,(()=>{this.app.$lxLog.mc("b_youxuan_mjrp5nen_mc")})),e.on(f.SessionEvent.REFUSEPHONE,(()=>{this.app.$lxLog.mc("b_youxuan_5tyfjagz_mc")})),e.on(f.SessionEvent.USERINFOCLICK,(()=>a(this,null,(function*(){this.app.$lxLog.mc("b_youxuan_2z3pm24i_mc");try{const e=yield(0,m.wx2promiseify)(wx.getSetting);void 0===e.authSetting["scope.userInfo"]&&this.app.$lxLog.mv("b_youxuan_311kv73z_mv")}catch(e){d.log.info("<login session> 获取授权状态失败",e)}})))),e.on(f.SessionEvent.ALLOWUSERINFO,(()=>{this.app.$lxLog.mc("b_youxuan_t5rbi4tm_mc")})),e.on(f.SessionEvent.REFUSEUSERINFO,(()=>{this.app.$lxLog.mc("b_youxuan_5sin2gyu_mc")})),e}setOpenidAndUnionid(e){return a(this,null,(function*(){let t={};try{t=yield(0,I.getOpenidAndUnionid)(),t.openid=t.oneid_openid,t.unionid=t.oneid_unionid,t.anonymousid=t.oneid_deviceid}catch(e){d.log.error("setOpenidAndUnionid 设置openid失败",e),t={}}return d.log.info("login setOpenidAndUnionid",t,e),Object.assign({},e||{},t||{})}))}};