var e=Object.create,t=Object.defineProperty,a=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,s=Object.getPrototypeOf,i=Object.prototype.hasOwnProperty,n=e=>t(e,"__esModule",{value:!0}),u=u=>((e,s,n)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let u of r(s))i.call(e,u)||"default"===u||t(e,u,{get:()=>s[u],enumerable:!(n=a(s,u))||n.enumerable});return e})(n(t(null!=u?e(s(u)):{},"default",u&&u.__esModule&&"default"in u?{get:()=>u.default,enumerable:!0}:{value:u,enumerable:!0})),u);((e,a)=>{for(var r in n(e),a)t(e,r,{get:a[r],enumerable:!0})})(exports,{PrefetchStatus:()=>o,default:()=>w});var o,c,l,h,g=u(require("./u4.js")),D=u(require("./ob.js")),d=u(require("./sw.js")),f=u(require("./pa.js")),p=u(require("./ug.js")),m=u(require("./u3.js")),y=u(require("./uh.js")),E=u(require("./u8.js")),S=u(require("./du.js")),I=u(require("./pi.js")),{DefaultQueryString:P}=(getApp(),require("./u2.js")),A=(require("./uc.js").requestUrl,"5.78.20"),U="[Prefetchor]:";(c=o||(o={})).UNEXEC="未执行",c.FAILED="执行失败",c.SUCCESS="执行成功",c.ASYNC_SUCCESS="异步执行成功",c.MANUAL_DONE="手动请求快于预拉取",c.SUCCESS_BUT_INVALID="执行成功但数据无效",c.API_FAILED="后端接口返回失败",c.WX_DATA_INVALID="wx预拉取api返回数据有问题",(h=l||(l={})).APIVERSONGREATER="apiVersonGreater",h.APIVERSONLESS="apiVersonLess",h.TOKEN="tokenNoEquel",h.EXPIRED="expired",h.MEDIUM="medium",h.UUID="uuid";var v={[l.APIVERSONGREATER]:"API版本号大于前端版本号",[l.APIVERSONLESS]:"API版本号小于前端版本号",[l.TOKEN]:"TOKEN不匹配",[l.EXPIRED]:"EXPIRED",[l.MEDIUM]:"MEDIUM不匹配",[l.UUID]:"UUID不匹配"},C=(0,p.buildProportion)("firstDataValidate"),w=new class{constructor(){this.event=g.default,this.status=o.UNEXEC,this.data=null,this.originData=null,this.error=null,this.isPrefetchDone=!1,this.isDebug=!1,this.isApplyPrefetch=!0,this.aggreAndPrefetchInfo="",this.getPrefetchData=(0,d.getResFromRecently)(this.getPrefetchDataCore.bind(this),{refresh:!0,tag:"prefetch",expire:0}),this.isDebug=!1,this.isDebug||this.getPrefetchData()}setStatus(e,t){if(e===o.SUCCESS||e===o.ASYNC_SUCCESS)C("success"),D.log.warn(U,"预拉取数据应用");else if(e===o.MANUAL_DONE);else{switch(e){case o.WX_DATA_INVALID:C("wxDataInvalid");break;case o.API_FAILED:C("apiFailed");break;case o.SUCCESS_BUT_INVALID:C(t);break;case o.FAILED:C("wxFailed")}this.error=t,D.log.warn(U,"预拉取失败：",e,t)}this.status=e,this.isPrefetchDone=!0}isSupportPrefetch(){return!!I.default.getBackgroundFetchData||(this.setStatus(o.UNEXEC,"\b不支持getBackgroundFetchData"),void D.log.warn(U,"不支持getBackgroundFetchData"))}judgeValidData(e,t,a,r){var s;if(!t)return{valid:!1,type:l.EXPIRED};if((e.t||"")!==a)return{valid:!1,type:l.TOKEN};const i=e.uuid||"";if(r!==i)return{valid:!1,type:l.UUID};""===i&&""===a?C("emptyTokenUUID"):""===a?C("emptyToken"):""===i&&C("emptyUUID");const n=(0,m.default)(e.version,A),u=getApp(),o="on"===(null==(s=null==u?void 0:u.getModule("env"))?void 0:s.getCache("ignoreVersionPrefetch"));if(0!==n||this.isDebug&&!o)return{valid:!1,type:1===n?l.APIVERSONGREATER:l.APIVERSONLESS};const c=e.utm_medium||"";return(0,E.isMMP)()&&c!==P.utm_medium?{valid:!1,type:l.MEDIUM}:{valid:!0}}_getPrefetchDataCore(e){return D.log.warn(U,"getPrefetchDataCore"),new Promise(((t,a)=>{try{D.log.info(U,"getPrefetchDataCore->wx.getBackgroundFetchData"),e.getBackgroundFetchData({fetchType:"pre",success:(e={})=>{this.handleData(e).then((e=>t(e))).catch((e=>a(e)))},fail:e=>{this.setStatus(o.FAILED,e);const t=`预拉取失败fail：${JSON.stringify(e)}`;return a(new Error(t))}})}catch(e){const t=`预拉取报错：${JSON.stringify(e)}`;return this.setStatus(o.FAILED,t),a(new Error(t))}}))}handleData(e){return new Promise(((t,a)=>{try{const r=(y.default.getCacheValue("logindata")||{}).token||"";let s="";s=(0,E.isMT)()||(0,E.isApp)()?getApp().$systemInfo.getSystemInfo().uuid||"":y.default.getCacheValue("uuid")||"",D.log.warn(U,"本地信息：",{token:r,version:A,uuid:s},"预拉取后台返回",e),this.originData=e;const i=((e,t)=>{if(13===`${e}`.length){const a=t-e;return D.log.warn(U,"ms time diff",a),a<4e4}const a=Math.floor(t/1e3)-e;return D.log.warn(U,"s time diff",a),a<40})(e.timeStamp,Date.now());if(e.fetchedData){const n=JSON.parse(e.fetchedData);if(0===n.code&&n.data){const{type:e,valid:u}=this.judgeValidData(n.data,i,r,s);return u?((0,p.tagTime)("prefetch"),this.data=n.data,this.setStatus(o.SUCCESS,n.data),t(n.data)):(this.setStatus(o.SUCCESS_BUT_INVALID,e),a(new Error(`预拉取数据无效 ${v[e]}`)))}this.setStatus(o.API_FAILED,e);const u=`预拉取成功，但接口返回失败：${JSON.stringify(n)}`;return D.log.info(U,"getPrefetchDataCore->wx.getBackgroundFetchData",u),a(new Error(u))}return this.setStatus(o.WX_DATA_INVALID,"没有fetchedData"),D.log.info(U,"getPrefetchDataCore->wx.getBackgroundFetchData","没有fetchedData"),a(new Error("没有fetchedData"))}catch(e){const t=`预拉取报错：${JSON.stringify(e)}`;return this.setStatus(o.FAILED,t),a(new Error(t))}}))}_getPrefetchDataCoreDebug(){return new Promise(((e,t)=>{try{D.log.info(U,"getPrefetchDataCore->wx.getBackgroundFetchData"),(0,S.getPrefetchInfo)().then(((e={})=>this.handleData({timeStamp:Date.now(),fetchedData:JSON.stringify({code:0,data:e})}))).then((t=>e(t))).catch((e=>(this.setStatus(o.FAILED,e),t(e))))}catch(e){const a=`预拉取报错：${JSON.stringify(e)}`;return this.setStatus(o.FAILED,a),t(new Error(a))}}))}getPrefetchDataCore(){return e=this,t=null,a=function*(){var e;const t=getApp();return this.isDebug&&"on"===(null==(e=null==t?void 0:t.getModule("env"))?void 0:e.getCache("openPrefetch"))?this._getPrefetchDataCoreDebug():I.default.use("getBackgroundFetchData",(e=>this._getPrefetchDataCore(e)),(()=>{this.isSupportPrefetch()}))},new Promise(((r,s)=>{var i=e=>{try{u(a.next(e))}catch(e){s(e)}},n=e=>{try{u(a.throw(e))}catch(e){s(e)}},u=e=>e.done?r(e.value):Promise.resolve(e.value).then(i,n);u((a=a.apply(e,t)).next())}));var e,t,a}setPrefetchInfo(e){this.aggreAndPrefetchInfo=e,this.event.emit(f.PREFETCH_AGGRE_STATUS,{status:e})}};