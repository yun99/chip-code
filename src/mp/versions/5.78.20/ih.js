var e=Object.create,t=Object.defineProperty,r=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,o=Object.getOwnPropertySymbols,s=Object.getPrototypeOf,n=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,a=(e,r,i)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[r]=i,p=(e,t)=>{for(var r in t||(t={}))n.call(t,r)&&a(e,r,t[r]);if(o)for(var r of o(t))u.call(t,r)&&a(e,r,t[r]);return e},c=e=>t(e,"__esModule",{value:!0}),l=o=>((e,o,s)=>{if(o&&"object"==typeof o||"function"==typeof o)for(let u of i(o))n.call(e,u)||"default"===u||t(e,u,{get:()=>o[u],enumerable:!(s=r(o,u))||s.enumerable});return e})(c(t(null!=o?e(s(o)):{},"default",o&&o.__esModule&&"default"in o?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0})),o);((e,r)=>{for(var i in c(e),r)t(e,i,{get:r[i],enumerable:!0})})(exports,{default:()=>m});var d=l(require("./ob.js")),h=l(require("./u8.js")),y=require("./p3.js"),g="AppShowOptions",I={},m=class{constructor(e,t){this.pendingSceneVal={},this.getProtoParse=()=>this.protoParse,this.parseQueryScene=e=>{return t=this,r=null,i=function*(){const t=this.parseQuerySceneRG(e),{r:r="",g:i=""}=t;if(i)try{const e=yield this.app.$service.parseGroupMiniAppQrCode({uniqueCode:`g=${i}`});return d.log.info(g,"团长海报码的接口返回值是：",e),e}catch(e){return d.log.warn(g,"团长海报二维码接口报错",e),t||{}}if(r)try{const e=yield this.app.$service.parseMiniAppQrCode({uniqueCode:`r=${r}`});return d.log.info(g,"小程序码的接口返回值是：",e),e||t}catch(e){return d.log.warn(g,"小程序码的接口报错：需要@季士普+@黄杨统一【团长和用户】技术实现",e),t||{}}return{}},new Promise(((e,o)=>{var s=e=>{try{u(i.next(e))}catch(e){o(e)}},n=e=>{try{u(i.throw(e))}catch(e){o(e)}},u=t=>t.done?e(t.value):Promise.resolve(t.value).then(s,n);u((i=i.apply(t,r)).next())}));var t,r,i},this.getPath=()=>this.path,this.getQuery=()=>this.query,this.getScene=()=>this.scene,this.getExtPoiIds=()=>({extPoiIds:this.extPoiIds,extPoiIdStr:this.extPoiIdStr,shareUserId:this.shareUserId}),this.parseExtPoiIds=(e={})=>{let t=e.poiList||e.poilist||e.poiId||e.poi_id;t=t&&"0"!==t&&"undefined"!==t&&"null"!==t?t:null;let r=e.poiIdStr||"";return r="-999"===r?"":r,{extPoiIds:t,extPoiIdStr:r}},this.setExtPoiIds=e=>{if(e){let t=e.poiList||e.poilist||e.poiId||e.poi_id,r=e.poiIdStr;t=t&&"0"!==t&&"undefined"!==t&&"null"!==t?t:null,t&&(delete this.query.poiList,delete this.query.poilist,delete this.query.poiId,delete this.query.poi_id,this.query.originalPoiId=t,t.includes(",")&&(d.log.error(g,"外部传入了多个门店：",t),t=t.split(",").find((e=>+e>0))||null)),r="-999"===r?"":r,r&&(this.query.originalPoiIdStr=r,delete this.query.extPoiIdStr),this.extPoiIds=t,this.extPoiIdStr=r;const i=+((null==e?void 0:e.shareUserId)||(null==e?void 0:e.suid));this.shareUserId=isNaN(i)?null:i,this.queryObject&&this.queryObject.updateOriginQuery(this.query)}},this.clearExtPoiIds=()=>{this.extPoiIds="",this.extPoiIdStr=""},this.app=e,this.orginalAppLaunchOptions=t,this.init(t),this.handleOptions(t)}ignoreSomeQueryInSomeScene(e){return!!(0,h.isWX)()&&[1106,1104,1089].includes(+e)}handleOptions(e){try{const t=JSON.parse(JSON.stringify((null==e?void 0:e.query)||{}));(t.reqid||t.shareid||!Object.keys(I).length)&&(I=t,d.log.warn(g,"oldShareOptions重置：",I)),this.shareOptions=I}catch(e){this.shareOptions={}}}init(e){const{path:t,scene:r,referrerInfo:i={}}=e;this.path=t,this.scene=r;let{query:o={}}=e;d.log.warn(g,"原始Options：",e),this.ignoreSomeQueryInSomeScene(r)&&(d.log.warn(g,"清空query",r),o={});let s=p({},o);if(o.userId&&(this.app.$shareUserId=o.userId),s.scene&&(void 0===r&&(s.scene=""),this.pendingSceneVal=this.parseQuerySceneRG(s.scene)),i&&i.extraData&&(s=p(p({},o),i.extraData)),s.q){const e=y.parse(decodeURIComponent(s.q),!0).query;s.utm_campaign=e.utm_campaign,e.protocol&&(s.protocol=encodeURIComponent(e.protocol))}let n=s||{};const u=s.protocol?y.parse(decodeURIComponent(s.protocol),!0):null;this.protoParse=u,u&&u.query&&(n=p(p({},s),u.query)),this.query=n||{},this.setExtPoiIds(n),d.log.warn("解析app.onShow的参数为：",{path:this.path,query:this.query,scene:this.scene,shareTicket:this.shareTicket,referrerInfo:this.referrerInfo,extPoiIds:this.extPoiIds,extPoiIdStr:this.extPoiIdStr}),this.queryObject=new class{constructor(e){this.originQuery=e}updateOriginQuery(e){this.originQuery=e}getQuery(){if("object"!=typeof this.originQuery||null===this.originQuery)return d.log.warn(g,"originQuery 不是对象"),this.originQuery;try{const e=JSON.stringify(this.originQuery);return JSON.parse(e)}catch(e){return d.log.error(g,"parse 失败",this.originQuery),this.originQuery}}getDecodeQuery(){const e=this.getQuery();return e&&"object"==typeof e&&+e._routerEncodeCount&&(delete e._routerEncodeCount,d.log.info("getDecodeQuery query",e),Object.keys(e).map((t=>{const r=e[t],i=r?decodeURIComponent(r):"";try{const r=JSON.parse(i);e[t]=r}catch(r){e[t]=i}}))),e}}(this.query),this.app.$event.emit(this.app.$event.CONTANTS.OPTIONS_PARSING_FINISHED,{q:n})}getDecodeQuery(){return this.queryObject&&"function"==typeof this.queryObject.getDecodeQuery?this.queryObject.getDecodeQuery():{}}appendOptions(e){if(!e)return;d.log.warn(g,"解析小程序码之后的参数：",e);const{query:t}=this,{skuId:r="",poiId:i="",poiIdStr:o="",r:s="",protocol:n="",g:u="",userId:a=null,scid:p="",sappnm:c="",utm:l="",extendParams:h="{}",extraParams:y="{}"}=e;if(r&&(t.skuId=+r),i&&(t.poiId=+i),o&&(t.poiIdStr=o),s&&(t.r=s),u&&(t.g=u),n&&u){const e=-1===n.indexOf("?")?"?":"&";t.protocol=`${encodeURIComponent(`${n}${e}${u}&poiId=${i}&poiIdStr=${o}`)}`}else n?t.protocol=`${encodeURIComponent(`${n}`)}`:r&&(i||o)&&(t.protocol=`${encodeURIComponent(`igrocery://www.grocery.com/detail?poiId=${+i}&skuId=${+r}&poiIdStr=${o}`)}`,d.log.info("旧海报二维码",`商详 - ${JSON.stringify(e)}`));if(a&&(t.shareUserId=a),t.scid=p,t.sappnm=c,l)try{const e=JSON.parse(l);Object.keys(e).forEach((r=>{t[r]=e[r]}))}catch(e){d.log.error(`解析 utm 失败, utm: ${l}, error: ${e}`)}if(h)try{t.extendParams=JSON.parse(h)||{}}catch(e){d.log.error(`解析 extendParams 失败, extendParams: ${h}, error: ${e}`)}if(y)try{t.extraParams=JSON.parse(y)||{}}catch(e){d.log.error(`解析 extraParams 失败, extraParams: ${y}, error: ${e}`)}this.app.$lxLog.setLxEnv({opt:t,scene:this.scene}),this.queryObject.updateOriginQuery(t),this.app.$router.proxyActivity.initYXQuery(t)}parseQuerySceneRG(e){return(decodeURIComponent(e)||"").split("&").reduce(((e,t)=>{if("string"==typeof t&&t){const[r="",i=""]=t.split("=");r&&i&&(e[r]=i)}return e}),{})}};module.exports={AppShowOptions:m};