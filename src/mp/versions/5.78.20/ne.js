var e=Object.create,r=Object.defineProperty,t=Object.getOwnPropertyDescriptor,o=Object.getOwnPropertyNames,i=Object.getOwnPropertySymbols,s=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,d=(e,t,o)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,u=(e,r)=>{for(var t in r||(r={}))a.call(r,t)&&d(e,t,r[t]);if(i)for(var t of i(r))n.call(r,t)&&d(e,t,r[t]);return e},c=e=>r(e,"__esModule",{value:!0}),p=i=>((e,i,s)=>{if(i&&"object"==typeof i||"function"==typeof i)for(let n of o(i))a.call(e,n)||"default"===n||r(e,n,{get:()=>i[n],enumerable:!(s=t(i,n))||s.enumerable});return e})(c(r(null!=i?e(s(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i),l=(e,r,t)=>new Promise(((o,i)=>{var s=e=>{try{n(t.next(e))}catch(e){i(e)}},a=e=>{try{n(t.throw(e))}catch(e){i(e)}},n=e=>e.done?o(e.value):Promise.resolve(e.value).then(s,a);n((t=t.apply(e,r)).next())}));((e,t)=>{for(var o in c(e),t)r(e,o,{get:t[o],enumerable:!0})})(exports,{default:()=>R});var m=p(require("./is.js")),g=p(require("./ob.js")),y=p(require("./gb.js")),h=p(require("./u8.js")),f=p(require("./ko.js")),b=p(require("./x6.js")),S=p(require("./f6.js")),{isMMP:v,getPerformanceExtraData:P}=require("./p0.js"),O=getApp(),R=class{constructor(e){this.submitErrorCode=null,this.submitErrorMsg="",this.delay=3e3,this.submitOrderService=u({},b),this.ORDER_TYPE=f.SubmitOrderType.NORMAL,this.order=e}showPreviewLoading(){this.order.loading(!0),this.order.ifPreviewResponse=!1}hidePreviewLoading(){this.order.loading(!1),this.order.ifPreviewResponse=!0}orderPreview(){return l(this,null,(function*(){var e;const{order:r}=this;let t;try{if(this.showPreviewLoading(),r.pageFirstLoad){g.log.info("<submitOrderService orderPreview> 准备执行预请求");try{t=yield r.getPreFetchedData(),g.log.info("<submitOrderService orderPreview> 执行预请求成功")}catch(e){if("NoPreFetchedDataError"!==e.name)throw e;g.log.info("<submitOrderService orderPreview> 执行预请求失败，重新发起请求"),t=yield this.getPreviewRes(),g.log.info("<submitOrderService orderPreview> 调用orderPreview接口完成",t)}}else t=yield this.getPreviewRes(),g.log.info("<submitOrderService orderPreview> 调用orderPreview接口完成",t);if(r.fromSource=1,this.hidePreviewLoading(),t.error)throw t.error;t&&"toastMsg"in t&&t.toastMsg&&r.toast(t.toastMsg),g.log.info("<submitOrderService orderPreview> 准备对response进行mapping");const e=r.mapping.normalOrderPreviewMappingRes(t);return g.log.info("<submitOrderService orderPreview> 对response  mapping完成"),this.previewDataProcess(t,e),O.$cat.reportCustomMetrics(m.YXReportTarget.SUBMIT_ORDER_PREVIEW,m.ReportValue.SUCCESS,{type:"success"}),t}catch(t){if(this.hidePreviewLoading(),r.ifPreviewResponse=!0,this.order.setData({isPageReady:!0}),g.log.info(`<submitOrderService orderPreview> orderPreview报错，错误为${JSON.stringify(t)}`,t),O.$cat.reportCustomMetrics(m.YXReportTarget.SUBMIT_ORDER_PREVIEW,m.ReportValue.FAILED,{type:t.msg||t.message||"unknown error"}),t.reason||t.exceptionPopProductModelList)return r.submitError.handleErrorReason(t);r.toast(t.message||"网络异常，请重试。"),406!==(null==(e=null==t?void 0:t.data)?void 0:e.code)&&(r.timer=setTimeout((()=>O.$router.triggerBack("submitOrder-orderPreview")),2e3))}return{}}))}getPreviewRes(){return Promise.resolve()}setSubmitErrorCode(e){this.submitErrorCode=e}delayClearSubmitErrorCode(){setTimeout((()=>{this.submitErrorCode=null}),this.delay)}checkSubmitErrorCodeDelay(){return 10006===this.submitErrorCode&&(this.order.toast({message:this.submitErrorMsg}),!0)}reportSubmitName(){var e,r;O.$cat.reportCustomMetrics(m.YXReportTarget.SUBMIT_ORDER_NAME,m.ReportValue.SUCCESS,{result:m.SubmitOrderNameResults.TOTAL_NAME});const t=null==(e=this.order.data.orderPreview.defaultPerson)?void 0:e.addressPerson,o=this.order.data.orderPreview.resultPersonName;o===(null==(r=O.getModule("user"))?void 0:r.getWxNickName())?O.$cat.reportCustomMetrics(m.YXReportTarget.SUBMIT_ORDER_NAME,m.ReportValue.SUCCESS,{result:m.SubmitOrderNameResults.USE_WX_NAME}):O.$cat.reportCustomMetrics(m.YXReportTarget.SUBMIT_ORDER_NAME,m.ReportValue.FAILED,{result:m.SubmitOrderNameResults.USE_WX_NAME}),o===t?O.$cat.reportCustomMetrics(m.YXReportTarget.SUBMIT_ORDER_NAME,m.ReportValue.SUCCESS,{result:m.SubmitOrderNameResults.USE_BACK_NAME}):O.$cat.reportCustomMetrics(m.YXReportTarget.SUBMIT_ORDER_NAME,m.ReportValue.FAILED,{result:m.SubmitOrderNameResults.USE_BACK_NAME})}getSubmitNextUrl(e,r){let t="";const{ABTestKey:o,orderPreview:i}=this.order.data;return t=r&&v()?e>1?"/pages/orderList/index":"/pages/orderDetail/index":o?`/pages/paySuccess/index?strategy=${o}&shippingType=${i.shippingType}`:`/pages/paySuccess/index?shippingType=${i.shippingType}`,t}submit(){return l(this,null,(function*(){var e,r,t,o,i,s,a;const{order:n}=this;this.reportSubmitName();try{if(this.checkSubmitErrorCodeDelay())return;if(g.log.info("<submitOrderService submit> 准备进行submit校验"),!n.validate.normalSubmit())return void g.log.info("<submitOrderService submit> submit校验失败");if(g.log.info("<submitOrderService submit> submit校验成功"),null==(r=null==(e=this.order.data.orderPreview)?void 0:e.selfLifting)?void 0:r.selfTipTypeDesc){if(!(yield this.order.useComponentFunc("#self-lifting-confirm","secCheck",this.order.data.orderPreview.selfLifting)))return}n.loading(!0),n.submitPending=!0,g.log.info("<submitOrderService submit> 准备生成submit参数");const d=n.mapping.getNormalSubmitMapping();g.log.info("<submitOrderService submit> submit参数生成成功"),this.order.data.payType===f.PayType.oneClickPay&&(d.payType=9);const c=yield this.submitOrderService.submitOrder(d,u(u({},n.options.trafficSource?{trafficSource:n.options.trafficSource}:{}),getApp().$externalSource?{externalSourceList:getApp().$externalSource}:[]));if(c.error)return g.log.info(`<submitOrderService submit> 调用submit出错, 错误为${JSON.stringify(c.error)}`),O.$cat.reportCustomMetrics(m.YXReportTarget.SUBMIT_ORDER_SUBMIT,m.ReportValue.FAILED,{type:c.error.msg||"unknown failure",orderType:this.ORDER_TYPE}),c.code&&1021===c.code&&(this.order.isPartReturnCouponInvalid=!0),n.submitPending=!1,n.loading(!1),n.submitError.handleErrorReason(c.error);this.setSubmitErrorCode(null),g.log.info("<submitOrderService submit> submit接口调用成功");const{orderId:p,orderIdList:l,experiments:y}=c,h=(null==(t=(y||[]).find((e=>"pay_success_page_optimize_group1"===e.groupKey)))?void 0:t.expKey)||"d",b="D"===(null==h?void 0:h.toLocaleUpperCase()),S=this.getSubmitNextUrl(l.length,b),v={};(n.data.orderPreview.packageInfo||[]).forEach((e=>{(e.skuProductInfo||[]).forEach((e=>{v[e.spuId]=1}))}));const P=l||[p],{memberUserSwitchInfo:R,open:T}=(null==(o=n.data.orderPreview.useSwitch)?void 0:o.memberInfo)||{};if((null==R?void 0:R.memberCardSkuId)&&T&&(v[R.memberCardSkuId]=1),P.length?(g.log.info(`<submitOrderService submit> 上报成单事件。\n\n                    skuMap：${JSON.stringify(v)} \n\n                    skuProductInfo：${JSON.stringify(n.data.orderPreview.packageInfo||[])}\n                    orderList：${JSON.stringify(P)}`),P.forEach((e=>{var r,t;O.$lxLog.bo("b_youxuan_h978z0ca_bo",e,{poi_id:null==(r=O.$poi)?void 0:r.getPoiId(),poiIdStr:null==(t=O.$poi)?void 0:t.getPoiIdStr(),order_id:e,parent_order_id:p,card_order_id:"-999",sku_list:Object.keys(v).map((e=>+e))})}))):g.log.info(`<submitOrderService submit> 没有成单事件。\n\n                    orderIdList：${JSON.stringify(l||[])}\n\n                    orderId：${p||"无"}`),"NO_NEED_TO_PAY"===c.payToken)return g.log.info("<submitOrderService submit> 零元单无需支付"),setTimeout((()=>{this.gotoRedirectTo(`${S}${S.indexOf("?")>-1?"&":"?"}showPop=1&orderId=${c.orderId}`)}),1e3),void O.$cat.reportCustomMetrics(m.YXReportTarget.SUBMIT_ORDER_SUBMIT,m.ReportValue.SUCCESS,{type:"no need pay",orderType:this.ORDER_TYPE});g.log.info("<submitOrderService submit> 准备支付");const E={cashier_type:this.order.data.payType,extra_data:{reconfirm:this.order.data.toggleOneClickSwitch||(null==(i=this.order.data.orderPreview.preDisplayInfo)?void 0:i.openStatus)||this.order.data.payType!==f.PayType.oneClickPay?"0":"1",open_oneclickpay:(null==(s=this.order.data.orderPreview.preDisplayInfo)?void 0:s.openStatus)||this.order.data.payType!==f.PayType.oneClickPay?"0":"1",serialCode:null==(a=this.order.data.orderPreview.preDisplayInfo)?void 0:a.serialCode}};if(c.riskInfo&&"126"===c.riskInfo.riskLevel)return void this.order.alert({message:c.riskInfo.riskMsg,textOK:c.riskInfo.btnDesc,ok:()=>{this.pay(Object.assign(c,E),S)}});O.$cart.operateCart({cartOpType:"REFRESH",cartOpSource:"ORDER",forceRefresh:!0,needAnimation:!1});const C=yield this.getEncryptedOrderId(p);this.generateQRCode(C),this.pay(Object.assign(c,E),S)}catch(e){const r=e.data&&e.data.code||null;this.setSubmitErrorCode(r),this.delayClearSubmitErrorCode(),g.log.info(`<submitOrderService submit> submit失败，错误为${JSON.stringify(e)}`),O.$cat.reportCustomMetrics(m.YXReportTarget.SUBMIT_ORDER_SUBMIT,m.ReportValue.FAILED,{type:e.message||"unknown failure",orderType:this.ORDER_TYPE}),this.order.loading(!1),this.order.submitPending=!1;(O.judgeIfNetWorkErrorFindLogLevel(e)||console.error)("submit-err:",e);let t=e.message||"网络异常，请重试";e.data&&1021===e.data.code&&(this.order.isPartReturnCouponInvalid=!0),e.data&&2===e.data.code&&!e.data.error&&(t="支付失败,请稍后重试"),e.data&&3006===e.data.code&&this.gotoRedirectTo("/pages/orderList/index"),this.submitErrorMsg=t,this.order.toast({message:t}),n.submitError.handleErrorReport("提单接口",JSON.stringify(e))}}))}generateQRCode(e){return b.generateQRCode({text:e}).then((e=>{e.url?O.$cat.reportCustomMetrics(m.YXReportTarget.ORDER_QRCODE,m.ReportValue.SUCCESS):O.$cat.reportCustomMetrics(m.YXReportTarget.ORDER_QRCODE,m.ReportValue.FAILED,{reason:"no url"})})).catch((e=>{g.log.error(`二维码绘制接口失败了 ${JSON.stringify(e)}`),O.$cat.reportCustomMetrics(m.YXReportTarget.ORDER_QRCODE,m.ReportValue.FAILED,{reason:e.message||"unknown reason"})}))}gotoRedirectTo(e){var r,t;let o;const i=getApp().$abTest.getGrayStrategyVal("grocery_c_front_submit_cart")||"";o={forceGotoFn:!0,fnName:(0,h.isWX)()&&["a1","a2","a3"].includes(i.toLowerCase())&&"pages/cart/index"===(null==(t=null==(r=getApp())?void 0:r.page())?void 0:t.route)?"navigateTo":"redirectTo"},this.order.loading(!1),O.$router.goto(e,null,o)}payNotSuccess(e,r){return`/pages/orderDetail/index?orderId=${e.orderId}${r.failGoBackUrl?`&waitPayGoBackUrl=${encodeURIComponent(r.failGoBackUrl)}`:""}`}paySuccess(e,r){return`${r}${r.indexOf("?")>-1?"&":"?"}&showPop=1&orderId=${e.orderId}`}pay(e,r){g.log.info("<submitOrderService pay> 准备支付"),this.order.onShowFromPay=!0;const t=this.paySuccess(e,r),o=this.payNotSuccess(e,this.order.options);this.order.setData({showMask:!0}),this.order._payNotSuccessUrl=1===e.payTokenType||4===e.payTokenType||v()?"":o,S.pay(e,{options:{successUrl:t,errorUrl:o},success:r=>{const o=(0,h.isWXMT)()?["pickUp","paySuccessActive","paySuccessSeckill"]:["pickUp","delivery","collected"];return this.order._payNotSuccessUrl=void 0,g.log.info("<submitOrderService pay> 支付成功",r),this.order.submitPending=!1,S.paySuccess(e.orderId,this.ORDER_TYPE),S.subscribeAfterPay(o,!0).then((()=>{this.gotoRedirectTo(t)})).catch((e=>{if((0,h.isInWX)()){g.log.warn("支付完成订阅失败",e);let r="";"99994"===e.errCode?r=t.indexOf("?")>-1?`${t}&subscribe=1`:`${t}?subscribe=1`:(O.page().toast(e.errMsg),r=t),this.gotoRedirectTo(r)}}))},cancel:e=>{this.order._payNotSuccessUrl=void 0,g.log.info("<submitOrderService pay> 支付取消",e),this.order.submitPending=!1,this.order.loading(!1),setTimeout((()=>{this.gotoRedirectTo(o)}),1e3)},fail:e=>{this.order._payNotSuccessUrl=void 0,g.log.info("<submitOrderService pay> 支付失败",e),this.order.submitPending=!1,this.order.loading(!1),O.$cat.reportCustomMetrics(m.YXReportTarget.SUBMIT_ORDER_SUBMIT,m.ReportValue.FAILED,{type:"pay fail",orderType:this.ORDER_TYPE}),this.order.toast({message:"支付失败,请稍后重试"}),this.order.submitError.handleErrorReport("支付",JSON.stringify(e)),setTimeout((()=>{this.gotoRedirectTo(o)}),1e3)}})}previewDataProcess(e,r){var t,o,i,s,a;g.log.info("<submitOrderService previewDataProcess> 处理普通提单数据",r);const{order:n}=this,d=this.order.remarkObj[r.shippingType],u=[];let c=f.PayType.traditionPay;e.preDisplayInfo&&(u.push({title:"极速支付",payType:f.PayType.oneClickPay,subTitle:null==(t=e.preDisplayInfo)?void 0:t.oneClickPaySubTitle,usable:null==(o=e.preDisplayInfo)?void 0:o.usableStatus}),1===(null==(i=e.preDisplayInfo)?void 0:i.defaultPayType)&&(c=f.PayType.oneClickPay)),u.push({title:"普通支付",payType:f.PayType.traditionPay,subTitle:"",usable:!0});let p,m,h=c===f.PayType.oneClickPay?"极速支付":"立即支付";if(e.priceThresholdStatus&&(h=`商品满${(0,y.fen2Yuan)(e.deliveryPriceThreshold,2,!0)}元起送`),e.experiments){const r=e.experiments.find((e=>"Buy_one_more_group"===e.groupKey));p=null==(s=null==r?void 0:r.expKey)?void 0:s.toLocaleUpperCase();const t=e.experiments.find((e=>"SubmitPage_newuser_highlight_poi_group1"===e.groupKey));m=null==(a=null==t?void 0:t.expKey)?void 0:a.toLocaleUpperCase()}const{fromPage:b}=n.options;Object.keys(r).forEach((e=>void 0===r[e]&&delete r[e])),n.metricsSetData({isPageReady:!0,orderPreview:r,isBuyNow:this.order.isBuyNow,submitDisabled:this.checkSubmitDisabled(),payTypeList:u,submitText:h,ABTestKey:"cart"===b||n.options.scene?"":"A",payType:c,hasPromotion:!!r.priceInfo&&(r.priceInfo||[]).some((e=>1===e.promotionFlag)),noticeBoardShow:!("number"!=typeof(r.pushMsg&&r.pushMsg.msgType)),remark:d?d.submitOrderShowText:e.defaultRemark&&e.defaultRemark.content||"",selfLiftingTest:m||"C",fromPage:b||"-999"},{fmp:!0,fmpParams:n.options,extra:P()},(()=>{if(!n.renderEndTime&&n.renderStartTime){n.renderEndTime=Date.now();const e=n.renderEndTime-n.renderStartTime;g.log.info("<submitOrder metricsSetData> 提单页首屏渲染时间为",e),O.$lxLog.mv("b_youxuan_8ralvvty_mv",{fmp:e})}const r=n.selectComponent("#notice-board");let t=0;if(n.data.noticeBoardShow){const e=setTimeout((()=>l(this,null,(function*(){t=yield n.selectComponent("#notice-board").getBoardHeight();const{screenWidth:r}=O.getModule("systemInfo").systemInfo;t+=18*r/750,clearTimeout(e)}))),100)}n.setData({marginTop:t,noticeBoardShow:(null==r?void 0:r.getInnerNoticeBoardShow())||!1}),["B","C"].indexOf(p)>-1&&e.makeUpPopModel&&setTimeout((()=>O.$event.emit(O.$event.CONTANTS.BUY_ANOTHER_POPUP_SHOW)),0)})),O.$store.setCache("skuProductInfo",e.skuProductInfo||[],{isOnlyCache:!0})}checkSubmitDisabled(){return O.$poi.isExperiencePoi()}getCouponList(e){e&&(this.order.loading(!0),O.$service.querySubmitPageResultById({id:e}).then((e=>{const{couponIds:r}=this.order.data.orderPreview.couponInfo,{defaultChoiceCouponId:t}=this.order.data.orderPreview.couponInfo,o=[],i=[],s=[];e.couponUserList.forEach((e=>{-1!==r.indexOf(e.couponCode)?e.couponSelected=!0:e.couponSelected=!1,-1!==t.indexOf(e.couponCode)?o.push(e):-1===t.indexOf(e.couponCode)&&e.valid?i.push(e):s.push(e)})),this.order.setData({couponData:{couponDesc:e.couponDesc,bestCouponList:o,otherUsefullCouponList:i,unUsefullCouponList:s},showCouponList:!0}),this.order.loading(!1)})).catch((e=>{this.order.toast(`${e.message||"网络异常，请重试"}`),this.order.loading(!1)})))}queryOrderReturn(){b.queryOrderReturn({type:2,cacheId:this.order.data.orderPreview.couponAssign.idStr}).then((e=>{this.order.setData({returnCouponList:e.items&&e.items.length?e.items:[],ifCouponAssignToastShow:!(!e.items||!e.items.length)}),this.order.loading(!1)})).catch((e=>{this.order.loading(!1)}))}getEncryptedOrderId(e,r=!0){return b.getEncryptedOrderId({orderId:e}).then((({orderIdEncrypted:t})=>t||(r?e:""))).catch((t=>(g.log.warn(`获取加密订单id(${e})接口失败 ${JSON.stringify(t)}`),r?e:"")))}};