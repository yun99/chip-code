var t,e;t="undefined"!=typeof self?self:exports,e=function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s="./src/index.ts")}({"./src/config.ts":function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.RETRY_CODE=e.Domain=void 0,e.Domain={production:"wss://api-mall.meituan.com/client/report",staging:"wss://api-mall.meituan.com/client/report",test:"ws://mall-api.mall.test.sankuai.com/client/report",dev:"ws://localhost:4001/client/report"},e.RETRY_CODE=[1001,1003,1005,1006,1007,1011,1012,1013,1014]},"./src/format.ts":function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.leftPad=void 0;var i=[""," ","  ","   ","    ","     ","      ","       ","        ","         "];e.leftPad=function(t,e,n){if((e-=(t+="").length)<=0)return t;if(n||0===n||(n=" ")," "==(n+="")&&e<10)return i[e]+t;for(var o="";1&e&&(o+=n),e>>=1;)n+=n;return o+t}},"./src/index.ts":function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.Logger=void 0;var i=n("./src/message.ts"),o=n("./src/config.ts"),r=n("./src/format.ts"),s=function(){function t(t){var e=this;if(this.allReadyAttempts=0,this.canSend=!1,this.isOpen=!1,this.isDebug=!1,this.reconnecting=!1,this.maxHistory=1e3,this.historyLogs=[],this.keepAlive=function(){e.reconnecting||e.isOpen||e.createSocket()},this.onNetworkStatusChangeCallBack=function(t){t&&t.networkType&&(e.network=t.networkType)},this.start=function(){e.isOpen||e.reconnecting||(e.createSocket(),e.timer&&clearInterval(e.timer),e.keepAliveTimer&&clearInterval(e.keepAliveTimer),e.timer=setInterval((function(){e.canSend&&e.socket&&e.websocketSend("ping")}),2e3),e.keepAliveTimer=setInterval(e.keepAlive,2e6),wx.onNetworkStatusChange&&wx.onNetworkStatusChange(e.onNetworkStatusChangeCallBack))},this.close=function(){e._print("close"),e.socket&&e.socket.close({code:1e3,reason:"SDK主动关闭"}),e.canSend=!1,e.isOpen=!1,wx.offNetworkStatusChange&&wx.offNetworkStatusChange(e.onNetworkStatusChangeCallBack),clearInterval(e.timer),clearInterval(e.keepAliveTimer)},this.reStart=function(){e.close(),setTimeout((function(){e.start()}),0)},this.websocketSend=function(t){e.socket&&(e.isOpen?e.socket.send({data:t,fail:function(t){if(e._print("send:error",t),!t.errMsg.indexOf("fail taskID not exist")&&!t.errMsg.indexOf("fail wcwss taskID not exist"))throw t;e.reStart()}}):e.reStart())},this.send=function(t){if(e.canSend&&e.socket){var n=JSON.stringify({type:"log",data:t});e.websocketSend(n)}else e.historyLogs.length>e.maxHistory&&e.historyLogs.shift(),e.historyLogs.push(t)},this.log=function(t,n,i,o,s,a){var c=getCurrentPages(),u=c[c.length-1],f="";u&&(f=u.route);var p=new Date,d={tags:{tag:s,type:t,scene:o,path:f,network:e.network,client_time:p.getFullYear()+"-"+r.leftPad(p.getMonth()+1,2,"0")+"-"+r.leftPad(p.getDate(),2,"0")+" "+r.leftPad(p.getHours(),2,"0")+":"+r.leftPad(p.getMinutes(),2,"0")+":"+r.leftPad(p.getSeconds(),2,"0")+"."+r.leftPad(p.getMilliseconds(),3,"0"),extra:e.tryStringfyExtra(a||{})},level:n,msg:i};e.send(d)},this.error=function(t){var n=t.type,i=t.tag,o=t.msg,r=t.extra,s=t.scene;e.log(n,"error",o,s,i,r)},this.info=function(t){var n=t.type,i=t.tag,o=t.msg,r=t.extra,s=t.scene;e.log(n,"info",o,s,i,r)},this.warn=function(t){var n=t.type,i=t.tag,o=t.msg,r=t.extra,s=t.scene;e.log(n,"warn",o,s,i,r)},this.debug=function(t){var n=t.type,i=t.tag,o=t.msg,r=t.extra,s=t.scene;e.log(n,"debug",o,s,i,r)},this.trace=function(t){var n=t.type,i=t.tag,o=t.msg,r=t.extra,s=t.scene;e.log(n,"trace",o,s,i,r)},!o.Domain[t.env])throw new Error("环境信息错误");if(t.uuid&&"string"!=typeof t.uuid)throw new Error("uuid 必须是string");if(t.uid&&"string"!=typeof t.uid)throw new Error("uid 必须是string");if(t.maxHistory&&"number"!=typeof t.maxHistory)throw new Error("maxHistory 必须是number");this.env=t.env||"production",this.appKey=t.appKey,this.uuid=t.uuid||"",this.uid=t.uid||"",this.openid=t.openid||"",this.unionid=t.unionid||"",this.maxHistory=t.maxHistory||1e3,this.reconnection="boolean"!=typeof t.reconnection||t.reconnection,this.reconnectionAttempts=t.reconnectionAttempts||500,this.reconnectionDelay=t.reconnectionDelay||1e3,this.timeout=t.timeout||5e3,this.network="unknown",this.extra={},"dev"===this.env&&(this.isDebug=!0)}return t.prototype._print=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.isDebug},t.prototype.reconnect=function(){var t=this;this.reconnecting||(this._print("reconnect start"),this.reconnecting=!0,this.allReadyAttempts<this.reconnectionAttempts&&(this.isOpen||(this.allReadyAttempts+=1,setTimeout((function(){t.createSocket()}),Math.min(this.reconnectionDelay*this.allReadyAttempts,2e4)))))},t.prototype.createSocket=function(){var t=this;try{this.socket=wx.connectSocket({url:o.Domain[this.env],timeout:this.timeout}),this.socket.onOpen((function(){t._print("onOpen"),t.isOpen=!0,t.reconnecting=!1;var e=wx.getSystemInfoSync();wx.getNetworkType({success:function(e){t.network=e.networkType}}),t.websocketSend(JSON.stringify(new i.InitMsg(t.appKey,{uuid:t.uuid,uid:t.uid,extra:t.extra,device:JSON.stringify({loggerLibVersion:"0.2.0",model:e.model,system:e.system,version:e.version,SDKVersion:e.SDKVersion,fontSizeSetting:e.fontSizeSetting,benchmarkLevel:e.benchmarkLevel,albumAuthorized:e.albumAuthorized,cameraAuthorized:e.cameraAuthorized,locationAuthorized:e.locationAuthorized,locationEnabled:e.locationEnabled,wifiEnabled:e.wifiEnabled,theme:e.theme,brand:e.brand,batteryLevel:e.batteryLevel,platform:e.platform})})))})),this.socket.onMessage((function(e){if(t._print("onMessage",e.data),"pong"!==e.data)try{var n=JSON.parse(e.data);n&&"init"===n.type&&(t.allReadyAttempts=0,t.canSend=!0,t.historyLogs.length>0&&(t.historyLogs.forEach((function(e){return t.send(e)})),t.historyLogs=[]))}catch(t){}})),this.socket.onError((function(e){var n=e.errMsg;t._print("onError",n,t.isOpen,t.reconnecting),t.isOpen||(t.socket=null,t.canSend=!1,t.reconnecting=!1,t.reconnect())})),this.socket.onClose((function(e){var n=e.code,i=e.reason;t.reconnecting&&o.RETRY_CODE.indexOf(n)>-1||(t.reconnecting=!1,t.isOpen=!1,t.canSend=!1,t.socket=null,t._print("onClose",n,i),o.RETRY_CODE.indexOf(n)>-1&&t.reconnect())}))}catch(t){}},t.prototype.sendConfig=function(){this.canSend&&this.websocketSend(JSON.stringify(new i.ConfigMsg(this.appKey,{uuid:this.uuid,openid:this.openid,unionid:this.unionid,uid:this.uid,extra:this.extra})))},t.prototype.getUid=function(){return this.uid},t.prototype.setUid=function(t){if("string"!=typeof t)throw new Error("uid 必须是string");this.uid=t,this.sendConfig()},t.prototype.getOpenID=function(){return this.openid},t.prototype.setOpenID=function(t){if("string"!=typeof t)throw new Error("openid 必须是string");this.openid=t,this.sendConfig()},t.prototype.getUnionID=function(){return this.unionid},t.prototype.setUnionID=function(t){if("string"!=typeof t)throw new Error("unionid 必须是string");this.unionid=t,this.sendConfig()},t.prototype.getUUID=function(){return this.uuid},t.prototype.setUUID=function(t){if("string"!=typeof t)throw new Error("uuid 必须是string");this.uuid=t,this.sendConfig()},t.prototype.getExtra=function(){return this.extra},t.prototype.setExtra=function(t){this.extra=t||{},this.sendConfig()},t.prototype.tryStringfyExtra=function(t){"string"==typeof t&&(t={extra:t});try{return JSON.stringify(t),t}catch(t){return t}},t}();e.Logger=s},"./src/message.ts":function(t,e,n){Object.defineProperty(e,"__esModule",{value:!0}),e.ConfigMsg=e.InitMsg=void 0;var i=function(t,e){this.type="init",this.appKey=t,this.tags=e||{}};e.InitMsg=i;var o=function(t,e){this.type="config",this.appKey=t,this.tags=e||{}};e.ConfigMsg=o}})},"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("index",[],e):"object"==typeof exports?exports.index=e():t.index=e();