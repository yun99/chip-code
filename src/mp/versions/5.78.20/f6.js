var e=Object.create,t=Object.defineProperty,o=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,a=Object.getOwnPropertySymbols,n=Object.getPrototypeOf,i=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,c=(e,o,r)=>o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[o]=r,l=(e,t)=>{for(var o in t||(t={}))i.call(t,o)&&c(e,o,t[o]);if(a)for(var o of a(t))s.call(t,o)&&c(e,o,t[o]);return e},p=e=>t(e,"__esModule",{value:!0}),u=a=>((e,a,n)=>{if(a&&"object"==typeof a||"function"==typeof a)for(let s of r(a))i.call(e,s)||"default"===s||t(e,s,{get:()=>a[s],enumerable:!(n=o(a,s))||n.enumerable});return e})(p(t(null!=a?e(n(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a),y=(e,t,o)=>new Promise(((r,a)=>{var n=e=>{try{s(o.next(e))}catch(e){a(e)}},i=e=>{try{s(o.throw(e))}catch(e){a(e)}},s=e=>e.done?r(e.value):Promise.resolve(e.value).then(n,i);s((o=o.apply(e,t)).next())}));((e,o)=>{for(var r in p(e),o)t(e,r,{get:o[r],enumerable:!0})})(exports,{pay:()=>k,paySuccess:()=>$,subscribeAfterPay:()=>P});var d=u(require("./ob.js")),m=u(require("./uc.js")),f=u(require("./u8.js")),g=u(require("./is.js")),b=u(require("./x0.js")),{wx2promiseify:v}=require("./gi.js"),{subscribe:_}=require("./sz.js"),T=getApp(),I=(e,t)=>y(void 0,[e,t],(function*(e,{success:t,fail:o,cancel:r}){if(!T.$isProd&&!(0,f.isMMP)())return T.page().toast("支付成功"),void t();let a=(0,f.isMMP)()?wx.mtRequestPayment:wx.requestPayment;if(e.orderInfo){a=wx.requestOrderPayment;try{e.orderInfo=JSON.parse(e.orderInfo)}catch(e){d.log.error("API支付解析orderInfo失败",JSON.stringify(e))}}d.log.info("开始调用API支付 ",e);try{const o=yield v(a,e);d.log.info("API支付成功 ",o),t(o)}catch(e){/(?:mt)?requestPayment:(fail[: ])?cancel/i.test(e.errMsg)?(d.log.info("API支付取消",JSON.stringify(e)),r(e)):(d.log.error("API支付失败",JSON.stringify(e)),o(e))}})),$=(e,t)=>{d.log.info("<submitOrderService pay> 支付成功"),T.$cat.reportCustomMetrics(g.YXReportTarget.SUBMIT_ORDER_SUBMIT,g.ReportValue.SUCCESS,{type:"success",orderType:t})},P=(...e)=>y(void 0,[...e],(function*(e=["pickUp","delivery"],t=!1){var o;try{if(!(0,f.isMMP)()&&!(0,f.isTT)()){const r=yield _(e);if((0,f.isWXMT)()&&t){const e={pickUp:100,paySuccessActive:101,paySuccessSeckill:102};try{T.$service.syncSubscribeData({subPage:T.page()._route||T.page().__route__,subTemplates:r.data.map((t=>({templateId:t.tmplId,subScene:e[t.type]})))})}catch(e){d.log.warn("<paySuccess> 上报订阅结果失败",e)}}else try{yield T.$service.reportSubscribeTmpId(null==(o=null==r?void 0:r.data[0])?void 0:o.tmplId)}catch(e){d.log.warn("订阅上报失败，原因：",e)}d.log.info("提单: 优选订单提货通知订阅结果",r)}}catch(e){if(d.log.warn("提单：模板消息订阅失败",e),"99994"===e.errCode||"99998"===e.errCode)throw e;const{data:t}=e.errData||{};t&&Object.keys(t).every((e=>"reject"!==t[e]))?T.page().toast("订阅失败 请稍后重试"):T.page().toast("请打开订阅模板功能，重新尝试")}})),k=(e,t)=>{var o,r,a,n,i;const s=(null==(o=t.options)?void 0:o.goToType)||"navigateTo",c=t.options.callbackType||"redirectTo";let{successUrl:p}=t.options;const u=(0,f.isWXMT)()&&(null==(r=t.options)?void 0:r.errorUrl)?`/youxuan${null==(a=t.options)?void 0:a.errorUrl}`:null==(n=t.options)?void 0:n.errorUrl;if(1===e.payTokenType&&4===e.payTokenType||!(0,f.isInWX)()||(p+=p.indexOf("?")>-1?"&":"?",p+="subscribe=1"),e.merchantNo&&(e.merchant_no=e.merchantNo),(0,f.isMMP)())return I(e,t);if(1===e.payTokenType){d.log.info("<pay> 支付方式 微信极简支付");const o=e.wxTicket;try{const r=JSON.parse(e.tradeno)||{},a=e.subChannelPayInfo||{};return I(o?l({ticket:o},r):l(l({},r),a),t)}catch(e){d.log.error("pay",e)}}if(2!==e.payTokenType){if(3===e.payTokenType&&(d.log.info("<pay> 支付方式 降级到收银台支付"),wx[s]({url:`/finance-pay/pages/cashier/index?tradeno=${e.tradeno}&pay_token=${e.payToken}&callback_app_id=tt48f03e4dd7c81b7d01&callback_path=${encodeURIComponent(p)}&callback_type=${c}&h5_scheme=${encodeURIComponent("/pages/h5Container/index?url=")}&from=youxuan`},!0)),4===e.payTokenType){d.log.info("<pay> 支付方式 使用支付SDK进行支付"),T.globalData.mtpayCityId=e.mtCityId;const o={runtime:T.$isProd?"production":"test",productInfo:e.productInfo,callback_app_id:"tt48f03e4dd7c81b7d01",callback_type:"navigateBack",callback_path:encodeURIComponent(p),from:"youxuan"};null==(i=b.mtpay)||i.requestFinancePayment(l(l({},o),t))}}else{d.log.info("<pay> 支付方式 降级到H5收银台支付");const t=T.$poi&&T.$poi.poiInfo&&T.$poi.poiInfo.cityId,{longitude:o=0,latitude:r=0}=T.$location||{},a=`${m.payUrl}/i/cashier/show/index?auth=v2&token=${T.$userModule.getToken()}&tradeno=${e.tradeno}&pay_token=${e.payToken}&pay_success_url=${encodeURIComponent((0,f.isWXMT)()?`/youxuan${p}`:p)}&redr_url=${encodeURIComponent(u)}&nb_uuid=${T.$uuid}&nb_location=${r}_${o}&nb_ci=${t}&dp_cityid=${t}&app_id=tt48f03e4dd7c81b7d01`;T.$router.goto(a,{},{fnName:s})}};