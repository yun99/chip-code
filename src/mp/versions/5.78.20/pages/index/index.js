var e=Object.create,t=Object.defineProperty,a=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,s=Object.getOwnPropertySymbols,o=Object.getPrototypeOf,r=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,d=(e,a,i)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[a]=i,l=s=>{return((e,s,o)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let n of i(s))r.call(e,n)||"default"===n||t(e,n,{get:()=>s[n],enumerable:!(o=a(s,n))||o.enumerable});return e})((n=t(null!=s?e(o(s)):{},"default",s&&s.__esModule&&"default"in s?{get:()=>s.default,enumerable:!0}:{value:s,enumerable:!0}),t(n,"__esModule",{value:!0})),s);var n},u=(e,t,a)=>new Promise(((i,s)=>{var o=e=>{try{n(a.next(e))}catch(e){s(e)}},r=e=>{try{n(a.throw(e))}catch(e){s(e)}},n=e=>e.done?i(e.value):Promise.resolve(e.value).then(o,r);n((a=a.apply(e,t)).next())})),p=l(require("../../er.js")),g=l(require("../../ob.js")),c=l(require("../../a8.js")),m=l(require("../../up.js")),h=l(require("../../p0.js")),y=l(require("../../sx.js")),f=l(require("../../sc.js")),L=l(require("../../sv.js")),S=l(require("../../sb.js")),D=getApp();(0,p.default)({data:{poiId:0,pageId:"",requestId:"",scrollAnimation:!1,layoutScrollTop:0,poiInfo:{},apiRequestError:!1,feedData:{},feedTitle:"",hasAddCartBar:!1,isLoadingData:!1,scenes:null,configSkusList:[],configSkusTitle:"",isLive:!1,isSkuFeedEnd:!1,bidMap:L.bidMap,liveSkuType:c.ListTypes.ttLandingPageSkuArea,defaultSkuType:c.ListTypes.ttLandingPageGuesslike,isLogin:!0,subscribeLoginFlag:!1,isReported:!1,dataLoaded:!1,isPageNoSkuData:!1,errorMessage:"网络异常，请稍后再试"},onLoad(e){var t,a;(0,f.catReport)(f.FirstTarget.ON_LOAD);const{query:i}=wx.getLaunchOptionsSync(),{resume_args:s}=e;let o=null;const r=e.pageId||(null==(a=null==(t=null==D?void 0:D.$appShowOptions)?void 0:t.query)?void 0:a.pageId)||i.pageId||"";if(s)try{o=decodeURIComponent(s),o=JSON.parse(o)}catch(e){g.log.error("[pages/index/index]: 商品还原参数解析有误",e)}this.setData({pageId:r}),this.resumeArgs=o},onShow(){return u(this,null,(function*(){var e,t;g.log.info("page onShow, isLive",this.data.isLive),D.$lxLog.pv(this.data.bidMap.pageCid,{custom:{activity_page_id:this.data.pageId||(null==(t=null==(e=null==D?void 0:D.$appShowOptions)?void 0:e.query)?void 0:t.pageId)||""}}),D.$cart.refreshCart({slient:!0}),this.data.isLive&&(g.log.info("page onshow reload data,",this.data.isLive),this.retryLoadData())}))},onReady(){(0,f.catReport)(f.FirstTarget.ON_READY)},onUnload(){this.data.subscribeLoginFlag&&D.$event.off(D.$event.CONTANTS.LOGIN_SUCCESS,this.onLoginSuccessBindThis)},onShareAppMessage:()=>({path:"/pages/index/index?from=from_share",imageUrl:"https://p0.meituan.net/travelcube/3d408726ef56c85494c2e4724540a13e4500.jpg",title:"美团优选-便宜有好货，邻居都爱买。今日下单，次日自提，方便又省心，就在美团优选！"}),beforHandleTapPoi(){return u(this,null,(function*(){if(D.isLogin())return!0;const e=yield D.$login.login();return!!(null==e?void 0:e.userId)}))},onPoiInfoUpdated(e,t={}){(0,f.firstTagTime)(f.FirstTarget.ON_POI_UPDATE),g.log.info("poi update",e);const{poiId:a,poiIdStr:i}=e,{pageId:s}=this.data;(0,f.firstTagTime)(f.FirstTarget.ON_SHOW),(0,f.pageLog)("info",`onPoiInfoUpdated, pageId:${s},poiInfo:${e}`);const{resumeArgs:o}=this,r={poiIdStr:i};o&&(r.resumeParams=o),a||i?(this.loadPageData(a,s,r),this.loginStatusInit()):(this.data.isLoadingData=!1,this.setData({apiRequestError:!0})),this.setData({poiId:a||0,poiIdStr:i||0})},loginStatusInit(){return u(this,null,(function*(){try{yield null==D?void 0:D.getModule("login").tryLogin()}catch(e){(0,f.pageLog)("warn","tryLogin error")}const e=D.isLogin();this.setData({isLogin:e}),e||(this.onLoginSuccessBindThis=(0,f.throttle)(this.onLoginSuccess.bind(this),1e3),D.$event.on(D.$event.CONTANTS.LOGIN_SUCCESS,this.onLoginSuccessBindThis),this.data.subscribeLoginFlag=!0)}))},onLoginSuccess(){return u(this,null,(function*(){(0,f.pageLog)("info","onLoginSuccess");const e=D.isLogin();this.setData({layoutScrollTop:Math.random(),isLogin:e}),this.loadPageData(D.$poiId,this.data.pageId,{poiIdStr:D.$poiIdStr})}))},loadPageData(e,t,a){return u(this,null,(function*(){var i,s;if(e||a||a.poiIdStr){this.setData({isSkuFeedEnd:!1}),null==(i=D.page())||i.loading(!0);try{if(this.data.isLoadingData)return;this.data.isLoadingData=!0,(0,f.firstTagTime)(f.FirstTarget.ON_SERVICE_API_START);const i=yield(0,y.getAggregationData)(e,t,a);this.dataInit(i)}catch(a){this.data.isLoadingData=!1,this.setData({apiRequestError:!0,dataLoaded:!0}),(null==a?void 0:a.message)&&this.setData({errorMessage:a.message}),g.log.error(`ttLandingPage - 接口请求错误, message: ${null==a?void 0:a.message}, poiId: ${e}, landPageId: ${t}`)}finally{null==(s=D.page())||s.loading(!1)}(0,f.firstTagTime)(f.FirstTarget.ON_SERVICE_API_END)}}))},dataInit(e){const{banner:t,scenes:a,configSkus:i,feedSkus:o,pageNum:l,limit:u,offset:p,M_TraceId:g}=e,{list:c,title:y,isConfig:L}=(0,f.formateData)(a,i,o);this.perfSetData=this.perfSetData||this.metricsSetData||this.setData;const v=a===S.sceneTypes.LIVE,I=a===S.sceneTypes.KOL||a===S.sceneTypes.FEED,T=(null==i?void 0:i.skus)||[],b=t&&t.bannerImgUrl,P=v&&0===T.length,k=I&&T.length>0,O=c&&c.length>0,E=b||P||k||O;this.perfSetData({requestId:g||"-999",bannerData:t,scenes:a,isLive:v,isKol:I,configSkusList:T,configSkusTitle:(null==i?void 0:i.moduleTitle)||"",feedData:{itemList:c,pageNum:l,limit:u,offset:p},feedTitle:y,isConfig:L,isLoadingData:!1,apiRequestError:!1,dataLoaded:E,isBannerShow:b,isEmptyTipsShow:P,isLiveSkuFeedShow:k,isRecommendSkuFeedShow:O},(()=>{var e,t,a;this.data.isReported||((null==tt?void 0:tt.performance)&&(null==(e=null==tt?void 0:tt.performance)||e.mark("FMP")),null==(a=m.metrics)||a.appFmp(((e,t)=>{for(var a in t||(t={}))r.call(t,a)&&d(e,a,t[a]);if(s)for(var a of s(t))n.call(t,a)&&d(e,a,t[a]);return e})({key:"success",pageName:null==(t=D.page())?void 0:t.route,duration:Date.now()-D.$getAppStartTime()},(0,h.getPerformanceExtraData)())),this.setData({isReported:!0}))}))},retryLoadData(){var e;this.setData({apiRequestError:!1}),this.loadPageData(D.$poiId,this.data.pageId,{poiIdStr:(null==(e=null==D?void 0:D.$poi)?void 0:e.getPoiIdStr())||""})},onReachBottom(){return u(this,null,(function*(){g.log.info("xh: onReachBottom 触发了"),this.data.isLogin&&(this.data.isLoadingData||this.data.isSkuFeedEnd||(this.setData({isLoadingData:!0}),this.useComponentFunc("#guess-like-wrapper","getRenderData",{complete:()=>{this.setData({isLoadingData:!1})}})))}))},showAddCartBar(e){e&&e.detail!==this.data.hasAddCartBar&&this.setData({hasAddCartBar:e.detail})},onGuesssLikeRequestEnd(){this.setData({isSkuFeedEnd:!0})}});