var e=Object.create,r=Object.defineProperty,t=Object.getOwnPropertyDescriptor,o=Object.getOwnPropertyNames,a=Object.getOwnPropertySymbols,i=Object.getPrototypeOf,s=Object.prototype.hasOwnProperty,d=Object.prototype.propertyIsEnumerable,l=(e,t,o)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,n=(e,r)=>{for(var t in r||(r={}))s.call(r,t)&&l(e,t,r[t]);if(a)for(var t of a(r))d.call(r,t)&&l(e,t,r[t]);return e},p=e=>r(e,"__esModule",{value:!0}),u=a=>((e,a,i)=>{if(a&&"object"==typeof a||"function"==typeof a)for(let d of o(a))s.call(e,d)||"default"===d||r(e,d,{get:()=>a[d],enumerable:!(i=t(a,d))||i.enumerable});return e})(p(r(null!=a?e(i(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a),c=(e,r,t)=>new Promise(((o,a)=>{var i=e=>{try{d(t.next(e))}catch(e){a(e)}},s=e=>{try{d(t.throw(e))}catch(e){a(e)}},d=e=>e.done?o(e.value):Promise.resolve(e.value).then(i,s);d((t=t.apply(e,r)).next())}));((e,t)=>{for(var o in p(e),t)r(e,o,{get:t[o],enumerable:!0})})(exports,{default:()=>O});var h=u(require("../../sm.js")),g=u(require("../../a0.js")),m=u(require("../../ob.js")),_=u(require("./p9.js")),y=u(require("./gc.js")),f=u(require("./g6.js")),O=class{constructor(e){this.orderDetail=e,this.app=getApp(),this.paying=!1}operateOrder({orderId:e,btnType:r,phone:t,extractInfo:o}){var a;const{orderInfo:i}=this.orderDetail.data,{type:s,status:d,parentOrderId:l,poiId:n,poiIdStr:p,invoiceId:u,orderGroupOpFlag:c,skus:g}=i;try{o=JSON.parse(o||"{}")}catch(t){m.log.error(`订单详情：订单：${e}，按钮 type 为 ${r} 的 extractInfo: ${o}，解析报错`),o={}}switch(r){case 1:this.handleCancel({orderId:e,orderInfo:i,extractInfo:o});break;case 2:if(this.paying)return;this.toPay(e,l,c,s);break;case 3:this.app.$order.finishOrder(e);break;case 4:default:this.app.$order.askService(t);break;case 5:this.app.$order.cancelRefund(e);break;case 6:case 7:case 8:case 9:case 22:break;case 10:this.handleRefund(e,n,p,o);break;case 11:this.app.$order.gotoRefund("detail",e,n,p);break;case 12:this.app.$lxLog.mc("b_youxuan_0j21i1sk_mc",{order_id:e}),this.app.$order.gotoEvaluation("submit",e,n,p,h.SUBMIT_PAGE_SOURCE.ORDER_DETAIL_ADD_COMMENT_IM);break;case 13:this.app.$router.goto(`igrocery://www.grocery.com/my_comment?orderId=${e}&orderPoiId=${n}`);break;case 15:this.app.$order.gotoMapPage(null==(a=null==i?void 0:i.orderDelivery)?void 0:a.selfLiftInfo);break;case 16:this.orderDetail.showSelfLiftPopup();break;case 17:this.app.$lxLog.mc("b_youxuan_pi5tgue0_mc",{order_id:e,order_st:(null==i?void 0:i.detailStatusView.detailTitle)||""}),this.app.$order.addCart("ORDERDETAIL",g.map((({skuId:e,count:r})=>({skuId:e,count:r}))));break;case 24:this.app.$lxLog.mc("b_youxuan_t4bivmu0_mc",{order_id:e}),this.app.$order.completeOrder(i,h.SUBMIT_PAGE_SOURCE.ORDER_DETAIL_ADD_CONFIRM).then((()=>{this.orderDetail.refreshOrder()}));break;case 40:this.app.$lxLog.mc("b_youxuan_vtfwkp6w_mc",{order_id:e}),this.canDeleteOrder(e)}}toPay(e,r,t,o){this.paying=!0,this.app.$order.payOrder(e,{parentOrderId:r,successUrl:`/${this.app.page().route}?${(0,g.stringify)({orderId:e,showPop:1,showGiftCardPop:2===o||void 0})}`,from:"orderDetail",orderGroupOpFlag:t}).then((r=>{this.orderDetail.initOptions({orderId:e,showPop:1,showGiftCardPop:2===o||void 0}),r?this.orderDetail.onLoadFetchData(!0):getApp().$router.goto(`/pages/paySuccess/index?orderId=${e}`)})).catch((e=>{this.orderDetail.refreshOrder()})).then((()=>{this.paying=!1})),setTimeout((()=>{this.paying=!1}),1e3)}handleCancel(e){return c(this,arguments,(function*({orderId:e,orderInfo:r,extractInfo:t}){var o,a,i,s;const{type:d,status:l,parentOrderId:p,poiId:u,csServiceUrl:c,orderGroupOpFlag:h,skus:g}=r;this.app.$lxLog.mc("b_youxuan_mpryv0r5_mc",{order_id:e,order_st:(null==r?void 0:r.detailStatusView.status)||"-999",poi_id:u});const y=yield(0,_.getOrderDetailTransactionComposite)(e,{}),O=null==(i=null==(a=null==(o=null==y?void 0:y.orderDetail)?void 0:o.data)?void 0:a.detailStatusView)?void 0:i.status;try{this.orderDetail.loading(!0);try{if(10===O){m.log.info("<OrderDetail operateOrder> operateOrder开始处理取消订单啦");const t=yield this.app.$order.toCancelOrderNew(e,{parentOrderId:p,type:d,status:l,orderGroupOpFlag:h});this.orderDetail.setData({cancelReasonList:t.cancelReasonList,switchBar:(null==(s=t.returnAddCartInfo)?void 0:s.switchShow)||"",orderId:e}),this.app.$lxLog.mc("b_youxuan_rdcmhjjq_mc",{order_id:e,order_st:(null==r?void 0:r.detailStatusView.status)||"-999"}),m.log.info("<OrderDetail operateOrder> operateOrder取消订单成功啦"),this.orderDetail.refreshOrder()}else{const r={order_id:e,sku_list:g.map((({skuId:e})=>e))},t={orderId:e,refundApplyPageSource:2,refundApplyType:1};(yield this.app.$order.refundApplyVerify({reqParams:t,mvBid:"b_youxuan_sbdvo91k_mv",lxParams:r,onTapBtn:({type:e,buttonText:t,jumpType:o,title:a,contentText:i})=>{this.app.$lxLog.mc("ok"===e?"b_youxuan_tp28v257_mc":"b_youxuan_yjeux6n3_mc",n({button_name:t},r)),o===f.REFUND_BUTTON_JUMP_TYPE.CALL_GROUP_HEADER&&this.orderDetail.onContactGroupHeader()}}))&&(m.log.info("<OrderDetail operateOrder> operateOrder开始处理取消订单啦"),yield this.app.$order.toCancelOrder(e,{parentOrderId:p,type:d,status:l,orderGroupOpFlag:h}),m.log.info("<OrderDetail operateOrder> operateOrder取消订单成功啦"),this.orderDetail.refreshOrder())}}catch(e){m.log.warn("<OrderDetail operateOrder> 开始执行旧版取消订单逻辑",e)}}catch(e){this.orderDetail.toast("网络异常，请稍后重试"),m.log.error("<OrderDetail operateOrder> 取消订单失败",e)}finally{this.orderDetail.loading(!1)}}))}Old(e){return c(this,arguments,(function*({orderId:e,orderInfo:r,extractInfo:t}){const{type:o,status:a,parentOrderId:i,poiId:s,csServiceUrl:d,orderGroupOpFlag:l}=r;if(this.app.$lxLog.mc("b_youxuan_mpryv0r5_mc",{order_id:e,poi_id:s}),t&&3===t.status)return m.log.info("<OrderDetail operateOrder> 砍价免费拿订单，不支持退款"),this.orderDetail.toggleBuyFreePopShow(),this.app.$lxLog.mv("b_youxuan_uaja788k_mv",{order_id:e}),void this.orderDetail.alert({title:null==t?void 0:t.title,message:null==t?void 0:t.subTitle,zIndex:101,textOK:"知道了",ok:()=>{this.app.$lxLog.mc("b_youxuan_r9cvd3ml_mc",{order_id:e}),this.orderDetail.toggleBuyFreePopShow()}});if(t&&[4,6].includes(t.status))return void this.orderDetail.alert({title:null==t?void 0:t.title,message:null==t?void 0:t.subTitle,customContentStyle:"text-align: center;",zIndex:101,textOK:"知道了"});m.log.info("<OrderDetail operateOrder> operateOrder开始处理取消订单啦");const n=yield(0,_.getRefundStatus)({orderId:e}),{buttonTipsList:p=[],refundable:u,title:c,refundLimitReason:h,type:g}=n;if(u||1!==g)u||2!==g?this.app.$order.toCancelOrder(e,{parentOrderId:i,type:o,status:a,orderGroupOpFlag:l}).then((()=>{m.log.info("<OrderDetail operateOrder> operateOrder取消订单成功啦"),this.orderDetail.refreshOrder()})):this.orderDetail.alert({title:c,message:h,customContentStyle:"text-align: center;",zIndex:101,textOK:"知道了"});else if(p.length){const e=[{pic:y.Images.order_phone_guard,btn_icon:y.Images.order_phone_gray,btn_text:"电话联系"},{pic:y.Images.order_IM_guard,btn_icon:y.Images.order_IM_gray,btn_text:"在线联系"}],r=p.map((r=>1===r.btnTipsType?Object.assign(r,e[0]):Object.assign(r,e[1])));this.orderDetail.setData({showLookforIM:!0,lookforGroupHeader:{title:c,btns:r}})}else this.orderDetail.confirm({title:c,message:h,textCancel:"取消",textOK:"联系团长",customContentStyle:"text-align: center",zIndex:30,ok:()=>{this.orderDetail.onContactGroupHeader()},cancel:()=>{}})}))}handleRefund(e,r,t,o){if(this.app.$lxLog.mc("b_chaoshi_1papg1wk_mc"),0===(null==o?void 0:o.status))return void this.app.$order.gotoRefund("select",e,r,t);if(1!==(null==o?void 0:o.status)&&2!==(null==o?void 0:o.status))return;const{orderInfo:a}=this.orderDetail.data,i={message:null==o?void 0:o.subTitle},s=n({title:null==o?void 0:o.title,message:null==o?void 0:o.subTitle,zIndex:101},1===(null==o?void 0:o.status)?{textCancel:"不用了",textOK:"联系客服",ok:()=>{this.app.$lxLog.mc("b_chaoshi_s3bagzug_mc",i),this.app.$router.goto(null==a?void 0:a.csServiceUrl)},cancel:()=>{this.app.$lxLog.mc("b_chaoshi_4ndsr0x8_mc",i)}}:{textCancel:"知道了",textOK:"查看退款详情",ok:()=>{this.app.$router.goto(null==o?void 0:o.jumpUrl)}});this.orderDetail.confirm(s)}canDeleteOrder(e){return c(this,null,(function*(){try{const r=yield(0,_.deleteOrder)({orderId:e,confirm:!1}),{flag:t,deleteOrderConfirmPopup:o={}}=r;if(null==t||""===t)throw new Error;if(!t){const{title:r="",text:t="",buttonList:a=[]}=o;this.app.$lxLog.mv("b_youxuan_dsvvl398_mv",{order_id:e}),this.app.page().confirm({title:r,message:t,textCancel:a[1].desc,textOK:a[0].desc,customContentStyle:"text-align: center",zIndex:101,ok:()=>{this.app.$lxLog.mc("b_youxuan_2hst5gnt_mc",{order_id:e})},cancel:()=>{this.app.$lxLog.mc("b_youxuan_xa1umvae_mc",{order_id:e}),this.deleteOrder(e)}})}}catch(e){const{msg:r=""}=e.data.error;r?this.app.page().toast(r):this.app.page().toast("系统开小差，请稍后再试"),m.log.info("<deleteOrder> 订单是否可删除",e)}}))}deleteOrder(e){return c(this,null,(function*(){try{const r=yield(0,_.deleteOrder)({orderId:e,confirm:!0}),{flag:t,deleteSuccessToast:o=""}=r;if(null==t||""===t)throw new Error;if(t){o?this.app.page().toast(o):this.app.page().toast("订单删除成功");const e=getCurrentPages();this.app.$store.setCache("is_delete_order",!0),e.length>0?this.app.$router.goto(-1):this.app.$router.goto("/pages/index/index")}}catch(e){const{msg:r=""}=e.data.error;r?this.app.page().toast(r):this.app.page().toast("系统开小差，请稍后再试"),m.log.error("<deleteOrder> 删除订单失败",e)}}))}};