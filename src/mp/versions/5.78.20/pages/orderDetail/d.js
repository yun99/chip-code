var e=Object.create,a=Object.defineProperty,t=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,r=Object.getPrototypeOf,s=Object.prototype.hasOwnProperty,o=o=>{return((e,r,o)=>{if(r&&"object"==typeof r||"function"==typeof r)for(let i of n(r))s.call(e,i)||"default"===i||a(e,i,{get:()=>r[i],enumerable:!(o=t(r,i))||o.enumerable});return e})((i=a(null!=o?e(r(o)):{},"default",o&&o.__esModule&&"default"in o?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0}),a(i,"__esModule",{value:!0})),o);var i},i=(e,a,t)=>new Promise(((n,r)=>{var s=e=>{try{i(t.next(e))}catch(e){r(e)}},o=e=>{try{i(t.throw(e))}catch(e){r(e)}},i=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,o);i((t=t.apply(e,a)).next())})),c=o(require("../../ob.js")),l=o(require("./2y.js")),m=o(require("./24.js")),u=o(require("./23.js"));(0,o(require("../../jc.js")).defineComponent)({propTypes:null,properties:{originConfig:{type:Object,value:{}},canvasElementId:{type:String,value:""}},data:{canvasWidth:300,canvasHeight:150,debug:!1},created(){this.initCommonData()},ready(){this.getCanvasNode()},observers:{originConfig(e){this.updateDrawingSchemaSymbol(e)}},methods:{trigger(e,a){"function"==typeof this.commonData.listener[e]&&this.commonData.listener[e](a)},subscribe(e,a){this.commonData.listener[e]=a},toCreate(){return i(this,null,(function*(){try{if(this.commonData.createStatus===l.CREATE_STATUS.PENDING)return;c.log.info("<canvasDraw toCreate> 开始绘制图片流程"),this.changeCreateStatus(l.CREATE_STATUS.PENDING),this.startCanvasMetricsPoint(),this.setDrawingSchema();const e=yield this.coreModule.getDrawingImage();this.trigger(l.CANVAS_DRAW_EVENT.CANVAS_DRAW_SUCCESS,e),this.changeCreateStatus(l.CREATE_STATUS.READY),this.endCanvasMetricsPoint(),c.log.info(`<canvasDraw toCreate> 绘制成功，临时文件地址${e}`)}catch(e){c.log.warn(`<canvasDraw toCreate> 绘制失败，error：${e}`),this.changeCreateStatus(l.CREATE_STATUS.READY),this.trigger(l.CANVAS_DRAW_EVENT.CANVAS_DRAW_FAIL,e)}}))},clearCanvas(){var e;c.log.info("<canvasDraw clearCanvas> 清空画布"),null==(e=this.coreModule)||e.clearCanvas()},getCanvasNode(){return i(this,null,(function*(){const{node:e}=yield this.getElement(this.data.canvasElementId||"defaultCanvasElementId");if(e){c.log.info("<canvasDraw getCanvasNode> 成功获取canvas节点");try{this.coreModule=new m.default(u.WORK_ENVIRONMENT.WEIXIN,{wx:wx,canvas:e,ctx:e.getContext("2d"),scope:this,canvasElementId:this.data.canvasElementId||"defaultCanvasElementId"})}catch(e){c.log.warn(`<canvasDraw getCanvasNode> 实例化CoreModule失败，error：${e.message}`),this.coreModule=null}}else c.log.info("<canvasDraw getCanvasNode> 获取canvas节点失败")}))},getElement(e){return new Promise(((a,t)=>{try{this.createSelectorQuery().select(`#${e}`).fields({node:!0,size:!0}).exec((e=>{a(e[0]||null)}))}catch(e){t(null)}}))},initCommonData(){this.commonData={isDrawingSchemaUpdated:!1,listener:{},createStatus:l.CREATE_STATUS.READY,metricsPointHandler:null}},updateDrawingSchemaSymbol(e){c.log.info(`<canvasDraw updateDisplayConfig> 更新canvasDraw绘制配置数据：${e}`),e&&(this.commonData.isDrawingSchemaUpdated=!0)},setDrawingSchema(){this.commonData.isDrawingSchemaUpdated&&(this.coreModule.setDrawingSchema(this.data.originConfig),this.commonData.isDrawingSchemaUpdated=!1)},startCanvasMetricsPoint(){try{const e=getApp().page();if(!e)return;this.commonData.metricsPointHandler=e.startMetricsPoint(`${e.route}_canvasStartCreate`,{num:2}),this.commonData.metricsPointHandler.add({step:"<canvasDraw toCreate> start"})}catch(e){c.log.warn(`<canvasDraw startCanvasMetricsPoint> 创建自定义测速点失败，error: ${e.message}`)}},endCanvasMetricsPoint(){try{this.commonData.metricsPointHandler&&this.commonData.metricsPointHandler.add({step:"<canvasDraw toCreate> finish"}).end()}catch(e){c.log.warn(`<canvasDraw endCanvasMetricsPoint> 结束自定义测速点失败，error: ${e.message}`)}},changeCreateStatus(e){this.commonData.createStatus=e}}});