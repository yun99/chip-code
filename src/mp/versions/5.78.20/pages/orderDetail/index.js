var e=Object.create,t=Object.defineProperty,o=Object.defineProperties,r=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertyNames,i=Object.getOwnPropertySymbols,n=Object.getPrototypeOf,d=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,c=(e,o,r)=>o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[o]=r,l=(e,t)=>{for(var o in t||(t={}))d.call(t,o)&&c(e,o,t[o]);if(i)for(var o of i(t))u.call(t,o)&&c(e,o,t[o]);return e},p=(e,t)=>o(e,a(t)),h=e=>t(e,"__esModule",{value:!0}),m=o=>((e,o,a)=>{if(o&&"object"==typeof o||"function"==typeof o)for(let i of s(o))d.call(e,i)||"default"===i||t(e,i,{get:()=>o[i],enumerable:!(a=r(o,i))||a.enumerable});return e})(h(t(null!=o?e(n(o)):{},"default",o&&o.__esModule&&"default"in o?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0})),o),g=(e,t,o)=>new Promise(((r,a)=>{var s=e=>{try{n(o.next(e))}catch(e){a(e)}},i=e=>{try{n(o.throw(e))}catch(e){a(e)}},n=e=>e.done?r(e.value):Promise.resolve(e.value).then(s,i);n((o=o.apply(e,t)).next())}));((e,o)=>{for(var r in h(e),o)t(e,r,{get:o[r],enumerable:!0})})(exports,{default:()=>G});var y=m(require("../../er.js")),f=m(require("../../ob.js")),_=m(require("../../u8.js")),P=m(require("../../is.js")),w=m(require("../../p0.js")),S=m(require("../../a3.js")),b=m(require("../../gb.js")),D=m(require("../../f8.js")),v=m(require("../../g8.js")),I=m(require("./gc.js")),C=m(require("./gv.js")),k=m(require("./s1.js")),x=m(require("./p9.js")),O=m(require("./hq.js")),T=m(require("./g6.js")),R=m(require("./g0.js")),L=m(require("./hw.js")),$=m(require("./hr.js")),N=m(require("./he.js")),M=m(require("./ge.js")),A=getApp();k.default.register(A.$module);var{$cat:B,$version:H,$systemInfo:U}=A,j="<OrderDetail> ==== v2 ",{subscribe:E}=require("../../sz.js");k.default.register(A.$module);var G=class{constructor(){var e,t;this.orderDetailMetricReport=new R.default,this.first=!0,this.requestLock=!1,this.paySuccessCouponTimer=null,this.noticeBoardHeight=0,this.noticeBoardTop=0,this.checkLoginThis=null,this.lackAuthSource=0,this.statusCodeSite=0,this.fromPage="",this.loginPromiseChecked=!1,this.data={isAndroid:!A.$systemInfo.isIOS(),isIpx:(null==(t=null==(e=A.getModule("systemInfo"))?void 0:e.getSystemInfo())?void 0:t.isIpx)||!1,showAppGoodPop:(0,_.isApp)(),isPageReady:!1,orderId:"",orderInfo:{},orderQRCode:"",shareToken:"",groupStatus:null,showIM:!1,navigatorHeight:0,noticeBoardShow:!1,noticeBoardInfo:null,isFixed:!1,statusList:[],btnList:[],btnMaxLength:4,btnHasMore:!1,renderMap:[],statusCard:{_subCls:"",title:[],subtitle:"",pic:""},canShowNativeComp:!0,canShowPop:!1,showPop:!1,canShowDeliveryPop:!0,showDeliveryPop:!1,shareInfo:{picUrl:"",type:0,shareDetail:null},showActivityPop:!1,showOrderStatusModal:!1,showCouponBackPop:!1,couponBackList:[],shareData:null,sharePopLxParams:{},showSatisfied:!1,satisfied:null,popData:null,showRefundStayPop:!1,refundStayInfo:{skuId:"",message:""},showBuyFreeConfirmPop:!1,showRefundWithHeader:!1,paySuccessCouponPopShow:!1,showRiskPopup:!1,riskInfo:"",paySuccesCoupon:{couponList:[],backgroundColor:"",pic:"",btnText:"",btnColor:"",btnLink:""},freeOrderInfo:{},showFreeOrderPopup:!1,showGroupHeaderPop:!1,showSkuOperatePop:!1,showLookforIM:!1,lookforGroupHeader:{title:"",btns:[]},skuOperatePopData:{},showCommonPop:!1,showSelfLiftQRPopup:!1,sharePopMvParams:{mv:"b_youxuan_u5v6rsn8_mv",mc:"b_youxuan_u5v6rsn8_mc",bubbleMv:"b_youxuan_dsuuz7rg_mv",bubbleMc:"b_youxuan_dsuuz7rg_mc"},showRefundDetentionPopup:!1,bottomHeight:20,sharePopUpBottom:120,monthCardMsg:{btnText:"",canEnjoyDiscount:"",jumpUrl:"",leftIcon:""},showLackRefundPop:!1,lackRefundData:null,recommendSkus:{show:!1,data:{},total:0,offset:0,limit:10,isNoMoreCommand:!1},skuCardCanDirect:!0,cancelOrderReasonPopup:!1}}onLoad(e){this.fromPage=e.fromPage,A.$lxLog.mv("b_youxuan_5bz0x688_mv",{},{cid:"c_youxuan_86vyf1ja"}),this.renderStartTime=Date.now(),this.orderDetailMetricReport&&(this.orderDetailMetricReport.resetReportSymbol(),this.orderDetailMetricReport.reportOrderDetailOnLoadCount(P.YXReportTarget,P.ReportValue,B,H,U)),this.initPage(e),this.onLoadCheckLogin(),(0,_.isWX)()&&setTimeout((()=>{var e;(0,v.getPrefetchBundle)({openId:A.getModule("user").getOpenId(),name:"pay-finance-cashier",env:"gray",app:"grocery_mp_pay",dynamicEnv:null==(e=A.$env)?void 0:e.getDynamicEnv()})}),0)}onShow(){!this.first&&A.$login.isLogin()&&this.refreshOrder(),A.$event.emit(A.$event.CONTANTS.CLEAR_CART_PAY_NOT_SUCCESSURL)}onReady(){this.orderDetailMetricReport&&this.orderDetailMetricReport.reportOrderDetailOnReadyCount(P.YXReportTarget,P.ReportValue,B,H,U)}onUnload(){this.map&&this.map.timeLoop&&clearInterval(this.map.timeLoop),clearInterval(this.paySuccessCouponTimer),A.$event.off(A.$event.CONTANTS.RETURN_FROM_LOGIN,this.checkLoginThis),A.$event.off(A.$event.CONTANTS.LOGIN_FINISH,this.checkLoginThis)}onReachBottom(){}onLoadCheckLogin(){A.$login.isLogin()?this.onLoadFetchData():A.$loginPromise&&!this.loginPromiseChecked?(f.log.info(j,"[waitLogin] 等待全局登录完成"),A.$loginPromise.then((e=>{f.log.info(j,"[checkLogin] app.$loginPromise返回",e),this.loginPromiseChecked=!0,this.onLoadFetchData()}))):(f.log.info(j,"[checkLogin] 跳转登录页"),A.$event.once(A.$event.CONTANTS.RETURN_FROM_LOGIN,this.checkLoginThis),A.$event.once(A.$event.CONTANTS.LOGIN_FINISH,this.checkLoginThis),A.$login.login())}initPage(e){this.first=!0,this.map=new L.default(this),this.operateOrder=new $.default(this),this.checkLoginThis=this.onLoadCheckLogin.bind(this),this.overrideCommonPopFn(),this.initOptions(e),wx.hideShareMenu({})}initOptions(e){f.log.info(j,"[initOptions] 传入的原始options为:",e);const t={orderId:e.orderId||e.order_id||"",fromPaySuccess:1==+e.showPop,scrollToSkus:1==+e.toSkus,action:parseInt(`${e.action}`,10),waitPayGoBackUrl:e.waitPayGoBackUrl||void 0};Object.assign(this.options,t),this.lackAuthSource=this.options.action===O.OPTIONS_ACTION.LACK_REFUND_PUSH?1:0,this.setData({orderId:this.options.orderId,showPop:this.options.fromPaySuccess,scrollToSkus:this.options.scrollToSkus})}onLoadFetchData(e=!1){return g(this,null,(function*(){this.loading(!0),this.requestLock=!0;let t=[];if(e)t=yield(0,N.assembleRequest)(this.options.orderId,this.options);else try{t=yield this.getPreFetchedData()}catch(e){"NoPreFetchedDataError"===e.name&&f.log.warn("没有预拉取数据"),t=yield(0,N.assembleRequest)(this.options.orderId,this.options)}const[o,r]=t;this.firstRender(o,r)}))}firstRender(e,t){return g(this,null,(function*(){var o;const{orderDetail:r,contactGroupHeaderGuideData:a}=e||{};A.$lxLog.pv("c_youxuan_86vyf1ja",{custom:{order_st:(null==(o=null==r?void 0:r.detailStatusView)?void 0:o.detailTitle)||""}});const{orderId:s,fromPaySuccess:i,scrollToSkus:n}=this.options;r&&(this.metricsSetData(p(l({},this.getOrderDetailRenderData(r)),{isPageReady:!0}),{fmp:!0,fmpParams:this.options,extra:(0,w.getPerformanceExtraData)()},(()=>{if(!this.renderEndTime){this.renderEndTime=Date.now();const e=this.renderEndTime-this.renderStartTime;f.log.info("<orderDetail metricsSetData> 订单详情页首屏渲染时间为",e),A.$lxLog.mv("b_youxuan_sfjqmpaw_mv",{fmp:e},{cid:"c_youxuan_86vyf1ja"})}if(this.orderDetailMetricReport&&this.orderDetailMetricReport.reportOrderDetailFMPCount(P.YXReportTarget,P.ReportValue,B,H,U),n){this.options.scrollToSkus=!1;const{navigatorHeight:e=0}=(0,S.getStatusBarHeightWithDowngrade)(18),t=this.selectComponent("#map-temp-list");wx.createSelectorQuery().in(t).select("#skus").boundingClientRect((t=>{wx.pageScrollTo({scrollTop:t.top-(0,w.convertRpxToPx)(e),duration:0})})).exec()}i&&((0,_.isApp)()&&mmp.callCustomAPI("showPraiseAlert",{success:()=>{A.$router.goto("igrocery://www.grocery.com/customerFeedback")},fail:()=>{this.setData({showAppGoodPop:!1})}}),this.data.showPop&&this.showDeliveryPop()),a&&this.showContactGroupHeaderGuidePop(a),this.getBottomHeight(),this.loading(!1),this.first=!1,this.requestLock=!1,this.secondaryRender(t)})),void 0!==this.options.action&&this.actionOperate())}))}secondaryRender(e){return g(this,null,(function*(){const[t,o={}]=yield e;this.setData(l(l(l({},this.getMarketingRes(o)),this.getNoticeBoardInfo(t)),this.judgeLackRefundPop()),(()=>{this.getBottomHeight();const{orderInfo:{status:e}}=this.data;e&&e===T.ORDER_STATUS.WAIT_PAY&&this.getNavigatorHeight(),this.recommendSkusABTest()}))}))}getOrderDetailRenderData(e){var t;if(e){f.log.info(j,"[getOrderDetailRenderData] 订单详情数据获取成功",e);const o=this.map.mapOrderInfo(e),{btns:r,maxLength:a,hasMore:s}=this.map.mapBtn(o);if(f.log.info(j,`<OrderDetail getOrderDetailRenderData> 获取到按钮信息为 ${JSON.stringify(r)}`),r.some((e=>22===e.type||e.type>=33&&e.type<=36))&&!this.orderShareController&&e.token){const{groupStatus:e}=o}return(null==(t=null==o?void 0:o.questionList)?void 0:t.length)&&(0,_.isTT)()&&(o.questionList=o.questionList.map((e=>p(l({},e),{link:e.link.replace("/kbn_web","/web")})))),{orderInfo:o,renderMap:this.map.mapTempData(o),statusCard:this.map.mapStatusCard(o),btnList:this.getBtnList(r,o),btnMaxLength:a,btnHasMore:s}}return{}}getOrderSkuItemById(e){var t,o;return e?null==(o=null==(t=this.data.orderInfo)?void 0:t.skus)?void 0:o.find((t=>t.skuId===e)):null}overrideCommonPopFn(){this._alert=this.alert,this._confirm=this.confirm;const e=e=>t=>(this.setData({showCommonPop:!0},this.checkCanShowNativeComp),e(t).then((()=>{this.setData({showCommonPop:!1},this.checkCanShowNativeComp)})));this.alert=e(this._alert),this.confirm=e(this._confirm)}refreshOrder(){return g(this,null,(function*(){if(this.options.orderId){this.loading(!0),this.requestLock=!0;const e=yield(0,N.getOrderDetail)(this.options.orderId);this.setData(l({},this.getOrderDetailRenderData(e)),(()=>{this.loading(!1),this.requestLock=!1}))}}))}getNoticeBoardInfo(e){var t;let o=null;const r=(null==(t=(this.data.orderInfo.tips||[]).find((({type:e,msgType:t})=>5===e&&0===t)))?void 0:t.content)||"";return e&&e.msg?o=p(l({},e),{infoLine:3}):r&&(o={msg:r,type:0,infoLine:3,cycleType:2}),{noticeBoardInfo:o}}getBtnList(e,t){const o={order_id:this.data.orderId,order_st:(null==t?void 0:t.detailStatusView.status)||"-999"};return e.find(((t,o)=>t.type<=36&&t.type>=33&&(e.splice(o,1),e.push(t),!0))),e.map((e=>{switch(e.type){case 1:e.bid="b_youxuan_mpryv0r5_mv",e.lxParams=o;break;case 12:e.bid="b_youxuan_0j21i1sk_mv",e.lxParams=o;break;case 17:e.bid="b_youxuan_pi5tgue0_mv",e.lxParams=p(l({},o),{order_st:(null==t?void 0:t.detailStatusView.detailTitle)||""});break;case 24:e.bid="b_youxuan_t4bivmu0_mv",e.lxParams=o;break;case 40:e.bid="b_youxuan_vtfwkp6w_mv",e.lxParams=o}return e}))}toOperateOrder(e){const{orderId:t,btnType:o,phone:r,extractInfo:a}=e.detail;f.log.info(j,`<OrderDetail toOperateOrder> orderDetail/index中的按钮类型为 ${o}`),this.operateOrder.operateOrder({orderId:t,btnType:o,phone:r,extractInfo:a})}cancelOrderReason(e,t){this.setData({cancelOrderReasonPopup:!0}),A.$lxLog.mv("b_youxuan_n4a34ucd_mv",{order_id:e,order_st:t})}actionOperate(){const{orderId:e,orderInfo:{status:t=0}}=this.data,{action:o}=this.options;delete this.options.action;const r=A.$abTest.getGrayStrategyVal("Pending_order_Personal_center_group2"),a=["a1","a2"].indexOf(r)>-1,s=1014===A.$scene&&a&&t===T.ORDER_STATUS.WAIT_PAY;(0===o||s)&&this.operateOrder.operateOrder({orderId:e,btnType:2}),1===o&&this.showSelfLiftPopup()}gotoRefund(){A.$order.gotoRefund("detail",this.data.orderId,this.data.orderInfo.poiIdStr)}gotoGroupDetail(){A.$lxLog.mc("b_youxuan_bua5px9c_mc",{order_id:this.data.orderId}),A.$router.goto("igrocery://www.grocery.com/groupDetail",{orderId:this.data.orderId,fromDetail:1})}toCopy({text:e}){wx.setClipboardData({data:`${e}`,success:()=>{(0,_.isInWX)()||this.toast("复制成功")},fail:e=>{this.toast("复制失败"),f.log.warn(j,"复制功能异常",e)}})}eventTrigger(e){const{action:t,args:o,bid:r}=e.detail;t&&this[t]&&"function"==typeof this[t]&&this[t](o),r&&A.$lxLog.mc(r,{order_id:this.data.orderId})}onContactGroupHeader(){this.useComponentFunc("#contact-group-header","getGroupHeaderPhone",{page:this,orderId:this.data.orderId,lxData:{privacyAlertMV:"b_youxuan_1pbexf9f_mv",privacyAlertOK:"b_youxuan_ks54c0z7_mc",privacyAlertCancel:"b_youxuan_8sfhzubs_mc"},lxParams:{order_id:this.data.orderId}})}onTapNoticeBoard(){A.$lxLog.mc("b_youxuan_5fk2nkns_mc",{order_id:this.data.orderId})}mvHandler(e){const{bid:t="",lxParams:o={}}=e.detail;A.$lxLog.mv(t,o)}onTapGoBack(){return g(this,null,(function*(){f.log.info(j,"点击自定义导航栏返回按钮");const{showRefundDetentionPopup:e,orderInfo:t}=this.data;if((null==t?void 0:t.userWithdrawModel)&&!e){const e=(new Date).getTime();let o;try{o=JSON.parse(A.$store.getCacheValue("orderDetailRefundDetentionOrders")||"{ latestShowTime: 0 }")}catch(e){o={latestShowTime:0},f.log.warn(j,"读取挽留弹窗缓存失败")}const r=o[t.orderId];if(1===t.userWithdrawModel.popStrategy&&(0,w.formatTimeToDay)(new Date(o.latestShowTime))!==(0,w.formatTimeToDay)(new Date)||2===t.userWithdrawModel.popStrategy&&!r)return o.latestShowTime=e,o[t.orderId]=e,this.setData({showRefundDetentionPopup:!0}),Object.keys(o).forEach((t=>{Math.floor((e-o[t])/864e5)>2&&delete o[t]})),void A.$store.setCache("orderDetailRefundDetentionOrders",JSON.stringify(o),{expires:Number.MAX_SAFE_INTEGER})}yield this.onWaitPaySubscribe(),this.goBack()}))}goBack(){if(1===A.pages().length)(0,_.isMT)()?wx.exitMiniProgram():A.$router.goto("/pages/index/index");else{(this.data.orderInfo.status===T.ORDER_STATUS.WAIT_PAY||this.data.orderInfo.status===T.ORDER_STATUS.CANCEL)&&this.options.waitPayGoBackUrl?A.$router.goto(decodeURIComponent(this.options.waitPayGoBackUrl)):A.$router.triggerBack("orderDetail-goBack")}}recommendSkusABTest(){"a"===getApp().$abTest.getGrayStrategyVal("grocery_c_front_order_recommend_skus_direct").toLowerCase()&&this.setData({skuCardCanDirect:!1})}getRecommendSkus(){return g(this,null,(function*(){var e,t;try{const{recommendSkus:o,orderInfo:r}=this.data,{offset:a,total:s}=o;if(a>s)return void this.setData({"recommendSkus.isNoMoreCommand":!0});const i=[...r.skus.map((({skuId:e})=>e)),...((null==(e=o.data)?void 0:e.goodsList)||[]).map((({skuId:e})=>e))],n=(yield x.getCommonRecommend({poiId:A.$poiId||(null==r?void 0:r.poiId),poiIdStr:A.$poi.getPoiIdStr()||(null==r?void 0:r.orderPoiId),offset:o.offset,limit:o.limit,type:113},{excludeSkuIds:i}))||{};o.total=n.total||0,o.offset+=o.limit;const d=((null==(t=o.data)?void 0:t.goodsList)||[]).concat((n.itemList||[]).map((e=>(0,D.skuBoardFormat)({skuItem:e,type:e.type,requestid:(null==n?void 0:n.M_TraceId)||""})))),u={goodsList:d,moduleTitle:n.moduleTitle};o.data=u,o.show=d.length>0,this.setData({recommendSkus:o})}catch(e){f.log.info(j,"[getRecommendSkus] 获取推荐商品失败",e)}}))}gotoHomePage(){A.$router.goto("/pages/index/index")}onWaitPaySubscribe(){return g(this,null,(function*(){if((0,_.isWX)()){const{orderInfo:e,orderId:t}=this.data;try{if(e.status===T.ORDER_STATUS.WAIT_PAY){const e=(0,w.formatTimeToDay)(new Date);if(e!==(A.$store.getCacheValue("orderDetailWaitPaySubscribeShowTime")||"")){f.log.info(j,"待支付订阅"),A.$store.setCache("orderDetailWaitPaySubscribeShowTime",e,{expires:Number.MAX_SAFE_INTEGER});const t=["waitPay"],o=I.Images.order_detail_wait_pay_subscribe;yield E(t,o)}}}catch(e){f.log.info(`待支付订阅失败, ${t}`,e)}}}))}checkCanShowNativeComp(){const{canShowPop:e,showSatisfied:t,showRefundStayPop:o,showBuyFreeConfirmPop:r,showRefundWithHeader:a,showGroupHeaderPop:s,showRiskPopup:i,showCommonPop:n,showFreeOrderPopup:d,showSelfLiftQRPopup:u,showRefundDetentionPopup:c,showLackRefundPop:l}=this.data;this.setData({canShowNativeComp:!(e||t||o||r||a||s||i||n||d||u||c||l)})}showDeliveryPop(){const{orderInfo:e}=this.data,t=(e.tips||[]).find((({type:e,msgType:t})=>(6===e||7===e)&&1===t)),o=!!t;this.setData({canShowDeliveryPop:o,showDeliveryPop:o,deliveryPopData:{isVipFirst:!0,subTitle:(null==t?void 0:t.popMsg)||"",selfTipNoticeMsg:(null==t?void 0:t.popSubMsg)||""}}),o&&A.$lxLog.mv("b_youxuan_3wlv8k4t_mv")}closeBringBagPop(){A.$lxLog.mc("b_youxuan_5mr0rai1_mc"),this.setData({showPop:!1,canShowPop:!1,showDeliveryPop:!1})}showSelfLiftPopup(){A.$lxLog.mc("b_youxuan_yx30qbni_mc");const{orderInfo:e}=this.data;e&&e.orderDelivery&&e.orderDelivery.selfLiftInfo&&e.orderDelivery.selfLiftInfo.qrCode&&this.setData({showSelfLiftQRPopup:!0},this.checkCanShowNativeComp)}onSelfLiftPopupClose(){this.setData({showSelfLiftQRPopup:!1},this.checkCanShowNativeComp)}toggleRefundStayPop(e){const{orderId:t}=this.data,{skuId:o="",message:r=""}=e;this.setData({showRefundStayPop:!0,refundStayInfo:e},this.checkCanShowNativeComp),A.$lxLog.mv("b_youxuan_gwjluhga_mv",{order_id:t,sku_id:o,message:r})}closeRefundStayPop(e){const{stay:t,routerParams:o}=e.detail,{orderId:r,refundStayInfo:a}=this.data,{skuId:s="",message:i=""}=a;this.setData({showRefundStayPop:!1},this.checkCanShowNativeComp),A.$lxLog.mc(t?"b_youxuan_3ajchxje_mc":"b_youxuan_g71ex1pn_mc",{order_id:r,sku_id:s,message:i}),t||A.$router.goto("/subPackages/refund/pages/apply/index",o)}toggleBuyFreePopShow(){this.setData({showBuyFreeConfirmPop:!this.data.showBuyFreeConfirmPop},this.checkCanShowNativeComp)}refundWithHeader(){this.setData({showRefundWithHeader:!this.data.showRefundWithHeader},this.checkCanShowNativeComp)}getActivityPop(){var e;const{orderId:t,fromPaySuccess:o}=this.options;t&&(A.$poi.getPoiIdStr()||null==(e=this.data)||e.orderInfo.orderPoiId)}closeActivityPop(){this.setData({canShowPop:!1,showPop:!1},this.checkCanShowNativeComp)}cancelQuestionPop(){this.setData({showSatisfied:!1},this.checkCanShowNativeComp)}onTapFreeOrder(){return g(this,null,(function*(){yield this.subscribeFreeOrder(),this.setData({canShowPop:!1,showPop:!1,showFreeOrderPopup:!1})}))}subscribeFreeOrder(){return g(this,null,(function*(){var e;const t=["freeOrder"],o=A.page();let r=!1;if((0,_.isMMP)()||(0,_.isWXMT)()||(0,_.isTT)())return o.toast("活动消息订阅成功");try{const a=yield E(t);r=a.isShowConfirm,(r||a.data&&"resolve"===(null==(e=a.data[0])?void 0:e.status))&&o.toast("活动消息订阅成功")}catch(e){if(f.log.error("<$activity.getFreeOrder> 订阅免单特权失败",null==e?void 0:e.errMsg),"99994"===e.errCode||"99998"===e.errCode)return void o.toast(e.errMsg);if("99995"===e.errCode)return void o.toast("取消提醒可能会错过免单权益哦！");const{errData:{data:t}}=({errData:{}}=e);t&&Object.keys(t).every((e=>"reject"!==t[e]))?o.toast("订阅失败 请稍后重试"):o.toast("请打开订阅模板功能，重新尝试")}}))}closeFreeOrderPop(){this.setData({canShowPop:!1,showPop:!1,showFreeOrderPopup:!1}),this.toast("取消提醒可能会错过免单权益哦！")}toggleCouponBack(e){return g(this,arguments,(function*({show:e=!1}){e&&(yield this.fetchCouponBack()),this.setData({showCouponBackPop:e})}))}fetchCouponBack(){return g(this,null,(function*(){let e=[];try{this.loading(!0);const t=yield x.queryOrderReturn({orderId:this.data.orderId,type:1});e=(null==t?void 0:t.items)&&t.items.length?t.items:[]}catch(e){this.toast(`${e.message||"网络异常，请重试"}`)}finally{this.setData({couponBackList:e}),this.loading(!1)}}))}showContactGroupHeaderGuidePop(e){return g(this,null,(function*(){const{orderId:t}=this.options;try{const o=+(A.$store.getCacheValue("_mall_order_detail_group_header_popup_count")||0);e&&e.popupCount&&e.popupTips&&e.popupCount>o&&(A.$store.setCache("_mall_order_detail_group_header_popup_count",o+1,{expires:Number.MAX_SAFE_INTEGER}),A.$lxLog.mv("b_youxuan_8a8glouq_mv",{order_id:t}),this.setData({showGroupHeaderPop:!0},this.checkCanShowNativeComp),this.confirm({message:e.popupTips,customContentStyle:"text-align: center",zIndex:101,textCancel:"取消",textOK:"联系团长",ok:()=>{this.setData({showGroupHeaderPop:!1},this.checkCanShowNativeComp),this.onContactGroupHeader(),A.$store.setCache("_mall_order_detail_group_header_popup_count",9999,{expires:Number.MAX_SAFE_INTEGER}),A.$lxLog.mc("b_youxuan_zcnstute_mc",{order_id:t})},cancel:()=>{this.setData({showGroupHeaderPop:!1},this.checkCanShowNativeComp),A.$lxLog.mc("b_youxuan_tn0gx121_mc",{order_id:t})}}))}catch(e){f.log.warn(j,`展示联系团长弹窗信息失败,orderId: ${t}`,e)}}))}getPaySuccessCoupon(){var e,t;const{orderId:o}=this.data;this.paySuccessCouponTimer=A.$order.intervalFetchOrderPaySuccessCoupon({orderId:o,poi:A.$poiId||(null==(e=this.data)?void 0:e.orderInfo.poiId),poiIdStr:A.$poi.getPoiIdStr()||(null==(t=this.data)?void 0:t.orderInfo.orderPoiId)},this.showPaySuccessCouponPop)}showPaySuccessCouponPop(e){const t={pic:e.picURL,backgroundColor:e.backgroundColor,btnText:e.btnLabel,btnColor:e.btnColor,btnLink:e.btnLink,couponList:e.couponUserList,riskInfo:e.riskInfo};e&&e.riskInfo&&(this.setData({showRiskPopup:e.riskInfo,riskInfo:e.riskInfo},this.checkCanShowNativeComp),clearInterval(this.paySuccessCouponTimer)),-1!==e.popupMills&&this.setData({paySuccessCouponPopShow:!0,paySuccesCoupon:t},(()=>{e.popupMills>0&&setTimeout((()=>{this.setData({showPop:!1,canShowPop:!1,paySuccessCouponPopShow:!1})}),e.popupMills)}))}closePaySuccessCouponPop(){this.setData({showPop:!1,canShowPop:!1,paySuccessCouponPopShow:!1})}closeRiskPop(){this.setData({showPop:!1,canShowPop:!1,showRiskPopup:!1},this.checkCanShowNativeComp)}toggleContactGroupHeaderPop(e){this.setData({showGroupHeaderPop:e.detail},this.checkCanShowNativeComp)}contactGroupHeader(e){const{orderId:t}=this.data.orderInfo,{item:o,isSkuOperatePop:r}=e.detail;1===o.btnTipsType?(this.callGroupHeader(),A.$lxLog.mc(r?"b_youxuan_bfc2zk62_mc":"b_youxuan_pe4eatf6_mc",{order_id:t})):2===o.btnTipsType&&(this.onContactGroupHeaderOnline(),A.$lxLog.mc(r?"b_youxuan_nlpt15zl_mc":"b_youxuan_d987g3do_mc",{order_id:t}))}callGroupHeader(){return g(this,null,(function*(){const{orderId:e}=this.data.orderInfo;try{const t=yield x.getGroupHeaderPhone({orderId:e}),{phoneNumber:o}=t;wx.makePhoneCall({phoneNumber:o,success:()=>{},fail:e=>{f.log.warn("<拨打团长号失败 orderDetail>",e)}})}catch(e){f.log.error(j,"<getGroupHeaderPhone> 获取团长隐私号失败",e)}}))}callCustomerSupport(){A.$lxLog.mc("b_youxuan_gv6up3ix_mc",{}),wx.makePhoneCall({phoneNumber:"4000919699",success:()=>{},fail:e=>{f.log.warn("<拨打优选客服失败 orderDetail>",e)}})}onContactGroupHeaderOnline(){const{orderId:e,poiId:t,poiIdStr:o}=this.data.orderInfo;C.default.isSupprotChat?(this.loading(!0),C.default.getGroupHeaderDxId(t,o).then((r=>{C.default.jumpToChatPage(e,r,t,o)})).catch((e=>{f.log.info(j,"[chatbot] getGroupHeaderDxId 用户大象id获取失败",e),this.toast("获取用户身份异常")})).then((()=>{this.loading(!1)}))):this.toast("当前平台不支持该功能")}closeLookforIMPop(e){const{orderId:t}=this.data.orderInfo;this.setData({canShowPop:!1,showLookforIM:!1,showSkuOperatePop:!1},this.checkCanShowNativeComp),e.detail.manual&&A.$lxLog.mc("b_youxuan_4yfek083_mc",{order_id:t})}closeCallGroupHeader(){const{orderId:e}=this.data.orderInfo;this.setData({showLookforIM:!1}),A.$lxLog.mc("b_youxuan_i5ayry62_mc",{order_id:e})}getMarketingRes(e){const{orderId:t}=this.options,{data:o=[]}=e;let r={};return r=o.reduce(((e,o)=>{try{let r={};const a=o.resourceInfos[0]||{},{contentInfos:s={},jumpUrl:i="",picUrl:n="",tacticCode:d="",title:u=""}=a;if(o.boothCode===N.PROMOTION_BOOTH_CODE.ACTIVITY_POP){const{type:o}=s;r={shareData:l(l({},e.shareData),a),canShowPop:!!n&&this.options.fromPaySuccess,shareInfo:{type:o,picUrl:n,shareDetail:{title:u,imageUrl:s.thumbnail,path:i}},sharePopLxParams:{type:o,activity_id:s.activityId||"",order_id:t}}}if(o.boothCode===N.PROMOTION_BOOTH_CODE.ACTIVITY_BUBBLE&&(r={shareData:p(l({},e.shareData),{bubblePic:n||""})}),o.boothCode===N.PROMOTION_BOOTH_CODE.FREE_ORDER_POP&&(r={freeOrderInfo:{picUrl:n},showFreeOrderPopup:!!n}),o.boothCode===N.PROMOTION_BOOTH_CODE.VEGETABLE_MONEY_OR_MONTH_CARD){const e=(0,M.transformTempStringToArray)(u);r={monthCardMsg:e.length>0?p(l({},s),{jumpUrl:i,showType:1,textArr:e}):{}},A.$lxLog.mv("b_youxuan_8983kljh_mv",{tactic_code:"TUARRBEV"})}return Object.assign(e,r)}catch(r){return f.log.warn(`订单${t}, ${o.boothCode}数据解析错误`,r),e}}),{}),r}getBottomHeight(){const{btnList:e=[],monthCardMsg:t={},isIpx:o=!1}=this.data;let r=20,a=120;o&&(r+=30),e.length&&(r+=100),Object.getOwnPropertyNames(t).length&&(r+=40,a+=70),this.setData({bottomHeight:r,sharePopUpBottom:a})}gotoMonthCard(){A.$lxLog.mc("b_youxuan_8983kljh_mc",{tactic_code:"TUARRBEV"});const{jumpUrl:e}=this.data.monthCardMsg;A.$router.goto(e)}onLackRefundSubmit(e){return g(this,null,(function*(){const{level:t,sku_id:o}=e.detail;let r="";const a={order_id:this.options.orderId,sku_id:o};try{if(0!==t){yield x.lackRefundAuth(this.options.orderId,{lackAuthSource:this.lackAuthSource,level:t});this.refreshOrder(),r="b_youxuan_er1nu5iu_mc",a.is_selected=1===t?1:0}else r="b_youxuan_3sstd31w_mc";A.$lxLog.mc(r,a),this.lackAuthSource=0,this.setData({showLackRefundPop:!1})}catch(e){f.log.warn(j,"[onLackRefundSubmit] 缺货主动退授权失败",e),this.toast(`${e.message||"网络异常，请重试"}`)}}))}judgeLackRefundPop(){const{orderInfo:e}=this.data,{authDetail:t={}}=e;let o={};if(0===Object.keys(t).length)return o;const{title:r="",reason:a="",authType:s=0,customPhone:i="",list:n=[]}=t;switch(s){case O.CONFIRM_MSG.AUTH:if(!n.length)return o;o=this.getLackRefundData(e);break;case O.CONFIRM_MSG.ASK_SEVICE:A.page().confirm({title:r,message:a,textCancel:"取消",textOK:"联系客服",ok:()=>{A.$order.askService(i)},cancel:()=>{}})}return o}getLackRefundData(e){let t={};const o=p(l({},e.authDetail),{list:(e.authDetail.list||[]).map((e=>p(l({},e),{priceStr:(0,b.fen2Yuan)(e.totalShouldRefundPrice)})))});return t={showLackRefundPop:!0,lackRefundData:o},A.$lxLog.mv("b_youxuan_er1nu5iu_mv",{order_id:e.orderId,sku_id:o.list.map((({skuId:e})=>e)).join(",")}),t}getNavigatorHeight(){const{navigatorHeight:e=0}=(0,S.getStatusBarHeightWithDowngrade)(18);this.setData({navigatorHeight:e},(()=>{this.getNoticeBoardHeight()}))}getNoticeBoardHeight(){wx.createSelectorQuery().select("#notice-board").boundingClientRect((e=>{this.noticeBoardHeight=e.height,this.noticeBoardTop=e.top})).exec(),this.setObserver()}setObserver(){const{navigatorHeight:e}=this.data;this.createIntersectionObserver().relativeToViewport({top:-(0,w.convertRpxToPx)(e)}).observe("#node-line",(e=>{e.intersectionRatio>=0?this.setData({isFixed:!1}):this.setData({isFixed:!0})}))}skuOperatePopBtnTap(e){const{secondButton:t}=this.data.skuOperatePopData,{index:o}=e.detail||{};t[o].onTap&&t[o].onTap()}};(0,y.default)(new G);