var e=Object.create,a=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertyNames,r=Object.getOwnPropertySymbols,c=Object.getPrototypeOf,l=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,h=(e,t,n)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,d=(e,a)=>{for(var t in a||(a={}))l.call(a,t)&&h(e,t,a[t]);if(r)for(var t of r(a))o.call(a,t)&&h(e,t,a[t]);return e},u=e=>a(e,"__esModule",{value:!0}),v=t=>((e,t,s)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of i(t))l.call(e,r)||"default"===r||a(e,r,{get:()=>t[r],enumerable:!(s=n(t,r))||s.enumerable});return e})(u(a(null!=t?e(c(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t),m=(e,a,t)=>new Promise(((n,s)=>{var i=e=>{try{c(t.next(e))}catch(e){s(e)}},r=e=>{try{c(t.throw(e))}catch(e){s(e)}},c=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,r);c((t=t.apply(e,a)).next())}));((e,t)=>{for(var n in u(e),t)a(e,n,{get:t[n],enumerable:!0})})(exports,{default:()=>y});var w=v(require("./3v.js")),g=v(require("./3g.js")),p=v(require("./3m.js")),x=v(require("./3n.js")),I=v(require("./3b.js")),y=class{constructor(e,a){this.drawingDefaultSchema=new w.default,this.drawingSchema=new w.default,this.canvasInitHandler(e,a),this.injectModules()}setDrawingSchema(e){this.drawingSchema=this.filterUnableDrawData(this.canvasUtils.deepClone(d(d({},this.drawingDefaultSchema),e)))}getDrawingImage(){return m(this,null,(function*(){return yield this.initCanvas(),this.clearCanvas(),yield this.downloadImages(),this.drawingImage(),this.getTempFilePath()}))}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}canvasInitHandler(e,a){switch(this.workEnvironment=e,e){case g.WORK_ENVIRONMENT.WEIXIN:if(!(a.wx&&a.canvas&&a.ctx&&a.scope&&a.canvasElementId))throw new Error(`<CoreModule canvasInitHandler WEIXIN> 环境初始化参数错误 wx:${a.wx}, canvas:${a.canvas}, ctx:${a.ctx}, scope:${a.scope}, canvasElementId:${a.canvasElementId}`);this.wx=a.wx,this.canvas=a.canvas,this.ctx=a.ctx,this.scope=a.scope,this.canvasElementId=a.canvasElementId;break;case g.WORK_ENVIRONMENT.NODE:if(!a.createCanvas||!a.CanvasNodeImage)throw new Error("<CoreModule canvasInitHandler NODE> 环境初始化参数错误");this.createCanvas=a.createCanvas,this.CanvasNodeImage=a.CanvasNodeImage;break;default:throw new Error(`<CoreModule canvasInitHandler> 环境初始化错误，不支持当前环境（${e}）`)}}injectModules(){this.canvasUtils=new p.default(this),this.canvasImageModule=new x.default(this),this.canvasDrawModule=new I.default(this)}filterUnableDrawData(e){var a,n,i,r,c;if(!(null==e?void 0:e.filter))return e;const l=(null==(a=null==e?void 0:e.blocks)?void 0:a.filter((e=>e.display)))||[],o=(null==(n=null==e?void 0:e.textBlocks)?void 0:n.filter((e=>e.display)))||[],h=(null==(i=null==e?void 0:e.texts)?void 0:i.filter((e=>e.display)))||[],u=(null==(r=null==e?void 0:e.images)?void 0:r.filter((e=>e.display)))||[],v=(null==(c=null==e?void 0:e.lines)?void 0:c.filter((e=>e.display)))||[];return m=d({},e),t(m,s({blocks:l,textBlocks:o,texts:h,images:u,lines:v}));var m}initCanvas(){return m(this,null,(function*(){switch(this.workEnvironment){case g.WORK_ENVIRONMENT.WEIXIN:yield this.initWeixinCanvas();break;case g.WORK_ENVIRONMENT.NODE:yield this.initNodeCanvas();break;default:throw new Error("<CoreModule initCanvas> 初始化Canvas错误")}}))}initWeixinCanvas(){return new Promise((e=>{this.scope.setData({canvasWidth:this.canvasUtils.toPx(this.drawingSchema.canvasWidth,!0),canvasHeight:this.canvasUtils.toPx(this.drawingSchema.canvasHeight,!0),debug:this.drawingSchema.debug},(()=>m(this,null,(function*(){const a=yield this.getElement(this.canvasElementId);this.canvas.width=a.width,this.canvas.height=a.height,e()}))))}))}initNodeCanvas(){return new Promise((e=>{this.canvas=this.createCanvas(this.canvasUtils.toPx(this.drawingSchema.canvasWidth,!0),this.canvasUtils.toPx(this.drawingSchema.canvasHeight,!0)),this.ctx=this.canvas.getContext("2d"),e()}))}downloadImages(){const e=[];return this.drawingSchema.images.forEach(((a,t)=>e.push(this.canvasImageModule.downloadImageAndInfo(a,t)))),Promise.all(e)}drawingImage(){this.drawingSchema.backgroundColor&&(this.ctx.save(),this.ctx.fillStyle=this.drawingSchema.backgroundColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore());const{texts:e=[],drawImages:a=[],blocks:t=[],textBlocks:n=[],lines:s=[]}=this.drawingSchema;let i=[];i=i.concat(a).concat(e.map((e=>(e.type="text",e.zIndex=e.zIndex||0,e)))).concat(t.map((e=>(e.type="block",e.zIndex=e.zIndex||0,e)))).concat(n.map((e=>(e.type="textBlock",e.zIndex=e.zIndex||0,e)))).concat(s.map((e=>(e.type="line",e.zIndex=e.zIndex||0,e)))),i.sort(((e,a)=>e.zIndex-a.zIndex)),i.forEach((e=>{"drawImage"===e.type?this.canvasDrawModule.drawImage(e):"text"===e.type?this.canvasDrawModule.drawText(e):"block"===e.type?this.canvasDrawModule.drawBlock(e):"textBlock"===e.type?this.canvasDrawModule.drawTextBlock(e):"line"===e.type&&this.canvasDrawModule.drawLine(e)}))}getTempFilePath(){return m(this,null,(function*(){switch(this.workEnvironment){case g.WORK_ENVIRONMENT.WEIXIN:return this.getTempFilePathInWeixin();case g.WORK_ENVIRONMENT.NODE:return this.getTempFilePathInNode();default:throw new Error("<CoreModule initCanvas> 初始化Canvas错误")}}))}getTempFilePathInWeixin(){return new Promise(((e,a)=>{this.wx.canvasToTempFilePath({canvas:this.canvas,destWidth:this.canvasUtils.toPx(this.drawingSchema.canvasWidth,!0),destHeight:this.canvasUtils.toPx(this.drawingSchema.canvasHeight,!0),success:a=>{e(a.tempFilePath)},fail:e=>{a(e)}})}))}getTempFilePathInNode(){return new Promise(((e,a)=>{try{e(this.canvas.createJPEGStream({quality:1,progressive:!1,chromaSubsampling:!1}))}catch(e){a(e)}}))}getElement(e){return new Promise(((a,t)=>{try{this.scope.createSelectorQuery().select(`#${e}`).fields({node:!0,size:!0}).exec((e=>{a(e[0]||null)}))}catch(e){t(null)}}))}};