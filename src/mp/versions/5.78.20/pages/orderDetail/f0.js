var e=Object.create,r=Object.defineProperty,t=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,a=Object.getOwnPropertySymbols,o=Object.getPrototypeOf,n=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,s=(e,t,i)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,d=(e,r)=>{for(var t in r||(r={}))n.call(r,t)&&s(e,t,r[t]);if(a)for(var t of a(r))l.call(r,t)&&s(e,t,r[t]);return e},u=e=>r(e,"__esModule",{value:!0}),g=a=>((e,a,o)=>{if(a&&"object"==typeof a||"function"==typeof a)for(let l of i(a))n.call(e,l)||"default"===l||r(e,l,{get:()=>a[l],enumerable:!(o=t(a,l))||o.enumerable});return e})(u(r(null!=a?e(o(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a),c=(e,r,t)=>new Promise(((i,a)=>{var o=e=>{try{l(t.next(e))}catch(e){a(e)}},n=e=>{try{l(t.throw(e))}catch(e){a(e)}},l=e=>e.done?i(e.value):Promise.resolve(e.value).then(o,n);l((t=t.apply(e,r)).next())}));((e,t)=>{for(var i in u(e),t)r(e,i,{get:t[i],enumerable:!0})})(exports,{default:()=>P});var h=g(require("../../ob.js")),m=g(require("../../u8.js")),p=g(require("../../kc.js")),f=g(require("../../sn.js")),y=g(require("../../u3.js")),I=g(require("./cc.js")),S=g(require("../../is.js")),x=g(require("../../u1.js")),v=g(require("./p9.js")),F=g(require("./gr.js"));var b=getApp(),P=class{constructor(e=null,r=!1){var t;this.canSync=!1,this.showShareMenu=!1,this.userId=(null==(t=b.$user)?void 0:t.userId)||"",this.canSync=!(0,m.isMMP)()&&!(0,m.isMTChannel)()&&(0,y.default)(b.$systemInfo.getSystemInfo("SDKVersion"),"2.12.0")>=0,this.showShareMenu=r,e&&(this.prefetchOrder=e,this.fetchShareData(e))}getShareMessage(e,r){var t,i,a;return h.log.info("[core-order-share]","开始获取分享内容",JSON.stringify(e)),P.checkAppInstall(),(null==e?void 0:e.orderId)?(null==(t=this.prefetchOrder)?void 0:t.orderId)&&((null==(i=this.prefetchOrder)?void 0:i.token)||(null==(a=this.prefetchOrder)?void 0:a.groupId))?(h.log.info("[core-order-share]","读取prefetchOrder缓存数据"),this.getMessage(d(d({},this.prefetchOrder),e),r)):this.canSync?(h.log.info("[core-order-share]","支持异步加载分享信息",JSON.stringify(e)),this.fetchShareData(e).then((({title:t,token:i,poiId:a,poiIdStr:o,imageUrl:n})=>this.getMessage(d({title:t,token:i,poiId:a,poiIdStr:o,imageUrl:n},e),r))).catch((()=>this.getMessage(e,r)))):(h.log.info("[core-order-share]","没有缓存&&不能异步加载，直接使用默认图",JSON.stringify(e)),this.getMessage(e,r)):{title:"美团优选",path:"/pages/index/index",imageUrl:""}}static checkAppInstall(){var e,r;(0,m.isApp)()&&(0,y.default)((null==(r=null==(e=b.$systemInfo)?void 0:e.systemInfo)?void 0:r.appVersion)||"0.0.0","6.6.0")>=0&&mmp.callCustomAPI("isInstalledApp",{scheme:"weixin://",packageName:"com.tencent.mm",success(e){e.installed||b.page().toast("未安装微信")},fail(e){h.log.warn("判断是否安装微信失败",e)}})}getMessage(e,r){const{title:t,orderId:i,poiId:a,poiIdStr:o,token:n,imageUrl:l,groupId:s,from:d,hitGray:u}=e;if(s)return this.getGroupShareMessage(e);try{v.getConfirmShare({orderId:i})}catch(e){h.log.warn(`<OrderShareController getConfirmShare>, ${e.message}, orderId : ${i}`)}const g=b.isLogin()?`&shareUserId=${this.userId}`:"";let c="";c=u&&"paySuccess"===d?`pages/index/index?protocol=${encodeURIComponent(`igrocery://www.grocery.com/communityShare?orderId=${i}&poiId=${a}&poiIdStr=${o}&token=${n}&from=${d}${g}`)}`:`subPackages/orderShareLanding/pages/index?orderId=${i}&poiId=${a}&poiIdStr=${o}&token=${n}&from=${d}${g}`;const m={title:t||"团长，我刚在美团优选下单了，请接单！",path:c,imageUrl:this.convertPicUrl(l)||"https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/pay_success_order_share_default_background_new.0af71169.jpg"};return(0,p.isFunction)(r)&&r(m),n||h.log.error("[core-order-share] <getMessage> 分享链接不存在token"),b.$cat.reportCustomMetrics(S.YXReportTarget.ORDER_SHARE_URL,n?S.ReportValue.SUCCESS:S.ReportValue.FAILED,{info:"生成订单分享链接"+(n?"正常":"不存在token"),path:c,token:n}),h.log.info(` [core-order-share] <getMessage> 分享成功, message: ${JSON.stringify(m)}`),m}convertPicUrl(e){return e?`${e}${e.indexOf("@")>-1?"_":"@"}1000w_800h_80q`:""}fetchShareData(e){return c(this,arguments,(function*({orderId:e,poiId:r,poiIdStr:t,groupId:i,token:a,shareCardType:o}){try{wx.hideShareMenu({});let n={};if(i){const{title:i,imageUrl:a}=yield this.getGroupShareImage({orderId:e,poiId:r,poiIdStr:t});n={title:i,imageUrl:a},h.log.info("[core-order-share]","<异步请求> 获取团中分享图片",JSON.stringify(n))}else{const[r,{poiId:t,poiIdStr:i,imageUrl:l,title:s}]=yield Promise.all([this.getShareToken(e,a),this.getShareImage(e,o)]);n={token:r,poiId:t,poiIdStr:i,imageUrl:l,title:s},h.log.info("[core-order-share]","<异步请求> 获取订单分享图片",JSON.stringify(n))}return this.prefetchOrder&&(this.prefetchOrder=d(d({},this.prefetchOrder),n)),this.showShareMenu&&wx.showShareMenu({}),n}catch(r){h.log.warn(`[core-order-share]  <fetchShareData>请求订单分享信息失败, ${r.message}, orderId: ${e}`)}}))}getShareToken(e,r){return c(this,null,(function*(){var t,i;if((null==(t=this.prefetchOrder)?void 0:t.token)||r)return(null==(i=this.prefetchOrder)?void 0:i.token)||r;try{const{token:r}=yield v.getShareToken({orderId:e});if(!r)throw new Error("share token返回为空");return r}catch(r){h.log.warn(`[core-order-share] <getShareToken>请求订单分享token失败, ${r.message}, orderId: ${e}`)}}))}getShareImage(e,r){return c(this,null,(function*(){try{const t=yield this.getOrderShareImageInfo(e);h.log.info(`[core-order-share] <getShareImage>, orderShareData: ${JSON.stringify(t)}`);const{imageUrl:i="",title:a=""}=yield this.getShareImageUrl(t,e,r);return{poiId:t.poiId,poiIdStr:t.poiIdStr,imageUrl:i,title:a}}catch(r){h.log.warn(`[core-order-share]  <getShareImage>获取服务端绘制的分享图片失败, ${r.message}, orderId: ${e}`)}}))}getShareImageUrl(e,r,t){return c(this,null,(function*(){if(!e)return{};let i="",a="";switch(t){case F.ShareCardType.TYPE_REMIND_ORDERS:{a="团长请接单，我买的超值好物，限时限量，先到先得";const r="0"!==(null==e?void 0:e.discount),t=r?"我下单省了":"我下单花了",o=r?null==e?void 0:e.discount:null==e?void 0:e.totalPay,n=r?"我也要省":"我也要花",l=42,s=new F.default(l,{shareCardType:F.ShareCardType.TYPE_REMIND_ORDERS}),{picUrl:d=""}=yield s.setTestTemplateId(l).addImageMap({skuPicUrl:null==e?void 0:e.pic}).addTextMap({priceDec:t,priceStr:`${o||0}元`,btnName:n}).create();i=d,h.log.info("[core-order-share] <getShareImageUrl> 提醒团长接单")}break;case F.ShareCardType.TYPE_REMIND_RECEIPT:{a=this.getReceiptTitle(null==e?void 0:e.poiName);const r=this.getShareUserName(null==e?void 0:e.shareUserName),t=43,o=new F.default(t,{shareCardType:F.ShareCardType.TYPE_REMIND_RECEIPT}),{picUrl:n=""}=yield o.setTestTemplateId(t).addImageMap({skuPicUrl:null==e?void 0:e.pic,firstAvatar:(null==e?void 0:e.avatarUrls[0])||"",secondAvatar:(null==e?void 0:e.avatarUrls[1])||""}).addTextMap({orignalPrice:`￥${null==e?void 0:e.orignalPrice}`,shareUserName:r}).create();i=n,h.log.info("[core-order-share] <getShareImageUrl> 提醒团长收货")}break;case F.ShareCardType.TYPE_VIEW_PRODUCT_INFO:{const r=null==e?void 0:e.shareUserName;a=this.getProductInfoTitle(r);const t=44,o=new F.default(t,{shareCardType:F.ShareCardType.TYPE_VIEW_PRODUCT_INFO}),{picUrl:n=""}=yield o.setTestTemplateId(t).addTextMap({orignalPrice:`${(null==e?void 0:e.orignalPrice)||0}元/份`}).create();i=n,h.log.info("[core-order-share] <getShareImageUrl> 查看商品信息")}}try{if(!i){const{url:r=""}=yield b.$service.getGenerateImage({uuid:this.userId,schema:this.getShareImageSchema(e)});i=r,h.log.info("[core-order-share] <getShareImageUrl> 使用Node服务绘制兜底")}}catch(e){h.log.warn(`[core-order-share] <getShareImage>获取node服务端绘制的分享图片失败, ${e.message}, orderId: ${r}`)}return{imageUrl:i,title:a}}))}getProductInfoTitle(e){let r="";if(e){let t=e;e.length>3&&(t=`${e.substring(0,3)}…`),r=`【${t}买过后分享】我买到了超值好物，大家猜猜是什么`}else r="我买到了超值好物，大家猜猜是什么";return r}getReceiptTitle(e){let r="";if(e){let t=e;e.length>4&&(t=`${e.substring(0,4)}…`),r=`订单到哪了？${t}附近的人都在买这些好货`}else r="附近的人都在买这些好货";return r}getShareUserName(e){let r="";if(e){let t=e;e.length>3&&(t=`${e.substring(0,3)}…`),r=`${t}等附近`}else r="附近";return r}getOrderShareImageInfo(e){return c(this,null,(function*(){try{const r={orderId:e};this.prefetchOrder&&this.prefetchOrder.token&&(r.token=this.prefetchOrder.token);return yield v.getOrderSharePicInfo(r)}catch(r){h.log.warn(`<OrderShareController getOrderSharePicInfo>获取分享图片数据失败, ${r.message}, orderId: ${e}`)}}))}getShareImageSchema(e){if(!e)return{};const r="0"!==(null==e?void 0:e.discount),t=[{name:"购买内容",display:0===(null==e?void 0:e.quantity)||!!(null==e?void 0:e.quantity),x:300,y:85,width:196,lineHeight:40,fontFamily:"PingFangSC-Semibold",fontSize:28,color:"#191919",fontWeight:"bold",baseLine:"top",text:"我在美团优选",textAlign:"center",lineNum:2,zIndex:1},{name:"商品件数",display:0===(null==e?void 0:e.quantity)||!!(null==e?void 0:e.quantity),x:300,y:124,width:196,lineHeight:40,fontFamily:"PingFangSC-Semibold",fontSize:28,color:"#191919",fontWeight:"bold",baseLine:"top",text:`买了${null==e?void 0:e.quantity}件商品`,textAlign:"center",lineNum:2,zIndex:1},{name:"省了",display:!0,x:196,y:200,width:206,height:68,lineHeight:68,fontWeight:"600",fontFamily:"PingFangSC-Semibold",color:"#FFFFFF",baseLine:"middle",textAlign:"center",lineNum:1,zIndex:1,text:[{name:"省了",display:!0,fontSize:26,lineHeight:36,fontWeight:"600",fontFamily:"PingFangSC-Semibold",color:"#FFFFFF",text:"省了",lineNum:1,zIndex:1},{name:"价格符号",display:!0,fontSize:30,fontWeight:"600",fontFamily:"PingFangSC-Semibold",color:"#FFFFFF",marginLeft:6,marginRight:4,text:"¥",lineNum:1,zIndex:1},{name:"节省价格",display:!!(null==e?void 0:e.discount),fontSize:36,fontWeight:"600",fontFamily:"PingFangSC-Semibold",color:"#FFFFFF",text:`${null==e?void 0:e.discount}`,lineNum:1,zIndex:1}]}],i=[{name:"购买内容",display:0===(null==e?void 0:e.quantity)||!!(null==e?void 0:e.quantity),x:300,y:85,width:196,lineHeight:40,fontFamily:"PingFangSC-Semibold",fontSize:28,color:"#191919",fontWeight:"bold",baseLine:"top",text:"我在美团优选",textAlign:"center",lineNum:2,zIndex:1},{name:"商品件数",display:0===(null==e?void 0:e.quantity)||!!(null==e?void 0:e.quantity),x:300,y:124,width:196,lineHeight:40,fontFamily:"PingFangSC-Semibold",fontSize:28,color:"#191919",fontWeight:"bold",baseLine:"top",text:`买了${null==e?void 0:e.quantity}件商品`,textAlign:"center",lineNum:2,zIndex:1},{name:"花了",display:!0,x:196,y:200,width:206,height:68,lineHeight:68,fontWeight:"600",fontFamily:"PingFangSC-Semibold",color:"#FFFFFF",baseLine:"middle",textAlign:"center",lineNum:1,zIndex:1,text:[{name:"花了",display:!0,fontSize:26,lineHeight:36,fontWeight:"600",fontFamily:"PingFangSC-Semibold",color:"#FFFFFF",text:"花了",lineNum:1,zIndex:1},{name:"价格符号",display:!0,fontSize:30,fontWeight:"600",fontFamily:"PingFangSC-Semibold",color:"#FFFFFF",marginLeft:6,marginRight:4,text:"¥",lineNum:1,zIndex:1},{name:"节省价格",display:!!(null==e?void 0:e.totalPay),fontSize:36,fontWeight:"600",fontFamily:"PingFangSC-Semibold",color:"#FFFFFF",text:`${null==e?void 0:e.totalPay}`,lineNum:1,zIndex:1}]}];return{canvasWidth:420,canvasHeight:336,backgroundColor:"#ffffff",debug:!1,filter:!0,pixelRatio:2,images:[{name:"背景图片",display:!0,width:420,height:336,x:0,y:0,url:r?"https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/pay_success_order_share_background_new.a1f71196.png":"https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/has_no_save_price.33f0963.png",zIndex:0},{name:"商品图",display:!!(null==e?void 0:e.pic)||!0,width:160,height:160,x:18,y:72,url:(null==e?void 0:e.pic)||"https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/order_share_sku_default.28c91049.png",zIndex:1}],texts:r?t:i}}getGroupShareMessage({title:e,imageUrl:r,groupId:t}){const i=`pages/index/index?protocol=${encodeURIComponent(`igrocery://www.grocery.com/followGroup?groupId=${t}&userId=${this.userId}`)}&needFold=1`,{path:a}=b.$lxLog.genLxSharePath(b.page().route,i,{});return{imageUrl:r||"https://s3plus.meituan.net/v1/mss_1f3dca8fe8534e6fa640054bf3ad2ba6/grocery-fe-cdn/wx/images/cdn/pay_success_order_share_default_background_new.0af71169.jpg",title:e||"美团优选",path:a}}getGroupShareImage(e){return c(this,arguments,(function*({orderId:e,poiId:r,poiIdStr:t}){var i,a,o;try{const{shareInfoModel:n,groupQueryBaseModel:l}=yield(o={orderId:e,poiId:r,poiIdStr:t},(0,x.get)({url:"/activity/interact/group/query/groupInfo",params:o})),{url:s}=yield I.getGenerateImage({model:this.getGroupShareImageSchema(n?{sharePicUrl:n.sharePicUrl,skuName:l.groupPoiSkuModel.skuName,picUrl:l.groupPoiSkuModel.picUrl,cashPay:(0,f.toRoundFixed)(l.groupInfoModel.cashPay/100,2),originPrice:(0,f.toRoundFixed)(l.groupPoiSkuModel.originPrice/100,2)}:null),requestType:null==(i=l.groupInfoModel)?void 0:i.groupType,requestId:null==(a=l.groupInfoModel)?void 0:a.skuId});return{title:n.shareTitle,imageUrl:s}}catch(r){h.log.warn(`<OrderShareController getGroupShareImage>获取服务端绘制的分享图片失败, ${r.message}, orderId: ${e}`)}}))}getGroupShareImageSchema(e){return e?{}:{canvasWidth:418,canvasHeight:335,backgroundColor:"#ffffff",pixelRatio:1.8,images:[{name:"背景图片",x:0,y:0,url:null==e?void 0:e.sharePicUrl,width:418,height:335},{name:"商品图",x:18,y:96,url:null==e?void 0:e.picUrl,width:222,height:222,borderRadius:6}],texts:[{name:"售价",x:329,y:168,width:172,fontFamily:"sans-serif",textAlign:"center",text:`￥${e.cashPay}`,fontSize:42,color:"#F20000",fontWeight:"600",baseLine:"middle",lineNum:1},{name:"原价",x:329,y:208,width:172,fontFamily:"sans-serif",textAlign:"center",text:`￥${e.originPrice}`,fontSize:24,color:"#7E7E7E",baseLine:"middle",lineNum:1}]}}};