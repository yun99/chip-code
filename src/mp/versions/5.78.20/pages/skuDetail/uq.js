var e=Object.create,t=Object.defineProperty,r=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyNames,s=Object.getPrototypeOf,o=Object.prototype.hasOwnProperty,i=i=>{return((e,s,i)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let n of a(s))o.call(e,n)||"default"===n||t(e,n,{get:()=>s[n],enumerable:!(i=r(s,n))||i.enumerable});return e})((n=t(null!=i?e(s(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0}),t(n,"__esModule",{value:!0})),i);var n},n=(e,t,r)=>new Promise(((a,s)=>{var o=e=>{try{n(r.next(e))}catch(e){s(e)}},i=e=>{try{n(r.throw(e))}catch(e){s(e)}},n=e=>e.done?a(e.value):Promise.resolve(e.value).then(o,i);n((r=r.apply(e,t)).next())})),l=i(require("../../ob.js")),h=i(require("../../is.js")),u=i(require("../../jc.js")),m=i(require("../../xf.js")),S=i(require("../../u8.js")),d=i(require("./xs.js")),c=i(require("./xd.js")),p=getApp();(0,u.defineComponent)(new class{constructor(){this.created=function(){this.initCommonDataCommonData()},this.observers={sharePosterConfig(e){this.isPosterPrepared&&e&&(this.isPosterPrepared=!1,setTimeout((()=>this.startCreating()),0))}},this.methods={onTapShareFriend(){this.triggerEvent("close")},onTapShareTimeline(){this.turnToShareTimelineMode(),this.createPoster()},onTapShareFriendLoading(){},shareTimeline(e){(0,S.isApp)()?mmp.callCustomAPI("yxShare",{title:"美团优选",type:3,imageUrl:e,fail(){l.log.error("【分享朋友圈失败】：优选app newShare组件功能异常"),p.page().toast("分享失败，请稍后重试")}}):(0,S.isMT)()&&mmp.mtShare({type:2,title:"美团优选",imageUrl:e,channel:"WXTimeline",fail(){l.log.error("【分享朋友圈失败】：美团 newShare组件功能异常"),p.page().toast("分享失败，请稍后重试")}}),this.closeShareTiemlineMode()},createPoster(){var e,t;l.log.info("<Share createPoster> 开始绘制海报");const{sharePostLxMc:r}=this.data;if((null==r?void 0:r.bid)?p.$lxLog.mc(r.bid,r.params||{}):p.$lxLog.mc("b_youxuan_hjet0k5m_mc",{shareUserId:(null==(e=p.getModule("user"))?void 0:e.getUserId())||"",share_to:"wx_moments",share_url:"",share_content:(null==(t=this.data)?void 0:t.shareContent)||""}),this.commonData.shareMetricsReport.startSharePosterMetricsPoint(),this.clearPreviewPosterUrl(),this.setPosterGenerateStatus(c.POSTER_GENERATE_STATUS.PENDING),this.data.isShareTimelineMode||this.turnToPreviewMode(),!this.data.sharePosterConfig)return l.log.info("<Share createPoster> 海报绘制参数还未准备好"),void(this.isPosterPrepared=!0);this.startCreating()},startCreating(){return n(this,null,(function*(){try{if(this.data.isLackSharePosterKeyData)return l.log.info("<Share createPoster> 缺失海报必须数据"),p.page().toast("生成海报失败，请稍后重试"),void this.closePreviewMode();this.resetRemoteDrawStatus(),yield this.getWxCode(),yield this.getSkuSharePosterFromRemote()}catch(e){l.log.warn("<Share createPoster> 绘制海报失败")}}))},onSavePoster(){return n(this,null,(function*(){var e,t,r,a;const s=(0,m.genShareId)();try{const{poiId:t="",poiIdStr:r="",scid:a="",skuId:o="",userId:i=""}=this.data.wxCodeReqParams||{};let n=i;n||(n=null==(e=p.getModule("user"))?void 0:e.getUserId());const l={eventType:"CREATE_POSTER",shareid:s,share_type:"post",suid:n,scid:a,poiId:t,poiIdStr:r,skuId:o};p.$service.shareReport((0,m.getLeaderShareParams)(l))}catch(e){l.log.error(`团长激励-海报分享-埋点上报错误(在src/components/newShare/index.ts => onSavePoster方法里)：${e}`)}try{if(p.$lxLog.mc("b_youxuan_cshare_mc",{shareid:s,share_type:"post",share_pos:this.data.sharePosition||"",share_object:this.data.shareButtonObject||"",sku_id:(null==(r=null==(t=this.data)?void 0:t.wxCodeReqParams)?void 0:r.skuId)||-999,share_extra:(null==(a=this.data)?void 0:a.shareExtra)||"-999"}),this.isNetWorkDisable())return void p.page().toast("网络异常，请重试");switch(this.data.posterGenerateStatus){case c.POSTER_GENERATE_STATUS.PENDING:p.page().toast("海报生成中，请稍等");break;case c.POSTER_GENERATE_STATUS.SUCCESS:case c.POSTER_GENERATE_STATUS.FAIL:yield this.getPhotosAuthorize(),yield this.saveImageToPhotosAlbum(this.data.previewPosterUrl),this.closePreviewMode();break;case c.POSTER_GENERATE_STATUS.ABSOLUTELY_FAIL:p.page().toast("图片绘制失败")}}catch(e){e&&l.log.warn("<Share onSavePoster> 保存海报失败",e)}}))},prevents(){},closeShare(){this.triggerEvent("close")},onTapShareMask(){this.data.posterGenerateStatus===c.POSTER_GENERATE_STATUS.ABSOLUTELY_FAIL&&this.onClosePreviewContainer()},onClosePreviewContainer(){this.data.posterGenerateStatus!==c.POSTER_GENERATE_STATUS.PENDING?this.closePreviewMode():p.page().toast("正在生成海报，请稍等")},initCommonDataCommonData(){this.commonData={remoteDrawStatus:c.REMOTE_DRAW_STATUS.READY,shareMetricsReport:new d.default(this)}},getWxCode(){return n(this,null,(function*(){try{if(!this.data.isUseWxCodeByRequest)return;const e=yield p.$service.getMiniAppQrCode(this.data.wxCodeReqParams||{});yield this.setDrawWxCode(e)}catch(e){throw this.onCreatePosterFailAgent(e),e}}))},setDrawWxCode(e){var t,r;if(!(null==(r=null==(t=this.data.sharePosterConfig)?void 0:t.images)?void 0:r.length))throw new Error("share组件自请求设置小程序码失败-缺少images数据");if(!this.data.sharePosterConfig.images.some((t=>"二维码"===t.name&&(t.display=!!e,t.url=e,!0))))throw new Error("share组件自请求设置小程序码失败-缺少二维码绘制配置");return new Promise((e=>{this.setData({"sharePosterConfig.images":this.data.sharePosterConfig.images},(()=>e()))}))},clearPreviewPosterUrl(){this.data.previewPosterUrl=""},getSkuSharePosterFromRemote(){return n(this,null,(function*(){var e;try{l.log.info("<Share getSkuSharePosterFromRemote> 从服务端获取商详海报图片"),this.commonData.shareMetricsReport.startRemoteDrawMetricsPoint(),this.updateRemoteDrawStatus(c.REMOTE_DRAW_STATUS.PENDING);const t=yield p.$service.getGenerateImage({uuid:(null==(e=p.$user)?void 0:e.userId)||"",schema:this.data.sharePosterConfig});if(this.commonData.shareMetricsReport.endRemoteDrawMetricsPoint(),p.$cat.reportCustomMetrics(h.YXReportTarget.NEW_SHARE_COMPONENT_REMOTE_DRAW,h.ReportValue.SUCCESS,{wxAppVersion:p.$version||"none",result:h.NewShareComponentRemoteDrawResult.REMOTE_SUCCESS}),this.data.isShareTimelineMode)yield this.onCreatePosterSuccess(t.url,"服务端");else{const e=yield this.downLoadRemoteDrawPoster(t.url);this.onCreatePosterSuccess(e,"服务端"),l.log.info(`<Share getSkuSharePosterFromRemote> 从服务端获取商详海报图片 -- 成功，原始图片地址：${t.url}，本地临时文件地址：${e}`)}this.updateRemoteDrawStatus(c.REMOTE_DRAW_STATUS.SUCCESS)}catch(e){l.log.info(`<Share getSkuSharePosterFromRemote> 从服务端获取商详海报图片 -- 失败，错误：${e.message}`),p.$cat.reportCustomMetrics(h.YXReportTarget.NEW_SHARE_COMPONENT_REMOTE_DRAW,h.ReportValue.FAILED,{wxAppVersion:p.$version||"none",result:h.NewShareComponentRemoteDrawResult.REMOTE_FAIL}),this.updateRemoteDrawStatus(c.REMOTE_DRAW_STATUS.FAIL),this.onCreatePosterFail(e)}}))},downLoadRemoteDrawPoster:e=>new Promise(((t,r)=>{wx.downloadFile({url:e,success:e=>{200===e.statusCode&&e.tempFilePath?(l.log.info(`<Share downLoadRemoteDrawPoster>  下载服务端绘制海报 -- 成功，临时图片地址：${e.tempFilePath}`),t(e.tempFilePath)):(l.log.warn(`<Share downLoadRemoteDrawPoster>  下载服务端绘制海报 -- 失败 - 状态码为：${e.statusCode}`),r(new Error("下载服务端绘制海报失败！-- 下载成功但状态码非200或者临时文件地址不存在")))},fail:()=>{l.log.warn("<Share downLoadRemoteDrawPoster> 下载兜底海报失败"),r(new Error("下载服务端绘制海报失败！-- 下载失败"))}})})),onCreatePosterSuccess(e,t){return n(this,null,(function*(){this.data.previewPosterUrl||(l.log.info(`<Share onCreatePosterSuccess> 执行海报绘制成功回调，图片地址：${e}`),yield this.updatePreviewPosterUrl(e),yield this.setPosterGenerateStatus(c.POSTER_GENERATE_STATUS.SUCCESS),this.data.isShareTimelineMode&&this.shareTimeline(e),this.commonData.shareMetricsReport.endSharePosterMetricsPoint())}))},onCreatePosterFail(e){return n(this,null,(function*(){l.log.warn(`<Share onCreatePosterFail> 执行海报绘制失败回调 错误为：${e}`),this.data.defaultPoster?wx.downloadFile({url:this.data.defaultPoster,success:e=>n(this,null,(function*(){200===e.statusCode&&e.tempFilePath?(l.log.info(`<Share onCreatePosterFail downloadFile> 下载兜底海报成功，临时图片地址：${e.tempFilePath}`),yield this.updatePreviewPosterUrl(e.tempFilePath),this.setPosterGenerateStatus(c.POSTER_GENERATE_STATUS.FAIL)):(l.log.warn(`<Share onCreatePosterFail downloadFile> 下载兜底海报失败 - 状态码为：${e.statusCode}`),yield this.updatePreviewPosterUrl(""),this.setPosterGenerateStatus(c.POSTER_GENERATE_STATUS.ABSOLUTELY_FAIL),p.page().toast("图片保存失败，请稍后重试"))})),fail:()=>{l.log.warn("<Share onCreatePosterFail downloadFile> 下载兜底海报失败"),this.updatePreviewPosterUrl("").then((()=>{this.setPosterGenerateStatus(c.POSTER_GENERATE_STATUS.ABSOLUTELY_FAIL),p.page().toast("生成海报失败，请稍后重试")}))}}):(yield this.updatePreviewPosterUrl(""),this.setPosterGenerateStatus(c.POSTER_GENERATE_STATUS.ABSOLUTELY_FAIL),p.page().toast("生成海报失败，请稍后重试"))}))},getPhotosAuthorize:()=>new Promise(((e,t)=>{wx.getSetting({success(r){r.authSetting["scope.writePhotosAlbum"]?e():wx.authorize({scope:"scope.writePhotosAlbum",success(){e()},fail(){l.log.warn("<Share getPhotosAuthorize getSetting authorize> 用户拒绝授权保存相册"),p.page().toast("图片保存失败，请授权相册后重试"),t()}})},fail(){l.log.warn("<Share getPhotosAuthorize> 获取用户权限设置失败"),p.page().toast("暂未获得授权，保存失败"),t()}})})),saveImageToPhotosAlbum:e=>new Promise(((t,r)=>{l.log.info(`<Share saveImageToPhotosAlbum> 保存图片，地址为：${e}`),wx.saveImageToPhotosAlbum({filePath:e,success:()=>{p.page().toast("保存成功，请在相册中查看"),t()},fail:e=>{"saveImageToPhotosAlbum:fail auth deny"===e.errMsg?(l.log.warn("<Share saveImageToPhotosAlbum> 图片保存失败，没有授权",e),p.page().toast("图片保存失败，请授权后重试")):"saveImageToPhotosAlbum:fail cancel"===e.errMsg?(l.log.info("<Share saveImageToPhotosAlbum> 用户取消保存图片",e),p.page().toast("取消保存")):(l.log.warn("<Share saveImageToPhotosAlbum> 图片保存失败",e),p.page().toast("图片保存失败，请稍后重试")),r()}})})),turnToPreviewMode(){this.triggerEvent("close"),this.setData({isShowPreviewContainer:!0})},turnToShareTimelineMode(){p.page().toast("分享内容准备中，请稍等"),this.triggerEvent("close"),this.setData({isShareTimelineMode:!0})},setPosterGenerateStatus(e){return new Promise((t=>{this.setData({posterGenerateStatus:e},(()=>t()))}))},resetRemoteDrawStatus(){this.commonData.remoteDrawStatus=c.REMOTE_DRAW_STATUS.READY},updateRemoteDrawStatus(e){this.commonData.remoteDrawStatus=e},updatePreviewPosterUrl(e){return new Promise((t=>{this.setData({previewPosterUrl:e},(()=>t()))}))},closePreviewMode(){this.setData({isShowPreviewContainer:!1})},closeShareTiemlineMode(){this.setData({isShareTimelineMode:!1})},isNetWorkDisable(){const e=p.$module.getModule("networkStatus");return!e.isConnected||"none"===e.networkType}},this.properties={shareButtonObject:{type:String,value:""},sharePosition:{type:Number,value:""},show:{type:Boolean,value:!1},isShowSharePoster:{type:Boolean,value:!0},isShowShareFriend:{type:Boolean,value:!0},isShowShareTimeline:{type:Boolean,value:!0},isShowShareFriendLoading:{type:Boolean,value:!1},sharePosterConfig:{type:Object,value:{}},isLackSharePosterKeyData:{type:Boolean,value:!1},defaultPoster:{type:String,value:""},fixIpx:{type:Boolean,value:!0},fixCustomNavigator:{type:Boolean,value:!1},zIndex:{type:Number,value:85},isUseWxCodeByRequest:{type:Boolean,value:!1},wxCodeReqParams:{type:Object,value:{}},shareContent:{type:String,value:""},sharePostLxMc:{type:Object,value:null},shareExtra:{type:Object,value:null}},this.data={isShowPreviewContainer:!1,posterGenerateStatus:c.POSTER_GENERATE_STATUS.FAIL,previewPosterUrl:"",posterPreviewHeight:.62*p.$systemInfo.systemInfo.windowHeight,isIpx:p.getModule("systemInfo").getSystemInfo().isIpx,isShareTimelineMode:!1}}});