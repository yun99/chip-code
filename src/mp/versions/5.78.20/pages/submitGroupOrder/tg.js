var e=Object.create,t=Object.defineProperty,o=Object.defineProperties,r=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertyNames,s=Object.getOwnPropertySymbols,n=Object.getPrototypeOf,c=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,p=(e,o,r)=>o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[o]=r,u=(e,t)=>{for(var o in t||(t={}))c.call(t,o)&&p(e,o,t[o]);if(s)for(var o of s(t))l.call(t,o)&&p(e,o,t[o]);return e},m=o=>{return((e,o,a)=>{if(o&&"object"==typeof o||"function"==typeof o)for(let s of i(o))c.call(e,s)||"default"===s||t(e,s,{get:()=>o[s],enumerable:!(a=r(o,s))||a.enumerable});return e})((a=t(null!=o?e(n(o)):{},"default",o&&o.__esModule&&"default"in o?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0}),t(a,"__esModule",{value:!0})),o);var a},h=m(require("../../ob.js")),d=m(require("../../jc.js")),f=!1,g=getApp();(0,d.defineComponent)({properties:{hasRedemptionInfo:{type:Boolean,default:!1,observer(){this.calcShow()}},redemptionData:{type:Object,observer(e){const t=e.popupItemVOList&&e.popupItemVOList[0]||{};var r,i;this.setData({skuItem:Object.assign((r=u({},t),i={newPrice:this.formatPrice(t.promotionPrice?t.promotionPrice:t.sellPrice),oldPrice:this.formatPrice(t.scatter?t.totalCutlinePrice:t.skuCutlinePrice),feUnit:t.scatter?"":t.sellUnitViewName},o(r,a(i)))),tagEntity:t.promotionRuleDesc?{type:"promotion",text:t.promotionRuleDesc}:{}})}}},data:{show:!1,skuItem:{},tagEntity:{}},methods:{calcShow(){const e=this.data.hasRedemptionInfo&&!f&&this.canShowNow();e&&setTimeout((()=>{g.$lxLog.mv("b_chaoshi_z48cd2rh_mv",this.getReportParams())}),0),this.setData({show:e})},canShowNow(){const{cancelCount:e}=this.data.redemptionData;if(e<=0)return!1;const t=g.$store.getCacheValue("redemptionPopupNextShowTime")||0;return Date.now()>=t},updateStorageInfo(e=!1){const{cancelCount:t,interval:o}=this.data.redemptionData;if(t<=0)return;let r=+g.$store.getCacheValue("redemptionCancelCount")||0;if(e)r=0;else if(r+1>=t){r=0;const e=Date.now()+864e5*o;g.$store.setCache("redemptionPopupNextShowTime",e)}else r++;g.$store.setCache("redemptionCancelCount",String(r))},formatPrice:e=>e?+(e/100).toFixed(2):0,closePopup(e){f=!0,"number"==typeof e&&this.updateStorageInfo(1===e),this.calcShow()},getReportParams(){const{skuId:e,promotionPrice:t,sellPrice:o}=this.data.skuItem;return{sku_id:e,sale_price:t,origin_price:o}},handleBtnClick(e){const{code:t}=e.currentTarget.dataset;switch(t){case 0:this.handleClose();break;case 1:this.handleRedemption();break;default:h.log.error(`换购弹窗未知的按钮code:${t}`),this.handleClose()}},handleClose(){g.$lxLog.mc("b_chaoshi_dxmyh236_mc",this.getReportParams()),this.closePopup(0)},handleRedemption(){return e=this,t=null,o=function*(){const{skuId:e,promotionId:t,promotionType:o}=this.data.skuItem;if(t&&o||h.log.warn(`换购弹窗中 skuId 为 ${e} 的商品，缺少 promotionId 或者 promotionType`),!(yield g.$cart.operateCart({cartOpSource:"ORDER",cartOpType:"INCREASE_GIFT",opTarget:{opTargets:[{skuId:e,promotionId:t,promotionType:o}]},lxData:{bid:"b_chaoshi_z48cd2rh_mc",valLab:this.getReportParams()},showSuccessToast:!1})))return h.log.error(`换购弹窗中商品添加到购物车失败，skuId 为 ${e}`),void this.closePopup(1);this.triggerEvent("redemptionSku"),this.closePopup(1)},new Promise(((r,a)=>{var i=e=>{try{n(o.next(e))}catch(e){a(e)}},s=e=>{try{n(o.throw(e))}catch(e){a(e)}},n=e=>e.done?r(e.value):Promise.resolve(e.value).then(i,s);n((o=o.apply(e,t)).next())}));var e,t,o}}});