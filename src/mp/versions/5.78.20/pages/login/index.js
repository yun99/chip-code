var e,t=Object.create,o=Object.defineProperty,r=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,n=Object.getOwnPropertySymbols,s=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,u=(e,t,r)=>t in e?o(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,g=(e,t)=>{for(var o in t||(t={}))a.call(t,o)&&u(e,o,t[o]);if(n)for(var o of n(t))l.call(t,o)&&u(e,o,t[o]);return e},p=e=>{return((e,t,n)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let s of i(t))a.call(e,s)||"default"===s||o(e,s,{get:()=>t[s],enumerable:!(n=r(t,s))||n.enumerable});return e})((n=o(null!=e?t(s(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0}),o(n,"__esModule",{value:!0})),e);var n},c=(e,t,o)=>new Promise(((r,i)=>{var n=e=>{try{a(o.next(e))}catch(e){i(e)}},s=e=>{try{a(o.throw(e))}catch(e){i(e)}},a=e=>e.done?r(e.value):Promise.resolve(e.value).then(n,s);a((o=o.apply(e,t)).next())})),h=p(require("../../pi.js")),d=p(require("../../er.js")),y=p(require("../../ob.js")),f=p(require("./a9.js")),m=p(require("../../sq.js")),b=p(require("../../u8.js")),T=p(require("../../a0.js")),v=p(require("../../u3.js")),{before:U,after:x}=f.default,L=getApp();(0,d.default)({data:{navTop:0,isMT:(0,b.isMT)(),isWX:(0,b.isWX)(),isIOSApp:(0,b.isApp)()&&(null==(e=L.$systemInfo)?void 0:e.isIOS()),appVersionShow:!1},onLoad(e){if(y.log.debug("login page onload options",e),this.resolveOptions(e),h.default.hideShareMenu({}),this.getStatusBarHeight(),this.setData({loginType:this.loginType}),"1"===this.loginType&&this.getLoginCode(),this.data.isMT){const{appVersion:e}=L.$systemInfo.systemInfo;e&&(1!==(0,v.default)(e,"11.5.200")&&0!==(0,v.default)(e,"11.5.200")||this.setData({appVersionShow:!0}))}},backToMeiTuan(){var e,t,o;(null==(t=null==(e=getApp())?void 0:e.pages())?void 0:t.length)>1?null==(o=getApp())||o.$router.triggerBack("login"):h.default.redirectTo({url:"/pages/index/index"})},resolveOptions(e){this.sourceUrl=(null==e?void 0:e.sourceUrl)?decodeURIComponent(e.sourceUrl):"h5",this.targetUrl=(null==e?void 0:e.targetUrl)?decodeURIComponent(e.targetUrl):"",this.loginType=(null==e?void 0:e.loginType)||"2",this.beforeLogin=U[null==e?void 0:e.beforeLogin],this.afterLogin=x[null==e?void 0:e.afterLogin],this.backCount=Number(null==e?void 0:e.backCount);try{this.passThroughData=JSON.parse((null==e?void 0:e.passThroughData)?decodeURIComponent(e.passThroughData):null)}catch(e){this.passThroughData=null,y.log.error("[login page] 解析 passThroughData 错误",e)}this.sourceUrl!==this.targetUrl||this.backCount||(this.targetUrl="",this.backCount=1)},getStatusBarHeight(){h.default.use("getMenuButtonBoundingClientRect",(e=>{const t=e.getMenuButtonBoundingClientRect(),o=this.calcHeight(t.top)+(this.calcHeight(t.height)-48)/2;this.setData({navTop:o})}))},calcHeight(e){const t=750/L.$systemInfo.systemInfo.windowWidth;return Math.floor(e*t)},getLoginCode(){L.$login.getLoginCode()},getTargetOpts(){return{opts:{sourceUrl:this.sourceUrl,targetUrl:this.targetUrl,url:this.targetUrl,passThroughData:this.passThroughData}}},jumpToTargetPage(e){var t;const o=e.url||e.targetUrl,r=/^https?/.test(o);if("2"===this.loginType&&r)L.$router.triggerBack("login");else if(this.backCount){const e=null==(t=getCurrentPages())?void 0:t.length,r=Math.max(-this.backCount-1,-e);L.$router.navigateBackAndGoto(this.backCount,o,L.page(r))}else{if(!o)return;const{query:t}=(0,T.parseUrl)(o);y.log.info("<Login JumpToTargetPage> 登录中间页跳转至目标URL",o),t.sourceUrl&&t.targetUrl?L.$router.goto(o,{},{fnName:"redirectTo"}):L.$router.goto(o,e,{fnName:"redirectTo"})}},onTapBg(){"2"===this.data.loginType&&this.login()},onTapDebug(){L.$isProd?this.toast("美团优选"):L.$router.goto("/subPackages/debug/pages/root/index")},login(){return c(this,null,(function*(){L.$lxLog.mc("b_youxuan_ymoydjbu_mc",{type:1});try{let{opts:e}=this.getTargetOpts();if("function"==typeof this.beforeLogin&&(yield this.beforeLogin()),L.$login.isLogin())return void this.jumpToTargetPage(e);const t=yield L.$login.login(e);if(yield(0,m.default)((()=>"pages/login/index"===(L.page(-1)||{}).__route__)),!t)return;let o;if("function"==typeof this.afterLogin&&(o=(yield this.afterLogin())||{}),null==o?void 0:o.error)return void this.toast(o.error);e=g(g({},e),o),this.jumpToTargetPage(e)}catch(e){y.log.error("登录中间页 login 报错",e)}}))},wxMobileLoginDirect(e){return c(this,null,(function*(){L.$lxLog.mc("b_youxuan_ymoydjbu_mc",{type:2});try{const t=e.detail;if(!t.iv)return void this.toast("用户拒绝授权手机号");let{opts:o}=this.getTargetOpts();"function"==typeof this.beforeLogin&&(yield this.beforeLogin());if(!(yield L.$login.wxMobileLoginDirect(t,o)))return;let r;if("function"==typeof this.afterLogin&&(r=yield this.afterLogin()),null==r?void 0:r.error)return void this.toast(r.error);o=g(g({},o),r),this.jumpToTargetPage(o)}catch(e){y.log.error("wxMobileLoginDirect 报错",e)}}))}});