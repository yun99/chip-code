var e,t="production",r="",n=require("./kk.js");function a(e,t,r,n,a,i,o){try{var c=e[i](o),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,a)}function i(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function c(e){a(o,n,i,c,s,"next",e)}function s(e){a(o,n,i,c,s,"throw",e)}c(void 0)}))}}function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Object.defineProperty(exports,"__esModule",{value:!0});var s=require("./o5.js"),u={groupId:0,groupName:"",groupKey:"",expId:0,expKey:"",param:null},y="功能灰度",l=[],p=function(e){return Promise.resolve([])},f=function(){return Promise.resolve()},g=function(){},h=function(){return{}},v=function(){function a(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a)}var c,v,m;return function(e,t,r){t&&o(e.prototype,t),r&&o(e,r)}(a,null,[{key:"getAllStrategy",value:(m=i(n.mark((function t(){return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,Promise.all(l.map((function(e){return p(e).then((function(t){a.strategyMap[e]=t}))})));case 3:f("YXWXMPGetAllStrategySucceedRate",1,"全部场景的灰度策略获取成功"),wx.setStorage({key:s.STRATEGY_CACHE,data:this.strategyMap}),t.next=12;break;case 7:throw t.prev=7,t.t0=t.catch(0),g(y,"全部场景的灰度策略获取异常: [errMsg] ".concat(null===t.t0||void 0===t.t0?void 0:t.t0.message," [userInfo] ").concat(JSON.stringify(e))),f("YXWXMPGetAllStrategySucceedRate",0,"全部场景的灰度策略获取失败"),new Error("全部场景的灰度策略获取失败");case 12:case"end":return t.stop()}}),t,this,[[0,7]])}))),function(){return m.apply(this,arguments)})},{key:"getStrategyByScene",value:(v=i(n.mark((function t(r){var a;return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,p(r);case 3:a=t.sent,this.strategyMap[r]=a,f("YXWXMPGetStrategyBySceneSucceedRate",1,"场景".concat(r,"的灰度策略获取成功")),wx.setStorage({key:s.STRATEGY_CACHE,data:this.strategyMap}),t.next=14;break;case 9:throw t.prev=9,t.t0=t.catch(0),g(y,"灰度策略获取异常: [errMsg] ".concat(null===t.t0||void 0===t.t0?void 0:t.t0.message," [sceneKey] ").concat(r," [userInfo] ").concat(JSON.stringify(e))),f("YXWXMPGetStrategyBySceneSucceedRate",0,"场景".concat(r,"的灰度策略获取失败")),new Error("场景".concat(r,"的灰度策略获取失败"));case 14:case"end":return t.stop()}}),t,this,[[0,9]])}))),function(e){return v.apply(this,arguments)})},{key:"useCache",value:function(){var e;this.hasInit||(e=wx.getStorageSync(s.STRATEGY_CACHE),this.strategyMap=e||{})}},{key:"useMock",value:function(){var e,n=this,a=t||r;"development"!==a&&"dev"!==a&&"test"!==a&&"qa"!==a||(e=wx.getStorageSync(s.AB_KEYS_MAP))&&Object.keys(e).forEach((function(t){var r;n.strategyMap[t]=null===(r=n.strategyMap[t])||void 0===r?void 0:r.map((function(r){r.originExpKey||(r.originExpKey=r.expKey);var n=e[t][r.groupKey];return n?n!==r.originExpKey?(r.expKey=n,r.isMock=!0):(r.expKey=n,r.isMock=!1):r.isMock=!1,r}))}))}},{key:"init",value:(c=i(n.mark((function t(r){return n.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0===r)throw new Error("调用 init 函数需要传入配置");t.next=3;break;case 3:if("boolean"==typeof r||(p=r.requestABStrategy||p,f=r.reportTargetToCat||f,g=r.codeLogError||g,h=r.getUserInfo||h,l=r.sceneList||[]),l.length){t.next=6;break}throw new Error("请传入实验场景列表配置");case 6:return e=h()||{},t.prev=7,t.next=10,this.getAllStrategy();case 10:f("YXWXMPABTestInitSucceedRate",1,"灰度策略初始化成功，重试次数: ".concat(this.retryTimes)),this.retryTimes=0,this.hasInit=!0,t.next=25;break;case 15:if(t.prev=15,t.t0=t.catch(7),this.retryTimes<3)return this.retryTimes+=1,t.next=21,this.init(!0);t.next=23;break;case 21:t.next=25;break;case 23:g(y,"灰度策略初始化异常: [userInfo] ".concat(JSON.stringify(e))),f("YXWXMPABTestInitSucceedRate",0,"灰度策略初始化异常");case 25:case"end":return t.stop()}}),t,this,[[7,15]])}))),function(e){return c.apply(this,arguments)})},{key:"getGroupStrategy",value:function(t,r){var n=this;if(this.hasInit&&-1===l.indexOf(t))throw new Error("".concat(t,"不在初始化场景列表中"));this.useCache(),this.useMock(),this.timmer&&clearTimeout(this.timmer),this.timmer=setTimeout((function(){n.getStrategyByScene(t).catch((function(){})),n.timmer=null}),5e3);var a=null===(a=this.strategyMap[t])||void 0===a?void 0:a.filter((function(e){return e.groupKey===r}));return null!=a&&a.length?a[0]:(g(y,"场景 ".concat(t," 的灰度实验组 ").concat(r," 获取异常: [userInfo] ").concat(JSON.stringify(e))),u)}},{key:"getGrayStrategy",value:function(e,t,r){return(null==(t=this.getGroupStrategy(e,t))?void 0:t.expKey)===r}},{key:"getStrategyMap",value:function(){return this.getAllStrategy().catch((function(){})),this.useMock(),this.strategyMap}}]),a}();c(v,"hasInit",!1),c(v,"retryTimes",0),c(v,"strategyMap",{}),c(v,"timmer",void 0),exports.default=v;