Object.defineProperty(exports,"__esModule",{value:!0});var t=require("./ul.js");function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var s,i,o=null;s=null,i="FST_HORN_CACHE_KEY",(o=function(t,e,i,o){return s||(e?(s=this,this.devMode=t,this.hornConfigName="wxapp-fst-".concat(e||""),this.wxappVersion=i,void(this.uuid=o)):null)}).init=function(t,e,s,i,n){if(e){var r=new o(t,e,i,n);setTimeout((function(){r&&r.fetchHornConfig()}),Math.max(s||0,0))}},o.prototype.fetchHornConfig=function(){var t="https://portal-portm.meituan.com/horn?version=v1&os=".concat(this.devMode?"android_test":"android","&from=").concat(this.hornConfigName,"&appVersion=").concat(this.wxappVersion,"&id=").concat(this.uuid);wx.request({url:t,success:function(t){var e=((t||{}).data||{}).customer||{pages:[]},s=e.pages;if(e.offline)try{wx.removeStorage({key:i})}catch(t){}else if(s)try{wx.setStorage({key:i,data:JSON.stringify(s)})}catch(t){}}})},o.fstEnabled=function(t){try{if(!t)return!1;var e=wx.getStorageSync(i);return-1!==(JSON.parse(e)||[]).indexOf(t)}catch(t){return!1}};var n=o,r=null;!function(){var t=null,e="FST_SYSINFO_CACHE_KEY";function s(t){if(!t||t==={})return!1;var e=t&&t.windowHeight||0,s=t&&t.system;return e&&s}(r=function(e){return t||(e?(t=this,this.sysInfo=e&&e.sysInfo||{},this.isWx=!(!e||!e.isWx),this.local=e.local||!1,this.pagesEnabled=e&&e.pages||[],this.devMode=e&&e.devMode||!1,this.wxappVersion=e&&e.wxappVersion||"-",this.catKey=e&&e.catKey||"",this.uuid=e&&e.uuid||"",void(this.channel=e&&e.channel||"")):null)}).init=function(t){var e=new r(t);e&&(e.getSysInfoSync(),t.local||n.init(e.devMode,t.hornKey,t.hornRequestDelay,e.wxappVersion,e.uuid))},r.prototype.getCustomConfig=function(){return{wxappVersion:this.wxappVersion,catKey:this.catKey,devMode:this.devMode,channel:this.channel}},r.prototype.fstEnabled=function(t){return!(!t||!t.length)&&(this.local?!!this.pagesEnabled&&-1!==this.pagesEnabled.indexOf(t):n.fstEnabled(t))},r.prototype.getSysInfoSync=function(){try{if(s(this.sysInfo))return this.sysInfo;var t=wx.getStorageSync(e);if(!t||!t.length)throw Error("读取缓存为空");if(this.sysInfo=JSON.parse(t),!s(this.sysInfo))throw Error("缓存的sysInfo异常");return this.sysInfo}catch(t){return this.sysInfo={},this.cacheSysInfo(),{}}},r.prototype.cacheSysInfo=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3;if(!(t<=0))try{var s=wx&&wx.getSystemInfoSync();s||this.cacheSysInfo(t-1),wx&&wx.setStorage({key:e,data:JSON.stringify(s)})}catch(e){this.cacheSysInfo(t-1)}}}();var a,h,c=r,f={INIT:-1,NORMAL:1,COMPUTE_BY_INTERACTIVE:101,COMPUTE_ON_HIDE:102,COMPUTE_ON_UNLOAD:103,NOT_STABLE:201,ERROR_COMPUTE_FAILED:400,ERROR_CONTENT_BLANK:401,ERROR_NO_SETDATA_BEFORE_JUDGE:402,ERROR_CAUSE_OTHER_EXCEPTIONS:499},u=function(){return"undefined"!=typeof mmp},p=null,l=function(){var t=new c;return t&&t.getSysInfoSync()||{}};a=null,h=f,(p=function(t){(a=t).fstPageId=t&&t.__wxWebviewId__,this.pageRoute=t&&t.route,this.pageId=t&&t.fstPageId,this.continueFstJudge=!0,this.reported=!1;var e=l();this.viewPortHeight=e&&e.windowHeight||699,this.fst=0,this.fstStatusCode=h.INIT,this.pageStartTime=0,this.firstInteractiveTime=0,this.didSetData=!1,this.mutaRecords=[]}).getCurrentPage=function(t){return t&&a&&a.fstPageId===t?a:null},p.prototype.checkReachBottom=function(t){if(this.continueFstJudge&&this.viewPortHeight&&t)return 0!==this.viewPortHeight&&t.targetTop>this.viewPortHeight?(this.continueFstJudge=!1,this.fst=t.timestamp-this.pageStartTime,void this.setStatusCode(h.NORMAL)):void 0},p.prototype.sampling=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:wx;if(this.continueFstJudge){this.didSetData=!0;var s=(new Date).getTime(),i=e&&e.createSelectorQuery();i&&i.select(".__fst_judge_target, .fst-root >>> .__fst_judge_target").boundingClientRect(),i&&i.exec((function(e){if(e&&e[0]){var i=e[0].top,o={timestamp:s,targetTop:i};t.mutaRecords&&t.mutaRecords.push(o),t.checkReachBottom(o)}}))}},p.prototype.startRecord=function(){var t=this;this.pageStartTime=(new Date).getTime();var e=wx&&wx.createSelectorQuery();e&&e.selectViewport().boundingClientRect(),e&&e.exec((function(e){e&&e[0]&&(t.viewPortHeight=e[0].height)}))},p.prototype.stopRecord=function(){this.continueFstJudge=!1},p.prototype.shouldComputeFst=function(){return this.continueFstJudge&&0===this.fst&&this.fstStatusCode===h.INIT},p.prototype.setStatusCode=function(t){this.fstStatusCode===h.INIT&&(this.fstStatusCode=t)},p.prototype.tryComputeFst=function(t){if(this.shouldComputeFst())if(this.didSetData||this.mutaRecords&&0!==this.mutaRecords.length){var e=(new Date).getTime(),s=this.mutaRecords&&this.mutaRecords.length>0&&this.mutaRecords[this.mutaRecords.length-1],i=s&&s.targetTop||0;if(i<=0)this.setStatusCode(h.ERROR_CONTENT_BLANK);else{for(var o=s,n=this.mutaRecords&&this.mutaRecords.slice(0).reverse(),r=0;r<n.length;r++){var a=n[r];if(!a||!a.targetTop||Math.abs(a.targetTop-i)>10)break;o=a||s}var c=o&&o.timestamp||0;0!==c?e-c<100?this.setStatusCode(h.NOT_STABLE):(this.fst=c-this.pageStartTime,this.setStatusCode(t)):this.setStatusCode(h.ERROR_CAUSE_OTHER_EXCEPTIONS)}}else this.setStatusCode(h.ERROR_NO_SETDATA_BEFORE_JUDGE)},p.prototype.onUserInteractive=function(){this.firstInteractiveTime>0||(this.firstInteractiveTime=(new Date).getTime(),this.tryComputeFst(h.COMPUTE_BY_INTERACTIVE),this.stopRecord())},p.prototype.report=function(){if(!this.reported){this.reported=!0;var s,i=l(),o=(s=new c)&&s.getCustomConfig()||{}||{},n=o.catKey,r=o.channel,f=o.wxappVersion,p=o.devMode,d={catKey:n,channel:r,wxappVersion:f,page:this.pageRoute,brand:i&&i.brand,model:i&&i.model,system:i&&i.system,isMmp:u()?1:0,vh:this.viewPortHeight||-1,version:i&&i.version,sdkVersion:i&&i.SDKVersion,platform:i&&i.platform,pixelRatio:i&&i.pixelRatio,statusCode:this.fstStatusCode,fst:this.fst||0,didSetData:this.didSetData?1:0,setDataCount:this.mutaRecords&&this.mutaRecords.length||0,interactiveTime:this.firstInteractiveTime>0?this.firstInteractiveTime-this.pageStartTime:-1};if(a&&a.fstTags&&"object"===e(a.fstTags))for(var y=Object.keys(a.fstTags)||[],g=Math.min(y.length,10),R=Object.keys(d)||[],v=0;v<g;v++){var m=y[v];R.indexOf(m)>=0||(d[m]=a.fstTags[m].toString().slice(0,128))}t.owl.start({project:n,devMode:p});var _=t.owl.newMetric();_.setTags(d),this.fst&&this.fst>0?(_.setMetric("FST_MP",this.fst),_.setMetric("FST_RATE_MP",this.fst<=1e3?1:0)):this.setStatusCode(h.ERROR_COMPUTE_FAILED),_.setMetric("FST_EXCEPTION_MP",this.fstStatusCode<200?1:0),_.report(),a=null}};var d=p,y=function(t){var e=function(t){var e=new c;return!!e&&e.fstEnabled(t)};t.__fstEnable=!1,t.__fstBindCaptureTouchStart=function(){this.__fstEnable&&this.fstReport&&this.fstReport.onUserInteractive()},t.doReportFstDataThenResetFstReport=function(){this.fstReport&&this.fstReport.report(),this.fstReport=null};var s=function(){this.fstReport=new d(this),this.fstReport.startRecord();var t=this.setData;this.setData=function(e,s){var i=this;t&&t.call(this,e,(function(){try{i.fstReport&&i.fstReport.sampling(i)}catch(t){}s&&s()}))}},i=t.onLoad;t.onLoad=function(){try{this.__fstEnable=e(this.route),this.__fstEnable&&s.call(this)}catch(t){}for(var t=arguments.length,o=new Array(t),n=0;n<t;n++)o[n]=arguments[n];i&&i.call.apply(i,[this].concat(o))};var o=function(){this.fstReport&&this.fstReport.tryComputeFst(f.COMPUTE_ON_HIDE),this.fstReport&&this.fstReport.stopRecord(),this.doReportFstDataThenResetFstReport()},n=t.onHide;t.onHide=function(){try{this.__fstEnable&&o.call(this)}catch(t){}for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];n&&n.call.apply(n,[this].concat(e))};var r=function(){this.fstReport&&this.fstReport.tryComputeFst(f.COMPUTE_ON_UNLOAD),this.fstReport&&this.fstReport.stopRecord(),this.doReportFstDataThenResetFstReport()},a=t.onUnload;return t.onUnload=function(){try{this.__fstEnable&&r.call(this)}catch(t){}for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];a&&a.call.apply(a,[this].concat(e))},t},g=function(){var t=Component;Component=function(e){var s=e.lifetimes&&e.lifetimes.attached,i=e.attached,o=function(){try{return d.getCurrentPage(this.__wxWebviewId__)}catch(t){return null}},n=function(){var t=o.call(this);return t&&t.__fstEnable||!1},r=function(){var t=this.setData;this.setData=function(e,s){var i=this;t&&t.call(this,e,(function(){try{var t=o.call(i);t&&t.fstReport&&t.fstReport.sampling(t)}catch(t){}s&&s()}))}};return s?e.lifetimes.attached=function(){try{n.call(this)&&r.call(this)}catch(t){}for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];s.call.apply(s,[this].concat(e))}:e.attached=function(){try{n.call(this)&&r.call(this)}catch(t){}for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];i&&i.call(this,e)},t(e)}},R={register:function(t){if(t&&t.catKey&&t.catKey.length&&t.isWx)try{c.init(t),g()}catch(t){}},fstEnable:function(t){var e=new c;return e&&e.fstEnabled(t)}};exports.default=R,exports.page=function(t){if(!t)return t;try{t.__fstBindCaptureTouchStart=function(){};var e=new c;return e&&e.isWx?y(t):t}catch(e){return t}};