var t=Object.create,e=Object.defineProperty,i=Object.defineProperties,r=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertyNames,s=Object.getOwnPropertySymbols,n=Object.getPrototypeOf,h=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,p=(t,i,r)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[i]=r,u=(t,e)=>{for(var i in e||(e={}))h.call(e,i)&&p(t,i,e[i]);if(s)for(var i of s(e))c.call(e,i)&&p(t,i,e[i]);return t},d=t=>e(t,"__esModule",{value:!0}),l=i=>((t,i,a)=>{if(i&&"object"==typeof i||"function"==typeof i)for(let s of o(i))h.call(t,s)||"default"===s||e(t,s,{get:()=>i[s],enumerable:!(a=r(i,s))||a.enumerable});return t})(d(e(null!=i?t(n(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);((t,i)=>{for(var r in d(t),i)e(t,r,{get:i[r],enumerable:!0})})(exports,{default:()=>w});var g=l(require("./is.js")),m=l(require("./u8.js")),C=l(require("./ob.js")),T=l(require("./zj.js")),f=l(require("./xg.js")),S=l(require("./cw.js")),y=l(require("./cq.js")),v=l(require("./lg.js")),b=getApp(),w=class extends S.default{constructor(){super(),this.fromPageSource=1;const t={isEditing:!1,noticeBoardInfo:{},isLogin:!0,card:[],totalItemCounts:0,couponInfo:{},isShowCouponDetail:!1,needBottom:!1,isTabPage:!1,isWXMT:(0,m.isWXMT)(),isIpx:!1,isShowConfrimPayment:!1,canOperateCart:()=>{},operatePopupCart:()=>{},setEditing:()=>{},setShowCart:()=>{},setIsShowConfrimPayment:()=>{},getCacheId:()=>{},onCouponPopupHandle:()=>{}};Object.assign(this.data,{isSubmitCart:!0,unifiedPropagandaData:{},showUnifiedPropagandaDataPopup:!1,fontRate:1},t),this.cacheId=0,this.totalItemCounts=0,this.needResetPreview=!1,this.cartMetricsReport=new v.default,C.log.warn(`<购物车> submitCart isSubmitCart: ${this.data.isSubmitCart}, now:${Date.now()}`)}onLoad(t){var e,i;wx.hideShareMenu({}),b.$cat.reportCustomMetrics("submit_cart_on_load",g.ReportValue.SUCCESS),b._cartRenderStartTime=Date.now(),null==(e=this.cartMetricsReport)||e.resetReportSymbol(),null==(i=this.cartMetricsReport)||i.reportCartOnLoadCount(g.YXReportTarget,g.ReportValue,b.$cat,b.$version,b.$systemInfo),this.options=t,this.pageInit(this.options),b.$event.on(b.$event.CONTANTS.CLEAR_CART_PAY_NOT_SUCCESSURL,this.clearCartPayNotSuccessUrlBindThis)}checkLogin(){b.isLogin()?this.submitCartPageOnShow():(this.checkLoginBindThis=this.checkLogin.bind(this),b.$event.once(b.$event.CONTANTS.RETURN_FROM_LOGIN,this.checkLoginBindThis),b.$event.once(b.$event.CONTANTS.LOGIN_FINISH,this.checkLoginBindThis),b.$login.login())}pageInit(t){this.currentPage=b.page().route||"",this.eventBindHandle();const e="pages/cart/index"===getApp().currentRoute?"c_youxuan_d4bo5dio":"c_youxuan_jww0m38m";b.$lxLog.mv("b_youxuan_okcrh1zl_mv",{},{cid:e});const{needToastMessage:i}=t;i&&b.page().toast(decodeURIComponent(i)),this.pageLoad(t,{fetchPreview:!1})}onHide(){this.handleOffEvent(),this.lastPoi=b.$poi.getPoiIdStr()}onUnload(){this.handleOffEvent()}onShow(){this.checkLogin()}onReady(){var t;null==(t=this.cartMetricsReport)||t.reportCartOnReadyCount(g.YXReportTarget,g.ReportValue,b.$cat,b.$version,b.$systemInfo)}submitCartPageOnShow(){var t;if(C.log.info("<submitCart onShow> onShow触发了"),this._payNotSuccessUrl)return b.$router.goto(this._payNotSuccessUrl,{},{fnName:"redirectTo"}),void(this._payNotSuccessUrl=void 0);if(!this.onShowFromPay){this.needResetPreview&&this.resetOrderPreview(),this.needResetPreview=!0,this.pageFirstLoad?this.pageFirstLoad=!1:0==+this.data.orderPreview.shippingType&&this.getSelectedAddress();try{this.onCartShowBindThis&&this.loginRefreshCartBindThis&&this.refreshDataBindThis&&this.refreshCouponBindThis||(C.log.error("购物车attach事件挂载失败"),this.eventBindHandle()),this.currentPage=(null==(t=null==b?void 0:b.page())?void 0:t.route)||"",b.$event.on(b.$event.CONTANTS.CART_SHOW,this.onCartShowBindThis),b.$event.on(b.$event.CONTANTS.LOGIN_REFRESH_CART_SUCCESS,this.loginRefreshCartBindThis),b.$event.on(b.$event.CONTANTS.ITEMS_REQUEST,this.refreshDataBindThis),this.onCartShow()}catch(t){C.log.error(`购物车事件挂载失败，e：${JSON.stringify(t)}`)}}}initService(){this.service=new y.default(this)}eventBindHandle(){this.onCartShowBindThis=this.onCartShow.bind(this),this.loginRefreshCartBindThis=this.loginRefreshCart.bind(this),this.refreshDataBindThis=this.refreshData.bind(this),this.refreshCouponBindThis=this.refreshCoupon.bind(this),this.clearCartPayNotSuccessUrlBindThis=this.clearCartPayNotSuccessUrl.bind(this)}handleOffEvent(){b.$event.off(b.$event.CONTANTS.CART_SHOW,this.onCartShowBindThis),b.$event.off(b.$event.CONTANTS.LOGIN_REFRESH_CART_SUCCESS,this.loginRefreshCartBindThis),b.$event.off(b.$event.CONTANTS.ITEMS_REQUEST,this.refreshDataBindThis),b.$event.off(b.$event.CONTANTS.RETURN_FROM_LOGIN,this.checkLoginBindThis),b.$event.off(b.$event.CONTANTS.LOGIN_FINISH,this.checkLoginBindThis)}clearCartPayNotSuccessUrl(){this._payNotSuccessUrl=void 0}onCartShow(t){t&&(b.page().options.trafficSource=t.trafficSource),b.page().route||C.log.warn("[modules/cart/index] 路由信息获取失败",JSON.stringify({page:b.page(),route:b.page().route||"无"})),this.operatePopupCart();const e=(0,m.isWXMT)()&&"pages/cart/index"===b.page().route,i=b.getModule("systemInfo").getSystemInfo().isIpx&&("pages/cart/index"!==b.page().route||(0,m.isWXMT)()),r={showCart:!0,isLogin:b.isLogin(),needBottom:e,isIpx:i,canOperateCart:this.canOperateCart.bind(this),operatePopupCart:this.operatePopupCart.bind(this),onCouponPopupHandle:this.onCouponPopupHandle.bind(this),setEditing:this.setEditing.bind(this),setShowCart:this.setShowCart.bind(this),setIsShowConfrimPayment:this.setIsShowConfrimPayment.bind(this),getCacheId:this.getCacheId.bind(this)};this.data.loadCart||(r.loadCart=!0),this.setData(r)}loginRefreshCart(){clearTimeout(this.timeoutId),this.timeoutId=setTimeout(this.onCartShowBindThis,500)}refreshData(t){if(!t)return;const{cartData:e}=(0,T.mapPopupCartReqsData)(t);if(!e)return;const r=(o=u({},e),s={card:[].concat(e.card,this.data.card.filter((t=>t.type===f.CardType.RECOMMEND)))},i(o,a(s)));var o,s;const n={card:this.data.card};this.totalItemCounts=t.totalItemCounts||0,this.cacheId=t.cacheId||0;const h=(0,T.popupCartDataDiff)(r,n);this.setData(u({},h),(()=>{var t;if(b._cartRenderStartTime){const t=Date.now()-b._cartRenderStartTime;C.log.info("<cart metricsSetData> 购物车首屏渲染时间为",t),b.$lxLog.mv("b_youxuan_phboj68y_mv",{fmp:t}),delete b._cartRenderStartTime}null==(t=this.cartMetricsReport)||t.reportCartFMPCount(g.YXReportTarget,g.ReportValue,b.$cat,b.$version,b.$systemInfo,"FMPCart")})),this.refreshCoupon(t)}onCouponPopupHandle(){this.setData({isShowCouponDetail:!this.data.isShowCouponDetail})}canOperateCart(){const t=b.$poi.isExperiencePoi();return t&&b.page().showNoLocationModal(),!t}refreshCoupon(t){if(!(null==t?void 0:t.cacheId))return;const e=t.cacheId||"";let i;b.$service.queryCouponInCart(e).then((({availableCouponList:t,total:e,couponTips:r,enterLabelText:a,enterLink:o,enterLinkText:s}={availableCouponList:void 0,total:0,couponTips:[],enterLabelText:"",enterLink:"",enterLinkText:""})=>{i={VIPCouponNum:(null==t?void 0:t.total)||0,total:e||0,couponTips:r||[],enterLabelText:a||"",enterLink:o||"",enterLinkText:s||""},this.setData({totalItemCounts:this.totalItemCounts,couponInfo:i})})).catch((t=>{i={},C.log.warn("[modules/cart/index] queryCouponInCart获取券信息失败",JSON.stringify(t)),this.setData({totalItemCounts:this.totalItemCounts,couponInfo:i})}))}operatePopupCart({cartOpType:t="REFRESH",opTarget:e=null,opTargets:i=[],lxData:r={}}={}){const{orderPreview:a}=this.data;return this.service.cartReq={cartOpType:t,cartOpSource:"CART",opTarget:e||{opTargets:i},poiId:b.$poiId,shippingType:(null==a?void 0:a.shippingType)||-1,tempCartId:"",createTempCart:!1,layerRender:!1,needItems:!1},this.service.orderPreview()}setEditing(t){this.setData({isEditing:t})}setShowCart(t){this.setData({showCart:t})}setIsShowConfrimPayment(t){this.data.isShowConfrimPayment!==t&&this.setData({isShowConfrimPayment:t})}getCacheId(){return this.cacheId}resetOrderPreview(){const t=this.resetSubmitCartData();Object.assign(this.data,t)}doNotNeedResetPreview(){this.needResetPreview=!1}gotoRemark(){if(this.remarkPageRouting)return;this.remarkPageRouting=!0,setTimeout((()=>{this.remarkPageRouting=!1}),800),b.$lxLog.mc("b_youxuan_z6a235eh_mc");const{selects:t=[],otherText:e=""}=this.remarkObj[this.data.orderPreview.shippingType]||{};this.needResetPreview=!1,b.$router.goto("/subPackages/submitOrderSub/pages/remark/index",{selects:t.join(),otherText:e,nowEdit:this.data.remark||"",shippingType:this.data.orderPreview.shippingType})}};