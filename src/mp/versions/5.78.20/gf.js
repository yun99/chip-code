var e=Object.create,t=Object.defineProperty,o=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,a=Object.getOwnPropertySymbols,i=Object.getPrototypeOf,n=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,u=(e,o,r)=>o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[o]=r,s=(e,t)=>{for(var o in t||(t={}))n.call(t,o)&&u(e,o,t[o]);if(a)for(var o of a(t))l.call(t,o)&&u(e,o,t[o]);return e},c=e=>t(e,"__esModule",{value:!0}),p=a=>((e,a,i)=>{if(a&&"object"==typeof a||"function"==typeof a)for(let l of r(a))n.call(e,l)||"default"===l||t(e,l,{get:()=>a[l],enumerable:!(i=o(a,l))||i.enumerable});return e})(c(t(null!=a?e(i(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a),f=(e,t,o)=>new Promise(((r,a)=>{var i=e=>{try{l(o.next(e))}catch(e){a(e)}},n=e=>{try{l(o.throw(e))}catch(e){a(e)}},l=e=>e.done?r(e.value):Promise.resolve(e.value).then(i,n);l((o=o.apply(e,t)).next())}));((e,o)=>{for(var r in c(e),o)t(e,r,{get:o[r],enumerable:!0})})(exports,{CoreDataStatus:()=>d,fetchPoiInfos:()=>q,getPrefetchData:()=>R,toggleCity:()=>j,togglePoi:()=>M});var d,g,m=p(require("./u8.js")),y=p(require("./gs.js")),P=p(require("./ux.js")),h=p(require("./u7.js")),I=p(require("./ob.js")),v=p(require("./ug.js")),L=p(require("./ub.js")),D=p(require("./po.js")),C=p(require("./u9.js")),b=p(require("./gg.js")),T=p(require("./aw.js")),E=p(require("./gk.js")),A=p(require("./gl.js")),O=!1,U=!1,x=(0,v.buildProportion)("firstDataSource");(g=d||(d={})).prefetch="prefetch",g.manual="manual",g.prefetchButLate="prefetchButLate";var _={[d.prefetch]:"预拉取成功",[d.prefetchButLate]:"异步预拉取快于手动请求",[d.manual]:"手动请求快于预请求"},F={[d.prefetch]:b.PoiFirstTarget.PREFETCH,[d.prefetchButLate]:b.PoiFirstTarget.PREFETCH_BUT_LATE,[d.manual]:b.PoiFirstTarget.MANUAL},S=e=>{I.log.warn("[poiControler]:[CoreData]:",_[e]),x(e),(0,b.poiMainCatReport)(F[e])};function R(){if(L.default.isPrefetchDone&&!U)return S(d.prefetch),U=!0,L.default.data}function q(e,t){return f(this,null,(function*(){var o,r,a,i,n,l,u,c,p;const{location:g={latitude:0,longitude:0}}=e,x={strategy:y.PoiApiStrategy.DEFAULT};e.cityId&&(x.cityId=e.cityId),g&&g.longitude&&(x.latitude=g.latitude,x.longitude=g.longitude);const _=getApp();if((e.extPoiIdStr||+e.extPoiIds>0)&&(x.poiIdStr_poiIds="undefined"===e.extPoiIdStr?"":e.extPoiIdStr,x.poiIds=e.extPoiIds,x.strategy=y.PoiApiStrategy.EXT,x.shareUserId=e.shareUserId),(e.r||e.g)&&(e.r?x.qrCode=`r=${e.r}`:e.g&&(x.qrCode=`g=${e.g}`),x.qrCode=`${x.qrCode}`,x.strategy=y.PoiApiStrategy.QRCODE),e.sceneCode&&e.sceneCode===T.SCENE_CODE.LIVE)if((0,D.isMMP)())x.subChannel=E.SUB_CHANNEL.MEITUAN_LIVE;else{let e;x.subChannel=E.SUB_CHANNEL.WX_LIVE;try{e=yield C.default.getWxLocation({refresh:!0})}catch(e){I.log.error("[poiControler]:[CoreData]: 获取微信信息出错",e)}e&&Object.assign(x,s({},e))}if(t&&(0,m.isApp)()){const e=getApp().$store.getCacheValue("privacyAdminStatus");x.recommendSwitch=e}x.prefeth=0;const F=function(e,t){return f(this,null,(function*(){const o=t&&!(0,m.isTT)(),r=o?P.default.getLocationWithBaseInfo:P.default.getPoiInfos,a=s(s({},e),h.default.getQuery());return(0,b.poiLogger)(`getLocationWithBaseInfo：${t?"请求includelocation/location聚合":"请求lbs门店"}接口的参数为：${JSON.stringify(a)}`),r(a).then((e=>(O=!0,(0,v.tagTime)("manual"),(0,b.poiLogger)("getLocationWithBaseInfo->getLocationPoi"),o?e:{lbsLocationResult:e})))}))}(x,t);let R=null;const q=[F],M=L.default.isDebug&&"on"===(null==(o=null==_?void 0:_.getModule("env"))?void 0:o.getCache("openPrefetch"));if(L.default.isSupportPrefetch()&&!U&&!e.r&&!e.g){if(L.default.isPrefetchDone&&L.default.data&&A.default.checkPrefetchDataVaid(L.default.data))return(0,b.poiLogger)("fetchPoiInfos->$prefetchor.isPrefetchDone"),S(d.prefetch),U=!0,L.default.setPrefetchInfo("应用预拉取数据"),L.default.data;(null==(n=null==(i=null==(a=null==(r=L.default)?void 0:r.data)?void 0:a.lbsLocationResult)?void 0:i.jumpInfo)?void 0:n.type)===y.PoiResType.LOCATIOM_TAG&&(0,b.poiMainCatReport)(b.PoiFirstTarget.PREFETCH_IP);R=(()=>new Promise(((e,t)=>{L.default.getPrefetchData().then((t=>{(0,b.poiLogger)("info","catchErrorPromise getPrefetchData then"),e(s({from:"prefeth"},t))})).catch((e=>{(0,b.poiLogger)("warn","catchErrorPromise getPrefetchData 数据抛弃：",e),M&&t(e)}))})))()}let j;if(R&&q.push(R),M&&!U){const e=!1;(0,b.poiLogger)("走测试环境逻辑 forbiddenIPPrefetch = ",e),j=e?yield A.default.requstFetchData(F,R):(yield function(e){return new Promise(((t,o)=>{function r(e){return Promise.all(e.map((e=>e.then((e=>({status:"fulfilled",value:e}))).catch((e=>({status:"rejected",reason:e}))))))}r(e).then((e=>{var r;const a=getApp(),i="on"===(null==(r=null==a?void 0:a.getModule("env"))?void 0:r.getCache("applyPrefetch")),[n={},l={}]=e;return i&&"fulfilled"===l.status?(L.default.setPrefetchInfo("应用预拉取数据"),(0,b.poiLogger)("getFinalyData prefetchData",l.value),t(l.value)):"fulfilled"===n.status?(L.default.setPrefetchInfo("应用聚合接口数据"),(0,b.poiLogger)("getFinalyData aggreData",l.value),t(n.value)):(L.default.setPrefetchInfo("预拉取和聚合接口均返回失败"),(0,b.poiLogger)("getFinalyData reason",l.value),o(i?l.reason:n.reason))}))}))}(q))||{},(0,b.poiLogger)("poiAndPageBaseInfo 走测试环境逻辑 ",null==j?void 0:j.lbsLocationResult)}else(0,b.poiLogger)("走线上环境逻辑 isPreDataUsed",U),j=yield A.default.requstFetchData(F,R),(0,b.poiLogger)("poiAndPageBaseInfo 走线上环境逻辑",null==j?void 0:j.lbsLocationResult),L.default.setPrefetchInfo("prefeth"===(null==j?void 0:j.from)?"应用预拉取数据":"应用聚合接口数据");if(U){if((null==(p=null==(c=null==j?void 0:j.lbsLocationResult)?void 0:c.jumpInfo)?void 0:p.type)===y.PoiResType.LOCATIOM_TAG){const e=O?b.PoiFirstTarget.NO_FIRST_MAULE_IP:b.PoiFirstTarget.NO_FIRST_PREFETCH_IP;(0,b.poiMainCatReport)(e)}}else if(S(O?d.manual:d.prefetchButLate),(null==(u=null==(l=null==j?void 0:j.lbsLocationResult)?void 0:l.jumpInfo)?void 0:u.type)===y.PoiResType.LOCATIOM_TAG){const e=O?b.PoiFirstTarget.MAULE_IP:b.PoiFirstTarget.PREFETCH_IP;(0,b.poiMainCatReport)(e)}return U=!0,j}))}function M(e={}){const t=s({strategy:y.PoiApiStrategy.TOGGLE},e);return(0,b.poiLogger)(`togglePoi->getPoiInfos 参数：${JSON.stringify(t)}`),P.default.getPoiInfos(t).then((e=>e))}function j(e={}){const t=s({strategy:y.PoiApiStrategy.DEFAULT},e);return P.default.getPoiInfos(t).then((e=>e))}