var t=Object.create,e=Object.defineProperty,a=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,o=Object.getOwnPropertySymbols,n=Object.getPrototypeOf,r=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,l=(t,a,i)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i,u=(t,e)=>{for(var a in e||(e={}))r.call(e,a)&&l(t,a,e[a]);if(o)for(var a of o(e))s.call(e,a)&&l(t,a,e[a]);return t},h=t=>e(t,"__esModule",{value:!0}),p=o=>((t,o,n)=>{if(o&&"object"==typeof o||"function"==typeof o)for(let s of i(o))r.call(t,s)||"default"===s||e(t,s,{get:()=>o[s],enumerable:!(n=a(o,s))||n.enumerable});return t})(h(e(null!=o?t(n(o)):{},"default",o&&o.__esModule&&"default"in o?{get:()=>o.default,enumerable:!0}:{value:o,enumerable:!0})),o);((t,a)=>{for(var i in h(t),a)e(t,i,{get:a[i],enumerable:!0})})(exports,{default:()=>U});var c=p(require("./gp.js")),O=p(require("./ao.js")),A=p(require("./ob.js")),T=p(require("./go.js")),g=p(require("./u8.js")),m=p(require("./a2.js")),D=p(require("./is.js")),d=p(require("./pa.js")),y=p(require("./u4.js")),{locationWxApi:S,isFirstGetLocationAuth:_,getLocationAuthStatus:f,cacheGetLocation:I}=require("./sr.js"),L={[T.LOCATION_AUTH_STATUS.AGGREE]:()=>{},[T.LOCATION_AUTH_STATUS.DENY]:()=>{}},U=new class{constructor(){this.count=0,this.errorCount=0,this.firstGetLocationPromise=null,this.authDialogOperationSwitch=!1,this.authDialogOperationStrategy="",this.hasHandledDialogOperation=!1,this.switchOfMIIT=!0,this.authDialogOperationFnMap=L}get app(){return getApp()}get isStrategyOfMIIT(){var t,e;return _()&&"pages/index/index"===(null==(e=null==(t=this.app)?void 0:t.page())?void 0:e.route)&&this.switchOfMIIT}get authDialogOperationEnable(){var t,e;return!(!this.authDialogOperationSwitch||this.hasHandledDialogOperation||"pages/index/index"!==(null==(e=null==(t=this.app)?void 0:t.page())?void 0:e.route))}setAuthDialogOperationSwitch(t=!1){A.log.info(t?"打开定位授权弹框操作开关":"关闭定位授权弹框操作开关"),this.authDialogOperationSwitch=t}setAuthDialogOperationStrategy(t=T.AUTH_DIALOG_OPERATION_STRATEGY.DEFAULT,e=L){A.log.info("设置授权弹框操作处理策略：",t),this.authDialogOperationStrategy=t,this.authDialogOperationFnMap=u(u({},this.authDialogOperationFnMap),e);try{const{SDKVersion:e,system:a}=this.app.$systemInfo.getSystemInfo();this.app.$cat.reportCustomMetrics(D.YXReportTarget.ADDRESS_STRATEGY,D.ReportValue.SUCCESS,{name:t,pageUrl:this.app.page().route,SDKVersion:e,systemType:0===a.toLowerCase().indexOf("ios")?"ios":"android"})}catch(t){}}getLocation(t,e){return a=this,i=null,o=function*(){try{const a=yield _();if(this.isStrategyOfMIIT&&a)return{};this.count++,a&&!this.firstGetLocationPromise&&(this.firstGetLocationPromise=t(e));const i=this.firstGetLocationPromise?this.firstGetLocationPromise:t(e),o=yield i;return this.handleAuthDialogOperation(T.LOCATION_AUTH_STATUS.AGGREE,o),o}catch(t){this.errorCount++;const{type:e=""}=t;throw e===O.PoiLocationErrorType.LOCATION_ACCESS_INVALID_WX_MP&&this.handleAuthDialogOperation(T.LOCATION_AUTH_STATUS.DENY),t}finally{this.firstGetLocationPromise=null}},new Promise(((t,e)=>{var n=t=>{try{s(o.next(t))}catch(t){e(t)}},r=t=>{try{s(o.throw(t))}catch(t){e(t)}},s=e=>e.done?t(e.value):Promise.resolve(e.value).then(n,r);s((o=o.apply(a,i)).next())}));var a,i,o}handleNotAuthLocation(){return y.default.emit(d.ADDRESS_AUTH_DIALOG_SHOW),this.getLocation(S,"gcj02").then((t=>{const{longitude:e="",latitude:a=""}=t||{},i={longitude:e,latitude:a};this.app.$location=i,m.default.$location=i,y.default.emit(d.ADDRESS_AUTH_DIALOG_CLOSE)})).catch((()=>{y.default.emit(d.ADDRESS_AUTH_DIALOG_CLOSE)}))}handleAuthDialogOperation(t,e={}){if(A.log.info("address handleAuthDialogOperation, operationType:",t,", authDialogOperationEnable:",this.authDialogOperationEnable),this.authDialogOperationEnable)switch(t){case T.LOCATION_AUTH_STATUS.DENY:this.handleDenyAuthLocation();break;case T.LOCATION_AUTH_STATUS.AGGREE:this.handleAggreeAuthLocation(e);break;default:this.handleNotAuthLocation()}}handleAggreeAuthLocation(t){this.hasHandledDialogOperation=!0;const e=this.authDialogOperationStrategy===T.AUTH_DIALOG_OPERATION_STRATEGY.POI_CONFIRMED_BY_IP,a=this.authDialogOperationStrategy===T.AUTH_DIALOG_OPERATION_STRATEGY.MIIT,i=t&&t.longitude;A.log.info("同意定位授权，执行策略：",e,a,i),e&&i?this.authDialogOperationFnMap[T.LOCATION_AUTH_STATUS.AGGREE](t):!e||i?a&&c.default.jumpOtherSelfPick({showCityListView:!1},!1):this.authDialogOperationFnMap[T.LOCATION_AUTH_STATUS.DENY]()}handleDenyAuthLocation(){this.hasHandledDialogOperation=!0,A.log.info("拒绝定位授权，执行策略：",this.authDialogOperationStrategy);if(this.authDialogOperationStrategy===T.AUTH_DIALOG_OPERATION_STRATEGY.MIIT)return void c.default.jumpOtherSelfPick({showCityListView:!0});const t=this.authDialogOperationStrategy===T.AUTH_DIALOG_OPERATION_STRATEGY.POI_CONFIRMED_BY_IP;return f().then((e=>{t&&e===T.LOCATION_AUTH_STATUS.AGGREE&&(this.authDialogOperationFnMap[T.LOCATION_AUTH_STATUS.DENY](),c.default.jumpOtherSelfPick({showCityListView:!1},!1)),t&&e!==T.LOCATION_AUTH_STATUS.AGGREE&&this.authDialogOperationFnMap[T.LOCATION_AUTH_STATUS.DENY]()}))}handleLocationAuthOperation(){return f().then((t=>{t!==T.LOCATION_AUTH_STATUS.DENY||(0,g.isInWX)()&&(0,g.isTT)()||(t=T.LOCATION_AUTH_STATUS.DEFAULT),this.switchOfMIIT=!1,setTimeout((()=>{this.handleAuthDialogOperation(t)}),200)}))}};