var e=Object.create,t=Object.defineProperty,o=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,n=Object.getPrototypeOf,i=Object.prototype.hasOwnProperty,s=s=>{return((e,n,s)=>{if(n&&"object"==typeof n||"function"==typeof n)for(let a of r(n))i.call(e,a)||"default"===a||t(e,a,{get:()=>n[a],enumerable:!(s=o(n,a))||s.enumerable});return e})((a=t(null!=s?e(n(s)):{},"default",s&&s.__esModule&&"default"in s?{get:()=>s.default,enumerable:!0}:{value:s,enumerable:!0}),t(a,"__esModule",{value:!0})),s);var a},a=(e,t,o)=>new Promise(((r,n)=>{var i=e=>{try{a(o.next(e))}catch(e){n(e)}},s=e=>{try{a(o.throw(e))}catch(e){n(e)}},a=e=>e.done?r(e.value):Promise.resolve(e.value).then(i,s);a((o=o.apply(e,t)).next())})),u=s(require("./u8.js")),c=s(require("./ob.js")),l=s(require("./is.js")),p=s(require("./ao.js")),y=s(require("./sw.js")),m=s(require("./go.js")),{DefaultQueryString:g}=require("./u2.js"),d=["denied","auth denied","无定位权限","未能完成操作","auth deny","authorize no response","User is not authorized","auth canceled"],T=["system permission denied","system permission has been denied","System location permissions denied"];function A(e,t){const o=t||{};return new Promise(((t,r)=>{o.success=t,o.fail=r,e(o)}))}var L,_,O=(0,y.getResFromRecently)((()=>a(void 0,null,(function*(){try{return yield A(wx.getSetting)}catch(e){throw c.log.error("getSetting调用报错：",e),e}}))),{refresh:!1,tag:"getSetting",expire:4e4}),f=()=>a(void 0,null,(function*(){let e;try{e=yield O();const t=e.authSetting["scope.userLocation"];return void 0===t?m.LOCATION_AUTH_STATUS.DEFAULT:!0===t?m.LOCATION_AUTH_STATUS.AGGREE:m.LOCATION_AUTH_STATUS.DENY}catch(e){throw(0,p.getLocationErrorWithType)(p.PoiLocationErrorType.LOCATION_AUTH_ERROR_WX_SETTING)}})),S=()=>a(void 0,null,(function*(){if(!getApp())return null;const e=getApp().$env,t=e.getDebug(),o=e.getMockLocation();return t&&o&&o.longitude?o:null}));var h,v=(...e)=>a(void 0,[...e],(function*(e="gcj02",t=3e4,o=3600,r=!0){let n=null;return new Promise(((i,s)=>a(void 0,null,(function*(){let y=null;const O=yield S();if(O)return c.log.warn("getLocationOverTime：返回mock的经纬度信息","*".repeat(20),O),void i(O);r&&(n=setTimeout((()=>{const e=getApp().$store.getCacheValue("realTimeLocation");y&&y.longitude||e&&e.longitude?(c.log.warn(`getLocationOverTime：超过${t/1e3}s，自动resolve，数据来自：${y?"api":"缓存"}`),i(y||e)):(c.log.warn(`getLocationOverTime：超过${t/1e3}s没返回，自动reject`),s((0,p.getLocationErrorWithType)(p.PoiLocationErrorType.LOCATION_ACCESS_API_TIMEOUT))),clearTimeout(n)}),t));const h=yield f();if(c.log.warn("[Location]:[Api]:","!".repeat(40),"定位授权状态是：",h),h===m.LOCATION_AUTH_STATUS.DENY&&(0,u.isInWX)())s((0,p.getLocationErrorWithType)(p.PoiLocationErrorType.LOCATION_ACCESS_INVALID_WX_MP));else try{y=(0,u.isWX)()?yield function(e){return a(this,null,(function*(){let t;try{t=void 0===(yield A(wx.getSetting)).authSetting["scope.userLocation"]&&!L}catch(e){}const o=getApp();try{if(t){o.$lxLog.mv("b_youxuan_qd2u8cij_mv"),L=!0;const{SDKVersion:e,system:t}=o.$systemInfo.getSystemInfo();o.$cat.reportCustomMetrics(l.YXReportTarget.ADDRESS_AUTH_DIALOG_MV,l.ReportValue.SUCCESS,{pageUrl:o.page().route,SDKVersion:e,systemType:0===t.toLowerCase().indexOf("ios")?"ios":"android",utmMedium:g&&g.utm_medium||""})}const r=yield e;return L&&!_&&(o.$lxLog.mc("b_youxuan_vft82avu_mc"),_=!0),r}catch(e){throw L&&!_&&(o.$lxLog.mc("b_youxuan_l380w3ck_mc"),_=!0),e}}))}(A(wx.getLocation,{type:e})):yield A(wx.getLocation,{type:e}),i(y),r&&getApp().$store.setCache("realTimeLocation",y,{expires:o})}catch(e){c.log.warn("getLocationOverTime：",e);const t=null==e?void 0:e.errMsg;let o=p.PoiLocationErrorType.LOCATION_ACCESS_API_ERROR_WX_LOCATION;t&&(T.find((e=>-1!==t.indexOf(e)))?(o=p.PoiLocationErrorType.LOCATION_AUTH_INVALID_WX,"failure"===e["mmp.status"]&&(0,u.isMMP)()&&(o=p.PoiLocationErrorType.LOCATION_ACCESS_INVALID_MT,(0,u.isApp)()&&(o=p.PoiLocationErrorType.LOCATION_ACCESS_INVALID_YX))):d.find((e=>-1!==t.indexOf(e)))&&(o=p.PoiLocationErrorType.LOCATION_ACCESS_INVALID_WX_MP),s((0,p.getLocationErrorWithType)(o))),s(e)}}))))})),E=(...e)=>a(void 0,[...e],(function*(e="gcj02",t=3e4,o=3600,r=!1){const n=`locationWxApi，从微信获取定位: ${"-".repeat(20)}`;try{if(h){if((0,u.isApp)())throw new Error("独立App:用户已经拒绝过一次授权请求了，这里直接失败，不再请求授权了");return c.log.error("deniedError失败：",h,"2s后重试"),setTimeout((()=>a(void 0,null,(function*(){h="",A(wx.getLocation,{type:e})}))),2e3),null}const i=yield v(e,t,o,r);return c.log.warn(`${n}成功，`,i),i}catch(e){throw c.log.warn(`${n}失败，`,null==e?void 0:e.type,e),e instanceof p.PoiLocationError&&(0,u.isApp)()&&(h=e.message),e}})),C=(0,y.getResFromRecently)(E,{refresh:!1,tag:"getLocation",expire:3e4});module.exports={locationWxApi:E,getLocationOverTime:v,getMockLocation:S,resetDeniedError:()=>{(0,u.isApp)()&&(h=void 0)},getLocationAuth:()=>a(void 0,null,(function*(){return(yield f())===m.LOCATION_AUTH_STATUS.AGGREE})),getLocationAuthStatus:f,isFirstGetLocationAuth:()=>a(void 0,null,(function*(){return(yield f())===m.LOCATION_AUTH_STATUS.DEFAULT})),cacheGetSetting:O,cacheGetLocation:C};