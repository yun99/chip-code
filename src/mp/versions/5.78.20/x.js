var e=Object.create,t=Object.defineProperty,o=Object.getOwnPropertyDescriptor,i=Object.getOwnPropertyNames,r=Object.getOwnPropertySymbols,n=Object.getPrototypeOf,s=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,l=(e,o,i)=>o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[o]=i,c=(e,t)=>{for(var o in t||(t={}))s.call(t,o)&&l(e,o,t[o]);if(r)for(var o of r(t))a.call(t,o)&&l(e,o,t[o]);return e},d=r=>{return((e,r,n)=>{if(r&&"object"==typeof r||"function"==typeof r)for(let a of i(r))s.call(e,a)||"default"===a||t(e,a,{get:()=>r[a],enumerable:!(n=o(r,a))||n.enumerable});return e})((a=t(null!=r?e(n(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0}),t(a,"__esModule",{value:!0})),r);var a},u=(e,t,o)=>new Promise(((i,r)=>{var n=e=>{try{a(o.next(e))}catch(e){r(e)}},s=e=>{try{a(o.throw(e))}catch(e){r(e)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(n,s);a((o=o.apply(e,t)).next())})),p=d(require("./jc.js")),m=d(require("./gp.js")),h=d(require("./ob.js")),g=d(require("./iy.js")),y=d(require("./ao.js")),P=d(require("./u8.js")),_=d(require("./gd.js")),f=d(require("./u9.js")),{wx2promiseify:T}=require("./gi.js"),L=getApp(),I="[POI]:[extPoiInfo]:[MultiPoiModal]:";(0,p.defineComponent)({propTypes:null,properties:{route:{type:String,value:"pages/index/index"}},data:{selectedPoiId:L.$poiId?L.$poiId:null,selectedPoiIdStr:L.$poiIdStr?L.$poiIdStr:"",poiList:[],show:!1,shareUserWXName:"",isTwoButtonStyle:!1,route:"",showInner:!1,title:"请重新选择自提点",leftTxt:"选择其他自提点",rightTxt:"确认选择",middleTxt:"选择其他自提点",leftUrl:"/subPackages/location/pages/selfPickSelect/index",message:"",innerTitle:"",innerMessage:"",innerLeftUrl:"/subPackages/location/pages/selfPickSelect/index?fromTo=请手动搜索或新增收货地址",innerLeftTxt:"手动输入地址",innerRightTxt:"重新刷新",innerCanClose:!1,needToHomePage:!1,showIPPOIModal:!1,recommondPoiModalData:null,innerErrorCode:"",coldStorage:[]},attached(){h.log.warn(I,"组件attached，监听事件",this.data.route)},detached(){h.log.debug(I,"组件detached了，解除事件监听")},methods:{selectPoi(e){const{item:t}=e.currentTarget.dataset,{poiBusinessStatus:o=1}=t||{};if(h.log.warn(I,"用户切换选择的门店，选中的是：",t),L.$lxLog.mc("b_youxuan_itfotha9_mc",{click_poiid:t.poiId,poi_list:this.poiIdListStr}),2===o)return;this.selectedPoi=t;const i=t.poiId,r=t.poiIdStr;this.setData({selectedPoiId:i,selectedPoiIdStr:r})},catchTouchMove(){},showMultiPoisModal(e={commonPoiInfos:[],targetPoiInfo:null,shareUserWXName:"",recommendTag:"",recommendTitle:"",modalType:""}){var t,o;const{commonPoiInfos:i=[],targetPoiInfo:r=null,shareUserWXName:n="",recommendTag:s="",recommendTitle:a="",modalType:l=""}=e;this.isSharePoiValid=r&&1===r.poiBusinessStatus,this.isRecommendPoiValid=i&&i.length>0;let c,d=this.isSharePoiValid?a||"请选择您方便取货的自提点":"当前自提点打烊啦，换一个下单吧";if(r){const e="好友分享";r.tagTxt=1===r.poiBusinessStatus?r.tagTxt=e:r.poiBusinessTag||"暂停营业"}this.isSharePoiValid?(this.selectedPoi=r,this.isRecommendPoiValid&&(i[0].tagTxt=s||"上次下单"),c=!0):!this.isSharePoiValid&&this.isRecommendPoiValid?(a&&(d=a),this.leftTxt="查看更多自提点",i[0].tagTxt=s||"为您推荐",[this.selectedPoi]=i,c=!0):(d="请重新选择自提点",a&&(d=a),this.selectedPoi=null,c=!1),h.log.warn(I,"首页弹窗日志：",{commonPoiInfos:i,targetPoiInfo:r,shareUserWXName:n});const u=(r?[r]:[]).concat(i);this.poiIdListStr=u&&u.map((e=>e.poiId)).toString()||"";const p={click_poiid:(null==r?void 0:r.poiId)||"",poiIdStr_click_poiid:(null==r?void 0:r.poiIdStr)||"",poi_list:this.poiIdListStr};"historyPoiOff"===l?L.$lxLog.mv("b_youxuan_gnwtb9iq_mv",{poi_list:this.poiIdListStr,toast_type:i.length>0?1:0}):this.isSharePoiValid?L.$lxLog.mv("b_youxuan_wzd4msb1_mv",p):c?L.$lxLog.mv("b_youxuan_hne4awl9_mv",p):r&&L.$lxLog.mv("b_youxuan_eirhl5m7_mv",p),this.setData({show:!!u.length,title:d,poiList:u,isTwoButtonStyle:c,selectedPoiId:(null==(t=this.selectedPoi)?void 0:t.poiId)||null,selectedPoiIdStr:`${(null==(o=this.selectedPoi)?void 0:o.poiIdStr)||""}`,isSharePoiValid:this.isSharePoiValid,rightTxt:this.isSharePoiValid?"确认选择":"确认",leftTxt:this.leftTxt},(()=>{this.calcPoiListDistance(u)})),this.disposeColdStorage(u)},calcPoiListDistance(e){return u(this,null,(function*(){if(!e||!e.length)return;const t=yield f.default.getWxLocation({refresh:!0});if(t){const{distanceVOS:o=[]}=yield L.$service.calculateDistance({targetPoints:e.map((e=>({latitude:e.latitude,longitude:e.longitude}))),userLocation:c({},t)}),i=o.reduce(((e,t,o)=>(e[`poiList[${o}].distanceText`]=e[`poiList[${o}].distanceText`]||t.distanceText,e)),{});this.setData(i)}else h.log.warn(I,"外部弹窗时没有获取到用户地理位置")}))},onModalButtonClick(e){const{action:t,url:o=""}=e.currentTarget.dataset;switch(h.log.info(I,`弹框点击 点击的是：${t}按钮`),g.default.hasConfirmed()&&this.setData({show:!1}),t){case"middle":L.$lxLog.mc("b_youxuan_l3822i8v_mc");break;case"left":L.$lxLog.mc(this.isSharePoiValid?"b_youxuan_64uti7j3_mc":"b_youxuan_t2yqa7v4_mc");break;case"right":L.$lxLog.mc(this.isSharePoiValid?"b_youxuan_phbosm5i_mc":"b_youxuan_6nzlya55_mc",{click_poiid:this.selectedPoi.poiId||"",poiIdStr_click_poiid:this.selectedPoi.poiIdStr||""})}if("left"!==t&&"middle"!==t)return h.log.warn(I,"此时外部手动close弹框，门店切换，确认门店"),g.default.togglePoiByPoi(this.selectedPoi);h.log.warn(I,"此时外部手动close弹框，打开门店选择页"),L.$router.goto(`${o}`)},showInnerPoiModal(e){let{code:t,error:o={}}=e;const i=getApp().page();if(!(0,_.default)(this.data.route)){if(o&&o.errMsg&&o.errMsg.startsWith("request:fail")){t=y.PoiLocationErrorType.CONTAINER_REQUEST_FAIL;const e=(0,y.getLocationErrorWithType)(t);o.message=`网络请求超时，请重试 ${e}`}if(o&&o.message&&getApp()&&(getApp().$poiId||getApp().$poiIdStr))i&&i.toast(o.message);else if(t)switch(t){case y.PoiLocationErrorType.ANTI_ERROR:case y.PoiLocationErrorType.ANTI_ERROR_420:this.showErrorPage("forbidden",t);break;case y.PoiLocationErrorType.CONTAINER_REQUEST_FAIL:case y.PoiLocationErrorType.HTTP_ERROR:this.showErrorPage("no_network",t);break;case y.PoiLocationErrorType.BACK_END_API_FAIL:case y.PoiLocationErrorType.BACK_END_EMPTY_RESPONSE:case y.PoiLocationErrorType.BACK_END_ERROR:case y.PoiLocationErrorType.OTHER:case y.PoiLocationErrorType.LOCATION_ACCESS_INVALID_MT_TIMEOUT:this.handleError((0,y.getLocationErrorWithType)(t));break;default:this.handleError()}else this.handleError()}},showErrorPage(e="no_network",t){var o,i,r,n,s,a,l,c;const d=(0,y.getLocationErrorWithType)(t);"server_error"===(null==(n=null==(r=null==(i=null==(o=getApp())?void 0:o.page())?void 0:i.selectComponent("#base_error"))?void 0:r.__data__)?void 0:n.type)&&(null==(a=null==(s=getApp())?void 0:s.page())||a.error(!1)),(null==(c=null==(l=getApp())?void 0:l.page())?void 0:c.showError)&&getApp().page().showError(e,null==d?void 0:d.errorCode)},closeInnerPoiModal(){this.setData({showInner:!1,show:!1})},showIPPoiModal(e){L.$lxLog.mv("b_youxuan_7azixjcq_mv"),this.setData({showIPPOIModal:!0,recommondPoiModalData:e})},handleError(e){return u(this,null,(function*(){if(h.log.error(I,"定位失败",JSON.stringify(e),null==e?void 0:e.desc),e)this.showLocationErrorBluredView(e,!1);else try{const{errorType:e,mmpAccessInvalid:t}=yield this.getLocationAccess();this.showLocationErrorBluredView(e,t)}catch(e){h.log.error(I,"获取定位权限异常",e)}}))},getLocationAccess(){return u(this,null,(function*(){let e;try{let t;if((yield T(wx.getSetting)).authSetting["scope.userLocation"]){t=!1;const o=(0,P.isMMP)()?y.PoiLocationErrorType.LOCATION_ACCESS_INVALID_MT:y.PoiLocationErrorType.LOCATION_ACCESS_INVALID_WX_MP;e=(0,y.getLocationErrorWithType)(o)}else t=!0,e=(0,y.getLocationErrorWithType)(y.PoiLocationErrorType.LOCATION_ACCESS_INVALID_WX_MP);return Promise.resolve({errorType:e,mmpAccessInvalid:t})}catch(t){return e=(0,y.getLocationErrorWithType)(y.PoiLocationErrorType.LOCATION_ACCESS_API_ERROR_WX_LOCATION),Promise.resolve({errorType:e,mmpAccessInvalid:!1})}}))},showLocationErrorBluredView(e,t){const{title:o,message:i,btnLeft:r,btnRight:n,modalType:s,needToHomePage:a=!0,isHideLeftBtn:l=!1,errorCode:c=""}=e,d=t?1:2,u=t?"openSetting":"confirm",p="showNoLocationModal"===s;L.$lxLog.mv("b_youxuan_rp1o5n2z_mv",{toast_type:d}),this.setData({showInner:!0,innerTitle:o,innerMessage:i,innerLeftTxt:r,innerRightTxt:n,innerOpenType:u,innerStatus:d,innerCanClose:p,needToHomePage:a,isHideLeftBtn:l,innerErrorCode:c&&L.$errorCode.getCode({code:c})||""})},showNoLocationModal(e){return u(this,null,(function*(){const t=(0,y.getLocationErrorWithType)(y.PoiLocationErrorType.POI_SAMPLE_ROOM),{name:o,type:i,desc:r,title:n,message:s,btnLeft:a,btnRight:l}=t,{refreshPoi:c,needToHomePage:d,from:p}=e;let m=!1;try{m=!!(yield T(wx.getSetting)).authSetting["scope.userLocation"]}catch(e){}return this.showLocationErrorBluredView({name:o,type:i,errorCode:"",desc:r,title:n,message:s,btnLeft:a,btnRight:l,modalType:"showNoLocationModal",needToHomePage:d,isHideLeftBtn:m},!0),L.$lxLog.mv("b_youxuan_avpmvle6_mv"),new Promise(((e,t)=>{this.toSelfPickSelectFn=t=>{e(t)},this.toOpenSettingFn=t=>u(this,null,(function*(){if(d&&(null==t?void 0:t.result["scope.userLocation"]))return wx.reLaunch({url:"/pages/index/index?from=showNoLocationModal"}),void e({type:"openSetting",result:{}});!1!==c&&(null==t?void 0:t.result["scope.userLocation"])&&(yield g.default.execPoi()),e(t)}))}))}))},closeNoLocationModal(){this.data.showInner&&this.setData({showInner:!1,innerCanClose:!1,needToHomePage:!1})},onInnerModalButtonClick(e){return u(this,null,(function*(){const{action:t,url:o="",status:i,text:r}=e.currentTarget.dataset;h.log.warn(I,`门店内部弹框点击 点击的是：${t}按钮`);const n=getApp();if("cancel"===t){let e=!1;if(this.toSelfPickSelectFn){n.$lxLog.mc("b_youxuan_jzwvigqq_mc"),this.toSelfPickSelectFn({type:"selfPickSelect",result:null}),this.setData({showInner:!1});return e=!(yield f.default.getLocationAuth()),void m.default.jumpOtherSelfPick({fromTo:"请手动搜索或新增收货地址",from:this.data.needToHomePage?"needToHome":"default",showCityListView:e})}n.$router.goto("igrocery://www.grocery.com/location/self_pick_select",{fromTo:"请手动搜索或新增收货地址",from:this.data.needToHomePage?"needToHome":"default"})}if("confirm"===t&&(n.$lxLog.mc("b_youxuan_fri50upr_mc",{button_name:r,toast_type:i}),this.setData({showInner:!1}),g.default.execPoi()),"openSetting"===t){n.$lxLog.mc("b_youxuan_fri50upr_mc",{button_name:r,toast_type:i}),this.toOpenSettingFn&&(this.setData({showInner:!1}),n.$lxLog.mc("b_youxuan_mkmhdblq_mc"));const e=yield T(wx.openSetting);h.log.warn("获取用户授权信息",e.authSetting),this.toOpenSettingFn&&this.toOpenSettingFn({type:"openSetting",result:e.authSetting})}}))},closeIPModalButton(){this.setData({showIPPOIModal:!1})},onIPModalButtonClick(e){return u(this,null,(function*(){const{poi:t}=e.target.dataset||{};L.$lxLog.mc("b_youxuan_c6qx2l4i_mc");try{yield g.default.togglePoiByPoi({poiId:t.poiId,poiIdStr:t.poiIdStr||""}),this.closeIPModalButton(),g.default.poiByIPConfirmd()}catch(e){g.default.poiByIPConfirmd()}}))},disposeColdStorage(e){var t;const o=null==(t=e.poiLabelsV2)?void 0:t.filter((e=>3===e.labelAttr));this.setData({coldStorage:o})}}});