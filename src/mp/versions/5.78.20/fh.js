var e=Object.create,t=Object.defineProperty,r=Object.getOwnPropertyDescriptor,o=Object.getOwnPropertyNames,i=Object.getPrototypeOf,n=Object.prototype.hasOwnProperty,s=e=>t(e,"__esModule",{value:!0}),a=a=>((e,i,s)=>{if(i&&"object"==typeof i||"function"==typeof i)for(let a of o(i))n.call(e,a)||"default"===a||t(e,a,{get:()=>i[a],enumerable:!(s=r(i,a))||s.enumerable});return e})(s(t(null!=a?e(i(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a),u=(e,r,o)=>(((e,r,o)=>{r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[r]=o})(e,"symbol"!=typeof r?r+"":r,o),o),l=(e,t,r)=>new Promise(((o,i)=>{var n=e=>{try{a(r.next(e))}catch(e){i(e)}},s=e=>{try{a(r.throw(e))}catch(e){i(e)}},a=e=>e.done?o(e.value):Promise.resolve(e.value).then(n,s);a((r=r.apply(e,t)).next())}));((e,r)=>{for(var o in s(e),r)t(e,o,{get:r[o],enumerable:!0})})(exports,{default:()=>w});var g=a(require("./ob.js")),c=a(require("./kw.js")),p=a(require("./p0.js")),m=a(require("./c0.js")),d=a(require("./iu.js")),y=a(require("./is.js")),h=a(require("./sq.js")),f=a(require("./vw.js")),b=a(require("./u8.js")),R=require("./p3.js"),{UriRequest:O}=require("./vq.js"),{ProxyActivity:M}=require("./ve.js"),{subscribeAll:T}=require("./sz.js"),U=[],w=class extends c.default{constructor(e,t){super(e,t),u(this,"fetchDemotionCogfig",(()=>{getApp().$service.getRouteDegradeConfig().then((e=>{e&&(this.demotionCogfig=e)})).catch((e=>{g.log.warn("[ROUTER] fetchDemotionCogfig  error",e)}))})),this.loginModule=t.getModule("login"),this.catModule=t.getModule("cat"),this.proxyActivity=new M(this),this.currentRouterInfo={url:null},this.demotionCogfig=null,this.memoryWarning={isAppear:0,currentPagesRoute:[]},(0,m.default)(this),this.onMemoryWarning(),this.debounceTimer=null,this.immediately=!0}static register(e){const t=new w("router",e);return e.addModule(t),t}getDemotionCogfig(){return this.demotionCogfig}getMemoryWarning(){return this.memoryWarning}setMemoryWarning(e,t={}){try{const{currentPagesRoute:r="",page:o}=this.catModule.getCurrentPagesRoute()||{};if(this.memoryWarning={isAppear:e,currentPagesRoute:r},e){const{networkType:e,prePagePath:r,entryPagePath:i,platform:n,SCENE:s,wxappVersion:a,systemInfo:u}=this.catModule.getReportInfo()||{},l=getCurrentPages&&getCurrentPages()||[];this.catModule.reportCustomMetrics(y.YXReportTarget.MEMORY_WARN,(null==t?void 0:t.level)||0,{networkType:e,pageUrl:null==o?void 0:o.route,prePagePath:r,entryPagePath:i,platform:n,SCENE:s,wxappVersion:a,system:u.system,version:u.version,SDKVersion:u.SDKVersion,brand:u.brand,pagesLen:l.length||0,historyPageLen:U.length+1,pages:l.map((e=>e.route)).join(",")})}g.log.warn("[Metric][Router]：",e,e?"出现内存不足告警":"恢复内存情况",t,this.memoryWarning)}catch(r){g.log.warn("[Metric][Router]：error",r,e,e?"出现内存不足告警":"恢复内存情况",t,this.memoryWarning)}}onMemoryWarning(){wx.onMemoryWarning((e=>{this.setMemoryWarning(1,e)}))}needDebounce(e,t=100){if(this.debounceTimer&&(clearTimeout(this.debounceTimer),this.immediately=!1),this.debounceTimer=setTimeout((()=>{this.immediately=!0,this.debounceTimer=null}),t),!this.immediately){g.log.warn("[ROUTER] needDebounce immediately",e);return getApp().$cat.reportCustomMetrics(y.YXReportTarget.ROUTER_GOTO,y.ReportValue.FAILED,{url:e,msg:"ROUTER needDebounce immediately true"}),!0}return!1}handleForceLogin(e,t,r){const o=!t.includes("noHandTouch");if((0,b.isUnforcedLoginApp)()&&o){const t=null==e?void 0:e.page();if(t&&"1-3"!==t.mtsiTag)return;const o=t&&t.__route__;["pages/index/index"].includes(o)&&(g.log.info("[Metric][Router]：",`sourcePage:${o}`,`sourcePage:${JSON.stringify(r)}`),Object.assign(r,{skipLoginMiddlePage:1,need_login:1}))}}goto(e){return l(this,arguments,(function*(e,t={},{fnName:r=null}={},o=100){U.push(e);const i=getApp();let n={};const s=`${e}`;try{t||(t={}),this.handleForceLogin(i,s,t),Object.keys(t).length&&("1"===t.need_preload&&t.preloadData&&(n=t.preloadData,delete t.preloadData),e.indexOf("?")>-1?e+=`&${p.qs.stringify(t)}`:e+=`?${p.qs.stringify(t)}`),this.currentRouterInfo={url:e};const o=new O(this,e,{preloadData:n,fnName:r}),a=o.getUri().getPath();if("/pop/subscribe"!==a){const t=yield o.goto(e);return i.$cat.reportCustomMetrics(y.YXReportTarget.ROUTER_GOTO,y.ReportValue.SUCCESS,{url:a,msg:null==t?void 0:t.errMsg}),i.$cat.reportCustomMetrics("router_url_temp",y.ReportValue.SUCCESS,{url:s}),t}this.pop(e)}catch(e){throw i.$cat.reportCustomMetrics(y.YXReportTarget.ROUTER_GOTO,y.ReportValue.FAILED,{url:s,msg:null==e?void 0:e.errMsg,stack:null==e?void 0:e.stack}),i.$cat.reportCustomMetrics("router_url_temp",y.ReportValue.SUCCESS,{url:s}),e}}))}pop(e){return l(this,null,(function*(){try{const t=R.parse(e,!0),{pathname:r,query:o}=t;o.params=o.params?JSON.parse(o.params):{},o.params&&"[object Object]"===Object.prototype.toString.call(o.params)&&(o.params.poiId=getApp().$poiId),o.major=isNaN(Number(o.major))?0:Number(o.major);let i=null;return"/pop/subscribe"===r&&(i=yield T([o])),i}catch(e){}}))}gotoAfterLogin(e=null,t,r){if(g.log.info("[router] gotoAfterLogin",this.loginModule.isLogin()),this.loginModule.isLogin())e&&this.goto(e,t);else{g.log.info("gotoAfterLogin 没登录，前去登陆,targetPage:",e,t);const o=this.app&&this.app.page(),i=o&&o.__route__;this.loginModule.login(t).then((o=>l(this,null,(function*(){g.log.debug("登陆后 info:",o,"waitFor",!!(null==r?void 0:r.waitFor)),r&&r.waitFor&&(yield(0,h.default)(r.waitFor)),o?this.afterLogin(o,i,e,t,r):g.log.warn("[router](gotoAfterLogin)","用户取消登陆")}))))}}afterLogin(e,t="",r="",o=null,i){g.log.info("[ROUTER] afterLogin",e,t,r,o),r&&"object"!=typeof r&&this.goto(decodeURIComponent(r),o,i)}navigateBackAndGoto(e,t,r){wx.navigateBack({delta:e}),t&&r&&setTimeout((()=>{this.emitNavigateTo(t,r)}),500)}emitNavigateTo(e,t){(this.app&&this.app.page(-1))!==t?setTimeout((()=>{this.emitNavigateTo(e,t)}),500):this.goto(e)}jumpToH5(e,t={}){t.paramObj&&(e.indexOf("?")>-1?e+=`&${p.qs.stringify(t.paramObj)}`:e+=`?${p.qs.stringify(t.paramObj)}`,delete t.paramObj);let r={};t.goToType&&(r={fnName:wx[t.goToType]});const o=`iretail://www.retail.com/web?url=${encodeURIComponent(e)}`;return this.goto(o,t,r)}triggerBack(e,t=-1,r=100){return l(this,null,(function*(){if(g.log.info("[ROUTER] back scene",e,t),this.needDebounce(t,r))return;U.push("BACK");const o=getApp();try{this.currentRouterInfo={url:t};const r=new O(this,t,{}),i=yield r.back(e);return o.$cat.reportCustomMetrics(y.YXReportTarget.ROUTER_GOTO,y.ReportValue.SUCCESS,{scene:e,url:t,msg:null==i?void 0:i.errMsg}),i}catch(r){o.$cat.reportCustomMetrics(y.YXReportTarget.ROUTER_GOTO,y.ReportValue.FAILED,{scene:e,url:t,msg:null==r?void 0:r.errMsg});const i={errMsg:`back Error: scene:${e}`,msg:null==r?void 0:r.errMsg};return o.$cat.reportError(d.CAT_SEC_CATEGORY.ROUTER_WARN({MOUDULE_NAME:f.MOUDULE_NAME,scene:e,url:t,error:i})),null}}))}};