var e=Object.create,t=Object.defineProperty,i=Object.defineProperties,s=Object.getOwnPropertyDescriptor,o=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertyNames,a=Object.getOwnPropertySymbols,n=Object.getPrototypeOf,l=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,d=(e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s,p=(e,t)=>{for(var i in t||(t={}))l.call(t,i)&&d(e,i,t[i]);if(a)for(var i of a(t))u.call(t,i)&&d(e,i,t[i]);return e},c=(e,t)=>i(e,o(t)),m=e=>t(e,"__esModule",{value:!0}),h=i=>((e,i,o)=>{if(i&&"object"==typeof i||"function"==typeof i)for(let a of r(i))l.call(e,a)||"default"===a||t(e,a,{get:()=>i[a],enumerable:!(o=s(i,a))||o.enumerable});return e})(m(t(null!=i?e(n(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);((e,i)=>{for(var s in m(e),i)t(e,s,{get:i[s],enumerable:!0})})(exports,{default:()=>C});var g=h(require("./ua.js")),_=h(require("./kw.js")),v=h(require("./a0.js")),I=h(require("./u2.js")),y=h(require("./ob.js")),f=h(require("./gi.js")),S=h(require("./is.js")),x=h(require("./ct.js")),P=h(require("./ia.js")),{camelToUnderScore:b}=require("./p0.js"),C=class extends _.default{constructor(e,t){super(e,t),this.env="production"===t.getModule("env").getEnv()?"market":"test",this.envModule=t.getModule("env"),this.catModule=t.getModule("cat"),this.storeModule=null,this.lxDebug=!1,this.utmTermObj={},this.yx_wxunionid="",this.shatTicket="",this.openGid="",this.templateId="",this.loginSuccessAndInitShareBindThis=this.loginSuccessAndInitShare.bind(this)}resolveLxEnvOptions(e){var t,i,s,o,r;let a;try{a=JSON.parse((null==(t=g.default.get("utm"))?void 0:t.utm_term)||"{}")}catch(e){a={}}let n={suid:(null==e?void 0:e.suid)||(null==e?void 0:e.shareUserId)||(null==(i=null==e?void 0:e.query)?void 0:i.shareUserId),sappnm:null==e?void 0:e.sappnm,scid:null==e?void 0:e.scid,reqid:(null==e?void 0:e.reqid)||(null==e?void 0:e.r)||(null==e?void 0:e.g),poiIdStr:(null==e?void 0:e.poiIdStr_spoi)||(null==e?void 0:e.poiIdStr)||(null==e?void 0:e.poiId)||void 0,poi_id:(null==e?void 0:e.spoi)||(null==e?void 0:e.originalPoiId)||(null==e?void 0:e.poiId)||void 0,sku_id:(null==e?void 0:e.sku_id)||(null==e?void 0:e.skuId),skuId:(null==e?void 0:e.sku_id)||(null==e?void 0:e.skuId),cookbook_id:(null==e?void 0:e.cookbook_id)||(null==e?void 0:e.cookbookId),activity_id:null==e?void 0:e.activity_id,is_robot:null==e?void 0:e.is_robot,start_from:null==e?void 0:e.start_from,start_sku_id:null==e?void 0:e.start_sku_id,start_shareid:null==e?void 0:e.start_shareid,shareid:null==e?void 0:e.shareid,share_type:null==e?void 0:e.share_type};try{if(e.utm_term&&"string"==typeof e.utm_term){const t=JSON.parse(e.utm_term);for(const e in t)n[e]||(n[e]=t[e])}}catch(e){}if(e.extraParams)try{let t=e.extraParams||{};"string"==typeof t&&(t=JSON.parse(t)),n.extra_params=t}catch(e){y.log.error(`团长分享增加扩展参数:${e}`)}const l=(null==e?void 0:e.extendParams)||{};try{const e=Object.keys(n),t={},i=Object.keys(l);for(const s of i){const i=l[s]||"";if(i){const o=b(s);e.includes(o)&&y.log.warn(`extendParams 上的字段 ${o} 覆盖了公参，确认这个动作OK？`),t[o]=i}}n=p(p({},n),t)}catch(e){y.log.error(`转换 extendParams 失败, error: ${e}`)}n.mtlm||n.reqid||n.shareid||n.set_source||!Object.keys(a).length||(y.log.info("使用旧 utm_term",JSON.stringify(a),JSON.stringify(n)),n=a),this.openGid&&(n.open_gid=this.openGid),this.utmTermObj=n;return{utm_term:JSON.stringify(n),utm_medium:(null==e?void 0:e.utm_medium)||(null==(s=null==e?void 0:e.query)?void 0:s.utm_medium)||null,utm_campaign:(null==e?void 0:e.utm_campaign)||(null==(o=null==e?void 0:e.query)?void 0:o.utm_campaign)||null,secChannel:(null==e?void 0:e.secChannel)||(null==(r=null==e?void 0:e.query)?void 0:r.secChannel)||null}}static register(e){const t=new C("lxLog",e);return e.addModule(t),t}destroy(){this.event.off(this.event.CONTANTS.LOGIN_SUCCESS,this.loginSuccessAndInitShareBindThis)}getLxValidateCode(){return this.storeModule&&this.storeModule.getCacheValue("lxValidCode")}setLxValidateCode(e){return this.storeModule&&this.storeModule.setCache("lxValidCode",e)}setStore(e){this.storeModule=e}openLxLogDebug(){this.lxDebug=!0}closeLxLogDebug(){this.lxDebug=!1}openLxDebug(e){const t=this.getLxValidateCode();let i=e||t;return(this.lxDebug||this.envModule.getDebug())&&(i||(i=Math.random().toString().slice(2,10),this.setLxValidateCode(i)),y.log.debug("[lxLog]","!".repeat(10),"八位验证码是：",i),g.default.debug(!0,{code:i})),i}init({lxUrl:e,LX_APP_NAME:t,LX_CHANNEL:i,LX_RTNM:s,version:o}){g.default.init(e,{appnm:t,category:i,rtnm:s,app:o})}setLxEnv({userId:e=null,openId:t=null,uuid:i=null,unionId:s=null,opt:o=null,scene:r=null,cityId:a=null,shareTicket:n=null,openGid:l=null}={}){if(e&&g.default.set("uid",e),i&&(this.yx_wxunionid=i.replace(/[\r\n]/g,"")),a&&g.default.set("cityId",a),r&&(g.default.set("scene",r),g.default.set("wxChannel",r),g.default.setUTM({utm_content:`${r}`},!0)),l&&(this.utmTermObj.open_gid=l,g.default.setUTM({utm_term:JSON.stringify(this.utmTermObj)},!0)),!o)return;((null==o?void 0:o.reqid)||(null==o?void 0:o.r)&&n!==this.shatTicket)&&(this.openGid="",this.shatTicket="",this.utmTermObj.open_gid=""),(null==o?void 0:o.templateId)&&(this.templateId=o.templateId),(null==o?void 0:o.bizMsgBatchId)&&(this.messageId=`${o.bizMsgBatchId}_${o.pushChannelId||0}`);const{utm_term:u,utm_medium:d,utm_campaign:p,secChannel:c}=this.resolveLxEnvOptions(o);n&&this.setShareTicket(n),u&&(g.default.setUTM({utm_term:u},!0),this.event.emit(this.event.CONTANTS.UTM_TERM_RESOLVED,u)),d&&g.default.setUTM({utm_medium:`${d}`},!0);const m=p||c;m&&(c&&g.default.set("secChannel",c),g.default.setUTM({utm_campaign:`${m}`},!0))}generateRequestId(){let e=parseInt(1e3*Math.random(),10);return e<10?e=`00${e}`:e<100&&(e=`0${e}`),`${Date.now()}-${e}`}setShareTicket(e){this.shatTicket=e,y.log.info("进入setShareTicket",e),this.app.isLogin()?(y.log.info("进入setShareTicket， 已登录"),this.loginSuccessAndInitShare()):this.event.once(this.event.CONTANTS.LOGIN_SUCCESS,this.loginSuccessAndInitShareBindThis)}setTagWithCtx(e,t,i){if(!t)throw new Error("没有传页面实例");const{route:s}=t,o=i||I.LX_CONFIG[s]&&I.LX_CONFIG[s].cid||"";if(!o)throw new Error(`${s} 没有注册cid`);g.default.setTagWithCtx(t,"youxuan",{[o]:e})}loginSuccessAndInitShare(){return e=this,t=null,i=function*(){if(this.shatTicket&&this.app.isLogin()&&this.utmTermObj.suid){y.log.info("进入loginSuccessAndInitShare， 已登录");let e=yield(0,f.wx2promiseify)(wx.login);y.log.info("进入loginSuccessAndInitShare， loginRes",e);const t=yield(0,f.wx2promiseify)(wx.getShareInfo,{shareTicket:this.shatTicket});y.log.info("进入loginSuccessAndInitShare， shareRes",t);try{yield(0,f.wx2promiseify)(wx.checkSession),y.log.info("进入loginSuccessAndInitShare checkSession 成功",t)}catch(t){y.log.warn("进入loginSuccessAndInitShare，checkSession 失败"),e=yield(0,f.wx2promiseify)(wx.login),y.log.info("进入loginSuccessAndInitShare，重新生成login",e)}if((null==e?void 0:e.code)&&(null==t?void 0:t.encryptedData)){const i=yield this.app.$service.groupMonitor({appId:"tt48f03e4dd7c81b7d01",appName:"mall",code:null==e?void 0:e.code,encryptedData:t.encryptedData,iv:t.iv});i&&(this.openGid=i,this.setLxEnv({openGid:i})),y.log.info("loginSuccessAndInitShare结果",p({res:i,code:null==e?void 0:e.code},t))}}},new Promise(((s,o)=>{var r=e=>{try{n(i.next(e))}catch(e){o(e)}},a=e=>{try{n(i.throw(e))}catch(e){o(e)}},n=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,a);n((i=i.apply(e,t)).next())}));var e,t,i}genLxShareParam(e,t={}){var i,s;const o=getApp(),r=this.generateRequestId();return{queryString:(0,v.stringify)(c(p({},t),{suid:(0,x.getSuid)(o),sappnm:"meituanyouxuan_dyapp",scid:t.cid||I.LX_CONFIG[e]&&I.LX_CONFIG[e].cid||"",spoi:t.shareFromPoi||(null==(i=o.$poi)?void 0:i.getPoiId()),poiIdStr_spoi:t.poiIdStr||(null==(s=o.$poi)?void 0:s.getPoiIdStr()),reqid:r})),requestId:r}}genLxSharePath(e,t,i={}){const{queryString:s,requestId:o}=this.genLxShareParam(e,i);let r=t;return-1!==r.indexOf("?")?r+=`&${s}`:r+=`?${s}`,{path:r,requestId:o}}pvByRoute(e,t={}){var i;const{cid:s=""}=e&&I.LX_CONFIG[e]||{};if(s&&I.LX_CONFIG[e].pvAuto){const i=this.catModule.getReportInfo();return this.pv(I.LX_CONFIG[e].cid,p(p({},i),t))}try{if(!s){const t=getApp();(null==(i=t.$cat)?void 0:i.reportCustomMetrics)&&t.$cat.reportCustomMetrics(S.YXReportTarget.PAGE_VIEW_CID,S.ReportValue.FAILED,{type:"LX_CONFIG_NO_CID",route:e||"EMPTY",cid:"EMPTY",result:"FAILED"})}}catch(e){}}pv(e,t={},i={}){var s,o,r,a,n,l;const u=p({},i);delete u.appName;const d=getApp();try{e?(null==(s=d.$cat)?void 0:s.reportCustomMetrics)&&d.$cat.reportCustomMetrics(S.YXReportTarget.PAGE_VIEW_CID,S.ReportValue.SUCCESS,{type:"Y_CID",route:(null==(o=d.page())?void 0:o.route)||"EMPTY",cid:e||"EMPTY",result:"SUCCESS"}):(null==(r=d.$cat)?void 0:r.reportCustomMetrics)&&d.$cat.reportCustomMetrics(S.YXReportTarget.PAGE_VIEW_CID,S.ReportValue.FAILED,{type:"N_CID",route:(null==(a=d.page())?void 0:a.route)||"EMPTY",cid:"EMPTY",result:"FAILED"})}catch(e){}const{groupSource:m="",groupSkuId:h="",groupShareId:_=""}=(0,x.getGroupShareParams)(d),v=(0,x.getLiveLXparams)(d),I=P.globalCustomLXParams.getCustomLXParamsFromAPP(),y=(null==(n=d.getModule("user"))?void 0:n.getWxNickName())||-999,f=(null==(l=d.getModule("user"))?void 0:l.getWxAvatarUrl())||-999,b=c(p(c(p(p({},I),v),{build_id:"false"}),t),{yx_wxunionid:this.yx_wxunionid,poi_id:this.app.$poiId||"",poiIdStr:this.app.$poi&&this.app.$poi.getPoiIdStr&&this.app.$poi.getPoiIdStr()||"-999",wechat_name:y,wechat_profile_url:f,custom:c(p({},t.custom),{traceids:this.getTraceids()}),environment:this.env,start_from:m,start_shareid:_||"",template_id:this.templateId,message_id:this.messageId});h&&(b.start_sku_id=h);return g.default.pageView(e,(0,x.dealToDefalutValue)(b),u)}bo(e,t,i={},s={}){const o=p({},s);delete o.appName;const r=getApp(),a=(0,x.getLiveLXparams)(r),n=P.globalCustomLXParams.getCustomLXParamsFromAPP();g.default.order(e,t,(0,x.dealToDefalutValue)(c(p(p(c(p(p({},n),a),{build_id:"false"}),i),i.custom),{traceids:this.getTraceids(),yx_wxunionid:this.yx_wxunionid,template_id:this.templateId,message_id:this.messageId,poi_id:this.app.$poiId||"",poiIdStr:this.app.$poi&&this.app.$poi.getPoiIdStr&&this.app.$poi.getPoiIdStr()||"-999",environment:this.env})),o)}mc(e,t={},i={}){var s,o;if(!(0,x.canReport)("mc",e,i,t))return;const r=getApp(),{groupSource:a="",groupSkuId:n="",groupShareId:l=""}=(0,x.getGroupShareParams)(r),u=(0,x.getLiveLXparams)(r),d=P.globalCustomLXParams.getCustomLXParamsFromAPP(),m=p({},i);delete m.appName;const h=p({},t.custom||{});let{requestId:_}=m;_||(_=this.generateRequestId());const v=(null==(s=r.getModule("user"))?void 0:s.getWxNickName())||-999,I=(null==(o=r.getModule("user"))?void 0:o.getWxAvatarUrl())||-999,y=c(p(p(c(p(p({},d),u),{build_id:"false"}),t),h),{wechat_name:v,wechat_profile_url:I,event_request_id:_,environment:this.env,poi_id:this.app.$poiId,poiIdStr:this.app.$poi&&this.app.$poi.getPoiIdStr&&this.app.$poi.getPoiIdStr()||"-999",traceids:this.getTraceids(),yx_wxunionid:this.yx_wxunionid,start_from:a,start_shareid:l||"",template_id:this.templateId,message_id:this.messageId});n&&(y.start_sku_id=n);return{requestId:_,res:g.default.moduleClick(e,(0,x.dealToDefalutValue)(y),m)}}mv(e,t={},i={}){var s,o;if(!(0,x.canReport)("mv",e,i,t))return;const r=getApp(),{groupSource:a="",groupSkuId:n="",groupShareId:l=""}=(0,x.getGroupShareParams)(r),u=(0,x.getLiveLXparams)(r),d=P.globalCustomLXParams.getCustomLXParamsFromAPP(),m=p({},i);delete m.appName;const h=p({},t.custom||{});let{requestId:_}=m;_||(_=this.generateRequestId());const v=(null==(s=r.getModule("user"))?void 0:s.getWxNickName())||-999,I=(null==(o=r.getModule("user"))?void 0:o.getWxAvatarUrl())||-999,y=c(p(p(c(p(p({},d),u),{build_id:"false"}),t),h),{wechat_name:v,wechat_profile_url:I,event_request_id:_,environment:this.env,poi_id:this.app.$poiId,poiIdStr:this.app.$poi&&this.app.$poi.getPoiIdStr&&this.app.$poi.getPoiIdStr()||"-999",traceids:this.getTraceids(),yx_wxunionid:this.yx_wxunionid,start_from:a,start_shareid:l||"",template_id:this.templateId,message_id:this.messageId});n&&(y.start_sku_id=n);return g.default.moduleView(e,(0,x.dealToDefalutValue)(y),m)}mvL(e,t={},i={}){if(!(0,x.canReport)("mvL",e,i,t))return;const s=p({},i);delete s.appName;return g.default.moduleViewList(e,(0,x.dealToDefalutValue)(c(p({build_id:"false"},t),{environment:this.env,yx_wxunionid:this.yx_wxunionid,poi_id:this.app.$poiId||"",poiIdStr:this.app.$poi&&this.app.$poi.getPoiIdStr&&this.app.$poi.getPoiIdStr()||"-999"})),s)}getTraceids(){return getCurrentPages().map((e=>null==e?void 0:e.route)).join("#")}destory(){}};