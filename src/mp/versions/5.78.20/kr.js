var e=Object.create,t=Object.defineProperty,r=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyNames,o=Object.getPrototypeOf,n=Object.prototype.hasOwnProperty,s=e=>t(e,"__esModule",{value:!0}),p=p=>((e,o,s)=>{if(o&&"object"==typeof o||"function"==typeof o)for(let p of a(o))n.call(e,p)||"default"===p||t(e,p,{get:()=>o[p],enumerable:!(s=r(o,p))||s.enumerable});return e})(s(t(null!=p?e(o(p)):{},"default",p&&p.__esModule&&"default"in p?{get:()=>p.default,enumerable:!0}:{value:p,enumerable:!0})),p);((e,r)=>{for(var a in s(e),r)t(e,a,{get:r[a],enumerable:!0})})(exports,{preFetch:()=>O,requestProjectVersion:()=>v});var c,u,l=p(require("./n3.js")),m=p(require("./n2.js")),i=p(require("./n7.js")),d=p(require("./n4.js")),h=p(require("./n2.js")),f=p(require("./n8.js")),y=(0,l.getRequest)((e=>(0,l.promiseRequest)(e)),{throwError:!0},(0,i.default)(d.default,h.default)),b=e=>{const t=getApp(),r=f.globalBpKey;null==u&&t?u=t[r]||(t[r]=[]):(u=u||[],setTimeout((()=>{c&&(getApp()[r]=u)}),100)),u.push(e)},g=e=>{const t=c.get(e.url);return t.isCold=!1,Promise.resolve(t)},w=e=>{const t=e.url,r=E(e);let a;q(e);const o=e.project.indexOf("__");return a=-1===o?`mtweapp_api_${"staging"===e.env?`${e.env}_`:""}${t}`:"mtweapp_api_"+e.project.slice(0,o)+"_"+e.name+"_"+e.env,y(r[C]?{url:t,method:"POST",cacheKey:a,cache:m.CacheType.check,data:r,header:{"content-type":"application/x-www-form-urlencoded"}}:{url:t,cacheKey:a,cache:m.CacheType.check}).then((r=>{if(r&&200===r.statusCode){var{data:a}=r;if(a)return((e,t)=>{c.set(t.url,e);const{dep:r,prefetch:a}=e,o=[];return r&&Object.keys(r).forEach((e=>{const a=j(e,t.project,t.env);r[e]?(q(a),c.set(a.url,r[e])):o.push(_(a))})),a&&setTimeout((()=>{a.names.forEach((e=>_(j(e,t.project,t.env))))}),a.delay||0),Promise.all(o).catch((e=>{})).then((()=>e))})(a,e).then((()=>a));throw new Error(`Caster prefetch data error: ${t}`)}throw new Error(`Caster prefetch request error: ${t}`)}))},_=e=>{const t=getApp();return null==c&&t?c=t[f.globalDepDataKey]||(t[f.globalDepDataKey]=new Map):(c=c||new Map,setTimeout((()=>{getApp()[f.globalDepDataKey]=c}),100)),(c.has(e.url)?g:w)(e)},j=(e,t,r)=>{const[a,o,n]=e.split("|"),s=o||t,p=null==n?r||"":0===n.indexOf("pro")?"":n;return{name:a,project:s,env:p,url:`https://portal-portm.meituan.com/weapp/dynamic/v6/${s}/${a}${p?`/${p}`:""}`}},v=e=>{var t={};const{openId:r,name:a,env:o="",app:n="group",appVersion:s=100,sdkVersion:p="1.0.0",platform:c="Weixin"}=e;if(null==r){throw new Error("请传入openId作为uuid")}const u={type:"CasterCheckVersion",env:"",project:a,state:0},l=Date.now(),m=`https://dd.meituan.com/config/caster/checkList?bundleNames=caster_${o}_${a}`,i=y({url:m,method:"POST",data:{platform:c,app:n,UUID:r,appVersion:s,channel:".*",sdkVersion:p}}).then((e=>{if(200===e.statusCode&&e.data){const{bundles:r}=e.data.body||{},o=r&&r.length&&r[0].url;if(o){const e=o.match(/project=(.*).js/)[1],r=getApp(),n=f.globalConfigKey+"__"+a;if(r?t=r[n]||(r[n]={}):setTimeout((()=>{getApp()[n]=t}),100),e)return t.project=e,b(Object.assign({},u,{state:1,project:e,value:Date.now()-l})),t}const n=new Error(`Caster request dd no match: ${o}`);throw n.type=f.ERROR_TYPE.NO_MATCH_RULE,n}throw new Error(`Caster request dd error: ${m}`)}));return i.catch((e=>{let t=0;e&&e.type===f.ERROR_TYPE.NO_MATCH_RULE&&(t=2),b(Object.assign({},u,{type:"CasterCheckVersion",value:Date.now()-l,state:t}))})),t.abTestFn=()=>i,i},O=e=>{const t=Date.now(),r=j(e),a={type:"CasterPrefetch",project:r.project,name:r.name,env:r.env,state:0};return _(r).then((()=>{b(Object.assign({},a,{state:1,value:Date.now()-t}))})).catch((()=>{a.value=Date.now()-t,b(a)}))},D={},q=e=>{const t=e.project+"|"+e.env;(D[t]||(D[t]=new Set)).add(e.name)},C="caster-cache",E=e=>{const t=e.project+"|"+e.env;return D[t]?{[C]:Array.from(D[t]).join(",")}:{}};